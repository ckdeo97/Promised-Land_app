<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>ì•½ì†ì˜ ë•…</title>
<!-- PWA / í™ˆí™”ë©´ ì¶”ê°€ -->
<link rel="manifest" href="manifest.json"/>
<link rel="apple-touch-icon" href="asset/logo.png"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<meta name="apple-mobile-web-app-title" content="ì•½ì†ì˜ ë•…"/>
<meta name="theme-color" content="#000000"/>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, collection, query, where, orderBy, onSnapshot, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCsc6xD7mTAnSwPbz7iSGB9NjniFub97wY",
    authDomain: "promiand-app.firebaseapp.com",
    projectId: "promiand-app",
    storageBucket: "promiand-app.firebasestorage.app",
    messagingSenderId: "585556305161",
    appId: "1:585556305161:web:2752434736fd4a652c1fd8",
    measurementId: "G-E2SKN09Y6T"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);
  try { getAnalytics(app); } catch(e) {}

  // ============================================================
  // FIREBASE DB LAYER
  // ============================================================
  window.FDB = {
    db, storage,

    async getCol(col) {
      try {
        const snap = await getDocs(collection(db, col));
        return snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch(e) { console.error('getCol', col, e); return []; }
    },

    async getDoc(col, id) {
      try {
        const snap = await getDoc(doc(db, col, id));
        return snap.exists() ? { id: snap.id, ...snap.data() } : null;
      } catch(e) { return null; }
    },

    async setDoc(col, id, data) {
      try {
        await setDoc(doc(db, col, id), { ...data, updatedAt: serverTimestamp() }, { merge: true });
      } catch(e) { console.error('setDoc', col, id, e); }
    },

    async addDoc(col, data) {
      try {
        const ref2 = await addDoc(collection(db, col), { ...data, createdAt: serverTimestamp() });
        return ref2.id;
      } catch(e) { console.error('addDoc', col, e); return null; }
    },

    async deleteDoc(col, id) {
      try {
        await deleteDoc(doc(db, col, id));
      } catch(e) { console.error('deleteDoc', col, id, e); }
    },

    async uploadFile(path, file) {
      try {
        const storageRef = ref(storage, path);
        await uploadBytes(storageRef, file);
        return await getDownloadURL(storageRef);
      } catch(e) { console.error('upload', e); return null; }
    },

    async uploadBase64(path, dataUrl) {
      try {
        const resp = await fetch(dataUrl);
        const blob = await resp.blob();
        const storageRef = ref(storage, path);
        await uploadBytes(storageRef, blob);
        return await getDownloadURL(storageRef);
      } catch(e) { console.error('uploadBase64', e); return null; }
    }
  };

  // ============================================================
  // SEED (Firestoreì— ìµœì´ˆ ë°ì´í„° ì—†ìœ¼ë©´ ìƒì„±)
  // ============================================================
  async function seedIfNeeded() {
    const snap = await getDoc(doc(db, 'meta', 'seeded'));
    if (snap.exists()) return;

    const batch = writeBatch(db);

    const users = [
      { uid:'admin1', id:'admin', pw:'1234', name:'ì•½ì†ì˜ ë•… ê´€ë¦¬ì', phone:'010-1234-5678', birth:'19950315', cellId:'c2', role:'admin', status:'active', createdAt:'2026-01-01', profileImg:'', idChangedAt:null }
    ];
    users.forEach(u => batch.set(doc(db,'users',u.uid), u));

    const cells = [
      { id:'c1', name:'ë¦¬ë‚˜ëª©ì¥', leader:'ê¹€ë¦¬ë‚˜', order:1 },
      { id:'c2', name:'ì°½ëŒ€ëª©ì¥', leader:'ê¹€ì°½ëŒ€', order:2 },
      { id:'c3', name:'ì€í˜œëª©ì¥', leader:'ë°•ì€í˜œ', order:3 },
    ];
    cells.forEach(c => batch.set(doc(db,'cells',c.id), c));

    const rosters = [
      { id:'r1', name:'ê¹€ì°½ëŒ€', phone:'010-1234-5678', birth:'19950315', cellId:'c2', linkedUid:'admin1' },
      { id:'r2', name:'ì´ì„œì—°', phone:'010-2345-6789', birth:'19970827', cellId:'c1', linkedUid:null },
      { id:'r3', name:'ë°•ë¯¼ì¤€', phone:'010-3456-7890', birth:'19961127', cellId:'c1', linkedUid:null },
      { id:'r4', name:'ìµœìœ ì§„', phone:'010-4567-8901', birth:'19980503', cellId:'c3', linkedUid:null },
      { id:'r5', name:'ì •í•˜ì€', phone:'010-5678-9012', birth:'20000112', cellId:'c2', linkedUid:null },
    ];
    rosters.forEach(r => batch.set(doc(db,'rosters',r.id), r));

    const notices = [
      { id:'n1', title:'ë™ê³„ ìˆ˜ë ¨íšŒ ì‹ ì²­ ë§ˆê° ì•ˆë‚´', body:'1ì›” 15ì¼(ìˆ˜)ê¹Œì§€ ì‹ ì²­ì„ ì™„ë£Œí•´ ì£¼ì„¸ìš”.\nì¥ì†Œ: ì–‘í‰ ìˆ˜ì–‘ê´€\nì°¸ê°€ë¹„: 50,000ì›', by:'admin1', at:'2026-02-20', pinned:true, images:[] },
      { id:'n2', title:'12ì›” ì„¬ê¹€ì´ ì¼ì • ê³µìœ ', body:'ì°¬ì–‘íŒ€Â·ê¸°ë„íŒ€Â·ì•ˆë‚´íŒ€ ìŠ¤ì¼€ì¤„ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', by:'admin1', at:'2026-02-19', pinned:false, images:[] },
    ];
    notices.forEach(n => batch.set(doc(db,'notices',n.id), n));

    const bulletins = [
      { id:'b1', title:'2026ë…„ 2ì›” 22ì¼ ì£¼ë³´', date:'2026-02-22', by:'admin1', at:'2026-02-21',
        order:'1. ì˜ˆë°°ì˜ ë¶€ë¦„\n2. ê²½ë°°ì™€ ì°¬ì–‘\n3. ëŒ€í‘œê¸°ë„\n4. ì„±ê²½ë´‰ë…\n5. ë§ì”€ ì„ í¬\n6. ë´‰í—Œ\n7. ë´‰í—Œê¸°ë„\n8. ê´‘ê³ (ì„±ë„ì˜ êµì œ)\n9. ì¶•ë„',
        announce:'â€¢ ë™ê³„ ìˆ˜ë ¨íšŒ ì‹ ì²­ ë§ˆê°: 1ì›” 15ì¼\nâ€¢ ìƒˆê°€ì¡± í™˜ì˜: í•œì†Œë§ ìë§¤',
        prayer_duty:'ì •í•˜ì€', bible_reading:'ë°•ë¯¼ì¤€', offering_duty:'ìµœìœ ì§„', announcement_duty:'ì´ì„œì—°',
        songs:'1. ì£¼ë‹˜ í•œ ë¶„ë§Œìœ¼ë¡œ (Key: G)\n2. Good Grace (Key: A)\n3. ì˜¤ì§ ì£¼ë§Œì´ (Key: D)' }
    ];
    bulletins.forEach(b => batch.set(doc(db,'bulletins',b.id), b));

    const worships = [
      { id:'w1', date:'2026-02-22', leader:'ê¹€ì°½ëŒ€',
        songs:[
          { title:'ì£¼ë‹˜ í•œ ë¶„ë§Œìœ¼ë¡œ', url:'', key:'G', sheet:'' },
          { title:'Good Grace', url:'', key:'A', sheet:'' },
        ],
        by:'admin1', at:'2026-02-20', storedAt:'2026-02-20' }
    ];
    worships.forEach(w => batch.set(doc(db,'worshipSets',w.id), w));

    const events = [
      { id:'e1', title:'ì£¼ì¼ ì²­ë…„ ì˜ˆë°°', date:'2026-02-22', time:'14:00', loc:'ë³¸ë‹¹', cat:'ì˜ˆë°°' },
      { id:'e2', title:'ëª©ì¥ ë¦¬ë” ëª¨ì„', date:'2026-03-05', time:'19:00', loc:'êµìœ¡ê´€', cat:'ëª¨ì„' },
    ];
    events.forEach(e => batch.set(doc(db,'events',e.id), e));

    const cellMeetings = [
      { id:'cm1', date:'2026-02-22', verse:'ìš”í•œë³µìŒ 15:1-8', verseText:'"ë‚˜ëŠ” í¬ë„ë‚˜ë¬´ìš” ë„ˆí¬ëŠ” ê°€ì§€ë¼"',
        questions:['ì˜¤ëŠ˜ ë§ì”€ì—ì„œ ê°€ì¥ ì™€ë‹¿ì€ ë¶€ë¶„ì€ ë¬´ì—‡ì¸ê°€ìš”?','ì´ë²ˆ ì£¼ ë‚˜ì˜ ì‚¶ì—ì„œ ì˜ˆìˆ˜ë‹˜ê»˜ ë” ì˜ì§€í•´ì•¼ í•  ë¶€ë¶„ì€?'],
        prayerItems:'â€¢ ìš°ë¦¬ ëª©ì¥ ëª¨ë“  ì§€ì²´ë¥¼ ìœ„í•´\nâ€¢ ì•½ì†ì˜ ë•… ì²­ë…„ë¶€ ë¶€í¥ì„ ìœ„í•´', by:'admin1', at:'2026-02-20' }
    ];
    cellMeetings.forEach(m => batch.set(doc(db,'cellMeetings',m.id), m));

    batch.set(doc(db,'meta','seeded'), { at: new Date().toISOString() });
    await batch.commit();
    console.log('Firestore seeded');
  }

  // ============================================================
  // INIT APP AFTER FIREBASE READY
  // ============================================================
  seedIfNeeded().then(() => {
    window._fbReady = true;
    if (window._appInit) window._appInit();
  }).catch(e => {
    console.error('seed error', e);
    window._fbReady = true;
    if (window._appInit) window._appInit();
  });
</script>
<script>
tailwind.config = {
  theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] } } }
}
</script>
<style>
  * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
  html { overflow-y: scroll; scrollbar-gutter: stable; }
  body { font-family: 'Inter', sans-serif; overscroll-behavior: none; }
  body.no-scroll { overflow: hidden; position: fixed; width: 100%; height: 100%; }
  .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24; }
  .material-symbols-outlined.filled { font-variation-settings: 'FILL' 1, 'wght' 300, 'GRAD' 0, 'opsz' 24; }
  ::-webkit-scrollbar { display: none; }
  * { -ms-overflow-style: none; scrollbar-width: none; }
  .hide-scrollbar::-webkit-scrollbar { display: none; }
  .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

  /* â”€â”€ ëª¨ì…˜: ëŒ€ê¸°ì—… ì•± ìŠ¤íƒ€ì¼ (ìŠ¤ì¼€ì¼ ì—†ìŒ, ìŠ¬ë¼ì´ë“œ/í˜ì´ë“œë§Œ) â”€â”€ */
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  @keyframes slideDown { from { transform: translateY(0); } to { transform: translateY(100%); } }
  @keyframes slideInRight { from { transform: translateX(24px); opacity:0; } to { transform: translateX(0); opacity:1; } }
  @keyframes slideInLeft { from { transform: translateX(-24px); opacity:0; } to { transform: translateX(0); opacity:1; } }

  .fade-in { animation: fadeIn 0.18s ease; }
  .slide-up { animation: slideUp 0.3s cubic-bezier(0.32,0.72,0,1); }
  .slide-in-right { animation: slideInRight 0.26s cubic-bezier(0.25,0.46,0.45,0.94); }
  .slide-in-left { animation: slideInLeft 0.26s cubic-bezier(0.25,0.46,0.45,0.94); }
  .scale-in { animation: fadeIn 0.2s ease; } /* ìŠ¤ì¼€ì¼ ëŒ€ì‹  í˜ì´ë“œ */
  .pop-in { animation: slideUp 0.28s cubic-bezier(0.32,0.72,0,1); } /* ìŠ¤ì¼€ì¼ ëŒ€ì‹  ìŠ¬ë¼ì´ë“œì—… */

  .tab-content { animation: fadeIn 0.18s ease; }
  .detail-page { animation: slideInRight 0.26s cubic-bezier(0.25,0.46,0.45,0.94); }
  .modal-overlay { animation: fadeIn 0.16s ease; }
  .modal-sheet { animation: slideUp 0.3s cubic-bezier(0.32,0.72,0,1); }
  .login-page { animation: fadeIn 0.22s ease; }
  .toast-anim { animation: slideUp 0.22s cubic-bezier(0.32,0.72,0,1); }

  .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  input, textarea, select { font-family: 'Inter', sans-serif; }
  .dot-pattern { background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.08) 1px, transparent 0); background-size: 20px 20px; }
  .fixed-layout { position: fixed; inset: 0; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; }
  .cal-sun { color: #ef4444; }
  .cal-sat { color: #3b82f6; }
  .profile-img-clip { overflow: hidden; cursor: grab; }
  .profile-img-clip:active { cursor: grabbing; }
  /* í¬ë¡­ ëª¨ë‹¬ */
  #crop-modal canvas { touch-action: none; }
</style>
</head>
<body class="bg-white text-black min-h-screen">
<div id="app"><div class="fixed-layout"><div class="w-8 h-8 border-2 border-black border-t-transparent rounded-full animate-spin"></div></div></div>

<script>
// ============================================================
// KOREAN PUBLIC HOLIDAYS
// ============================================================
const HOLIDAYS = new Set(['01-01','03-01','05-05','06-06','08-15','10-03','10-09','12-25']);
function isHoliday(ds) { return HOLIDAYS.has(ds.slice(5)); }

// ============================================================
// STATE
// ============================================================
let state = {
  user: null,
  page: 'loading',
  tab: 'home',
  detail: null,
  adminSub: 'dashboard',
  profileOpen: false,
  profilePage: null,
  toast: null,
  adminRosterTab: 'all',
  adminAttTab: null,
  _pendingProfileImg: null,
  _pendingProfileFile: null,
  _profileImgOffset: { x: 0, y: 0 },
  _calSel: null,
  _calMonth: null,
  _attDate: null,
  _offDate: null,
  _confirmModal: null,
  _cropModal: null,
  // Firestore ìºì‹œ
  cache: {
    users: [], cells: [], rosters: [], notices: [], bulletins: [],
    worshipSets: [], events: [], cellMeetings: [], notifications: [],
    attendance: {}, offerings: {}, comments: {}
  }
};

const uid = () => Math.random().toString(36).substr(2, 9);
const today = () => new Date().toISOString().split('T')[0];
const fmtPhone = v => { const d = v.replace(/\D/g,''); if(d.length<=3) return d; if(d.length<=7) return d.slice(0,3)+'-'+d.slice(3); return d.slice(0,3)+'-'+d.slice(3,7)+'-'+d.slice(7,11); };
const fmtDate = v => { if(!v) return ''; const d = String(v).replace(/\D/g,''); if(d.length===8) return d.slice(0,4)+'.'+d.slice(4,6)+'.'+d.slice(6,8); return v; };
const fmtAmt = v => Number(v).toLocaleString();

// localStorage: í˜„ì¬ ë¡œê·¸ì¸ ìœ ì €ë§Œ ìœ ì§€
const SESSION = {
  get() { try { return JSON.parse(localStorage.getItem('jmc_session') || 'null'); } catch { return null; } },
  set(u) { localStorage.setItem('jmc_session', JSON.stringify(u)); },
  clear() { localStorage.removeItem('jmc_session'); }
};

// ============================================================
// FIREBASE LOADER
// ============================================================
async function loadAll() {
  const FDB = window.FDB;
  const [users, cells, rosters, notices, bulletins, worshipSets, events, cellMeetings] = await Promise.all([
    FDB.getCol('users'), FDB.getCol('cells'), FDB.getCol('rosters'),
    FDB.getCol('notices'), FDB.getCol('bulletins'), FDB.getCol('worshipSets'),
    FDB.getCol('events'), FDB.getCol('cellMeetings')
  ]);
  state.cache.users = users;
  state.cache.cells = cells.sort((a,b)=>(a.order||0)-(b.order||0));
  state.cache.rosters = rosters;
  state.cache.notices = notices.sort((a,b)=>b.at.localeCompare(a.at));
  state.cache.bulletins = bulletins.sort((a,b)=>a.date.localeCompare(b.date));
  state.cache.worshipSets = worshipSets.sort((a,b)=>a.date.localeCompare(b.date));
  state.cache.events = events.sort((a,b)=>a.date.localeCompare(b.date));
  state.cache.cellMeetings = cellMeetings.sort((a,b)=>b.date.localeCompare(a.date));

  // â”€â”€ ì–´ë“œë¯¼ ê³„ì • ìë™ ë³µêµ¬: Firestoreì— admin ê³„ì •ì´ ì—†ìœ¼ë©´ ìƒì„± â”€â”€
  const adminExists = state.cache.users.find(u => u.id === 'admin' && u.role === 'admin');
  if (!adminExists && state.cache.users.length === 0) {
    // Firestore ë³´ì•ˆ ê·œì¹™ì´ ë§‰í˜€ìˆê±°ë‚˜ ì™„ì „íˆ ë¹„ì–´ìˆëŠ” ê²½ìš° fall

// ============================================================
// CONFIRM MODAL
// ============================================================
function showConfirm(msg, onYes, yesLabel='ì‚­ì œ', yesClass='bg-red-500 text-white') {
  state._confirmModal = { msg, onYes, yesLabel, yesClass };
  render();
}

function renderConfirmModal() {
  if (!state._confirmModal) return '';
  const { msg, yesLabel, yesClass } = state._confirmModal;
  return `
  <div id="confirm-overlay" class="fixed inset-0 z-[300] bg-black/50 backdrop-blur-sm modal-overlay flex items-center justify-center px-6">
    <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl fade-in">
      <p class="text-base font-bold text-center mb-2">í™•ì¸</p>
      <p class="text-sm text-zinc-500 text-center leading-relaxed mb-6">${msg}</p>
      <div class="flex gap-3">
        <button id="confirm-no" class="flex-1 py-3 border border-zinc-200 rounded-2xl text-sm font-bold">ì·¨ì†Œ</button>
        <button id="confirm-yes" class="flex-1 py-3 ${yesClass} rounded-2xl text-sm font-bold">${yesLabel}</button>
      </div>
    </div>
  </div>`;
}

// ============================================================
// CROP MODAL
// ============================================================
function renderCropModal() {
  if (!state._cropModal) return '';
  return `
  <div id="crop-modal" class="fixed inset-0 z-[310] bg-black flex flex-col">
    <div class="flex items-center justify-between px-5 pt-safe pt-4 pb-3 border-b border-white/10">
      <button id="crop-cancel" class="text-white text-sm font-medium">ì·¨ì†Œ</button>
      <p class="text-white font-bold text-sm">ì‚¬ì§„ ì¡°ì •</p>
      <button id="crop-confirm" class="text-white font-bold text-sm">ì™„ë£Œ</button>
    </div>
    <div class="flex-1 relative overflow-hidden flex items-center justify-center bg-black">
      <div id="crop-container" style="position:relative;width:300px;height:300px;touch-action:none;">
        <img id="crop-img" src="${state._cropModal.src}" style="position:absolute;width:${state._cropModal.w}px;height:${state._cropModal.h}px;left:${state._cropModal.ox}px;top:${state._cropModal.oy}px;user-select:none;-webkit-user-drag:none;" draggable="false"/>
        <div style="position:absolute;inset:0;border-radius:50%;border:2px solid rgba(255,255,255,0.7);pointer-events:none;box-shadow:0 0 0 9999px rgba(0,0,0,0.55);"></div>
      </div>
    </div>
    <div class="px-5 pb-safe pb-6 pt-4 space-y-3">
      <div class="flex items-center gap-3">
        <span class="material-symbols-outlined text-white" style="font-size:18px">photo_size_select_small</span>
        <input id="crop-scale" type="range" min="100" max="300" value="${Math.round((state._cropModal.w / state._cropModal.origW) * 100)}" class="flex-1 accent-white"/>
        <span class="material-symbols-outlined text-white" style="font-size:22px">photo_size_select_large</span>
      </div>
    </div>
  </div>`;
}

// ============================================================
// LOGO
// ============================================================
function logoImg(cls='w-10 h-10') {
  return `<img src="asset/logo.png" class="${cls} object-contain" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" alt="logo"/>
          <div class="hidden ${cls} bg-black rounded-xl items-center justify-center"><span class="text-white font-black text-sm">PL</span></div>`;
}

// ============================================================
// RENDER
// ============================================================
function render() {
  const app = document.getElementById('app');
  let html = '';

  if (state.page === 'loading') {
    html = `<div class="fixed-layout"><div class="w-8 h-8 border-2 border-black border-t-transparent rounded-full animate-spin"></div></div>`;
  } else if (!state.user) {
    if (state.page === 'register') html = renderRegister();
    else html = renderLogin();
    document.body.classList.add('no-scroll');
  } else {
    document.body.classList.remove('no-scroll');
    if (state.page === 'admin') html = renderAdmin();
    else if (state.profilePage) html = renderProfilePage();
    else if (state.detail) {
      if (state.detail.type === 'bulletin') html = renderBulletinDetail();
      else if (state.detail.type === 'notice') html = renderNoticeDetail();
      else if (state.detail.type === 'worship') html = renderWorshipDetail();
      else html = renderMain();
    } else {
      html = renderMain();
    }
  }

  if (state.toast) {
    html += `<div class="fixed top-20 left-1/2 -translate-x-1/2 z-[200] bg-black text-white px-5 py-3 rounded-2xl text-sm font-bold shadow-xl toast-anim">${state.toast}</div>`;
  }

  html += renderConfirmModal();
  html += renderCropModal();

  app.innerHTML = html;
  bindEvents();
  bindCropModal();
}

function showToast(msg) {
  state.toast = msg;
  render();
  setTimeout(() => { state.toast = null; render(); }, 2200);
}

function icon(name, cls='', size=24, fill=false) {
  return `<span class="material-symbols-outlined ${fill?'filled':''} ${cls}" style="font-size:${size}px">${name}</span>`;
}

// ============================================================
// LOGIN
// ============================================================
function renderLogin() {
  return `
  <div class="fixed-layout bg-white login-page px-8">
    <div class="w-full max-w-sm">
      <div class="text-center mb-10">
        <div class="w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-5 overflow-hidden bg-black">
          ${logoImg('w-20 h-20')}
        </div>
        <h1 class="text-2xl font-bold tracking-tight">ì•½ì†ì˜ ë•…</h1>
        <p class="text-zinc-400 text-sm mt-1">ì²­ë…„ë¶€ ì»¤ë®¤ë‹ˆí‹°</p>
      </div>
      <div class="space-y-4">
        <input id="login-id" type="text" placeholder="ì•„ì´ë””" class="w-full px-4 py-3.5 bg-zinc-50 border border-zinc-200 rounded-2xl text-sm focus:outline-none focus:border-black focus:ring-1 focus:ring-black"/>
        <input id="login-pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full px-4 py-3.5 bg-zinc-50 border border-zinc-200 rounded-2xl text-sm focus:outline-none focus:border-black focus:ring-1 focus:ring-black"/>
        <div id="login-error" class="text-red-500 text-xs font-medium px-1 hidden"></div>
        <button id="btn-login" class="w-full py-3.5 bg-black text-white rounded-2xl font-bold text-sm transition-opacity active:opacity-70">ë¡œê·¸ì¸</button>
      </div>
      <div class="text-center mt-6">
        <button id="btn-go-register" class="text-sm text-zinc-500 font-medium">
          ì•„ì§ ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <span class="text-black font-bold underline underline-offset-2">íšŒì›ê°€ì…</span>
        </button>
      </div>
    </div>
  </div>`;
}

// ============================================================
// REGISTER
// ============================================================
function renderRegister() {
  return `
  <div class="fixed-layout bg-white overflow-y-auto slide-in-right" style="position:fixed;inset:0;overflow-y:auto;display:block;">
    <div class="px-6 py-8 max-w-sm mx-auto">
      <button id="btn-back-login" class="flex items-center gap-1 text-sm text-zinc-500 mb-6">${icon('arrow_back','',20)} ë’¤ë¡œ</button>
      <h1 class="text-2xl font-bold mb-1">íšŒì›ê°€ì…</h1>
      <p class="text-zinc-400 text-sm mb-8">ì•½ì†ì˜ ë•… ì²­ë…„ë¶€ ì»¤ë®¤ë‹ˆí‹°ì— ê°€ì…í•©ë‹ˆë‹¤.</p>
      <div class="space-y-4">
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì´ë¦„</label><input id="reg-name" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="í™ê¸¸ë™"/></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì „í™”ë²ˆí˜¸</label><input id="reg-phone" inputmode="numeric" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="010-1234-5678"/></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ìƒë…„ì›”ì¼</label><input id="reg-birth" inputmode="numeric" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="1995.03.15"/></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì•„ì´ë””</label><input id="reg-id" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="ì‚¬ìš©í•  ì•„ì´ë””"/></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ë¹„ë°€ë²ˆí˜¸</label><input id="reg-pw" type="password" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="4ì ì´ìƒ"/></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input id="reg-pw2" type="password" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥"/></div>
        <label class="flex items-start gap-3 pt-2">
          <input id="reg-agree" type="checkbox" class="mt-0.5 w-5 h-5 rounded border-zinc-300 accent-black"/>
          <span class="text-xs text-zinc-500 leading-relaxed">ê°œì¸ì •ë³´(ì´ë¦„, ì „í™”ë²ˆí˜¸, ìƒë…„ì›”ì¼) ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.</span>
        </label>
        <div id="reg-error" class="text-red-500 text-xs font-medium hidden"></div>
        <button id="btn-register" class="w-full py-3.5 bg-black text-white rounded-2xl font-bold text-sm transition-opacity active:opacity-70">ê°€ì… ì‹ ì²­</button>
      </div>
    </div>
  </div>`;
}

// ============================================================
// MAIN (tabs)
// ============================================================
function renderMain() {
  const u = state.user;
  const notis = state.cache.notifications || [];
  let content = '';
  if (state.tab === 'home') content = renderHomeTab();
  else if (state.tab === 'bulletin') content = renderBulletinTab();
  else if (state.tab === 'notice') content = renderNoticeTab();
  else if (state.tab === 'calendar') content = renderCalendarTab();
  else if (state.tab === 'cell') content = renderCellTab();

  const tabs = [
    { key:'home', icon:'home', label:'í™ˆ' },
    { key:'bulletin', icon:'menu_book', label:'ì£¼ë³´' },
    { key:'notice', icon:'campaign', label:'ê³µì§€' },
    { key:'calendar', icon:'calendar_month', label:'ì¼ì •' },
    { key:'cell', icon:'groups', label:'ëª©ì¥' },
  ];

  return `
  <div class="min-h-screen bg-white pb-32 fade-in">
    <!-- Header -->
    <header class="sticky top-0 z-50 px-5 pt-5 pb-4 bg-white/90 backdrop-blur-xl border-b border-zinc-100">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl overflow-hidden bg-black flex items-center justify-center">
            ${logoImg('w-10 h-10')}
          </div>
          <div>
            <p class="text-[10px] font-bold text-zinc-400 uppercase tracking-[0.15em]">ì•½ì†ì˜ ë•…</p>
            <h1 class="text-lg font-bold tracking-tight">${u.name} ğŸ‘‹</h1>
          </div>
        </div>
        <div class="flex gap-2">
          <button data-action="open-profile" class="relative w-10 h-10 rounded-full bg-zinc-200 flex items-center justify-center border-2 border-black overflow-hidden">
            ${u.profileImg ? `<img src="${u.profileImg}" class="w-full h-full object-cover"/>` : `<span class="text-sm font-bold text-zinc-500">${(u.name||'?')[0]}</span>`}
          </button>
        </div>
      </div>
    </header>

    <main class="px-5 mt-8 space-y-10"><div class="tab-content">${content}</div></main>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 left-0 right-0 z-50 px-2 pb-7 pt-3 bg-white/90 backdrop-blur-xl border-t border-zinc-100">
      <div class="flex justify-around items-center max-w-md mx-auto">
        ${tabs.map(t => `
          <button data-tab="${t.key}" class="flex flex-col items-center gap-0.5 px-4 py-1 transition-colors ${state.tab===t.key?'text-black':'text-zinc-400'}">
            ${icon(t.icon,'',26,state.tab===t.key)}
            <span class="text-[10px] font-bold tracking-wider">${t.label}</span>
          </button>
        `).join('')}
      </div>
    </nav>

    ${state.profileOpen ? renderProfileSheet() : ''}
  </div>`;
}

// ============================================================
// PROFILE SHEET
// ============================================================
function renderProfileSheet() {
  const u = state.user;
  const isAdmin = u.role === 'admin';
  const cells = state.cache.cells;
  const cell = cells.find(c => c.id === u.cellId);
  return `
  <div data-action="close-profile" class="fixed inset-0 z-[100] bg-black/40 backdrop-blur-sm modal-overlay"></div>
  <div class="fixed bottom-0 left-0 right-0 z-[101] bg-white rounded-t-3xl shadow-2xl modal-sheet">
    <div class="flex justify-center pt-3 pb-1"><div class="w-10 h-1 bg-zinc-200 rounded-full"></div></div>
    <div class="flex items-center gap-4 px-6 py-5 border-b border-zinc-100">
      ${u.profileImg ? `<div class="w-14 h-14 rounded-full bg-zinc-200 flex items-center justify-center border-2 border-black overflow-hidden"><img src="${u.profileImg}" class="w-full h-full object-cover"/></div>` :
        `<div class="w-14 h-14 rounded-full bg-zinc-200 flex items-center justify-center border-2 border-black"><span class="text-xl font-bold text-zinc-500">${(u.name||'?')[0]}</span></div>`}
      <div>
        <p class="font-bold text-base">${u.name}</p>
        <p class="text-sm text-zinc-400">${cell ? cell.name : 'ëª©ì¥ ë¯¸ë°°ì •'} Â· ${isAdmin?'ê´€ë¦¬ì':'ì²­ë…„ë¶€ì›'}</p>
      </div>
    </div>
    <div class="px-4 py-3 space-y-1">
      ${isAdmin ? `
      <button data-action="go-admin" class="w-full flex items-center gap-4 px-4 py-4 rounded-2xl active:bg-zinc-50 transition-colors text-left">
        <div class="w-10 h-10 bg-zinc-100 rounded-xl flex items-center justify-center">${icon('admin_panel_settings','text-black')}</div>
        <div class="flex-1"><p class="font-bold text-sm">ê´€ë¦¬ì í˜ì´ì§€</p><p class="text-xs text-zinc-400">ì£¼ë³´Â·ì°¬ì–‘Â·ê³µì§€Â·ì¶œì„Â·í—Œê¸ˆ ê´€ë¦¬</p></div>
        ${icon('chevron_right','text-zinc-300',20)}
      </button>` : ''}
      <button data-profile-page="edit" class="w-full flex items-center gap-4 px-4 py-4 rounded-2xl active:bg-zinc-50 transition-colors text-left">
        <div class="w-10 h-10 bg-zinc-100 rounded-xl flex items-center justify-center">${icon('person','text-black')}</div>
        <div class="flex-1"><p class="font-bold text-sm">í”„ë¡œí•„ ìˆ˜ì •</p><p class="text-xs text-zinc-400">ì‚¬ì§„, ëª©ì¥, ì—°ë½ì²˜, ìƒë…„ì›”ì¼</p></div>
        ${icon('chevron_right','text-zinc-300',20)}
      </button>
      <button data-profile-page="noti" class="w-full flex items-center gap-4 px-4 py-4 rounded-2xl active:bg-zinc-50 transition-colors text-left">
        <div class="w-10 h-10 bg-zinc-100 rounded-xl flex items-center justify-center">${icon('notifications','text-black')}</div>
        <div class="flex-1"><p class="font-bold text-sm">ì•Œë¦¼ ì„¤ì •</p><p class="text-xs text-zinc-400">ì°¬ì–‘Â·ê³µì§€Â·ë§ì”€Â·ì¼ì •Â·ë‹´ë‹¹ì</p></div>
        ${icon('chevron_right','text-zinc-300',20)}
      </button>
      <button data-profile-page="settings" class="w-full flex items-center gap-4 px-4 py-4 rounded-2xl active:bg-zinc-50 transition-colors text-left">
        <div class="w-10 h-10 bg-zinc-100 rounded-xl flex items-center justify-center">${icon('settings','text-black')}</div>
        <div class="flex-1"><p class="font-bold text-sm">ì„¤ì •</p><p class="text-xs text-zinc-400">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½, ê³„ì • ê´€ë¦¬</p></div>
        ${icon('chevron_right','text-zinc-300',20)}
      </button>
      <button data-action="logout" class="w-full flex items-center gap-4 px-4 py-4 rounded-2xl active:bg-red-50 transition-colors text-left">
        <div class="w-10 h-10 bg-red-50 rounded-xl flex items-center justify-center">${icon('logout','text-red-500')}</div>
        <p class="font-bold text-sm text-red-500">ë¡œê·¸ì•„ì›ƒ</p>
      </button>
    </div>
    <div class="h-8"></div>
  </div>`;
}

// ============================================================
// HOME TAB
// ============================================================
function renderHomeTab() {
  const bulletins = state.cache.bulletins;
  const worships = state.cache.worshipSets;
  const notices = state.cache.notices;
  const events = state.cache.events;
  const latest = worships[worships.length - 1];
  const lb = bulletins[bulletins.length - 1];

  const dutySection = lb ? `
  <section>
    <h2 class="text-lg font-bold tracking-tight mb-4">ê¸ˆì£¼ ì˜ˆë°° ë‹´ë‹¹</h2>
    <div class="bg-white rounded-2xl border border-zinc-100 overflow-hidden">
      <div class="bg-black px-5 py-3 flex items-center gap-2">
        ${icon('church','text-white',18)}
        <span class="text-white text-xs font-bold">${lb.date} ì˜ˆë°°</span>
      </div>
      <div class="divide-y divide-zinc-50">
        ${[
          {l:'ëŒ€í‘œê¸°ë„', v:lb.prayer_duty||'ë¯¸ì •', i:'volunteer_activism'},
          {l:'ì„±ê²½ë´‰ë…', v:lb.bible_reading||'ë¯¸ì •', i:'menu_book'},
          {l:'ì„±ë„ì˜ êµì œ', v:lb.announcement_duty||'ë¯¸ì •', i:'campaign'},
          {l:'ë´‰í—Œ', v:lb.offering_duty||'ë¯¸ì •', i:'favorite'},
        ].map(d => `
        <div class="flex items-center gap-3 px-5 py-4">
          <div class="w-8 h-8 bg-zinc-100 rounded-lg flex items-center justify-center flex-none">${icon(d.i,'text-zinc-600',16)}</div>
          <span class="text-xs text-zinc-400 w-20 flex-none">${d.l}</span>
          <span class="text-sm font-bold">${d.v}</span>
        </div>`).join('')}
      </div>
    </div>
  </section>` : `
  <section>
    <div class="bg-zinc-50 rounded-2xl p-6 text-center">
      <p class="text-sm text-zinc-400">ë“±ë¡ëœ ì£¼ë³´ê°€ ì—†ìŠµë‹ˆë‹¤</p>
    </div>
  </section>`;

  return `
  <section>
    <div class="bg-black rounded-3xl p-7 text-white relative overflow-hidden">
      <div class="relative z-10">
        <span class="px-2.5 py-1 bg-white/10 border border-white/20 rounded-lg text-[10px] font-bold uppercase tracking-wider">ì˜¤ëŠ˜ì˜ ë§ì”€</span>
        <blockquote class="text-xl font-bold leading-snug mt-5 mb-4">"ë‚´ê²Œ ëŠ¥ë ¥ ì£¼ì‹œëŠ” ì ì•ˆì—ì„œ<br/>ë‚´ê°€ ëª¨ë“  ê²ƒì„ í•  ìˆ˜ ìˆëŠë‹ˆë¼"</blockquote>
        <p class="text-zinc-400 text-sm">ë¹Œë¦½ë³´ì„œ 4:13</p>
      </div>
      <div class="absolute -right-10 -bottom-10 w-48 h-48 bg-white/5 rounded-full blur-3xl"></div>
      <div class="absolute -right-4 top-4 opacity-[0.06]">${icon('menu_book','text-white',120)}</div>
    </div>
  </section>
  ${dutySection}
  ${latest ? `
  <section>
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-base font-bold flex items-center gap-1.5">${icon('music_note','',18)} ì´ë²ˆì£¼ ì°¬ì–‘</h3>
      <button data-action="go-worship" class="text-zinc-400 text-xs font-bold">ì „ì²´ë³´ê¸°</button>
    </div>
    <div class="flex gap-3 overflow-x-auto pb-1 -mx-5 px-5 hide-scrollbar">
      ${latest.songs.map((s,i) => `
        <button data-action="go-worship" class="flex-none w-36 bg-white rounded-2xl border border-zinc-200 overflow-hidden active:bg-zinc-50 transition-colors text-left">
          <div class="w-full h-24 bg-zinc-100 flex items-center justify-center">${icon('graphic_eq','text-zinc-200',48)}</div>
          <div class="p-3">
            <p class="text-xs font-bold leading-tight truncate">${s.title}</p>
            <p class="text-[10px] text-zinc-400 mt-0.5">Key: ${s.key}</p>
          </div>
        </button>
      `).join('')}
    </div>
  </section>` : ''}
  <section>
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-base font-bold flex items-center gap-1.5">${icon('campaign','',18)} ê³µì§€ì‚¬í•­</h3>
      <button data-tab="notice" class="text-zinc-400 text-xs font-bold">ì „ì²´ë³´ê¸°</button>
    </div>
    <div class="space-y-3">
      ${notices.slice(0,3).map(n => `
        <button data-detail="notice:${n.id}" class="w-full flex items-start gap-3 bg-white p-4 rounded-2xl border border-zinc-100 active:bg-zinc-50 transition-colors text-left">
          <div class="w-8 h-8 ${n.pinned?'bg-black':'bg-zinc-100'} rounded-lg flex items-center justify-center flex-none mt-0.5">
            ${icon(n.pinned?'priority_high':'info','',16,false)}
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-bold leading-tight">${n.title}</p>
            <p class="text-xs text-zinc-400 mt-0.5 truncate">${n.body.split('\n')[0]}</p>
          </div>
          <span class="text-[10px] text-zinc-300 font-medium flex-none">${n.at.slice(5)}</span>
        </button>
      `).join('')}
    </div>
  </section>
  <section class="pb-4">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-base font-bold flex items-center gap-1.5">${icon('calendar_month','',18)} ë‹¤ê°€ì˜¤ëŠ” ì¼ì •</h3>
      <button data-tab="calendar" class="text-zinc-400 text-xs font-bold">ì „ì²´ë³´ê¸°</button>
    </div>
    <div class="space-y-3">
      ${events.slice(0,3).map(ev => {
        const d = new Date(ev.date); const m = d.getMonth()+1; const day = d.getDate();
        const isW = ev.cat === 'ì˜ˆë°°';
        return `
        <div class="flex items-center gap-4 bg-white p-4 rounded-2xl border border-zinc-100">
          <div class="w-12 h-12 ${isW?'bg-black':'bg-zinc-100'} rounded-xl flex flex-col items-center justify-center flex-none">
            <span class="text-[9px] font-black uppercase ${isW?'text-white/60':'text-zinc-400'}">${m}ì›”</span>
            <span class="text-lg font-bold leading-none ${isW?'text-white':'text-black'}">${day}</span>
          </div>
          <div class="flex-1">
            <span class="text-[10px] font-bold bg-zinc-100 text-zinc-500 px-1.5 py-0.5 rounded">${ev.cat}</span>
            <h4 class="font-bold text-sm text-black mt-0.5">${ev.title}</h4>
            ${(ev.loc||ev.time)?`<p class="text-xs text-zinc-400">${[ev.loc,ev.time].filter(Boolean).join(' Â· ')}</p>`:''}
          </div>
        </div>`;
      }).join('')}
    </div>
  </section>`;
}

// ============================================================
// BULLETIN TAB
// ============================================================
function renderBulletinTab() {
  const bulletins = [...state.cache.bulletins].reverse();
  return `
  <section>
    <h2 class="text-xl font-bold tracking-tight mb-6">ì£¼ë³´</h2>
    <div class="space-y-5">
      ${bulletins.map(b => `
        <button data-detail="bulletin:${b.id}" class="w-full text-left bg-white rounded-3xl border border-zinc-200 overflow-hidden active:bg-zinc-50 transition-colors">
          <div class="bg-gradient-to-br from-zinc-900 to-black p-6 text-white relative overflow-hidden dot-pattern">
            <div class="relative z-10">
              <div class="flex items-center gap-2 mb-3">
                <div class="w-8 h-8 bg-white/10 rounded-lg flex items-center justify-center">${icon('menu_book','text-white',18)}</div>
                <span class="text-[10px] font-bold uppercase tracking-wider text-white/60">ì£¼ì¼ ì˜ˆë°° ì£¼ë³´</span>
              </div>
              <h3 class="text-lg font-bold">${b.title}</h3>
              <p class="text-white/50 text-xs mt-1">${b.date}</p>
            </div>
          </div>
          <div class="p-4">
            <p class="text-xs text-zinc-400 line-clamp-2">${b.order?.split('\n').slice(0,2).join(' / ')}</p>
            <div class="flex items-center gap-1 mt-2 text-zinc-300">
              ${icon('chevron_right','',16)}<span class="text-[10px] font-bold">ìì„¸íˆ ë³´ê¸°</span>
            </div>
          </div>
        </button>
      `).join('')}
    </div>
  </section>`;
}

// ============================================================
// BULLETIN DETAIL
// ============================================================
function renderBulletinDetail() {
  const b = state.cache.bulletins.find(x => x.id === state.detail.id);
  if (!b) return '';
  const sections = [
    { i:'format_list_numbered', t:'ì˜ˆë°°ìˆœì„œ', c:b.order },
    { i:'volunteer_activism', t:'ëŒ€í‘œê¸°ë„', c:b.prayer_duty },
    { i:'menu_book', t:'ì„±ê²½ë´‰ë…', c:b.bible_reading },
    { i:'campaign', t:'ì„±ë„ì˜ êµì œ (ê´‘ê³ )', c:b.announcement_duty },
    { i:'favorite', t:'ë´‰í—Œ', c:b.offering_duty },
    { i:'music_note', t:'ì°¬ì–‘ê³¡ ëª©ë¡', c:b.songs },
    { i:'campaign', t:'ê´‘ê³  / ì•Œë¦¼', c:b.announce },
  ];
  return `
  <div class="min-h-screen bg-zinc-50 detail-page">
    <header class="sticky top-0 z-50 px-4 py-3 bg-white/90 backdrop-blur-xl border-b border-zinc-100 flex items-center gap-3">
      <button data-action="back" class="w-10 h-10 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('arrow_back','',22)}</button>
      <h1 class="font-bold text-sm flex-1">ì£¼ë³´</h1>
    </header>
    <div class="p-5">
      <div class="bg-white rounded-3xl overflow-hidden shadow-lg border border-zinc-100">
        <div class="bg-black text-white p-8 text-center relative overflow-hidden dot-pattern">
          <div class="relative z-10">
            <p class="text-[10px] font-bold uppercase tracking-[0.3em] text-white/50 mb-2">ì•½ì†ì˜ ë•… Â· ì£¼ì¼ì˜ˆë°°</p>
            <h2 class="text-2xl font-bold">${b.date}</h2>
            <div class="w-12 h-0.5 bg-white/20 mx-auto mt-4"></div>
          </div>
        </div>
        <div class="divide-y divide-zinc-100">
          ${sections.filter(s=>s.c).map(s => `
            <div class="p-6">
              <div class="flex items-center gap-2 mb-3">
                ${icon(s.i,'text-zinc-400',16)}
                <h3 class="text-xs font-bold uppercase tracking-wider text-zinc-400">${s.t}</h3>
              </div>
              <div class="text-sm leading-relaxed text-zinc-700 whitespace-pre-line">${s.c}</div>
            </div>
          `).join('')}
        </div>
        <div class="bg-zinc-50 p-6 text-center">
          <p class="text-[10px] text-zinc-300 font-bold uppercase tracking-[0.2em]">ì•½ì†ì˜ ë•… ì²­ë…„ë¶€</p>
        </div>
      </div>
    </div>
  </div>`;
}

// ============================================================
// NOTICE TAB
// ============================================================
function renderNoticeTab() {
  const notices = state.cache.notices;
  return `
  <section>
    <h2 class="text-xl font-bold tracking-tight mb-6">ê³µì§€ì‚¬í•­</h2>
    <div class="space-y-3">
      ${notices.map(n => `
        <button data-detail="notice:${n.id}" class="w-full flex items-start gap-3 bg-white p-5 rounded-2xl border border-zinc-100 active:bg-zinc-50 transition-colors text-left">
          <div class="w-9 h-9 ${n.pinned?'bg-black':'bg-zinc-100'} rounded-xl flex items-center justify-center flex-none">
            ${icon(n.pinned?'priority_high':'info','',16,false)}
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-bold">${n.title}</p>
            <p class="text-xs text-zinc-400 mt-1 line-clamp-2">${n.body.split('\n')[0]}</p>
            <p class="text-[10px] text-zinc-300 mt-1.5">${n.at}</p>
          </div>
        </button>
      `).join('')}
    </div>
  </section>`;
}

// ============================================================
// NOTICE DETAIL
// ============================================================
function renderNoticeDetail() {
  const n = state.cache.notices.find(x => x.id === state.detail.id);
  if (!n) return '';
  const comments = state.cache.comments[n.id] || [];
  return `
  <div class="min-h-screen bg-zinc-50 detail-page">
    <header class="sticky top-0 z-50 px-4 py-3 bg-white/90 backdrop-blur-xl border-b border-zinc-100 flex items-center gap-3">
      <button data-action="back" class="w-10 h-10 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('arrow_back','',22)}</button>
      <h1 class="font-bold text-sm flex-1">ê³µì§€ì‚¬í•­</h1>
    </header>
    <div class="p-5 space-y-4">
      <div class="bg-white rounded-2xl p-6 border border-zinc-100">
        ${n.pinned?'<span class="text-[10px] font-bold bg-red-50 text-red-500 px-2 py-1 rounded mb-3 inline-block">ğŸ“Œ ì¤‘ìš” ê³µì§€</span>':''}
        <h2 class="text-lg font-bold leading-snug mb-2">${n.title}</h2>
        <p class="text-[11px] text-zinc-400 mb-4">${n.at}</p>
        <p class="text-sm leading-relaxed text-zinc-700 whitespace-pre-line">${n.body}</p>
        ${n.images?.length ? `<div class="mt-4 space-y-2">${n.images.map(img=>`<img src="${img}" class="w-full rounded-xl"/>`).join('')}</div>` : ''}
      </div>
      <div class="bg-white rounded-2xl border border-zinc-100 overflow-hidden">
        <div class="px-5 py-4 border-b border-zinc-50"><p class="text-xs font-bold text-zinc-500">ëŒ“ê¸€ ${comments.length}</p></div>
        ${comments.map(c=>`
          <div class="px-5 py-3.5 border-b border-zinc-50 last:border-0">
            <div class="flex items-center gap-2 mb-1"><p class="text-xs font-bold">${c.name}</p><p class="text-[10px] text-zinc-300">${c.at}</p></div>
            <p class="text-sm text-zinc-600">${c.body}</p>
          </div>
        `).join('')}
        <div class="flex gap-2 p-3 border-t border-zinc-100">
          <input id="comment-input" placeholder="ëŒ“ê¸€ ì…ë ¥..." class="flex-1 px-3 py-2.5 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
          <button data-action="post-comment" data-notice-id="${n.id}" class="px-4 py-2.5 bg-black text-white rounded-xl text-xs font-bold">ì „ì†¡</button>
        </div>
      </div>
    </div>
  </div>`;
}

// ============================================================
// CALENDAR TAB
// ============================================================
function renderCalendarTab() {
  const events = state.cache.events;
  const vm = state._calMonth || { y: new Date().getFullYear(), m: new Date().getMonth() };
  const y = vm.y; const m = vm.m;
  const selDate = state._calSel || today();
  const firstDay = new Date(y, m, 1).getDay();
  const daysInMonth = new Date(y, m+1, 0).getDate();
  const dayLabels = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  let cells = '';
  for (let i=0; i<firstDay; i++) cells += '<div></div>';
  for (let d=1; d<=daysInMonth; d++) {
    const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isSel = ds === selDate;
    const hasEv = events.some(e=>e.date===ds);
    const isToday = ds === today();
    const dow = new Date(ds).getDay();
    const holiday = isHoliday(ds);
    let txtColor = '';
    if (isSel) txtColor = 'text-white';
    else if (dow === 0 || holiday) txtColor = 'text-red-500';
    else if (dow === 6) txtColor = 'text-blue-500';
    let bgColor = '';
    if (isSel) bgColor = 'bg-black';
    else if (isToday) bgColor = 'bg-zinc-100';
    cells += `<button data-cal-date="${ds}" class="relative w-full aspect-square flex items-center justify-center rounded-xl text-sm font-medium transition-colors ${bgColor} ${txtColor} active:opacity-70">${d}${hasEv&&!isSel?`<span class="absolute bottom-1 w-1 h-1 ${(dow===0||holiday)?'bg-red-400':dow===6?'bg-blue-400':'bg-black'} rounded-full"></span>`:''}</button>`;
  }

  const dayEvents = events.filter(e => e.date === selDate);
  const sd = new Date(selDate);

  return `
  <section>
    <h2 class="text-xl font-bold tracking-tight mb-6">ì¼ì •</h2>
    <div class="flex items-center justify-between mb-4">
      <button data-action="cal-prev" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('chevron_left','',20)}</button>
      <h3 class="font-bold text-sm">${y}ë…„ ${m+1}ì›”</h3>
      <button data-action="cal-next" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('chevron_right','',20)}</button>
    </div>
    <div class="grid grid-cols-7 gap-1 mb-2">
      ${dayLabels.map((d,i)=>`<div class="text-center text-[10px] font-bold ${i===0?'text-red-400':i===6?'text-blue-400':'text-zinc-400'}">${d}</div>`).join('')}
    </div>
    <div class="grid grid-cols-7 gap-1 mb-7">${cells}</div>
    <div>
      <h3 class="text-sm font-bold mb-3">${sd.getMonth()+1}ì›” ${sd.getDate()}ì¼ ì¼ì •</h3>
      ${dayEvents.length===0 ? '<p class="text-sm text-zinc-300 text-center py-8">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</p>' :
        `<div class="space-y-2">${dayEvents.map(ev=>`
          <div class="flex items-center gap-4 bg-zinc-50 p-4 rounded-2xl">
            <div class="w-1 h-10 bg-black rounded-full"></div>
            <div>
              <span class="text-[10px] font-bold bg-zinc-200 text-zinc-500 px-1.5 py-0.5 rounded">${ev.cat}</span>
              <h4 class="font-bold text-sm mt-0.5">${ev.title}</h4>
              ${(ev.loc||ev.time)?`<p class="text-xs text-zinc-400">${[ev.loc,ev.time].filter(Boolean).join(' Â· ')}</p>`:''}
            </div>
          </div>
        `).join('')}</div>`
      }
    </div>
  </section>`;
}

// ============================================================
// WORSHIP DETAIL
// ============================================================
function renderWorshipDetail() {
  const worships = state.cache.worshipSets;
  const w = worships[worships.length - 1];
  if (!w) return '';
  return `
  <div class="min-h-screen bg-white detail-page">
    <header class="sticky top-0 z-50 px-4 py-3 bg-white/90 backdrop-blur-xl border-b border-zinc-100 flex items-center gap-3">
      <button data-action="back" class="w-10 h-10 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('arrow_back','',22)}</button>
      <h1 class="font-bold text-sm flex-1">ì´ë²ˆì£¼ ì°¬ì–‘</h1>
    </header>
    <div class="p-5">
      <div class="bg-zinc-50 rounded-2xl p-5 mb-6">
        <p class="text-[10px] font-bold text-zinc-400 uppercase tracking-wider mb-1">ì„¸íŠ¸ ì •ë³´</p>
        <p class="text-sm font-bold mb-2">${w.date}</p>
        <div class="text-xs"><span class="text-zinc-400">ì¸ë„:</span> <span class="font-bold">${w.leader}</span></div>
      </div>
      <h3 class="text-sm font-bold mb-3">ê³¡ ëª©ë¡</h3>
      <div class="space-y-3">
        ${w.songs.map((s,i) => {
          const sheetValid = s.sheet && (!w.storedAt || (new Date() - new Date(w.storedAt)) < 30*24*60*60*1000);
          return `
          <div class="bg-white rounded-2xl border border-zinc-200 overflow-hidden">
            <div class="flex items-center gap-4 p-4">
              <div class="w-10 h-10 bg-black rounded-xl flex items-center justify-center flex-none">
                <span class="text-white font-bold text-sm">${i+1}</span>
              </div>
              <div class="flex-1 min-w-0">
                <h4 class="font-bold text-sm">${s.title}</h4>
                <p class="text-xs text-zinc-400">Key: ${s.key}</p>
              </div>
              <div class="flex items-center gap-2">
                ${s.url ? `<a href="${s.url}" target="_blank" class="w-9 h-9 bg-red-50 rounded-xl flex items-center justify-center">${icon('play_arrow','text-red-500',20)}</a>` : ''}
                ${sheetValid ? `<button data-sheet-toggle="${i}" class="w-9 h-9 bg-zinc-100 rounded-xl flex items-center justify-center">${icon('description','text-zinc-600',18)}</button>` : ''}
              </div>
            </div>
            ${sheetValid ? `<div id="sheet-panel-${i}" class="hidden border-t border-zinc-100"><img src="${s.sheet}" class="w-full" alt="ì•…ë³´"/></div>` : ''}
          </div>`;
        }).join('')}
      </div>
    </div>
  </div>`;
}

// ============================================================
// CELL TAB
// ============================================================
function renderCellTab() {
  const meetings = state.cache.cellMeetings;
  const latest = meetings[0];
  if (!latest) return `<div>
    <div class="pb-5 border-b border-zinc-100 mb-5"><h1 class="text-xl font-bold tracking-tight">ëª©ì¥ ëª¨ì„ ìë£Œ</h1></div>
    <div class="flex items-center justify-center py-16"><p class="text-sm text-zinc-400">ë“±ë¡ëœ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤</p></div>
  </div>`;
  const questions = latest.questions || [];
  return `<div>
    <div class="pb-5 border-b border-zinc-100 mb-6"><h1 class="text-xl font-bold tracking-tight">ëª©ì¥ ëª¨ì„ ìë£Œ</h1><p class="text-sm text-zinc-400 mt-0.5">${latest.date}</p></div>
    <div class="space-y-5">
      <div class="bg-zinc-900 text-white p-5 rounded-2xl">
        <p class="text-xs font-bold text-zinc-400 mb-1">ì˜¤ëŠ˜ì˜ ë§ì”€</p>
        <p class="text-base font-bold">${latest.verse||''}</p>
        ${latest.verseText?`<p class="text-sm text-zinc-300 mt-2 leading-relaxed italic">${latest.verseText}</p>`:''}
      </div>
      ${questions.length ? questions.map((q,qi)=>`
      <div class="bg-white p-5 rounded-2xl border border-zinc-100">
        <p class="text-xs font-bold text-zinc-400 mb-2">ë‚˜ëˆ” ì§ˆë¬¸ ${qi+1}</p>
        <p class="text-sm leading-relaxed font-medium">${q}</p>
      </div>`).join('') : ''}
      ${latest.prayerItems?`
      <div class="bg-gradient-to-br from-indigo-50 to-purple-50 p-5 rounded-2xl border border-indigo-100">
        <p class="text-xs font-bold text-indigo-400 mb-2">í•¨ê»˜ ê¸°ë„</p>
        <p class="text-sm leading-relaxed whitespace-pre-line text-indigo-900">${latest.prayerItems}</p>
      </div>`:''}
    </div>
  </div>`;
}

// ============================================================
// PROFILE PAGES
// ============================================================
function renderProfilePage() {
  const u = state.user;
  const cells = state.cache.cells;
  const pg = state.profilePage;
  const noti = u._noti || {worship:true,notice:true,verse:true,schedule:true,duty:true};

  const header = (title) => `<div class="sticky top-0 bg-white border-b border-zinc-100 px-5 py-4 flex items-center gap-3 z-10">
    <button data-action="close-profile-page" class="w-9 h-9 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('arrow_back','',22)}</button>
    <h1 class="font-bold text-base">${title}</h1>
  </div>`;

  if (pg === 'edit') {
    return `<div class="min-h-screen bg-zinc-50 slide-in-right">
      ${header('í”„ë¡œí•„ ìˆ˜ì •')}
      <div class="px-5 py-7 space-y-6">
        <div class="flex flex-col items-center gap-4">
          <div class="relative">
            <div class="w-24 h-24 rounded-full bg-zinc-200 border-2 border-black overflow-hidden">
              ${state._pendingProfileImg || u.profileImg ? `<img id="profile-preview-img" src="${state._pendingProfileImg||u.profileImg}" class="w-full h-full object-cover"/>` : `<span class="w-full h-full flex items-center justify-center text-2xl font-bold text-zinc-500">${(u.name||'?')[0]}</span>`}
            </div>
            <label class="absolute -bottom-1 -right-1 w-7 h-7 bg-black rounded-full flex items-center justify-center cursor-pointer">
              ${icon('photo_camera','text-white',14)}
              <input id="profile-img-input" type="file" accept="image/*" class="hidden"/>
            </label>
          </div>
          <p class="text-xs text-zinc-400">ì‚¬ì§„ì„ íƒ­í•˜ì—¬ ë³€ê²½</p>
        </div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì´ë¦„</label>
          <input id="edit-name" value="${u.name}" class="w-full px-4 py-3 bg-white border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
        </div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì „í™”ë²ˆí˜¸</label>
          <input id="edit-phone" value="${fmtPhone(u.phone||'')}" placeholder="010-0000-0000" inputmode="numeric" class="w-full px-4 py-3 bg-white border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
        </div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ìƒë…„ì›”ì¼</label>
          <input id="edit-birth" value="${fmtDate(u.birth||'')}" placeholder="1995.03.15" inputmode="numeric" class="w-full px-4 py-3 bg-white border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
        </div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ëª©ì¥</label>
          <select id="edit-cell" class="w-full px-4 py-3 bg-white border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black">
            <option value="">ë¯¸ë°°ì •</option>
            ${cells.map(c=>`<option value="${c.id}"${c.id===u.cellId?' selected':''}>${c.name}</option>`).join('')}
          </select>
        </div>
        <button id="save-profile-edit" class="w-full py-3.5 bg-black text-white rounded-xl text-sm font-bold transition-opacity active:opacity-70">ì €ì¥</button>
      </div>
    </div>`;
  }

  if (pg === 'noti') {
    const items = [
      {k:'worship',l:'ì°¬ì–‘ ì—…ë°ì´íŠ¸',d:'ìƒˆ ì°¬ì–‘ ì„¸íŠ¸ ë“±ë¡ ì‹œ'},
      {k:'notice',l:'ê³µì§€ì‚¬í•­',d:'ìƒˆ ê³µì§€ ë“±ë¡ ì‹œ'},
      {k:'verse',l:'ì˜¤ëŠ˜ì˜ ë§ì”€',d:'ë§¤ì¼ ë§ì”€ ì•Œë¦¼'},
      {k:'schedule',l:'ìƒˆ ì¼ì •',d:'ìƒˆ ì¼ì • ë“±ë¡ ì‹œ'},
      {k:'duty',l:'ë‹´ë‹¹ì ì§€ì •',d:'ì˜ˆë°° ë‹´ë‹¹ ë°°ì • ì‹œ'},
    ];
    return `<div class="min-h-screen bg-zinc-50 slide-in-right">
      ${header('ì•Œë¦¼ ì„¤ì •')}
      <div class="px-5 py-6">
        <div class="bg-white rounded-2xl border border-zinc-100 divide-y divide-zinc-50">
          ${items.map(it=>`
          <div class="flex items-center justify-between px-5 py-4">
            <div>
              <p class="text-sm font-bold">${it.l}</p>
              <p class="text-xs text-zinc-400 mt-0.5">${it.d}</p>
            </div>
            <button data-noti-toggle="${it.k}" class="relative w-12 h-6 rounded-full transition-colors ${noti[it.k]?'bg-black':'bg-zinc-200'}">
              <span class="absolute top-1 transition-all w-4 h-4 bg-white rounded-full shadow ${noti[it.k]?'left-7':'left-1'}"></span>
            </button>
          </div>`).join('')}
        </div>
      </div>
    </div>`;
  }

  if (pg === 'settings') {
    const canChangeId = !u.idChangedAt;
    return `<div class="min-h-screen bg-zinc-50 slide-in-right">
      ${header('ì„¤ì •')}
      <div class="px-5 py-6 space-y-4">
        <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ -->
        <div class="bg-white rounded-2xl border border-zinc-100 overflow-hidden">
          <button id="toggle-pw-section" class="w-full flex items-center justify-between px-5 py-4">
            <div class="flex items-center gap-3">${icon('lock','',20)}<span class="text-sm font-bold">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</span></div>
            ${icon('expand_more','text-zinc-400',20)}
          </button>
          <div id="pw-section" class="hidden border-t border-zinc-100 px-5 py-4 space-y-3">
            <input id="pw-current" type="password" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
            <input id="pw-new" type="password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
            <input id="pw-confirm" type="password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
            <button id="save-pw" class="w-full py-3 bg-black text-white rounded-xl text-sm font-bold">ë³€ê²½</button>
          </div>
        </div>
        <!-- ì•„ì´ë”” ë³€ê²½ (1íšŒ ê°€ëŠ¥) -->
        <div class="bg-white rounded-2xl border border-zinc-100 overflow-hidden">
          <button id="toggle-id-section" class="w-full flex items-center justify-between px-5 py-4">
            <div class="flex items-center gap-3">
              ${icon('badge','',20)}
              <div class="text-left">
                <span class="text-sm font-bold">ì•„ì´ë”” ë³€ê²½</span>
                ${!canChangeId?`<p class="text-[10px] text-zinc-400">ì´ë¯¸ ë³€ê²½í•˜ì…¨ìŠµë‹ˆë‹¤ (1íšŒ ì œí•œ)</p>`:`<p class="text-[10px] text-zinc-400">1íšŒë§Œ ë³€ê²½ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>`}
              </div>
            </div>
            ${canChangeId ? icon('expand_more','text-zinc-400',20) : icon('lock','text-zinc-300',18)}
          </button>
          ${canChangeId ? `<div id="id-section" class="hidden border-t border-zinc-100 px-5 py-4 space-y-3">
            <p class="text-xs text-zinc-500 bg-amber-50 border border-amber-100 rounded-lg px-3 py-2">ì•„ì´ë””ëŠ” 1íšŒë§Œ ë³€ê²½ ê°€ëŠ¥í•˜ë©°, ë³€ê²½ í›„ ì´ì „ ì•„ì´ë””ë¡œ ë¡œê·¸ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            <input id="id-pw-verify" type="password" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í™•ì¸" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
            <input id="id-new" placeholder="ìƒˆ ì•„ì´ë””" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
            <button id="save-id" class="w-full py-3 bg-black text-white rounded-xl text-sm font-bold">ë³€ê²½</button>
          </div>` : ''}
        </div>
        <!-- ì•± ë²„ì „ -->
        <div class="bg-white rounded-2xl border border-zinc-100 divide-y divide-zinc-50">
          <div class="flex items-center justify-between px-5 py-4">
            <span class="text-sm font-bold">ì•± ë²„ì „</span>
            <span class="text-sm text-zinc-400">v2.0.0</span>
          </div>
        </div>
        <!-- ê³„ì • íƒˆí‡´ -->
        <button id="withdraw-btn" class="w-full py-3.5 bg-red-50 text-red-500 rounded-xl text-sm font-bold border border-red-100 transition-opacity active:opacity-70">ê³„ì • íƒˆí‡´</button>
      </div>
    </div>`;
  }
  return '';
}

// ============================================================
// ADMIN PAGE
// ============================================================
function renderAdmin() {
  const menu = [
    { k:'approve', i:'how_to_reg', l:'ê°€ì… ìŠ¹ì¸', badge: state.cache.users.filter(u=>u.status==='pending').length },
    { k:'withdraw_approve', i:'person_remove', l:'íƒˆí‡´ ìŠ¹ì¸', badge: state.cache.users.filter(u=>u.status==='withdraw_pending').length },
    { k:'bulletin', i:'menu_book', l:'ì£¼ë³´ ê´€ë¦¬' },
    { k:'worship', i:'music_note', l:'ì°¬ì–‘ ê´€ë¦¬' },
    { k:'notice', i:'campaign', l:'ê³µì§€ ê´€ë¦¬' },
    { k:'event', i:'calendar_month', l:'ì¼ì • ê´€ë¦¬' },
    { k:'attendance', i:'fact_check', l:'ì¶œì„ ê´€ë¦¬' },
    { k:'offering', i:'volunteer_activism', l:'í—Œê¸ˆ ê¸°ë¡' },
    { k:'roster', i:'people', l:'ëª…ë¶€ ê´€ë¦¬' },
    { k:'cellmeet', i:'groups', l:'ëª©ì¥ ëª¨ì„ ìë£Œ' },
    { k:'cells', i:'dashboard', l:'ëª©ì¥ ê´€ë¦¬' },
    { k:'noti', i:'notifications', l:'ì•Œë¦¼ ë°œì†¡' },
  ];

  let content = '';
  if (state.adminSub === 'dashboard') {
    content = `<h2 class="text-lg font-bold mb-4">ê´€ë¦¬ ë©”ë‰´</h2><div class="space-y-3">${menu.map(m=>`
      <button data-admin="${m.k}" class="w-full flex items-center gap-4 bg-white p-4 rounded-2xl border border-zinc-100 active:bg-zinc-50 transition-colors text-left">
        <div class="w-10 h-10 bg-zinc-100 rounded-xl flex items-center justify-center">${icon(m.i,'text-black',20)}</div>
        <span class="flex-1 font-bold text-sm">${m.l}</span>
        ${m.badge>0?`<span class="bg-red-500 text-white text-[10px] font-bold w-5 h-5 rounded-full flex items-center justify-center">${m.badge}</span>`:''}
        ${icon('chevron_right','text-zinc-300',20)}
      </button>
    `).join('')}</div>`;
  } else {
    content = `<button data-admin="dashboard" class="flex items-center gap-1 text-xs text-zinc-400 font-bold mb-5">${icon('arrow_back','',16)} ë©”ë‰´ë¡œ</button>`;
    if (state.adminSub === 'approve') content += renderAdminApprove();
    else if (state.adminSub === 'withdraw_approve') content += renderAdminWithdrawApprove();
    else if (state.adminSub === 'bulletin') content += renderAdminBulletin();
    else if (state.adminSub === 'worship') content += renderAdminWorship();
    else if (state.adminSub === 'notice') content += renderAdminNotice();
    else if (state.adminSub === 'event') content += renderAdminEvent();
    else if (state.adminSub === 'attendance') content += renderAdminAttendance();
    else if (state.adminSub === 'offering') content += renderAdminOffering();
    else if (state.adminSub === 'roster') content += renderAdminRoster();
    else if (state.adminSub === 'cellmeet') content += renderAdminCellMeet();
    else if (state.adminSub === 'cells') content += renderAdminCells();
    else if (state.adminSub === 'noti') content += renderAdminNoti();
  }

  return `
  <div class="min-h-screen bg-zinc-50 fade-in">
    <header class="sticky top-0 z-50 px-4 py-3 bg-white/90 backdrop-blur-xl border-b border-zinc-100 flex items-center gap-3">
      <button data-action="back-main" class="w-10 h-10 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('arrow_back','',22)}</button>
      <h1 class="font-bold text-sm flex-1">ê´€ë¦¬ì</h1>
    </header>
    <div class="p-5">${content}</div>
  </div>`;
}

function renderAdminApprove() {
  const pending = state.cache.users.filter(u=>u.status==='pending');
  const rosters = state.cache.rosters;
  if (!pending.length) return '<h2 class="text-lg font-bold mb-4">ê°€ì… ìŠ¹ì¸</h2><p class="text-sm text-zinc-400 text-center py-10">ëŒ€ê¸° ì¤‘ì¸ ê°€ì… ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
  return `<h2 class="text-lg font-bold mb-4">ê°€ì… ìŠ¹ì¸</h2><div class="space-y-3">${pending.map(u=>{
    const match = rosters.find(r=>r.phone===u.phone);
    return `<div class="bg-white p-4 rounded-2xl border border-zinc-100">
      <div class="flex items-center justify-between mb-2">
        <div><p class="font-bold text-sm">${u.name}</p><p class="text-xs text-zinc-400">${fmtPhone(u.phone)} Â· ${fmtDate(u.birth)}</p></div>
        <button data-action="approve" data-uid="${u.uid}" class="px-4 py-2 bg-black text-white rounded-xl text-xs font-bold active:scale-95">ìŠ¹ì¸</button>
      </div>
      ${match?`<p class="text-[10px] text-emerald-600 bg-emerald-50 px-2 py-1 rounded inline-block">ğŸ“‹ ëª…ë¶€ ë§¤ì¹­: ${match.name}</p>`:''}
    </div>`;
  }).join('')}</div>`;
}

function renderAdminWithdrawApprove() {
  const pending = state.cache.users.filter(u=>u.status==='withdraw_pending');
  if (!pending.length) return '<h2 class="text-lg font-bold mb-4">íƒˆí‡´ ìŠ¹ì¸</h2><p class="text-sm text-zinc-400 text-center py-10">ëŒ€ê¸° ì¤‘ì¸ íƒˆí‡´ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
  return `<h2 class="text-lg font-bold mb-4">íƒˆí‡´ ìŠ¹ì¸</h2><div class="space-y-3">${pending.map(u=>`
    <div class="bg-white p-4 rounded-2xl border border-zinc-100">
      <div class="flex items-center justify-between">
        <div><p class="font-bold text-sm">${u.name}</p><p class="text-xs text-zinc-400">${u.id} Â· ${fmtPhone(u.phone)}</p>
          <p class="text-[10px] text-zinc-400 mt-0.5">íƒˆí‡´ ì‹ ì²­ì¼: ${u.withdrawAt||'-'}</p>
        </div>
        <button data-action="approve-withdraw" data-uid="${u.uid}" class="px-4 py-2 bg-red-500 text-white rounded-xl text-xs font-bold active:scale-95">íƒˆí‡´ ì²˜ë¦¬</button>
      </div>
    </div>
  `).join('')}</div>`;
}

function adminInput(id, label, ph, type='text') {
  return `<div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">${label}</label><input id="${id}" type="${type}" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="${ph}"/></div>`;
}
function adminTextarea(id, label, ph, rows=4) {
  return `<div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">${label}</label><textarea id="${id}" rows="${rows}" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black resize-none" placeholder="${ph}"></textarea></div>`;
}

function renderAdminBulletin() {
  const list = [...state.cache.bulletins].reverse();
  return `<h2 class="text-lg font-bold mb-4">ì£¼ë³´ ê´€ë¦¬</h2>
  <div id="admin-form-area">
    <button data-action="show-bulletin-form" class="w-full py-3 border-2 border-dashed border-zinc-200 rounded-2xl text-sm font-bold text-zinc-400 mb-4">+ ìƒˆ ì£¼ë³´</button>
    <div class="space-y-2">${list.map(b=>`<div class="bg-white p-4 rounded-2xl border border-zinc-100 flex items-center justify-between">
      <div><p class="font-bold text-sm">${b.title}</p><p class="text-xs text-zinc-400">${b.date}</p></div>
      <div class="flex gap-1">
        <button data-action="edit-bulletin" data-bid="${b.id}" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('edit','text-zinc-400',18)}</button>
        <button data-action="del-bulletin" data-bid="${b.id}" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-red-50">${icon('delete','text-red-400',18)}</button>
      </div>
    </div>`).join('')}</div>
  </div>`;
}

function renderAdminWorship() {
  const list = [...state.cache.worshipSets].reverse();
  return `<h2 class="text-lg font-bold mb-4">ì°¬ì–‘ ê´€ë¦¬</h2>
  <div id="admin-form-area">
    <button data-action="show-worship-form" class="w-full py-3 border-2 border-dashed border-zinc-200 rounded-2xl text-sm font-bold text-zinc-400 mb-4">+ ìƒˆ ì„¸íŠ¸</button>
    <div class="space-y-2">${list.map(w=>`<div class="bg-white p-4 rounded-2xl border border-zinc-100 flex items-center justify-between">
      <div><p class="font-bold text-sm">${w.date} ì°¬ì–‘ ì„¸íŠ¸</p><p class="text-xs text-zinc-400">ì¸ë„: ${w.leader} Â· ${w.songs.length}ê³¡</p></div>
      <div class="flex gap-1">
        <button data-action="edit-worship" data-wid="${w.id}" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('edit','text-zinc-400',18)}</button>
        <button data-action="del-worship" data-wid="${w.id}" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-red-50">${icon('delete','text-red-400',18)}</button>
      </div>
    </div>`).join('')}</div>
  </div>`;
}

function renderAdminNotice() {
  const list = [...state.cache.notices];
  return `<h2 class="text-lg font-bold mb-4">ê³µì§€ ê´€ë¦¬</h2>
  <div id="admin-form-area">
    <button data-action="show-notice-form" class="w-full py-3 border-2 border-dashed border-zinc-200 rounded-2xl text-sm font-bold text-zinc-400 mb-4">+ ìƒˆ ê³µì§€</button>
    <div class="space-y-2">${list.map(n=>`<div class="bg-white p-4 rounded-2xl border border-zinc-100 flex items-center justify-between">
      <div>${n.pinned?'<span class="text-[9px] font-bold bg-red-50 text-red-500 px-1.5 py-0.5 rounded mr-1">ì¤‘ìš”</span>':''}<span class="font-bold text-sm">${n.title}</span><p class="text-xs text-zinc-400">${n.at}</p></div>
      <div class="flex gap-1">
        <button data-action="edit-notice" data-nid="${n.id}" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('edit','text-zinc-400',18)}</button>
        <button data-action="del-notice" data-nid="${n.id}" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-red-50">${icon('delete','text-red-400',18)}</button>
      </div>
    </div>`).join('')}</div>
  </div>`;
}

function renderAdminEvent() {
  const list = state.cache.events;
  return `<h2 class="text-lg font-bold mb-4">ì¼ì • ê´€ë¦¬</h2>
  <div id="admin-form-area">
    <button data-action="show-event-form" class="w-full py-3 border-2 border-dashed border-zinc-200 rounded-2xl text-sm font-bold text-zinc-400 mb-4">+ ìƒˆ ì¼ì •</button>
    <div class="space-y-2">${list.map(e=>`<div class="bg-white p-4 rounded-2xl border border-zinc-100 flex items-center justify-between">
      <div><p class="font-bold text-sm">${e.title}</p><p class="text-xs text-zinc-400">${e.date} ${e.time} Â· ${e.cat}</p></div>
      <div class="flex gap-1">
        <button data-action="edit-event" data-eid="${e.id}" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('edit','text-zinc-400',18)}</button>
        <button data-action="del-event" data-eid="${e.id}" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-red-50">${icon('delete','text-red-400',18)}</button>
      </div>
    </div>`).join('')}</div>
  </div>`;
}

function renderAdminAttendance() {
  const rosters = state.cache.rosters;
  const cells = state.cache.cells;
  const att = state.cache.attendance;
  const d = state._attDate || today();
  const marks = att[d]?.marks || {};
  const activeTab = state.adminAttTab || 'all';
  const filtered = activeTab === 'all' ? rosters : rosters.filter(r=>r.cellId === activeTab);
  const present = filtered.filter(r=>marks[r.id]).length;
  const tabs = [{id:'all',name:'ì „ì²´'},...cells.map(c=>({id:c.id,name:c.name}))];
  return `<h2 class="text-lg font-bold mb-4">ì¶œì„ ê´€ë¦¬</h2>
  ${adminInput('att-date','ì˜ˆë°°ì¼',today())}
  <div class="flex gap-2 mt-3 overflow-x-auto hide-scrollbar pb-1">
    ${tabs.map(t=>`<button data-att-tab="${t.id}" class="flex-none px-3 py-1.5 rounded-full text-xs font-bold border transition-colors ${activeTab===t.id?'bg-black text-white border-black':'bg-white text-zinc-500 border-zinc-200'}">${t.name}</button>`).join('')}
  </div>
  <div class="flex items-center justify-between my-3">
    <p class="text-sm text-zinc-400">ì¶œì„: <span class="font-bold text-black">${present}</span> / ${filtered.length}</p>
    <button data-action="save-attendance" class="px-4 py-2 bg-black text-white rounded-xl text-xs font-bold active:scale-95">ì €ì¥</button>
  </div>
  <div class="space-y-1">${filtered.map(r=>{
    const cellName = cells.find(c=>c.id===r.cellId)?.name||'ë¯¸ë°°ì •';
    return `
    <button data-action="toggle-att" data-rid="${r.id}" class="w-full flex items-center gap-3 p-3 rounded-xl transition-colors ${marks[r.id]?'bg-emerald-50 border border-emerald-200':'bg-white border border-zinc-100'}">
      <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${marks[r.id]?'bg-emerald-500 border-emerald-500':'border-zinc-300'}">
        ${marks[r.id]?icon('check','text-white',14):''}
      </div>
      <div class="flex-1 text-left">
        <span class="text-sm font-medium">${r.name}</span>
        ${activeTab==='all'?`<span class="text-[10px] text-zinc-400 ml-2">${cellName}</span>`:''}
      </div>
    </button>`;
  }).join('')}</div>`;
}

function renderAdminOffering() {
  const rosters = state.cache.rosters;
  const offerings = state.cache.offerings;
  const d = state._offDate || today();
  const weekData = offerings[d] || { items:[] };
  const total = (weekData.items||[]).reduce((s,i)=>s+i.amount,0);
  return `<h2 class="text-lg font-bold mb-4">í—Œê¸ˆ ê¸°ë¡</h2>
  ${adminInput('off-date','ì£¼ì°¨',today())}
  <div class="mt-4 bg-white p-4 rounded-2xl border border-zinc-100 space-y-3">
    <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì´ë¦„</label>
      <select id="off-person" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black">
        <option value="">ì„ íƒ</option>${rosters.map(r=>`<option value="${r.id}">${r.name}</option>`).join('')}
      </select>
    </div>
    <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">í•­ëª©</label>
      <select id="off-type" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black">
        ${['ì£¼ì •','ì‹­ì¼ì¡°','ê°ì‚¬','ê¸°íƒ€'].map(t=>`<option value="${t}">${t}</option>`).join('')}
      </select>
    </div>
    ${adminInput('off-amount','ê¸ˆì•¡','10000')}
    <button data-action="add-offering" class="w-full py-3 bg-black text-white rounded-xl text-sm font-bold active:opacity-70">ì¶”ê°€</button>
  </div>
  <div class="mt-4 bg-zinc-900 text-white p-4 rounded-2xl">
    <p class="text-xs text-zinc-400">ì´ë²ˆ ì£¼ ì´ì•¡</p>
    <p class="text-2xl font-bold">${fmtAmt(total)}ì›</p>
  </div>
  ${(weekData.items||[]).length?`<div class="mt-3 space-y-1">${(weekData.items||[]).map((it,idx)=>`
    <div class="bg-white p-3 rounded-xl border border-zinc-100 flex items-center justify-between">
      <div><span class="text-sm font-bold">${it.name}</span><span class="text-xs text-zinc-400 ml-2">${it.type}</span></div>
      <div class="flex items-center gap-2">
        <span class="text-sm font-bold">${fmtAmt(it.amount)}ì›</span>
        <button data-action="del-offering" data-date="${d}" data-idx="${idx}" class="w-7 h-7 flex items-center justify-center rounded-full active:bg-red-50">${icon('delete','text-red-400',16)}</button>
      </div>
    </div>
  `).join('')}</div>`:''}`;
}

function renderAdminRoster() {
  const rosters = state.cache.rosters;
  const cells = state.cache.cells;
  const users = state.cache.users;
  const activeTab = state.adminRosterTab || 'all';
  const filtered = activeTab === 'all' ? rosters : rosters.filter(r=>r.cellId===activeTab);
  const tabs = [{id:'all',name:'ì „ì²´'},...cells.map(c=>({id:c.id,name:c.name}))];

  return `<h2 class="text-lg font-bold mb-4">ëª…ë¶€ ê´€ë¦¬</h2>
  <div class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar pb-1">
    ${tabs.map(t=>`<button data-roster-tab="${t.id}" class="flex-none px-3 py-1.5 rounded-full text-xs font-bold border transition-colors ${activeTab===t.id?'bg-black text-white border-black':'bg-white text-zinc-500 border-zinc-200'}">${t.name}</button>`).join('')}
  </div>
  <button data-action="show-roster-form" class="w-full py-3 border-2 border-dashed border-zinc-200 rounded-2xl text-sm font-bold text-zinc-400 mb-3">+ ëª…ë¶€ ì¶”ê°€</button>
  <div id="roster-form-area"></div>
  <div class="space-y-2">${filtered.map(r=>{
    const cell = cells.find(c=>c.id===r.cellId);
    const linkedUser = r.linkedUid ? users.find(u=>u.uid===r.linkedUid) : null;
    const isAdminR = linkedUser?.role === 'admin';
    return `
    <div id="roster-card-${r.id}" class="relative bg-white p-4 rounded-2xl border border-zinc-100 flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-zinc-900 flex items-center justify-center flex-none">
        <span class="text-white font-bold text-sm">${r.name[0]}</span>
      </div>
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-1.5">
          <p class="font-bold text-sm">${r.name}</p>
          ${isAdminR?`<span class="text-[9px] font-bold bg-black text-white px-1.5 py-0.5 rounded">ê´€ë¦¬ì</span>`:''}
        </div>
        <p class="text-xs text-zinc-400">${fmtPhone(r.phone)} Â· ${cell?.name||'ë¯¸ë°°ì •'}</p>
      </div>
      <button data-action="roster-menu" data-rid="${r.id}" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-zinc-100 active:bg-zinc-100 flex-none">
        ${icon('more_vert','text-zinc-400',20)}
      </button>
      <div id="roster-dd-${r.id}" class="hidden absolute right-2 top-12 z-50 bg-white border border-zinc-200 rounded-2xl shadow-lg overflow-hidden w-44">
        <button data-action="roster-edit" data-rid="${r.id}" class="w-full flex items-center gap-2.5 px-4 py-3 text-sm font-medium hover:bg-zinc-50 text-left">${icon('edit','text-zinc-500',16)} ì •ë³´ ë³€ê²½</button>
        <button data-action="roster-grant" data-rid="${r.id}" class="w-full flex items-center gap-2.5 px-4 py-3 text-sm font-medium hover:bg-zinc-50 text-left">${icon('shield','text-zinc-500',16)} ${isAdminR?'ê´€ë¦¬ì í•´ì œ':'ê´€ë¦¬ì ë¶€ì—¬'}</button>
        <button data-action="roster-delete" data-rid="${r.id}" class="w-full flex items-center gap-2.5 px-4 py-3 text-sm font-medium text-red-500 hover:bg-red-50 text-left">${icon('delete','text-red-500',16)} íƒˆí‡´ ì²˜ë¦¬</button>
      </div>
    </div>`;
  }).join('')}</div>`;
}

function renderAdminCells() {
  const cells = state.cache.cells;
  return `<h2 class="text-lg font-bold mb-4">ëª©ì¥ ê´€ë¦¬</h2>
  <button data-action="show-cell-form" class="w-full py-3 border-2 border-dashed border-zinc-200 rounded-2xl text-sm font-bold text-zinc-400 mb-3">+ ëª©ì¥ ì¶”ê°€</button>
  <div id="cell-form-area"></div>
  <div class="space-y-2">${cells.map(c=>`
    <div class="bg-white p-4 rounded-2xl border border-zinc-100">
      <div class="flex items-center justify-between">
        <div><p class="font-bold text-sm">${c.name}</p><p class="text-xs text-zinc-400">ëª©ì: ${c.leader}</p></div>
        <div class="flex gap-2">
          <button data-action="cell-edit" data-cid="${c.id}" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('edit','text-zinc-400',18)}</button>
          <button data-action="cell-delete" data-cid="${c.id}" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-red-50">${icon('delete','text-red-400',18)}</button>
        </div>
      </div>
      <div id="cell-edit-area-${c.id}" class="hidden mt-3 space-y-2">
        <input id="cell-name-${c.id}" value="${c.name}" placeholder="ëª©ì¥ ì´ë¦„" class="w-full px-3 py-2 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
        <input id="cell-leader-${c.id}" value="${c.leader}" placeholder="ëª©ì ì´ë¦„" class="w-full px-3 py-2 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
        <button data-action="cell-save" data-cid="${c.id}" class="w-full py-2 bg-black text-white rounded-xl text-xs font-bold">ì €ì¥</button>
      </div>
    </div>
  `).join('')}</div>`;
}

function renderAdminCellMeet() {
  const meetings = state.cache.cellMeetings;
  return `<h2 class="text-lg font-bold mb-4">ëª©ì¥ ëª¨ì„ ìë£Œ</h2>
  <button data-action="show-cellmeet-form" class="w-full py-3 border-2 border-dashed border-zinc-200 rounded-2xl text-sm font-bold text-zinc-400 mb-3">+ ìë£Œ ì¶”ê°€</button>
  <div id="admin-form-area"></div>
  <div class="space-y-3">${meetings.map(m=>`
    <div class="bg-white p-4 rounded-2xl border border-zinc-100">
      <div class="flex items-start justify-between mb-2">
        <div>
          <p class="font-bold text-sm">${m.date}</p>
          <p class="text-xs text-zinc-500 mt-0.5">${m.verse||''}</p>
        </div>
        <div class="flex gap-1">
          <button data-action="edit-cellmeet" data-mid="${m.id}" class="w-7 h-7 flex items-center justify-center rounded-full hover:bg-zinc-100">${icon('edit','text-zinc-400',16)}</button>
          <button data-action="del-cellmeet" data-mid="${m.id}" class="w-7 h-7 flex items-center justify-center rounded-full hover:bg-red-50">${icon('delete','text-zinc-300',16)}</button>
        </div>
      </div>
      ${(m.questions||[]).length ? `<p class="text-xs text-zinc-400 line-clamp-2">ì§ˆë¬¸ ${(m.questions||[]).length}ê°œ</p>` : ''}
    </div>
  `).join('')}</div>`;
}

function renderAdminNoti() {
  return `<h2 class="text-lg font-bold mb-4">ì•Œë¦¼ ë°œì†¡</h2>
  <div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100">
    ${adminInput('noti-title','ì œëª©','ì•Œë¦¼ ì œëª©')}
    ${adminTextarea('noti-body','ë‚´ìš©','ì•Œë¦¼ ë‚´ìš©')}
    <button data-action="send-noti" class="w-full py-3 bg-black text-white rounded-xl text-sm font-bold active:opacity-70">ì „ì²´ ë°œì†¡</button>
  </div>`;
}

// ============================================================
// EVENT BINDING
// ============================================================
function bindEvents() {
  // â”€â”€ Confirm modal â”€â”€
  document.getElementById('confirm-no')?.addEventListener('click', () => { state._confirmModal = null; render(); });
  document.getElementById('confirm-yes')?.addEventListener('click', () => {
    const cb = state._confirmModal?.onYes;
    state._confirmModal = null;
    if (cb) cb();
  });

  // â”€â”€ Login â”€â”€
  const doLogin = async () => {
    const id = document.getElementById('login-id')?.value?.trim();
    const pw = document.getElementById('login-pw')?.value;
    const errEl = document.getElementById('login-error');
    const btnEl = document.getElementById('btn-login');
    if (!id || !pw) { errEl.textContent='ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'; errEl.classList.remove('hidden'); return; }

    // ë¡œë”© í‘œì‹œ
    if (btnEl) { btnEl.textContent='ë¡œê·¸ì¸ ì¤‘...'; btnEl.disabled=true; }
    errEl.classList.add('hidden');

    try {
      // Firestoreì—ì„œ ì§ì ‘ ì¡°íšŒ (ìºì‹œ ì˜ì¡´ X)
      const allUsers = await window.FDB.getCol('users');
      const u = allUsers.find(x => x.id === id && x.pw === pw);

      if (!u) { errEl.textContent='ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.'; errEl.classList.remove('hidden'); return; }
      if (u.status === 'pending') { errEl.textContent='ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.'; errEl.classList.remove('hidden'); return; }
      if (u.status === 'withdraw_pending') { errEl.textContent='íƒˆí‡´ ì‹ ì²­ ì¤‘ì¸ ê³„ì •ì…ë‹ˆë‹¤.'; errEl.classList.remove('hidden'); return; }

      state.user = u;
      state.page = 'main';
      SESSION.set(u);
      await loadAll();
      render();
    } catch(e) {
      console.error('login error', e);
      errEl.textContent='ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
      errEl.classList.remove('hidden');
    } finally {
      if (btnEl) { btnEl.textContent='ë¡œê·¸ì¸'; btnEl.disabled=false; }
    }
  };
  document.getElementById('btn-login')?.addEventListener('click', doLogin);
  document.getElementById('login-pw')?.addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });

  // â”€â”€ Register â”€â”€
  document.getElementById('btn-go-register')?.addEventListener('click', () => { state.page='register'; render(); });
  document.getElementById('btn-back-login')?.addEventListener('click', () => { state.page='login'; render(); });
  document.getElementById('reg-phone')?.addEventListener('input', function() { this.value = fmtPhone(this.value); });
  document.getElementById('reg-birth')?.addEventListener('input', function() {
    const d = this.value.replace(/\D/g,'');
    if(d.length<=4) this.value=d;
    else if(d.length<=6) this.value=d.slice(0,4)+'.'+d.slice(4);
    else this.value=d.slice(0,4)+'.'+d.slice(4,6)+'.'+d.slice(6,8);
  });
  document.getElementById('btn-register')?.addEventListener('click', async () => {
    const g = id => document.getElementById(id)?.value || '';
    const name=g('reg-name'), rawPhone=g('reg-phone'), birth=g('reg-birth').replace(/\D/g,''), id=g('reg-id'), pw=g('reg-pw'), pw2=g('reg-pw2');
    const agree = document.getElementById('reg-agree')?.checked;
    const errEl = document.getElementById('reg-error');
    const showErr = msg => { errEl.textContent=msg; errEl.classList.remove('hidden'); };
    if (!name||!rawPhone||!birth||!id||!pw) return showErr('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    if (pw!==pw2) return showErr('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    if (pw.length<4) return showErr('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
    if (!agree) return showErr('ê°œì¸ì •ë³´ ìˆ˜ì§‘ì— ë™ì˜í•´ì£¼ì„¸ìš”.');
    if (!/^\d{8}$/.test(birth)) return showErr('ìƒë…„ì›”ì¼ì€ 8ìë¦¬ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    const phone = fmtPhone(rawPhone);
    if (state.cache.users.find(u=>u.id===id)) return showErr('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.');
    if (state.cache.users.find(u=>u.phone===phone)) return showErr('ì´ë¯¸ ë“±ë¡ëœ ì „í™”ë²ˆí˜¸ì…ë‹ˆë‹¤.');
    const newUid = uid();
    const newUser = { uid:newUid, id, pw, name, phone, birth, cellId:'', role:'user', status:'pending', createdAt:today(), profileImg:'', idChangedAt:null };
    await window.FDB.setDoc('users', newUid, newUser);
    state.cache.users.push(newUser);
    showToast('ê°€ì… ì‹ ì²­ ì™„ë£Œ! ê´€ë¦¬ì ìŠ¹ì¸ í›„ ë¡œê·¸ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    state.page='login'; render();
  });

  // â”€â”€ Tabs â”€â”€
  document.querySelectorAll('[data-tab]').forEach(el => {
    el.addEventListener('click', () => { state.tab=el.dataset.tab; state.detail=null; render(); });
  });

  // â”€â”€ Profile â”€â”€
  document.querySelector('[data-action="open-profile"]')?.addEventListener('click', () => { state.profileOpen=true; render(); });
  document.querySelector('[data-action="close-profile"]')?.addEventListener('click', () => { state.profileOpen=false; render(); });
  document.querySelector('[data-action="logout"]')?.addEventListener('click', () => {
    state.user=null; state.page='login'; state.profileOpen=false; SESSION.clear(); render();
  });
  document.querySelector('[data-action="go-admin"]')?.addEventListener('click', () => {
    state.page='admin'; state.adminSub='dashboard'; state.profileOpen=false; render();
  });
  document.querySelectorAll('[data-profile-page]').forEach(el => {
    el.addEventListener('click', () => { state.profilePage=el.dataset.profilePage; state.profileOpen=false; render(); });
  });
  document.querySelector('[data-action="close-profile-page"]')?.addEventListener('click', () => { state.profilePage=null; render(); });

  // â”€â”€ Back â”€â”€
  document.querySelectorAll('[data-action="back"]').forEach(el => {
    el.addEventListener('click', () => { state.detail=null; render(); });
  });
  document.querySelector('[data-action="back-main"]')?.addEventListener('click', () => { state.page='main'; state.tab='home'; render(); });

  // â”€â”€ Details â”€â”€
  document.querySelectorAll('[data-detail]').forEach(el => {
    el.addEventListener('click', async () => {
      const [type, id] = el.dataset.detail.split(':');
      state.detail = { type, id };
      // Load comments for notice
      if (type === 'notice') {
        const snap = await window.FDB.getCol(`notices/${id}/comments`).catch(()=>[]);
        state.cache.comments[id] = snap.sort((a,b)=>(a.at||'').localeCompare(b.at||''));
      }
      render();
    });
  });

  // â”€â”€ Worship â”€â”€
  document.querySelectorAll('[data-action="go-worship"]').forEach(el => {
    el.addEventListener('click', () => { state.detail={type:'worship',id:'latest'}; render(); });
  });

  // â”€â”€ Sheet toggle â”€â”€
  document.querySelectorAll('[data-sheet-toggle]').forEach(el => {
    el.addEventListener('click', () => {
      const panel = document.getElementById('sheet-panel-'+el.dataset.sheetToggle);
      if (panel) panel.classList.toggle('hidden');
    });
  });

  // â”€â”€ Comment â”€â”€
  document.querySelector('[data-action="post-comment"]')?.addEventListener('click', async function() {
    const input = document.getElementById('comment-input');
    if (!input?.value.trim()) return;
    const nid = this.dataset.noticeId;
    const comment = { id:uid(), uid:state.user.uid, name:state.user.name, body:input.value.trim(), at:today() };
    await window.FDB.addDoc(`notices/${nid}/comments`, comment);
    if (!state.cache.comments[nid]) state.cache.comments[nid]=[];
    state.cache.comments[nid].push(comment);
    input.value=''; render();
  });
  document.getElementById('comment-input')?.addEventListener('keydown', e => {
    if(e.key==='Enter') document.querySelector('[data-action="post-comment"]')?.click();
  });

  // â”€â”€ Calendar â”€â”€
  document.querySelectorAll('[data-cal-date]').forEach(el => {
    el.addEventListener('click', () => { state._calSel=el.dataset.calDate; render(); });
  });
  document.querySelector('[data-action="cal-prev"]')?.addEventListener('click', () => {
    const vm = state._calMonth || { y:new Date().getFullYear(), m:new Date().getMonth() };
    vm.m--; if(vm.m<0){vm.m=11;vm.y--;}
    state._calMonth={...vm}; render();
  });
  document.querySelector('[data-action="cal-next"]')?.addEventListener('click', () => {
    const vm = state._calMonth || { y:new Date().getFullYear(), m:new Date().getMonth() };
    vm.m++; if(vm.m>11){vm.m=0;vm.y++;}
    state._calMonth={...vm}; render();
  });

  // â”€â”€ Admin nav â”€â”€
  document.querySelectorAll('[data-admin]').forEach(el => {
    el.addEventListener('click', () => { state.adminSub=el.dataset.admin; render(); });
  });

  // â”€â”€ Admin: Approve â”€â”€
  document.querySelectorAll('[data-action="approve"]').forEach(el => {
    el.addEventListener('click', async () => {
      const targetUid = el.dataset.uid;
      await window.FDB.setDoc('users', targetUid, { status:'active' });
      const u = state.cache.users.find(x=>x.uid===targetUid);
      if (u) u.status='active';
      showToast('ìŠ¹ì¸ ì™„ë£Œ!'); render();
    });
  });

  // â”€â”€ Admin: Approve withdraw â”€â”€
  document.querySelectorAll('[data-action="approve-withdraw"]').forEach(el => {
    el.addEventListener('click', () => {
      const targetUid = el.dataset.uid;
      showConfirm('ì •ë§ íƒˆí‡´ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async () => {
        await window.FDB.deleteDoc('users', targetUid);
        state.cache.users = state.cache.users.filter(u=>u.uid!==targetUid);
        showToast('íƒˆí‡´ ì²˜ë¦¬ ì™„ë£Œ!'); render();
      }, 'íƒˆí‡´ ì²˜ë¦¬');
    });
  });

  // â”€â”€ Admin: Delete items â”€â”€
  document.querySelectorAll('[data-action="del-notice"]').forEach(el => {
    el.addEventListener('click', () => {
      showConfirm('ê³µì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async () => {
        await window.FDB.deleteDoc('notices', el.dataset.nid);
        state.cache.notices = state.cache.notices.filter(n=>n.id!==el.dataset.nid);
        render();
      });
    });
  });
  document.querySelectorAll('[data-action="del-event"]').forEach(el => {
    el.addEventListener('click', () => {
      showConfirm('ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async () => {
        await window.FDB.deleteDoc('events', el.dataset.eid);
        state.cache.events = state.cache.events.filter(e=>e.id!==el.dataset.eid);
        render();
      });
    });
  });
  document.querySelectorAll('[data-action="del-bulletin"]').forEach(el => {
    el.addEventListener('click', () => {
      showConfirm('ì£¼ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async () => {
        await window.FDB.deleteDoc('bulletins', el.dataset.bid);
        state.cache.bulletins = state.cache.bulletins.filter(b=>b.id!==el.dataset.bid);
        render();
      });
    });
  });
  document.querySelectorAll('[data-action="del-worship"]').forEach(el => {
    el.addEventListener('click', () => {
      showConfirm('ì°¬ì–‘ ì„¸íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async () => {
        await window.FDB.deleteDoc('worshipSets', el.dataset.wid);
        state.cache.worshipSets = state.cache.worshipSets.filter(w=>w.id!==el.dataset.wid);
        render();
      });
    });
  });
  document.querySelectorAll('[data-action="del-cellmeet"]').forEach(el => {
    el.addEventListener('click', () => {
      showConfirm('ëª©ì¥ ëª¨ì„ ìë£Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async () => {
        await window.FDB.deleteDoc('cellMeetings', el.dataset.mid);
        state.cache.cellMeetings = state.cache.cellMeetings.filter(m=>m.id!==el.dataset.mid);
        render();
      });
    });
  });
  document.querySelectorAll('[data-action="del-offering"]').forEach(el => {
    el.addEventListener('click', () => {
      showConfirm('í—Œê¸ˆ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async () => {
        const d = el.dataset.date; const idx = parseInt(el.dataset.idx);
        const offerings = state.cache.offerings;
        if (offerings[d]) { offerings[d].items.splice(idx,1); await window.FDB.setDoc('offering', d, offerings[d]); }
        state._offDate=d; render();
      });
    });
  });

  // â”€â”€ Admin: Attendance â”€â”€
  document.querySelectorAll('[data-action="toggle-att"]').forEach(el => {
    el.addEventListener('click', () => {
      const d = document.getElementById('att-date')?.value || today();
      const att = state.cache.attendance;
      if (!att[d]) att[d] = { marks:{} };
      att[d].marks[el.dataset.rid] = !att[d].marks[el.dataset.rid];
      state._attDate=d; render();
    });
  });
  document.querySelectorAll('[data-att-tab]').forEach(el => {
    el.addEventListener('click', () => { state.adminAttTab=el.dataset.attTab; render(); });
  });
  document.querySelector('[data-action="save-attendance"]')?.addEventListener('click', async () => {
    const d = document.getElementById('att-date')?.value || today();
    const att = state.cache.attendance;
    await window.FDB.setDoc('attendance', d, att[d]||{marks:{}});
    showToast('ì¶œì„ ì €ì¥ ì™„ë£Œ!');
  });

  // â”€â”€ Admin: Offering â”€â”€
  document.querySelector('[data-action="add-offering"]')?.addEventListener('click', async () => {
    const d = document.getElementById('off-date')?.value || today();
    const pid = document.getElementById('off-person')?.value;
    const type = document.getElementById('off-type')?.value;
    const amount = Number(document.getElementById('off-amount')?.value.replace(/,/g,''));
    if (!pid || !amount) return;
    const rosters = state.cache.rosters;
    const person = rosters.find(r=>r.id===pid);
    const offerings = state.cache.offerings;
    if (!offerings[d]) offerings[d] = { items:[] };
    offerings[d].items.push({ id:uid(), personId:pid, name:person?.name||'', type, amount });
    await window.FDB.setDoc('offering', d, offerings[d]);
    state._offDate=d; render();
  });

  // â”€â”€ Admin: Send notification â”€â”€
  document.querySelector('[data-action="send-noti"]')?.addEventListener('click', async () => {
    const title = document.getElementById('noti-title')?.value;
    const body = document.getElementById('noti-body')?.value;
    if (!title) return;
    const nid = uid();
    const notiData = { id:nid, title, body, type:'etc', at:today() };
    await window.FDB.setDoc('notifications', nid, notiData);
    state.cache.notifications.push(notiData);
    showToast('ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ!');
  });

  // â”€â”€ Admin: Roster tab â”€â”€
  document.querySelectorAll('[data-roster-tab]').forEach(el => {
    el.addEventListener('click', () => { state.adminRosterTab=el.dataset.rosterTab; render(); });
  });

  // â”€â”€ Admin: Roster menu â”€â”€
  document.querySelectorAll('[data-action="roster-menu"]').forEach(el => {
    el.addEventListener('click', e => {
      e.stopPropagation();
      const dd = document.getElementById('roster-dd-'+el.dataset.rid);
      document.querySelectorAll('[id^="roster-dd-"]').forEach(d=>{ if(d!==dd) d.classList.add('hidden'); });
      dd?.classList.toggle('hidden');
    });
  });
  document.querySelectorAll('[data-action="roster-edit"]').forEach(el => {
    el.addEventListener('click', e => {
      e.stopPropagation();
      const rid = el.dataset.rid;
      const r = state.cache.rosters.find(x=>x.id===rid); if (!r) return;
      const cells = state.cache.cells;
      const dd = document.getElementById('roster-dd-'+rid); dd?.classList.add('hidden');
      const card = document.getElementById('roster-card-'+rid); if (!card) return;
      const existing = document.getElementById('roster-inline-edit-'+rid);
      if (existing) { existing.remove(); return; }
      const editDiv = document.createElement('div');
      editDiv.id = 'roster-inline-edit-'+rid;
      editDiv.className = 'mt-3 space-y-2';
      editDiv.innerHTML = `
        <input id="re-name-${rid}" value="${r.name}" class="w-full px-3 py-2 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
        <input id="re-phone-${rid}" value="${fmtPhone(r.phone)}" inputmode="numeric" class="w-full px-3 py-2 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
        <input id="re-birth-${rid}" value="${r.birth}" inputmode="numeric" class="w-full px-3 py-2 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
        <select id="re-cell-${rid}" class="w-full px-3 py-2 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black">
          <option value="">ë¯¸ë°°ì •</option>${cells.map(c=>`<option value="${c.id}"${c.id===r.cellId?' selected':''}>${c.name}</option>`).join('')}
        </select>
        <button id="re-save-${rid}" class="w-full py-2 bg-black text-white rounded-xl text-xs font-bold">ì €ì¥</button>`;
      card.appendChild(editDiv);
      document.getElementById('re-phone-'+rid)?.addEventListener('input', function() { this.value=fmtPhone(this.value); });
      document.getElementById('re-save-'+rid)?.addEventListener('click', async () => {
        const g = id => document.getElementById(id)?.value||'';
        const updated = { ...r, name:g('re-name-'+rid)||r.name, phone:fmtPhone(g('re-phone-'+rid)||r.phone), birth:g('re-birth-'+rid)||r.birth, cellId:g('re-cell-'+rid)||r.cellId };
        await window.FDB.setDoc('rosters', rid, updated);
        const idx = state.cache.rosters.findIndex(x=>x.id===rid);
        if (idx>=0) state.cache.rosters[idx]=updated;
        showToast('ì •ë³´ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.'); render();
      });
    });
  });
  document.querySelectorAll('[data-action="roster-grant"]').forEach(el => {
    el.addEventListener('click', async e => {
      e.stopPropagation();
      const rid = el.dataset.rid;
      const r = state.cache.rosters.find(x=>x.id===rid); if (!r||!r.linkedUid) return;
      const u = state.cache.users.find(x=>x.uid===r.linkedUid);
      if (u) {
        u.role = u.role==='admin'?'user':'admin';
        await window.FDB.setDoc('users', u.uid, { role:u.role });
      }
      showToast('ë³€ê²½ ì™„ë£Œ!'); render();
    });
  });
  document.querySelectorAll('[data-action="roster-delete"]').forEach(el => {
    el.addEventListener('click', e => {
      e.stopPropagation();
      showConfirm('íƒˆí‡´ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async () => {
        const rid = el.dataset.rid;
        await window.FDB.deleteDoc('rosters', rid);
        state.cache.rosters = state.cache.rosters.filter(r=>r.id!==rid);
        render();
      });
    });
  });

  // â”€â”€ Admin: Edit notice â”€â”€
  document.querySelectorAll('[data-action="edit-notice"]').forEach(el => {
    el.addEventListener('click', () => {
      const nid = el.dataset.nid;
      const n = state.cache.notices.find(x=>x.id===nid); if (!n) return;
      const area = document.getElementById('admin-form-area'); if (!area) return;
      area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4 fade-in">
        ${adminInput('nf-title','ì œëª©','ê³µì§€ ì œëª©')}
        ${adminTextarea('nf-body','ë‚´ìš©','',5)}
        <label class="flex items-center gap-2"><input id="nf-pinned" type="checkbox" class="w-4 h-4 rounded accent-black"/><span class="text-sm font-medium">ì¤‘ìš” ê³µì§€ë¡œ ê³ ì •</span></label>
        <div class="flex gap-2">
          <button onclick="state.adminSub='notice';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">ì·¨ì†Œ</button>
          <button id="update-notice" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">ìˆ˜ì •</button>
        </div>
      </div>`;
      document.getElementById('nf-title').value = n.title;
      document.getElementById('nf-body').value = n.body;
      document.getElementById('nf-pinned').checked = n.pinned;
      document.getElementById('update-notice')?.addEventListener('click', async () => {
        const updated = { ...n, title:document.getElementById('nf-title').value, body:document.getElementById('nf-body').value, pinned:document.getElementById('nf-pinned').checked };
        await window.FDB.setDoc('notices', nid, updated);
        const idx = state.cache.notices.findIndex(x=>x.id===nid);
        if(idx>=0) state.cache.notices[idx]=updated;
        showToast('ê³µì§€ ìˆ˜ì • ì™„ë£Œ!'); render();
      });
    });
  });

  // â”€â”€ Admin: Edit event â”€â”€
  document.querySelectorAll('[data-action="edit-event"]').forEach(el => {
    el.addEventListener('click', () => {
      const eid = el.dataset.eid;
      const ev = state.cache.events.find(x=>x.id===eid); if (!ev) return;
      const area = document.getElementById('admin-form-area'); if (!area) return;
      area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4 fade-in">
        ${adminInput('ef-title','ì œëª©','')}
        ${adminInput('ef-date','ë‚ ì§œ','')}
        ${adminInput('ef-time','ì‹œê°„','')}
        ${adminInput('ef-loc','ì¥ì†Œ','')}
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì¹´í…Œê³ ë¦¬</label>
          <select id="ef-cat" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black">
            ${['ì˜ˆë°°','ëª¨ì„','í–‰ì‚¬','ìƒì¼','ê¸°íƒ€'].map(c=>`<option value="${c}"${c===ev.cat?' selected':''}>${c}</option>`).join('')}
          </select>
        </div>
        <div class="flex gap-2">
          <button onclick="state.adminSub='event';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">ì·¨ì†Œ</button>
          <button id="update-event" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">ìˆ˜ì •</button>
        </div>
      </div>`;
      document.getElementById('ef-title').value=ev.title; document.getElementById('ef-date').value=ev.date;
      document.getElementById('ef-time').value=ev.time||''; document.getElementById('ef-loc').value=ev.loc||'';
      document.getElementById('update-event')?.addEventListener('click', async () => {
        const g = id => document.getElementById(id)?.value||'';
        const updated = { ...ev, title:g('ef-title'), date:g('ef-date'), time:g('ef-time'), loc:g('ef-loc'), cat:g('ef-cat')||'ê¸°íƒ€' };
        await window.FDB.setDoc('events', eid, updated);
        const idx = state.cache.events.findIndex(x=>x.id===eid);
        if(idx>=0) state.cache.events[idx]=updated;
        showToast('ì¼ì • ìˆ˜ì • ì™„ë£Œ!'); render();
      });
    });
  });

  // â”€â”€ Admin: Edit bulletin â”€â”€
  document.querySelectorAll('[data-action="edit-bulletin"]').forEach(el => {
    el.addEventListener('click', () => {
      const bid = el.dataset.bid;
      const b = state.cache.bulletins.find(x=>x.id===bid); if (!b) return;
      const rosters = state.cache.rosters;
      const rOpts = `<option value="">ë¯¸ì •</option>${rosters.map(r=>`<option value="${r.name}">${r.name}</option>`).join('')}`;
      const area = document.getElementById('admin-form-area'); if (!area) return;
      area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4 fade-in">
        ${adminInput('bf-title','ì œëª©','')} ${adminInput('bf-date','ë‚ ì§œ','')}
        ${adminTextarea('bf-order','ì˜ˆë°°ìˆœì„œ','',6)}
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ëŒ€í‘œê¸°ë„</label><select id="bf-prayer" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm">${rOpts}</select></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì„±ê²½ë´‰ë…</label><select id="bf-bible" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm">${rOpts}</select></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì„±ë„ì˜ êµì œ</label><select id="bf-announce" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm">${rOpts}</select></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ë´‰í—Œ</label><select id="bf-offering" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm">${rOpts}</select></div>
        ${adminTextarea('bf-songs','ì°¬ì–‘ê³¡ ëª©ë¡','',4)} ${adminTextarea('bf-announce-text','ê´‘ê³  ë‚´ìš©','',4)}
        <div class="flex gap-2">
          <button onclick="state.adminSub='bulletin';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">ì·¨ì†Œ</button>
          <button id="update-bulletin" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">ìˆ˜ì •</button>
        </div>
      </div>`;
      document.getElementById('bf-title').value=b.title; document.getElementById('bf-date').value=b.date;
      document.getElementById('bf-order').value=b.order||'';
      const selVal = (sid, val) => { const el=document.getElementById(sid); if(el) el.value=val||''; };
      selVal('bf-prayer',b.prayer_duty); selVal('bf-bible',b.bible_reading); selVal('bf-announce',b.announcement_duty); selVal('bf-offering',b.offering_duty);
      document.getElementById('bf-songs').value=b.songs||''; document.getElementById('bf-announce-text').value=b.announce||'';
      document.getElementById('update-bulletin')?.addEventListener('click', async () => {
        const g = id => document.getElementById(id)?.value||'';
        const updated = { ...b, title:g('bf-title'), date:g('bf-date'), order:g('bf-order'), prayer_duty:g('bf-prayer'), bible_reading:g('bf-bible'), announcement_duty:g('bf-announce'), offering_duty:g('bf-offering'), songs:g('bf-songs'), announce:g('bf-announce-text') };
        await window.FDB.setDoc('bulletins', bid, updated);
        const idx = state.cache.bulletins.findIndex(x=>x.id===bid);
        if(idx>=0) state.cache.bulletins[idx]=updated;
        showToast('ì£¼ë³´ ìˆ˜ì • ì™„ë£Œ!'); render();
      });
    });
  });

  // â”€â”€ Admin: Edit worship â”€â”€
  document.querySelectorAll('[data-action="edit-worship"]').forEach(el => {
    el.addEventListener('click', () => {
      const wid = el.dataset.wid;
      const ws = state.cache.worshipSets.find(x=>x.id===wid); if (!ws) return;
      const KEYS=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
      let songCount = ws.songs.length || 1;
      const area = document.getElementById('admin-form-area'); if(!area) return;
      const getSongRows = (songs) => {
        let rows='';
        for(let i=0;i<songCount;i++){
          const s = songs[i]||{title:'',url:'',key:'C'};
          rows+=`<div class="bg-zinc-50 rounded-xl p-3 space-y-2 mb-2">
            <p class="text-[10px] font-bold text-zinc-400">ê³¡ ${i+1}</p>
            <input id="ws-title-${i}" value="${s.title||''}" placeholder="ê³¡ ì œëª©" class="w-full px-3 py-2 bg-white border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
            <input id="ws-url-${i}" value="${s.url||''}" placeholder="ìœ íŠœë¸Œ ë§í¬" class="w-full px-3 py-2 bg-white border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
            <div class="flex-1"><label class="block text-[10px] font-bold text-zinc-500 mb-1">í‚¤</label>
              <select id="ws-key-${i}" class="w-full px-3 py-2 bg-white border border-zinc-200 rounded-xl text-sm">${KEYS.map(k=>`<option value="${k}"${k===s.key?' selected':''}>${k}</option>`).join('')}</select>
            </div>
          </div>`;
        }
        return rows;
      };
      area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4 fade-in">
        ${adminInput('wf-date','ì£¼ì°¨ ë‚ ì§œ','')}
        ${adminInput('wf-leader','ì¸ë„ì','')}
        <div><label class="block text-xs font-bold text-zinc-600 mb-2 ml-1">ê³¡ ëª©ë¡</label>
          <div id="song-rows">${getSongRows(ws.songs)}</div>
          <button id="add-song-row" class="w-full py-2 border border-dashed border-zinc-200 rounded-xl text-xs font-bold text-zinc-400 mt-1">+ ê³¡ ì¶”ê°€</button>
        </div>
        <div class="flex gap-2">
          <button onclick="state.adminSub='worship';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">ì·¨ì†Œ</button>
          <button id="update-worship" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">ìˆ˜ì •</button>
        </div>
      </div>`;
      document.getElementById('wf-date').value=ws.date; document.getElementById('wf-leader').value=ws.leader||'';
      document.getElementById('add-song-row')?.addEventListener('click',()=>{ songCount++; document.getElementById('song-rows').innerHTML=getSongRows(ws.songs); });
      document.getElementById('update-worship')?.addEventListener('click', async () => {
        const g = id => document.getElementById(id)?.value||'';
        const songs = [];
        for(let i=0;i<songCount;i++){ const t=g('ws-title-'+i); if(t) songs.push({title:t,url:g('ws-url-'+i),key:g('ws-key-'+i)||'C',sheet:''}); }
        const updated = { ...ws, date:g('wf-date'), leader:g('wf-leader'), songs };
        await window.FDB.setDoc('worshipSets', wid, updated);
        const idx = state.cache.worshipSets.findIndex(x=>x.id===wid);
        if(idx>=0) state.cache.worshipSets[idx]=updated;
        showToast('ì°¬ì–‘ ìˆ˜ì • ì™„ë£Œ!'); render();
      });
    });
  });

  // â”€â”€ Admin: Edit cellmeet â”€â”€
  document.querySelectorAll('[data-action="edit-cellmeet"]').forEach(el => {
    el.addEventListener('click', () => {
      const mid = el.dataset.mid;
      const m = state.cache.cellMeetings.find(x=>x.id===mid); if (!m) return;
      let qCount = m.questions?.length || 1;
      const area = document.getElementById('admin-form-area'); if(!area) return;
      const getQRows = () => {
        let rows='';
        for(let i=0;i<qCount;i++){
          rows+=`<div class="flex gap-2 items-start mb-2"><textarea id="cm-q-${i}" rows="2" placeholder="ì§ˆë¬¸ ${i+1}" class="flex-1 px-3 py-2 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black resize-none"></textarea></div>`;
        }
        return rows;
      };
      area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4 fade-in">
        ${adminInput('cm-date','ë‚ ì§œ','')} ${adminInput('cm-verse','ë§ì”€ êµ¬ì ˆ','')}
        ${adminTextarea('cm-versetext','ë§ì”€ ë³¸ë¬¸ (í•µì‹¬)','',2)}
        <div><label class="block text-xs font-bold text-zinc-600 mb-2 ml-1">ë‚˜ëˆ” ì§ˆë¬¸</label>
          <div id="cm-q-rows">${getQRows()}</div>
          <button id="add-question-btn" class="w-full py-2 border border-dashed border-zinc-200 rounded-xl text-xs font-bold text-zinc-400 mt-1">+ ì§ˆë¬¸ ì¶”ê°€</button>
        </div>
        ${adminTextarea('cm-prayer','í•¨ê»˜ ê¸°ë„ ì œëª©','',4)}
        <div class="flex gap-2">
          <button onclick="state.adminSub='cellmeet';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">ì·¨ì†Œ</button>
          <button id="update-cellmeet" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">ìˆ˜ì •</button>
        </div>
      </div>`;
      document.getElementById('cm-date').value=m.date; document.getElementById('cm-verse').value=m.verse||'';
      document.getElementById('cm-versetext').value=m.verseText||''; document.getElementById('cm-prayer').value=m.prayerItems||'';
      m.questions?.forEach((q,i)=>{ const el=document.getElementById('cm-q-'+i); if(el) el.value=q; });
      document.getElementById('add-question-btn')?.addEventListener('click',()=>{ qCount++; document.getElementById('cm-q-rows').innerHTML=getQRows(); });
      document.getElementById('update-cellmeet')?.addEventListener('click', async () => {
        const g = id => document.getElementById(id)?.value||'';
        const questions=[];
        for(let i=0;i<qCount;i++){ const q=g('cm-q-'+i); if(q.trim()) questions.push(q.trim()); }
        const updated = { ...m, date:g('cm-date'), verse:g('cm-verse'), verseText:g('cm-versetext'), questions, prayerItems:g('cm-prayer') };
        await window.FDB.setDoc('cellMeetings', mid, updated);
        const idx = state.cache.cellMeetings.findIndex(x=>x.id===mid);
        if(idx>=0) state.cache.cellMeetings[idx]=updated;
        showToast('ëª©ì¥ ëª¨ì„ ìë£Œ ìˆ˜ì • ì™„ë£Œ!'); render();
      });
    });
  });

  // â”€â”€ Admin: Noti toggle â”€â”€
  document.querySelectorAll('[data-noti-toggle]').forEach(el => {
    el.addEventListener('click', async () => {
      const key = el.dataset.notiToggle;
      const noti = state.user._noti || {worship:true,notice:true,verse:true,schedule:true,duty:true};
      noti[key] = !noti[key];
      state.user._noti = noti;
      await window.FDB.setDoc('users', state.user.uid, { _noti: noti });
      SESSION.set(state.user); render();
    });
  });

  // â”€â”€ Settings â”€â”€
  document.getElementById('toggle-pw-section')?.addEventListener('click', () => {
    document.getElementById('pw-section')?.classList.toggle('hidden');
  });
  document.getElementById('toggle-id-section')?.addEventListener('click', () => {
    document.getElementById('id-section')?.classList.toggle('hidden');
  });
  document.getElementById('save-pw')?.addEventListener('click', async () => {
    const cur=document.getElementById('pw-current')?.value;
    const nw=document.getElementById('pw-new')?.value;
    const cf=document.getElementById('pw-confirm')?.value;
    const u=state.cache.users.find(x=>x.uid===state.user.uid);
    if (!u||u.pw!==cur) return showToast('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
    if (nw!==cf) return showToast('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    if (nw.length<4) return showToast('4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
    u.pw=nw;
    await window.FDB.setDoc('users', u.uid, { pw:nw });
    state.user=u; SESSION.set(u);
    showToast('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì™„ë£Œ!');
  });
  document.getElementById('save-id')?.addEventListener('click', async () => {
    const pwVerify=document.getElementById('id-pw-verify')?.value;
    const newId=document.getElementById('id-new')?.value?.trim();
    const u=state.cache.users.find(x=>x.uid===state.user.uid);
    if (!u||u.pw!==pwVerify) return showToast('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
    if (!newId) return showToast('ìƒˆ ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    if (newId.length<3) return showToast('ì•„ì´ë””ëŠ” 3ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
    if (state.cache.users.find(x=>x.id===newId&&x.uid!==u.uid)) return showToast('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.');
    u.id=newId; u.idChangedAt=today();
    await window.FDB.setDoc('users', u.uid, { id:newId, idChangedAt:today() });
    state.user=u; SESSION.set(u);
    showToast('ì•„ì´ë”” ë³€ê²½ ì™„ë£Œ! ë‹¤ìŒ ë¡œê·¸ì¸ ì‹œ ìƒˆ ì•„ì´ë””ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
    render();
  });
  document.getElementById('withdraw-btn')?.addEventListener('click', () => {
    // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬
    state._confirmModal = {
      msg: `<div class="space-y-3">
        <p>íƒˆí‡´ ì‹ ì²­ í›„ ê´€ë¦¬ì ìŠ¹ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.<br/>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        <input id="withdraw-pw-input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black mt-2"/>
      </div>`,
      yesLabel: 'íƒˆí‡´ ì‹ ì²­',
      yesClass: 'bg-red-500 text-white',
      onYes: async () => {
        const pw = document.getElementById('withdraw-pw-input')?.value;
        const u = state.cache.users.find(x=>x.uid===state.user.uid);
        if (!u||u.pw!==pw) { showToast('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.'); return; }
        await window.FDB.setDoc('users', u.uid, { status:'withdraw_pending', withdrawAt:today() });
        SESSION.clear();
        state.user=null; state.page='login'; state.profilePage=null;
        showToast('íƒˆí‡´ ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì²˜ë¦¬ë©ë‹ˆë‹¤.');
        render();
      }
    };
    render();
  });

  // â”€â”€ Profile edit: image upload â†’ crop modal â”€â”€
  document.getElementById('profile-img-input')?.addEventListener('change', function() {
    const file = this.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        const origW = img.naturalWidth; const origH = img.naturalHeight;
        const size = 300;
        const aspect = origW/origH;
        let w,h;
        if (aspect>1) { w=size; h=size/aspect; } else { h=size; w=size*aspect; }
        state._cropModal = { src:e.target.result, origW, origH, w, h, ox:(size-w)/2, oy:(size-h)/2 };
        state._pendingProfileFile = file;
        render();
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });

  document.getElementById('save-profile-edit')?.addEventListener('click', async () => {
    const name = document.getElementById('edit-name')?.value;
    const phone = fmtPhone(document.getElementById('edit-phone')?.value||'');
    const birth = document.getElementById('edit-birth')?.value.replace(/\D/g,'');
    const cellId = document.getElementById('edit-cell')?.value;
    let profileImg = state.user.profileImg;
    if (state._pendingProfileImg) {
      showToast('ì‚¬ì§„ ì—…ë¡œë“œ ì¤‘...');
      const url = await window.FDB.uploadBase64(`profiles/${state.user.uid}`, state._pendingProfileImg);
      if (url) profileImg = url;
      state._pendingProfileImg = null;
    }
    const updated = { ...state.user };
    if (name) updated.name=name;
    updated.phone=phone; updated.birth=birth; updated.cellId=cellId; updated.profileImg=profileImg;
    await window.FDB.setDoc('users', state.user.uid, updated);
    const idx = state.cache.users.findIndex(u=>u.uid===state.user.uid);
    if (idx>=0) state.cache.users[idx]=updated;
    state.user=updated; SESSION.set(updated);
    showToast('í”„ë¡œí•„ ì €ì¥ ì™„ë£Œ!'); state.profilePage=null; render();
  });

  // â”€â”€ Edit phone/birth realtime format in profile edit â”€â”€
  document.getElementById('edit-phone')?.addEventListener('input', function() { this.value=fmtPhone(this.value); });
  document.getElementById('edit-birth')?.addEventListener('input', function() {
    const d=this.value.replace(/\D/g,'');
    if(d.length<=4) this.value=d;
    else if(d.length<=6) this.value=d.slice(0,4)+'.'+d.slice(4);
    else this.value=d.slice(0,4)+'.'+d.slice(4,6)+'.'+d.slice(6,8);
  });

  // â”€â”€ Admin: Show forms â”€â”€
  // Notice form
  document.querySelector('[data-action="show-notice-form"]')?.addEventListener('click', () => {
    const area = document.getElementById('admin-form-area'); if (!area) return;
    let pendingImgs = [];
    area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4 fade-in">
      ${adminInput('nf-title','ì œëª©','ê³µì§€ ì œëª©')}
      ${adminTextarea('nf-body','ë‚´ìš©','ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”',5)}
      <div>
        <label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì‚¬ì§„ ì²¨ë¶€</label>
        <label class="flex items-center gap-2 px-3 py-2.5 bg-zinc-50 border border-zinc-200 rounded-xl text-sm text-zinc-400 cursor-pointer w-full">
          ${icon('attach_file','',18)} ì´ë¯¸ì§€ ì„ íƒ (ì—¬ëŸ¬ ì¥ ê°€ëŠ¥)
          <input id="nf-images" type="file" accept="image/*" multiple class="hidden"/>
        </label>
        <div id="nf-image-preview" class="flex gap-2 mt-2 flex-wrap"></div>
      </div>
      <label class="flex items-center gap-2"><input id="nf-pinned" type="checkbox" class="w-4 h-4 rounded accent-black"/><span class="text-sm font-medium">ì¤‘ìš” ê³µì§€ë¡œ ê³ ì •</span></label>
      <div class="flex gap-2">
        <button onclick="state.adminSub='notice';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">ì·¨ì†Œ</button>
        <button id="save-notice" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">ì €ì¥</button>
      </div>
    </div>`;
    document.getElementById('nf-images')?.addEventListener('change', function() {
      const preview = document.getElementById('nf-image-preview');
      Array.from(this.files).forEach(file => {
        const r = new FileReader();
        r.onload = e => {
          pendingImgs.push({file, dataUrl: e.target.result});
          if (preview) { const img=document.createElement('img'); img.src=e.target.result; img.className='w-16 h-16 rounded-xl object-cover border border-zinc-200'; preview.appendChild(img); }
        };
        r.readAsDataURL(file);
      });
    });
    document.getElementById('save-notice')?.addEventListener('click', async () => {
      const title = document.getElementById('nf-title')?.value; if (!title) return;
      showToast('ì €ì¥ ì¤‘...');
      const imageUrls = [];
      for (const {file} of pendingImgs) {
        const nid2 = uid();
        const url = await window.FDB.uploadFile(`notice_images/${nid2}`, file);
        if (url) imageUrls.push(url);
      }
      const nid = uid();
      const n = { id:nid, title, body:document.getElementById('nf-body')?.value||'', pinned:document.getElementById('nf-pinned')?.checked||false, by:state.user.uid, at:today(), images:imageUrls };
      await window.FDB.setDoc('notices', nid, n);
      state.cache.notices.unshift(n);
      showToast('ê³µì§€ ì €ì¥ ì™„ë£Œ!'); render();
    });
  });

  // Event form
  document.querySelector('[data-action="show-event-form"]')?.addEventListener('click', () => {
    const area = document.getElementById('admin-form-area'); if (!area) return;
    area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4 fade-in">
      ${adminInput('ef-title','ì œëª©','ì£¼ì¼ ì²­ë…„ ì˜ˆë°°')}
      ${adminInput('ef-date','ë‚ ì§œ',today())}
      ${adminInput('ef-time','ì‹œê°„','14:00')}
      ${adminInput('ef-loc','ì¥ì†Œ','ë³¸ë‹¹')}
      <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì¹´í…Œê³ ë¦¬</label>
        <select id="ef-cat" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm">
          ${['ì˜ˆë°°','ëª¨ì„','í–‰ì‚¬','ìƒì¼','ê¸°íƒ€'].map(c=>`<option value="${c}">${c}</option>`).join('')}
        </select>
      </div>
      <div class="flex gap-2">
        <button onclick="state.adminSub='event';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">ì·¨ì†Œ</button>
        <button id="save-event" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">ì €ì¥</button>
      </div>
    </div>`;
    document.getElementById('save-event')?.addEventListener('click', async () => {
      const g = id => document.getElementById(id)?.value||'';
      const title=g('ef-title'); if (!title) return;
      const eid = uid();
      const ev = { id:eid, title, date:g('ef-date'), time:g('ef-time'), loc:g('ef-loc'), cat:g('ef-cat')||'ê¸°íƒ€' };
      await window.FDB.setDoc('events', eid, ev);
      state.cache.events.push(ev); state.cache.events.sort((a,b)=>a.date.localeCompare(b.date));
      showToast('ì¼ì • ì €ì¥ ì™„ë£Œ!'); render();
    });
  });

  // Roster form
  document.querySelector('[data-action="show-roster-form"]')?.addEventListener('click', () => {
    const cells = state.cache.cells;
    const area = document.getElementById('roster-form-area'); if (!area) return;
    area.innerHTML = `<div class="bg-white p-4 rounded-2xl border border-zinc-100 mb-4 space-y-3 fade-in">
      <input id="rf-name" placeholder="ì´ë¦„" class="w-full px-3 py-2.5 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
      <input id="rf-phone" inputmode="numeric" placeholder="010-0000-0000" class="w-full px-3 py-2.5 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
      <input id="rf-birth" inputmode="numeric" placeholder="19950315" class="w-full px-3 py-2.5 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
      <select id="rf-cell" class="w-full px-3 py-2.5 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black">
        <option value="">ëª©ì¥ ì„ íƒ</option>${cells.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}
      </select>
      <div class="flex gap-2">
        <button id="cancel-roster-form" class="flex-1 py-2 border border-zinc-200 rounded-xl text-sm font-bold">ì·¨ì†Œ</button>
        <button id="save-roster" class="flex-1 py-2 bg-black text-white rounded-xl text-sm font-bold">ì¶”ê°€</button>
      </div>
    </div>`;
    document.getElementById('rf-phone')?.addEventListener('input', function() { this.value=fmtPhone(this.value); });
    document.getElementById('cancel-roster-form')?.addEventListener('click', () => { area.innerHTML=''; });
    document.getElementById('save-roster')?.addEventListener('click', async () => {
      const g = id => document.getElementById(id)?.value||'';
      const name=g('rf-name'), phone=fmtPhone(g('rf-phone')), birth=g('rf-birth'), cellId=g('rf-cell');
      if (!name||!phone) return showToast('ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      const rid = uid();
      const roster = { id:rid, name, phone, birth, cellId, linkedUid:null };
      await window.FDB.setDoc('rosters', rid, roster);
      state.cache.rosters.push(roster);
      showToast('ëª…ë¶€ ì¶”ê°€ ì™„ë£Œ!'); render();
    });
  });

  // Cell management
  document.querySelector('[data-action="show-cell-form"]')?.addEventListener('click', () => {
    const area = document.getElementById('cell-form-area'); if (!area) return;
    if (area.innerHTML) { area.innerHTML=''; return; }
    area.innerHTML = `<div class="bg-white p-4 rounded-2xl border border-zinc-100 mb-3 space-y-2 fade-in">
      <input id="new-cell-name" placeholder="ëª©ì¥ ì´ë¦„" class="w-full px-3 py-2.5 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
      <input id="new-cell-leader" placeholder="ëª©ì ì´ë¦„" class="w-full px-3 py-2.5 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
      <button id="save-new-cell" class="w-full py-2 bg-black text-white rounded-xl text-xs font-bold">ì¶”ê°€</button>
    </div>`;
    document.getElementById('save-new-cell')?.addEventListener('click', async () => {
      const name=document.getElementById('new-cell-name')?.value;
      const leader=document.getElementById('new-cell-leader')?.value;
      if (!name) return;
      const cid=uid();
      const cell={id:cid,name,leader:leader||'',order:state.cache.cells.length+1};
      await window.FDB.setDoc('cells', cid, cell);
      state.cache.cells.push(cell);
      showToast('ëª©ì¥ ì¶”ê°€ ì™„ë£Œ!'); render();
    });
  });
  document.querySelectorAll('[data-action="cell-edit"]').forEach(el => {
    el.addEventListener('click', () => { document.getElementById('cell-edit-area-'+el.dataset.cid)?.classList.toggle('hidden'); });
  });
  document.querySelectorAll('[data-action="cell-save"]').forEach(el => {
    el.addEventListener('click', async () => {
      const cid=el.dataset.cid;
      const name=document.getElementById('cell-name-'+cid)?.value;
      const leader=document.getElementById('cell-leader-'+cid)?.value;
      if (!name) return;
      await window.FDB.setDoc('cells', cid, { name, leader });
      const c=state.cache.cells.find(x=>x.id===cid);
      if(c){c.name=name;c.leader=leader;}
      showToast('ëª©ì¥ ì •ë³´ ë³€ê²½ ì™„ë£Œ!'); render();
    });
  });
  document.querySelectorAll('[data-action="cell-delete"]').forEach(el => {
    el.addEventListener('click', () => {
      showConfirm('ëª©ì¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async () => {
        const cid=el.dataset.cid;
        await window.FDB.deleteDoc('cells', cid);
        state.cache.cells=state.cache.cells.filter(c=>c.id!==cid);
        render();
      });
    });
  });

  // CellMeet form
  document.querySelector('[data-action="show-cellmeet-form"]')?.addEventListener('click', () => {
    const area = document.getElementById('admin-form-area'); if (!area) return;
    let qCount=1;
    const getQRows = () => {
      let rows='';
      for(let i=0;i<qCount;i++){
        rows+=`<div class="flex gap-2 items-start mb-2"><textarea id="cm-q-${i}" rows="2" placeholder="ì§ˆë¬¸ ${i+1}" class="flex-1 px-3 py-2 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black resize-none"></textarea></div>`;
      }
      return rows;
    };
    area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4 fade-in">
      ${adminInput('cm-date','ë‚ ì§œ',today())}
      ${adminInput('cm-verse','ë§ì”€ êµ¬ì ˆ','ìš”í•œë³µìŒ 15:1-8')}
      ${adminTextarea('cm-versetext','ë§ì”€ ë³¸ë¬¸ (í•µì‹¬)','"ë‚˜ëŠ” í¬ë„ë‚˜ë¬´ìš”..."',2)}
      <div>
        <label class="block text-xs font-bold text-zinc-600 mb-2 ml-1">ë‚˜ëˆ” ì§ˆë¬¸</label>
        <div id="cm-q-rows">${getQRows()}</div>
        <button id="add-question-btn" class="w-full py-2 border border-dashed border-zinc-200 rounded-xl text-xs font-bold text-zinc-400 mt-1">+ ì§ˆë¬¸ ì¶”ê°€</button>
      </div>
      ${adminTextarea('cm-prayer','í•¨ê»˜ ê¸°ë„ ì œëª©','â€¢ ëª©ì¥ ì§€ì²´ë¥¼ ìœ„í•´',4)}
      <div class="flex gap-2">
        <button onclick="state.adminSub='cellmeet';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">ì·¨ì†Œ</button>
        <button id="save-cellmeet" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">ì €ì¥</button>
      </div>
    </div>`;
    document.getElementById('add-question-btn')?.addEventListener('click', () => { qCount++; document.getElementById('cm-q-rows').innerHTML=getQRows(); });
    document.getElementById('save-cellmeet')?.addEventListener('click', async () => {
      const g = id => document.getElementById(id)?.value||'';
      const date=g('cm-date'); if(!date) return;
      const questions=[];
      for(let i=0;i<qCount;i++){ const q=g('cm-q-'+i); if(q.trim()) questions.push(q.trim()); }
      const mid=uid();
      const meeting={ id:mid, date, verse:g('cm-verse'), verseText:g('cm-versetext'), questions, prayerItems:g('cm-prayer'), by:state.user.uid, at:today() };
      await window.FDB.setDoc('cellMeetings', mid, meeting);
      state.cache.cellMeetings.unshift(meeting);
      showToast('ëª©ì¥ ëª¨ì„ ìë£Œ ì €ì¥ ì™„ë£Œ!'); render();
    });
  });

  // Worship form
  const worshipFormEl = document.querySelector('[data-action="show-worship-form"]');
  if (worshipFormEl) {
    worshipFormEl.removeEventListener('click', worshipFormEl._handler);
    const KEYS=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    let songCount=1;
    const getSongRows = () => {
      let rows='';
      for(let i=0;i<songCount;i++){
        rows+=`<div class="bg-zinc-50 rounded-xl p-3 space-y-2 mb-2">
          <p class="text-[10px] font-bold text-zinc-400">ê³¡ ${i+1}</p>
          <input id="ws-title-${i}" placeholder="ê³¡ ì œëª©" class="w-full px-3 py-2 bg-white border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
          <input id="ws-url-${i}" placeholder="ìœ íŠœë¸Œ ë§í¬" class="w-full px-3 py-2 bg-white border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
          <div class="flex gap-2">
            <div class="flex-1"><label class="block text-[10px] font-bold text-zinc-500 mb-1">í‚¤</label>
              <select id="ws-key-${i}" class="w-full px-3 py-2 bg-white border border-zinc-200 rounded-xl text-sm">${KEYS.map(k=>`<option value="${k}">${k}</option>`).join('')}</select>
            </div>
            <div class="flex-1"><label class="block text-[10px] font-bold text-zinc-500 mb-1">ì•…ë³´ (ì´ë¯¸ì§€)</label>
              <label class="flex items-center gap-1 px-3 py-2 bg-white border border-zinc-200 rounded-xl text-xs text-zinc-400 cursor-pointer">
                ğŸ“ íŒŒì¼ì„ íƒ
                <input id="ws-sheet-${i}" type="file" accept="image/*" class="hidden"/>
              </label>
              <p id="ws-sheet-name-${i}" class="text-[10px] text-zinc-400 mt-0.5 truncate"></p>
            </div>
          </div>
        </div>`;
      }
      return rows;
    };
    worshipFormEl._handler = () => {
      const area = document.getElementById('admin-form-area'); if (!area) return;
      songCount=1;
      area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4 fade-in">
        ${adminInput('wf-date','ì£¼ì°¨ ë‚ ì§œ',today())}
        ${adminInput('wf-leader','ì¸ë„ì','')}
        <div><label class="block text-xs font-bold text-zinc-600 mb-2 ml-1">ê³¡ ëª©ë¡</label>
          <div id="song-rows">${getSongRows()}</div>
          <button id="add-song-row" class="w-full py-2 border border-dashed border-zinc-200 rounded-xl text-xs font-bold text-zinc-400 mt-1">+ ê³¡ ì¶”ê°€</button>
        </div>
        <div class="flex gap-2">
          <button onclick="state.adminSub='worship';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">ì·¨ì†Œ</button>
          <button id="save-worship" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">ì €ì¥</button>
        </div>
      </div>`;
      const bindSheets = () => { for(let i=0;i<songCount;i++){ document.getElementById('ws-sheet-'+i)?.addEventListener('change', function(){ const nm=document.getElementById('ws-sheet-name-'+i); if(nm) nm.textContent=this.files[0]?.name||''; }); } };
      bindSheets();
      document.getElementById('add-song-row')?.addEventListener('click', () => { songCount++; document.getElementById('song-rows').innerHTML=getSongRows(); bindSheets(); });
      document.getElementById('save-worship')?.addEventListener('click', async () => {
        const g = id => document.getElementById(id)?.value||'';
        const date=g('wf-date'); if(!date) return;
        showToast('ì €ì¥ ì¤‘...');
        const songs=[];
        for(let i=0;i<songCount;i++){
          const title=g('ws-title-'+i); if(!title) continue;
          const fileEl=document.getElementById('ws-sheet-'+i); const file=fileEl?.files[0];
          let sheetUrl='';
          if(file){ sheetUrl=await window.FDB.uploadFile(`sheets/${uid()}`, file); }
          songs.push({title,url:g('ws-url-'+i),key:g('ws-key-'+i)||'C',sheet:sheetUrl||''});
        }
        const wid=uid();
        const ws={id:wid,date,leader:g('wf-leader'),songs,by:state.user.uid,at:today(),storedAt:today()};
        await window.FDB.setDoc('worshipSets', wid, ws);
        state.cache.worshipSets.push(ws);
        showToast('ì°¬ì–‘ ì €ì¥ ì™„ë£Œ!'); render();
      });
    };
    worshipFormEl.addEventListener('click', worshipFormEl._handler);
  }

  // Bulletin form
  const bulletinFormEl = document.querySelector('[data-action="show-bulletin-form"]');
  if (bulletinFormEl) {
    bulletinFormEl._handler = () => {
      const rosters=state.cache.rosters; const area=document.getElementById('admin-form-area'); if(!area) return;
      const rOpts=`<option value="">ë¯¸ì •</option>${rosters.map(r=>`<option value="${r.name}">${r.name}</option>`).join('')}`;
      area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4 fade-in">
        ${adminInput('bf-title','ì œëª©','2026ë…„ 3ì›” 1ì¼ ì£¼ë³´')}
        ${adminInput('bf-date','ë‚ ì§œ',today())}
        ${adminTextarea('bf-order','ì˜ˆë°°ìˆœì„œ','1. ì˜ˆë°°ì˜ ë¶€ë¦„\n2. ê²½ë°°ì™€ ì°¬ì–‘...',6)}
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ëŒ€í‘œê¸°ë„ ë‹´ë‹¹</label><select id="bf-prayer" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm">${rOpts}</select></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì„±ê²½ë´‰ë… ë‹´ë‹¹</label><select id="bf-bible" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm">${rOpts}</select></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì„±ë„ì˜ êµì œ ë‹´ë‹¹</label><select id="bf-announce" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm">${rOpts}</select></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ë´‰í—Œ ë‹´ë‹¹</label><select id="bf-offering" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm">${rOpts}</select></div>
        ${adminTextarea('bf-songs','ì°¬ì–‘ê³¡ ëª©ë¡','1. ê³¡ëª… (Key: G)',4)}
        ${adminTextarea('bf-announce-text','ê´‘ê³  ë‚´ìš©','â€¢ ìˆ˜ë ¨íšŒ ì•ˆë‚´',4)}
        <div class="flex gap-2">
          <button onclick="state.adminSub='bulletin';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">ì·¨ì†Œ</button>
          <button id="save-bulletin" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">ì €ì¥</button>
        </div>
      </div>`;
      document.getElementById('save-bulletin')?.addEventListener('click', async () => {
        const g = id => document.getElementById(id)?.value||'';
        const title=g('bf-title'),date=g('bf-date'); if(!title||!date) return;
        const bid=uid();
        const b={id:bid,title,date,order:g('bf-order'),prayer_duty:g('bf-prayer'),bible_reading:g('bf-bible'),announcement_duty:g('bf-announce'),offering_duty:g('bf-offering'),songs:g('bf-songs'),announce:g('bf-announce-text'),by:state.user.uid,at:today()};
        await window.FDB.setDoc('bulletins', bid, b);
        state.cache.bulletins.push(b); state.cache.bulletins.sort((a,b)=>a.date.localeCompare(b.date));
        showToast('ì£¼ë³´ ì €ì¥ ì™„ë£Œ!'); render();
      });
    };
    bulletinFormEl.removeEventListener('click', bulletinFormEl._handler);
    bulletinFormEl.addEventListener('click', bulletinFormEl._handler);
  }
}

// ============================================================
// CROP MODAL BINDING
// ============================================================
function bindCropModal() {
  if (!state._cropModal) return;
  const container = document.getElementById('crop-container');
  const imgEl = document.getElementById('crop-img');
  const scaleInput = document.getElementById('crop-scale');
  if (!container || !imgEl) return;

  const size = 300;
  let dragging=false, startX, startY, startOX, startOY;

  const clampPos = (ox,oy,w,h) => ({
    ox: Math.min(0, Math.max(size-w, ox)),
    oy: Math.min(0, Math.max(size-h, oy))
  });

  const applyTransform = () => {
    const c = state._cropModal;
    const pos = clampPos(c.ox,c.oy,c.w,c.h);
    state._cropModal.ox=pos.ox; state._cropModal.oy=pos.oy;
    imgEl.style.left=pos.ox+'px'; imgEl.style.top=pos.oy+'px';
    imgEl.style.width=c.w+'px'; imgEl.style.height=c.h+'px';
  };
  applyTransform();

  const onStart = e => {
    dragging=true;
    const pt=e.touches?e.touches[0]:e;
    startX=pt.clientX; startY=pt.clientY;
    startOX=state._cropModal.ox; startOY=state._cropModal.oy;
    e.preventDefault();
  };
  const onMove = e => {
    if (!dragging) return;
    const pt=e.touches?e.touches[0]:e;
    state._cropModal.ox=startOX+(pt.clientX-startX);
    state._cropModal.oy=startOY+(pt.clientY-startY);
    applyTransform(); e.preventDefault();
  };
  const onEnd = () => { dragging=false; };

  container.addEventListener('mousedown', onStart);
  container.addEventListener('touchstart', onStart, {passive:false});
  document.addEventListener('mousemove', onMove);
  document.addEventListener('touchmove', onMove, {passive:false});
  document.addEventListener('mouseup', onEnd);
  document.addEventListener('touchend', onEnd);

  scaleInput?.addEventListener('input', function() {
    const scale = parseInt(this.value)/100;
    const c = state._cropModal;
    const newW = c.origW*scale; const newH = c.origH*scale;
    // keep center
    const centerX = c.ox + c.w/2; const centerY = c.oy + c.h/2;
    state._cropModal.w=newW; state._cropModal.h=newH;
    state._cropModal.ox=centerX-newW/2; state._cropModal.oy=centerY-newH/2;
    applyTransform();
  });

  document.getElementById('crop-cancel')?.addEventListener('click', () => {
    state._cropModal=null; state._pendingProfileFile=null; render();
  });

  document.getElementById('crop-confirm')?.addEventListener('click', () => {
    const c = state._cropModal;
    const canvas = document.createElement('canvas');
    canvas.width=300; canvas.height=300;
    const ctx = canvas.getContext('2d');
    const img = new Image();
    img.onload = () => {
      ctx.drawImage(img, c.ox, c.oy, c.w, c.h);
      state._pendingProfileImg = canvas.toDataURL('image/jpeg', 0.88);
      state._cropModal = null;
      render();
    };
    img.src = c.src;
  });
}

// ============================================================
// APP INIT
// ============================================================
async function initApp() {
  const session = SESSION.get();
  if (session) {
    state.user = session;
    await loadAll();
    // refresh user from DB
    const freshUser = state.cache.users.find(u=>u.uid===session.uid);
    if (freshUser) { state.user=freshUser; SESSION.set(freshUser); }
    state.page = 'main';
  } else {
    state.page = 'login';
  }
  render();
}

window._appInit = initApp;
if (window._fbReady) initApp();
</script>
</body>
</html>
