<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>약속의 땅</title>
<!-- PWA / 홈화면 추가 -->
<link rel="manifest" href="manifest.json"/>
<link rel="icon" href="asset/favicon.ico" type="image/x-icon"/>
<link rel="icon" type="image/png" sizes="192x192" href="asset/logo.png"/>
<link rel="apple-touch-icon" sizes="192x192" href="asset/logo.png"/>
<link rel="apple-touch-icon" href="asset/logo.png"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<meta name="apple-mobile-web-app-title" content="약속의 땅"/>
<meta name="theme-color" content="#000000"/>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, collection, query, where, orderBy, onSnapshot, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, EmailAuthProvider, reauthenticateWithCredential, updatePassword as fbUpdatePassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCsc6xD7mTAnSwPbz7iSGB9NjniFub97wY",
    authDomain: "promiand-app.firebaseapp.com",
    projectId: "promiand-app",
    storageBucket: "promiand-app.firebasestorage.app",
    messagingSenderId: "585556305161",
    appId: "1:585556305161:web:2752434736fd4a652c1fd8",
    measurementId: "G-E2SKN09Y6T"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);
  const auth = getAuth(app);
  try { getAnalytics(app); } catch(e) {}
  window.FAUTH = auth; // 전역 접근용

  // ============================================================
  // FIREBASE DB LAYER
  // ============================================================
  window.FDB = {
    db, storage,

    async getCol(col) {
      try {
        const snap = await getDocs(collection(db, col));
        return snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch(e) { console.error('getCol', col, e); return []; }
    },

    async getDoc(col, id) {
      try {
        const snap = await getDoc(doc(db, col, id));
        return snap.exists() ? { id: snap.id, ...snap.data() } : null;
      } catch(e) { return null; }
    },

    async setDoc(col, id, data) {
      try {
        await setDoc(doc(db, col, id), { ...data, updatedAt: serverTimestamp() }, { merge: true });
      } catch(e) { console.error('setDoc', col, id, e); }
    },

    async addDoc(col, data) {
      try {
        const ref2 = await addDoc(collection(db, col), { ...data, createdAt: serverTimestamp() });
        return ref2.id;
      } catch(e) { console.error('addDoc', col, e); return null; }
    },

    async deleteDoc(col, id) {
      try {
        await deleteDoc(doc(db, col, id));
      } catch(e) { console.error('deleteDoc', col, id, e); }
    },

    async uploadFile(path, file) {
      try {
        const storageRef = ref(storage, path);
        await uploadBytes(storageRef, file);
        return await getDownloadURL(storageRef);
      } catch(e) { console.error('upload', e); return null; }
    },

    async uploadBase64(path, dataUrl) {
      try {
        const resp = await fetch(dataUrl);
        const blob = await resp.blob();
        const storageRef = ref(storage, path);
        await uploadBytes(storageRef, blob);
        return await getDownloadURL(storageRef);
      } catch(e) { console.error('uploadBase64', e); return null; }
    }
  };

  // ============================================================
  // SEED (Firestore에 최초 데이터 없으면 생성)
  // ============================================================
  async function seedIfNeeded() {
    const snap = await getDoc(doc(db, 'meta', 'seeded'));
    if (snap.exists()) return;

    const batch = writeBatch(db);

    const users = [
      { uid:'admin1', id:'admin', pw:'1234', name:'약속의 땅 관리자', phone:'010-3440-4318', birth:'19970908', cellId:'c1', role:'admin', status:'active', createdAt:'2026-01-01', profileImg:'', idChangedAt:null }
    ];
    users.forEach(u => batch.set(doc(db,'users',u.uid), u));

    const cells = [
      {id:"c1",name:"김창대목장",leader:"김창대",order:1},
      {id:"c2",name:"김유나목장",leader:"김유나",order:2},
      {id:"c3",name:"김제현목장",leader:"김제현",order:3},
      {id:"c4",name:"김예지목장",leader:"김예지",order:4}
    ];
    cells.forEach(c => batch.set(doc(db,'cells',c.id), c));

    const rosters = [
      {id:"r__4318",name:"김창대",phone:"010-3440-4318",birth:"19970908",cellId:"c1",role:"리더",linkedUid:null,joined:false},
      {id:"r__0683",name:"강주혜",phone:"010-9411-0683",birth:"20060105",cellId:"c1",role:"1",linkedUid:null,joined:false},
      {id:"r__7399",name:"고범수",phone:"010-6505-7399",birth:"20050826",cellId:"c1",role:"2",linkedUid:null,joined:false},
      {id:"r__1990",name:"김 난",phone:"010-6611-1990",birth:"19981103",cellId:"c1",role:"3",linkedUid:null,joined:false},
      {id:"r__8075",name:"김한수",phone:"010-7654-8075",birth:"19990712",cellId:"c1",role:"4",linkedUid:null,joined:false},
      {id:"r__4768",name:"노다온",phone:"010-9580-4768",birth:"20060126",cellId:"c1",role:"5",linkedUid:null,joined:false},
      {id:"r__1317",name:"양성경",phone:"010-4483-1317",birth:"19980817",cellId:"c1",role:"6",linkedUid:null,joined:false},
      {id:"r__7224",name:"왕종민",phone:"010-2044-7224",birth:"19950908",cellId:"c1",role:"7",linkedUid:null,joined:false},
      {id:"r__9728",name:"이은수",phone:"010-2288-9728",birth:"20050306",cellId:"c1",role:"8",linkedUid:null,joined:false},
      {id:"r__4230",name:"이지윤",phone:"010-2291-4230",birth:"20010626",cellId:"c1",role:"9",linkedUid:null,joined:false},
      {id:"r__0224",name:"전상록",phone:"010-9381-0224",birth:"",cellId:"c1",role:"10",linkedUid:null,joined:false},
      {id:"r__7440",name:"정의석",phone:"010-3871-7440",birth:"20020205",cellId:"c1",role:"11",linkedUid:null,joined:false},
      {id:"r__4080",name:"천사랑",phone:"010-8786-4080",birth:"20000710",cellId:"c1",role:"12",linkedUid:null,joined:false},
      {id:"r__8315",name:"오재준",phone:"010-3903-8315",birth:"20070323",cellId:"c1",role:"13",linkedUid:null,joined:false},
      {id:"r__5712",name:"김유나",phone:"010-8236-5712",birth:"20000118",cellId:"c2",role:"리더",linkedUid:null,joined:false},
      {id:"r__6517",name:"이혜영",phone:"010-6286-6517",birth:"20041110",cellId:"c2",role:"부리더",linkedUid:null,joined:false},
      {id:"r__0675",name:"권서영",phone:"010-9739-0675",birth:"20060413",cellId:"c2",role:"1",linkedUid:null,joined:false},
      {id:"r__5533",name:"김리나",phone:"010-7587-5533",birth:"19960803",cellId:"c2",role:"2",linkedUid:null,joined:false},
      {id:"r__6405",name:"김명희",phone:"010-8709-6405",birth:"19930709",cellId:"c2",role:"3",linkedUid:null,joined:false},
      {id:"r__7645",name:"김연태",phone:"010-2799-7645",birth:"19961117",cellId:"c2",role:"4",linkedUid:null,joined:false},
      {id:"r__7079",name:"김우재",phone:"010-9688-7079",birth:"19941014",cellId:"c2",role:"5",linkedUid:null,joined:false},
      {id:"r__8895",name:"김주헌",phone:"010-3934-8895",birth:"19981007",cellId:"c2",role:"6",linkedUid:null,joined:false},
      {id:"r__5449",name:"박찬홍",phone:"010-5477-5449",birth:"20020504",cellId:"c2",role:"7",linkedUid:null,joined:false},
      {id:"r__7072",name:"송진현",phone:"010-2380-7072",birth:"19990922",cellId:"c2",role:"8",linkedUid:null,joined:false},
      {id:"r__7160",name:"양희찬",phone:"010-7912-7160",birth:"19990617",cellId:"c2",role:"9",linkedUid:null,joined:false},
      {id:"r__1764",name:"이사라",phone:"010-8729-1764",birth:"19960308",cellId:"c2",role:"10",linkedUid:null,joined:false},
      {id:"r__5310",name:"임동민",phone:"010-2319-5310",birth:"20050201",cellId:"c2",role:"11",linkedUid:null,joined:false},
      {id:"r__2566",name:"토모카",phone:"010-9846-2566",birth:"20010110",cellId:"c2",role:"12",linkedUid:null,joined:false},
      {id:"r__7103",name:"김제현",phone:"010-3510-7103",birth:"20010129",cellId:"c3",role:"리더",linkedUid:null,joined:false},
      {id:"r__1943",name:"강유나",phone:"010-8994-1943",birth:"19980122",cellId:"c3",role:"1",linkedUid:null,joined:false},
      {id:"r__6163",name:"강은혜",phone:"010-9183-6163",birth:"19981014",cellId:"c3",role:"2",linkedUid:null,joined:false},
      {id:"r__5196",name:"강희영",phone:"010-6374-5196",birth:"20051011",cellId:"c3",role:"3",linkedUid:null,joined:false},
      {id:"r__5196",name:"강희윤",phone:"010-6359-5196",birth:"20031009",cellId:"c3",role:"4",linkedUid:null,joined:false},
      {id:"r__5712",name:"김서연",phone:"010-6494-5712",birth:"20050307",cellId:"c3",role:"5",linkedUid:null,joined:false},
      {id:"r__4106",name:"노승철",phone:"010-5536-4106",birth:"20021022",cellId:"c3",role:"6",linkedUid:null,joined:false},
      {id:"r__9382",name:"안사무엘",phone:"010-2571-9382",birth:"19930124",cellId:"c3",role:"7",linkedUid:null,joined:false},
      {id:"r__3192",name:"이건호",phone:"010-7552-3192",birth:"19920515",cellId:"c3",role:"8",linkedUid:null,joined:false},
      {id:"r__3327",name:"이준영",phone:"010-8867-3327",birth:"19991030",cellId:"c3",role:"9",linkedUid:null,joined:false},
      {id:"r__8772",name:"장서희",phone:"010-5733-8772",birth:"20060926",cellId:"c3",role:"10",linkedUid:null,joined:false},
      {id:"r__3108",name:"장수진",phone:"010-5742-3108",birth:"20060407",cellId:"c3",role:"11",linkedUid:null,joined:false},
      {id:"r__9118",name:"지정현",phone:"010-8954-9118",birth:"20001002",cellId:"c3",role:"12",linkedUid:null,joined:false},
      {id:"r__7399",name:"고범준",phone:"010-2310-7399",birth:"20070703",cellId:"c3",role:"13",linkedUid:null,joined:false},
      {id:"r__4728",name:"김예지",phone:"010-4370-4728",birth:"19971203",cellId:"c4",role:"리더",linkedUid:null,joined:false},
      {id:"r__7103",name:"김다현",phone:"010-9252-7103",birth:"19981101",cellId:"c4",role:"1",linkedUid:null,joined:false},
      {id:"r__2959",name:"김윤성",phone:"010-5527-2959",birth:"19920501",cellId:"c4",role:"2",linkedUid:null,joined:false},
      {id:"r__3461",name:"박건우",phone:"010-4033-3461",birth:"20020624",cellId:"c4",role:"3",linkedUid:null,joined:false},
      {id:"r__5449",name:"박세림",phone:"010-3048-5449",birth:"20041001",cellId:"c4",role:"4",linkedUid:null,joined:false},
      {id:"r__4528",name:"박채은",phone:"010-5453-4528",birth:"20060923",cellId:"c4",role:"5",linkedUid:null,joined:false},
      {id:"r__4230",name:"이민우",phone:"010-7544-4230",birth:"20040216",cellId:"c4",role:"6",linkedUid:null,joined:false},
      {id:"r__1764",name:"이상재",phone:"010-4177-1764",birth:"19940328",cellId:"c4",role:"7",linkedUid:null,joined:false},
      {id:"r__0929",name:"장은지",phone:"010-9026-0929",birth:"19980926",cellId:"c4",role:"8",linkedUid:null,joined:false},
      {id:"r__0547",name:"정유승",phone:"010-9459-0547",birth:"19990428",cellId:"c4",role:"9",linkedUid:null,joined:false},
      {id:"r__2066",name:"조민수",phone:"010-2083-2066",birth:"19901012",cellId:"c4",role:"10",linkedUid:null,joined:false},
      {id:"r__9870",name:"최찬영",phone:"010-4925-9870",birth:"19980618",cellId:"c4",role:"11",linkedUid:null,joined:false},
      {id:"r__9757",name:"홍석준",phone:"010-9487-9757",birth:"19960831",cellId:"c4",role:"12",linkedUid:null,joined:false},
      {id:"r__7069",name:"황지현",phone:"010-5458-7069",birth:"19990926",cellId:"c4",role:"13",linkedUid:null,joined:false}
    ];
    rosters.forEach(r => batch.set(doc(db,'rosters',r.id), r));

    const notices = [
      { id:'n1', title:'동계 수련회 신청 마감 안내', body:'1월 15일(수)까지 신청을 완료해 주세요.\n장소: 양평 수양관\n참가비: 50,000원', by:'admin1', at:'2026-02-20', pinned:true, images:[] },
      { id:'n2', title:'12월 섬김이 일정 공유', body:'찬양팀·기도팀·안내팀 스케줄이 확정되었습니다.', by:'admin1', at:'2026-02-19', pinned:false, images:[] },
    ];
    notices.forEach(n => batch.set(doc(db,'notices',n.id), n));

    const bulletins = [
      { id:'b1', title:'2026년 2월 22일 주보', date:'2026-02-22', by:'admin1', at:'2026-02-21',
        order:'1. 예배의 부름\n2. 경배와 찬양\n3. 대표기도\n4. 성경봉독\n5. 말씀 선포\n6. 봉헌\n7. 봉헌기도\n8. 광고(성도의 교제)\n9. 축도',
        announce:'• 동계 수련회 신청 마감: 1월 15일\n• 새가족 환영: 한소망 자매',
        prayer_duty:'정하은', bible_reading:'박민준', offering_duty:'최유진', announcement_duty:'이서연',
        songs:'1. 주님 한 분만으로 (Key: G)\n2. Good Grace (Key: A)\n3. 오직 주만이 (Key: D)' }
    ];
    bulletins.forEach(b => batch.set(doc(db,'bulletins',b.id), b));

    const worships = [
      { id:'w1', date:'2026-02-22', leader:'김창대',
        songs:[
          { title:'주님 한 분만으로', url:'', key:'G', sheet:'' },
          { title:'Good Grace', url:'', key:'A', sheet:'' },
        ],
        by:'admin1', at:'2026-02-20', storedAt:'2026-02-20' }
    ];
    worships.forEach(w => batch.set(doc(db,'worshipSets',w.id), w));

    const events = [
      { id:'e1', title:'주일 청년 예배', date:'2026-02-22', time:'14:00', loc:'본당', cat:'예배' },
      { id:'e2', title:'목장 리더 모임', date:'2026-03-05', time:'19:00', loc:'교육관', cat:'모임' },
    ];
    events.forEach(e => batch.set(doc(db,'events',e.id), e));

    const cellMeetings = [
      { id:'cm1', date:'2026-02-22', verse:'요한복음 15:1-8', verseText:'"나는 포도나무요 너희는 가지라"',
        questions:['오늘 말씀에서 가장 와닿은 부분은 무엇인가요?','이번 주 나의 삶에서 예수님께 더 의지해야 할 부분은?'],
        prayerItems:'• 우리 목장 모든 지체를 위해\n• 약속의 땅 청년부 부흥을 위해', by:'admin1', at:'2026-02-20' }
    ];
    cellMeetings.forEach(m => batch.set(doc(db,'cellMeetings',m.id), m));

    batch.set(doc(db,'meta','seeded'), { at: new Date().toISOString() });
    await batch.commit();
    console.log('Firestore seeded');
  }

  // ============================================================
  // INIT APP AFTER FIREBASE READY
  // ============================================================
  // FDB 준비 완료 → 즉시 앱 시작
  window._fbReady = true;
  if (window._appInit) window._appInit();
  // seed는 백그라운드 (앱 시작 블로킹 안 함)
  seedIfNeeded().catch(e => console.warn('seed:', e));
</script>
<script>
tailwind.config = {
  theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] } } }
}
</script>
<style>
  * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
  html { overflow-y: scroll; scrollbar-gutter: stable; }
  body { font-family: 'Inter', sans-serif; overscroll-behavior: none; }
  body.no-scroll { overflow: hidden; position: fixed; width: 100%; height: 100%; }
  .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24; }
  .material-symbols-outlined.filled { font-variation-settings: 'FILL' 1, 'wght' 300, 'GRAD' 0, 'opsz' 24; }
  ::-webkit-scrollbar { display: none; }
  * { -ms-overflow-style: none; scrollbar-width: none; }
  .hide-scrollbar::-webkit-scrollbar { display: none; }
  .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

  /* ── 모션: 탑앱 스타일 (iOS/Android 네이티브 패턴) ── */
  /* 탭전환: 즉시(모션 없음) - 카카오/인스타/유튜브 모두 탭은 즉시 */
  /* 상세진입: 아래서 살짝 올라오며 페이드 - 자연스럽고 가벼움 */
  /* 전체화면: 오른쪽에서 슬라이드 - 네이티브 push 느낌 */
  /* 시트/모달: 아래서 슬라이드업 */

  @keyframes _pushIn {
    from { transform: translateX(40px); opacity: 0; }
    to   { transform: translateX(0);    opacity: 1; }
  }
  @keyframes _riseIn {
    from { transform: translateY(10px); opacity: 0; }
    to   { transform: translateY(0);    opacity: 1; }
  }
  @keyframes _sheetUp {
    from { transform: translateY(100%); }
    to   { transform: translateY(0); }
  }
  @keyframes _overlayIn {
    from { opacity: 0; }
    to   { opacity: 1; }
  }
  @keyframes _toastUp {
    from { transform: translateY(8px) translateX(-50%); opacity:0; }
    to   { transform: translateY(0)   translateX(-50%); opacity:1; }
  }

  /* 전체화면 전환 (admin, profile 페이지) */
  .slide-in-right { animation: _pushIn 0.26s cubic-bezier(0.25,0.46,0.45,0.94) both; }
  .slide-in-left  { animation: _pushIn 0.26s cubic-bezier(0.25,0.46,0.45,0.94) both; }

  /* 상세 페이지 (notice/bulletin/worship detail) */
  .detail-page { animation: _pushIn 0.26s cubic-bezier(0.25,0.46,0.45,0.94) both; }

  /* 콘텐츠 영역 (탭 전환 - 매우 가볍게) */
  .tab-content { animation: _riseIn 0.16s ease both; }

  /* 메인/로그인 등 첫 진입 */
  .fade-in   { animation: _riseIn 0.2s ease both; }
  .scale-in  { animation: _riseIn 0.2s ease both; }
  .pop-in    { animation: _riseIn 0.2s ease both; }

  /* 시트/모달 */
  .slide-up     { animation: _sheetUp 0.32s cubic-bezier(0.32,0.72,0,1) both; }
  .modal-sheet  { animation: _sheetUp 0.32s cubic-bezier(0.32,0.72,0,1) both; }
  .modal-overlay{ animation: _overlayIn 0.18s ease both; }
  .login-page   { animation: _riseIn 0.22s ease both; }

  /* 토스트 */
  .toast-anim { animation: _toastUp 0.22s cubic-bezier(0.32,0.72,0,1) both; }

  .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  input, textarea, select { font-family: 'Inter', sans-serif; }
  .dot-pattern { background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.08) 1px, transparent 0); background-size: 20px 20px; }
  .fixed-layout { position: fixed; inset: 0; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; }
  .cal-sun { color: #ef4444; }
  .cal-sat { color: #3b82f6; }
  .profile-img-clip { overflow: hidden; cursor: grab; }
  .profile-img-clip:active { cursor: grabbing; }
  /* 크롭 모달 */
  #crop-modal canvas { touch-action: none; }
</style>
</head>
<body class="bg-zinc-50 text-black min-h-screen">
<div id="app" style="background:#f4f4f5;min-height:100vh;"><div class="fixed-layout"><div class="w-8 h-8 border-2 border-black border-t-transparent rounded-full animate-spin"></div></div></div>

<script>
// ============================================================
// KOREAN PUBLIC HOLIDAYS
// ============================================================
const HOLIDAYS = new Set(['01-01','03-01','05-05','06-06','08-15','10-03','10-09','12-25']);
function isHoliday(ds) { return HOLIDAYS.has(ds.slice(5)); }

// ============================================================
// STATE
// ============================================================
let state = {
  user: null,
  page: 'loading',
  tab: 'home',
  detail: null,
  adminSub: 'dashboard',
  profileOpen: false,
  profilePage: null,
  toast: null,
  adminRosterTab: 'all',
  adminAttTab: null,
  _pendingProfileImg: null,
  _pendingProfileFile: null,
  _profileImgOffset: { x: 0, y: 0 },
  _calSel: null,
  _calMonth: null,
  _attDate: null,
  _offDate: null,
  _confirmModal: null,
  _cropModal: null,
  // Firestore 캐시
  cache: {
    users: [], cells: [], rosters: [], notices: [], bulletins: [],
    worshipSets: [], events: [], cellMeetings: [], notifications: [],
    attendance: {}, offerings: {}, comments: {}
  }
};

const uid = () => Math.random().toString(36).substr(2, 9);
const today = () => new Date().toISOString().split('T')[0];
const fmtPhone = v => { const d = v.replace(/\D/g,''); if(d.length<=3) return d; if(d.length<=7) return d.slice(0,3)+'-'+d.slice(3); return d.slice(0,3)+'-'+d.slice(3,7)+'-'+d.slice(7,11); };
const fmtDate = v => { if(!v) return ''; const d = String(v).replace(/\D/g,''); if(d.length===8) return d.slice(0,4)+'.'+d.slice(4,6)+'.'+d.slice(6,8); return v; };
const fmtAmt = v => Number(v).toLocaleString();

// localStorage: 현재 로그인 유저만 유지
const SESSION = {
  get() { try { return JSON.parse(localStorage.getItem('jmc_session') || 'null'); } catch { return null; } },
  set(u) { localStorage.setItem('jmc_session', JSON.stringify(u)); },
  clear() { localStorage.removeItem('jmc_session'); }
};

// ============================================================
// FIREBASE LOADER
// ============================================================
async function loadAll() {
  const FDB = window.FDB;
  const [users, cells, rosters, notices, bulletins, worshipSets, events, cellMeetings] = await Promise.all([
    FDB.getCol('users'), FDB.getCol('cells'), FDB.getCol('rosters'),
    FDB.getCol('notices'), FDB.getCol('bulletins'), FDB.getCol('worshipSets'),
    FDB.getCol('events'), FDB.getCol('cellMeetings')
  ]);
  state.cache.users = users;
  state.cache.cells = cells.sort((a,b)=>(a.order||0)-(b.order||0));
  state.cache.rosters = rosters;
  state.cache.notices = notices.sort((a,b)=>b.at.localeCompare(a.at));
  state.cache.bulletins = bulletins.sort((a,b)=>a.date.localeCompare(b.date));
  state.cache.worshipSets = worshipSets.sort((a,b)=>a.date.localeCompare(b.date));
  state.cache.events = events.sort((a,b)=>a.date.localeCompare(b.date));
  state.cache.cellMeetings = cellMeetings.sort((a,b)=>b.date.localeCompare(a.date));
}

// ============================================================
// CONFIRM MODAL
// ============================================================
function showConfirm(msg, onYes, yesLabel='삭제', yesClass='bg-red-500 text-white') {
  state._confirmModal = { msg, onYes, yesLabel, yesClass };
  render();
}

function renderConfirmModal() {
  if (!state._confirmModal) return '';
  const { msg, yesLabel, yesClass } = state._confirmModal;
  return `
  <div id="confirm-overlay" class="fixed inset-0 z-[300] bg-black/50 backdrop-blur-sm modal-overlay flex items-center justify-center px-6">
    <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl fade-in">
      <p class="text-base font-bold text-center mb-2">확인</p>
      <p class="text-sm text-zinc-500 text-center leading-relaxed mb-6">${msg}</p>
      <div class="flex gap-3">
        <button id="confirm-no" class="flex-1 py-3 border border-zinc-200 rounded-2xl text-sm font-bold">취소</button>
        <button id="confirm-yes" class="flex-1 py-3 ${yesClass} rounded-2xl text-sm font-bold">${yesLabel}</button>
      </div>
    </div>
  </div>`;
}

// ============================================================
// CROP MODAL
// ============================================================
function renderCropModal() {
  if (!state._cropModal) return '';
  const src = state._cropModal.src;
  const scaleVal = Math.round((state._cropModal.w / state._cropModal.origW) * 100);
  const SIZE = 240;
  return `
  <div id="crop-modal" class="fixed inset-0 z-[310] bg-black/75 backdrop-blur-sm flex items-end sm:items-center justify-center">
    <div class="bg-white w-full sm:rounded-3xl sm:max-w-sm sm:mx-6 rounded-t-3xl shadow-2xl" style="animation:_sheetUp 0.3s cubic-bezier(0.32,0.72,0,1) both">
      <!-- 헤더 -->
      <div class="flex items-center justify-between px-5 py-4 border-b border-zinc-100">
        <button id="crop-cancel" class="text-sm text-zinc-500 font-medium px-1 py-1">취소</button>
        <p class="text-sm font-bold">프로필 사진</p>
        <button id="crop-confirm" class="text-sm font-bold text-black px-1 py-1">완료</button>
      </div>
      <!-- 크롭 영역 -->
      <div class="relative bg-zinc-900 flex items-center justify-center select-none" style="height:300px;">
        <!-- 배경 (오버레이) -->
        <div id="crop-overlay" style="position:absolute;inset:0;pointer-events:none;">
          <svg width="100%" height="100%" style="position:absolute;inset:0;">
            <defs>
              <mask id="circleMask">
                <rect width="100%" height="100%" fill="white"/>
                <circle cx="50%" cy="50%" r="${SIZE/2}" fill="black"/>
              </mask>
            </defs>
            <rect width="100%" height="100%" fill="rgba(0,0,0,0.55)" mask="url(#circleMask)"/>
            <circle cx="50%" cy="50%" r="${SIZE/2 - 1}" fill="none" stroke="rgba(255,255,255,0.8)" stroke-width="2"/>
          </svg>
        </div>
        <!-- 이미지 드래그 영역 (전체 영역) -->
        <div id="crop-drag-area" style="position:absolute;inset:0;touch-action:none;cursor:grab;overflow:hidden;">
          <img id="crop-img" src="${src}"
            style="position:absolute;width:${state._cropModal.w}px;height:${state._cropModal.h}px;left:${state._cropModal.ox}px;top:${state._cropModal.oy}px;user-select:none;-webkit-user-drag:none;pointer-events:none;"
            draggable="false"/>
        </div>
      </div>
      <!-- 컨트롤 -->
      <div class="px-5 pt-4 pb-6 space-y-2">
        <div class="flex items-center gap-3">
          <span class="text-zinc-400 text-xs w-6 text-center">−</span>
          <input id="crop-scale" type="range" min="100" max="350" value="${scaleVal}" class="flex-1 accent-black h-1.5" style="cursor:pointer"/>
          <span class="text-zinc-600 text-xs w-6 text-center">+</span>
        </div>
        <p class="text-[11px] text-zinc-400 text-center" id="crop-hint">
          <span class="hidden sm:inline">마우스로 드래그해서 위치 조정</span>
          <span class="sm:hidden">한 손가락으로 이동 · 두 손가락으로 확대축소</span>
        </p>
      </div>
    </div>
  </div>`;
}

// ============================================================
// LOGO
// ============================================================
// YouTube 썸네일 추출
function getYtThumb(url) {
  if (!url) return null;
  const m = url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|shorts\/))([\w-]{11})/);
  return m ? `https://img.youtube.com/vi/${m[1]}/mqdefault.jpg` : null;
}

function logoImg(cls='w-10 h-10') {
  return `<img src="asset/logo.png" class="${cls} object-contain" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" alt="logo"/>
          <div class="hidden ${cls} bg-black rounded-xl items-center justify-center"><span class="text-white font-black text-sm">PL</span></div>`;
}

// ============================================================
// RENDER
// ============================================================
function render() {
  const app = document.getElementById('app');
  let html = '';

  if (state.page === 'loading') {
    html = `<div class="fixed-layout"><div class="w-8 h-8 border-2 border-black border-t-transparent rounded-full animate-spin"></div></div>`;
  } else if (!state.user) {
    if (state.page === 'register') html = renderRegister();
    else html = renderLogin();
    document.body.classList.add('no-scroll');
  } else {
    document.body.classList.remove('no-scroll');
    if (state.page === 'admin') html = renderAdmin();
    else if (state.profilePage) html = renderProfilePage();
    else if (state.detail) {
      if (state.detail.type === 'bulletin') html = renderBulletinDetail();
      else if (state.detail.type === 'notice') html = renderNoticeDetail();
      else if (state.detail.type === 'worship') html = renderWorshipDetail();
      else html = renderMain();
    } else {
      html = renderMain();
    }
  }

  // 프로필 시트는 항상 최상위 레이어로 (스크롤 영향 없음)
  if (state.profileOpen) html += renderProfileSheet();

  if (state.toast) {
    html += `<div class="fixed top-20 left-1/2 -translate-x-1/2 z-[200] bg-black text-white px-5 py-3 rounded-2xl text-sm font-bold shadow-xl toast-anim">${state.toast}</div>`;
  }

  html += renderConfirmModal();
  html += renderCropModal();

  // 깜빡임 완전 제거: 배경색 고정 + 즉시 교체
  // CSS 애니메이션이 자식 요소에서 처리하므로 app 자체는 즉시 교체
  app.style.transition = '';
  app.style.opacity = '1';
  app.innerHTML = html;
  bindEvents();
  bindCropModal();
}

function showToast(msg) {
  state.toast = msg;
  render();
  setTimeout(() => { state.toast = null; render(); }, 2200);
}

function icon(name, cls='', size=24, fill=false) {
  return `<span class="material-symbols-outlined ${fill?'filled':''} ${cls}" style="font-size:${size}px">${name}</span>`;
}

// ============================================================
// LOGIN
// ============================================================
function renderLogin() {
  return `
  <div class="fixed-layout bg-white login-page px-8">
    <div class="w-full max-w-sm">
      <div class="text-center mb-10">
        <div class="w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-5 overflow-hidden bg-black">
          ${logoImg('w-20 h-20')}
        </div>
        <h1 class="text-2xl font-bold tracking-tight">약속의 땅</h1>
        <p class="text-zinc-400 text-sm mt-1">청년부 커뮤니티</p>
      </div>
      <div class="space-y-4">
        <input id="login-id" type="text" placeholder="아이디" class="w-full px-4 py-3.5 bg-zinc-50 border border-zinc-200 rounded-2xl text-sm focus:outline-none focus:border-black focus:ring-1 focus:ring-black"/>
        <input id="login-pw" type="password" placeholder="비밀번호" class="w-full px-4 py-3.5 bg-zinc-50 border border-zinc-200 rounded-2xl text-sm focus:outline-none focus:border-black focus:ring-1 focus:ring-black"/>
        <div id="login-error" class="text-red-500 text-xs font-medium px-1 hidden"></div>
        <button id="btn-login" class="w-full py-3.5 bg-black text-white rounded-2xl font-bold text-sm transition-opacity active:opacity-70">로그인</button>
      </div>
      <div class="text-center mt-6">
        <button id="btn-go-register" class="text-sm text-zinc-500 font-medium">
          아직 계정이 없으신가요? <span class="text-black font-bold underline underline-offset-2">회원가입</span>
        </button>
      </div>
    </div>
  </div>`;
}

// ============================================================
// REGISTER
// ============================================================
function renderRegister() {
  return `
  <div class="fixed-layout bg-white overflow-y-auto slide-in-right" style="position:fixed;inset:0;overflow-y:auto;display:block;">
    <div class="px-6 py-8 max-w-sm mx-auto">
      <button id="btn-back-login" class="flex items-center gap-1 text-sm text-zinc-500 mb-6">${icon('arrow_back','',20)} 뒤로</button>
      <h1 class="text-2xl font-bold mb-1">회원가입</h1>
      <p class="text-zinc-400 text-sm mb-8">약속의 땅 청년부 커뮤니티에 가입합니다.</p>
      <div class="space-y-4">
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">이름</label><input id="reg-name" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="홍길동"/></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">전화번호</label><input id="reg-phone" inputmode="numeric" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="010-1234-5678"/></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">생년월일</label><input id="reg-birth" inputmode="numeric" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="1995.03.15"/></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">아이디</label><input id="reg-id" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="사용할 아이디"/></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">비밀번호</label><input id="reg-pw" type="password" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="영문+숫자 혼합 8자 이상"/></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">비밀번호 확인</label><input id="reg-pw2" type="password" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="비밀번호 재입력"/></div>
        <label class="flex items-start gap-3 pt-2">
          <input id="reg-agree" type="checkbox" class="mt-0.5 w-5 h-5 rounded border-zinc-300 accent-black"/>
          <span class="text-xs text-zinc-500 leading-relaxed">개인정보(이름, 전화번호, 생년월일) 수집·이용에 동의합니다.</span>
        </label>
        <div id="reg-error" class="text-red-500 text-xs font-medium hidden"></div>
        <button id="btn-register" class="w-full py-3.5 bg-black text-white rounded-2xl font-bold text-sm transition-opacity active:opacity-70">가입 신청</button>
      </div>
    </div>
  </div>`;
}

// ============================================================
// MAIN (tabs)
// ============================================================
function renderMain() {
  const u = state.user;
  const notis = state.cache.notifications || [];
  let content = '';
  if (state.tab === 'home') content = renderHomeTab();
  else if (state.tab === 'bulletin') content = renderBulletinTab();
  else if (state.tab === 'notice') content = renderNoticeTab();
  else if (state.tab === 'calendar') content = renderCalendarTab();
  else if (state.tab === 'cell') content = renderCellTab();

  const tabs = [
    { key:'home', icon:'home', label:'홈' },
    { key:'bulletin', icon:'menu_book', label:'주보' },
    { key:'notice', icon:'campaign', label:'공지' },
    { key:'calendar', icon:'calendar_month', label:'일정' },
    { key:'cell', icon:'groups', label:'목장' },
  ];

  return `
  <div class="min-h-screen bg-zinc-100/60 pb-36 fade-in">
    <!-- Header -->
    <header class="sticky top-0 z-50 px-5 pt-3 pb-3 bg-white/90 backdrop-blur-xl border-b border-zinc-100">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl overflow-hidden bg-black flex items-center justify-center">
            ${logoImg('w-10 h-10')}
          </div>
          <div>
            <p class="text-[10px] font-bold text-zinc-400 uppercase tracking-[0.15em]">약속의 땅</p>
            <h1 class="text-lg font-bold tracking-tight">${u.name} <span class="text-xs font-light text-zinc-400 tracking-normal ml-1">청년</span></h1>
          </div>
        </div>
        <div class="flex gap-2">
          <button data-action="open-profile" class="relative w-10 h-10 rounded-full bg-zinc-200 flex items-center justify-center border-2 border-black overflow-hidden">
            ${u.profileImg ? `<img src="${u.profileImg}" class="w-full h-full object-cover"/>` : `<span class="text-sm font-bold text-zinc-500">${(u.name||'?')[0]}</span>`}
          </button>
        </div>
      </div>
    </header>

    <main class="px-5 mt-5 pb-8"><div class="tab-content space-y-10">${content}</div></main>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 left-0 right-0 z-50 px-2 pb-7 pt-3 bg-white/90 backdrop-blur-xl border-t border-zinc-100">
      <div class="flex justify-around items-center max-w-md mx-auto">
        ${tabs.map(t => `
          <button data-tab="${t.key}" class="flex flex-col items-center gap-0.5 px-4 py-1 transition-colors ${state.tab===t.key?'text-black':'text-zinc-400'}">
            ${icon(t.icon,'',26,state.tab===t.key)}
            <span class="text-[10px] font-bold tracking-wider">${t.label}</span>
          </button>
        `).join('')}
      </div>
    </nav>

  </div>`;
}

// ============================================================
// PROFILE SHEET
// ============================================================
function renderProfileSheet() {
  const u = state.user;
  const isAdmin = u.role === 'admin';
  const cells = state.cache.cells;
  const cell = cells.find(c => c.id === u.cellId);
  return `
  <div data-action="close-profile" class="fixed inset-0 z-[100] bg-black/40 backdrop-blur-sm modal-overlay"></div>
  <div class="fixed bottom-0 left-0 right-0 z-[101] bg-white rounded-t-3xl shadow-2xl modal-sheet">
    <div class="flex justify-center pt-3 pb-1"><div class="w-10 h-1 bg-zinc-200 rounded-full"></div></div>
    <div class="flex items-center gap-4 px-6 py-5 border-b border-zinc-100">
      ${u.profileImg ? `<div class="w-14 h-14 rounded-full bg-zinc-200 flex items-center justify-center border-2 border-black overflow-hidden"><img src="${u.profileImg}" class="w-full h-full object-cover"/></div>` :
        `<div class="w-14 h-14 rounded-full bg-zinc-200 flex items-center justify-center border-2 border-black"><span class="text-xl font-bold text-zinc-500">${(u.name||'?')[0]}</span></div>`}
      <div>
        <p class="font-bold text-base">${u.name}</p>
        <p class="text-sm text-zinc-400">${cell ? cell.name : '목장 미배정'} · ${isAdmin?'관리자':'청년부원'}</p>
      </div>
    </div>
    <div class="px-4 py-3 space-y-1">
      ${isAdmin ? `
      <button data-action="go-admin" class="w-full flex items-center gap-4 px-4 py-4 rounded-2xl active:bg-zinc-50 transition-colors text-left">
        <div class="w-10 h-10 bg-zinc-100 rounded-xl flex items-center justify-center">${icon('admin_panel_settings','text-black')}</div>
        <div class="flex-1"><p class="font-bold text-sm">관리자 페이지</p><p class="text-xs text-zinc-400">주보·찬양·공지·출석·헌금 관리</p></div>
        ${icon('chevron_right','text-zinc-300',20)}
      </button>` : ''}
      <button data-profile-page="edit" class="w-full flex items-center gap-4 px-4 py-4 rounded-2xl active:bg-zinc-50 transition-colors text-left">
        <div class="w-10 h-10 bg-zinc-100 rounded-xl flex items-center justify-center">${icon('person','text-black')}</div>
        <div class="flex-1"><p class="font-bold text-sm">프로필 수정</p><p class="text-xs text-zinc-400">사진, 목장, 연락처, 생년월일</p></div>
        ${icon('chevron_right','text-zinc-300',20)}
      </button>
      <button data-profile-page="noti" class="w-full flex items-center gap-4 px-4 py-4 rounded-2xl active:bg-zinc-50 transition-colors text-left">
        <div class="w-10 h-10 bg-zinc-100 rounded-xl flex items-center justify-center">${icon('notifications','text-black')}</div>
        <div class="flex-1"><p class="font-bold text-sm">알림 설정</p><p class="text-xs text-zinc-400">찬양·공지·말씀·일정·담당자</p></div>
        ${icon('chevron_right','text-zinc-300',20)}
      </button>
      <button data-profile-page="settings" class="w-full flex items-center gap-4 px-4 py-4 rounded-2xl active:bg-zinc-50 transition-colors text-left">
        <div class="w-10 h-10 bg-zinc-100 rounded-xl flex items-center justify-center">${icon('settings','text-black')}</div>
        <div class="flex-1"><p class="font-bold text-sm">설정</p><p class="text-xs text-zinc-400">비밀번호 변경, 계정 관리</p></div>
        ${icon('chevron_right','text-zinc-300',20)}
      </button>
      <button data-action="logout" class="w-full flex items-center gap-4 px-4 py-4 rounded-2xl active:bg-red-50 transition-colors text-left">
        <div class="w-10 h-10 bg-red-50 rounded-xl flex items-center justify-center">${icon('logout','text-red-500')}</div>
        <p class="font-bold text-sm text-red-500">로그아웃</p>
      </button>
    </div>
    <div class="h-8"></div>
  </div>`;
}

// ============================================================
// HOME TAB
// ============================================================
function renderHomeTab() {
  const bulletins = state.cache.bulletins;
  const worships = state.cache.worshipSets;
  const notices = state.cache.notices;
  const events = state.cache.events;
  const latest = worships[worships.length - 1];
  const lb = bulletins[bulletins.length - 1];

  const dutySection = lb ? `
  <section>
    <h2 class="text-lg font-bold tracking-tight mb-5">금주 예배 담당</h2>
    <div class="bg-white rounded-2xl border border-zinc-100 overflow-hidden">
      <div class="bg-black px-5 py-3 flex items-center gap-2">
        ${icon('church','text-white',18)}
        <span class="text-white text-xs font-bold">${lb.date} 예배</span>
      </div>
      <div class="divide-y divide-zinc-50">
        ${[
          {l:'대표기도', v:lb.prayer_duty||'미정', i:'volunteer_activism'},
          {l:'성경봉독', v:lb.bible_reading||'미정', i:'menu_book'},
          {l:'성도의 교제', v:lb.announcement_duty||'미정', i:'campaign'},
          {l:'봉헌', v:lb.offering_duty||'미정', i:'favorite'},
        ].map(d => `
        <div class="flex items-center gap-3 px-5 py-4">
          <div class="w-8 h-8 bg-zinc-100 rounded-lg flex items-center justify-center flex-none">${icon(d.i,'text-zinc-600',16)}</div>
          <span class="text-xs text-zinc-400 w-20 flex-none">${d.l}</span>
          <span class="text-sm font-bold">${d.v}</span>
        </div>`).join('')}
      </div>
    </div>
  </section>` : `
  <section>
    <div class="bg-zinc-50 rounded-2xl p-6 text-center">
      <p class="text-sm text-zinc-400">등록된 주보가 없습니다</p>
    </div>
  </section>`;

  return `
  <section>
    <div class="bg-black rounded-3xl p-7 text-white relative overflow-hidden">
      <div class="relative z-10">
        <span class="px-2.5 py-1 bg-white/10 border border-white/20 rounded-lg text-[10px] font-bold uppercase tracking-wider">오늘의 말씀</span>
        <blockquote class="text-xl font-bold leading-snug mt-5 mb-4">"내게 능력 주시는 자 안에서<br/>내가 모든 것을 할 수 있느니라"</blockquote>
        <p class="text-zinc-400 text-sm">빌립보서 4:13</p>
      </div>
      <div class="absolute -right-10 -bottom-10 w-48 h-48 bg-white/5 rounded-full blur-3xl"></div>
      <div class="absolute -right-4 top-4 opacity-[0.06]">${icon('menu_book','text-white',120)}</div>
    </div>
  </section>
  <div class="h-3"></div>
  ${dutySection}
  ${latest ? `
  <div class="h-3"></div><section>
    <div class="flex justify-between items-center mb-5">
      <h3 class="text-base font-bold flex items-center gap-1.5">${icon('music_note','',18)} 이번주 찬양</h3>
      <button data-action="go-worship" class="text-zinc-400 text-xs font-bold">전체보기</button>
    </div>
    <div class="flex gap-3 overflow-x-auto pb-1 -mx-5 px-5 hide-scrollbar">
      ${latest.songs.map((s,i) => {
        const thumb = getYtThumb(s.url);
        return `<button data-worship-play="${i}" class="flex-none w-36 bg-white rounded-2xl border border-zinc-200 overflow-hidden active:bg-zinc-50 transition-colors text-left">
          <div class="w-full h-24 bg-zinc-100 flex items-center justify-center overflow-hidden relative">
            ${thumb
              ? `<img src="${thumb}" class="w-full h-full object-cover" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"/>
                 <div class="hidden w-full h-full items-center justify-center"><img src="asset/logo.png" class="w-12 h-12 object-contain opacity-30"/></div>
                 <div class="absolute inset-0 flex items-center justify-center"><div class="w-8 h-8 bg-black/60 rounded-full flex items-center justify-center">${icon('play_arrow','text-white',18)}</div></div>`
              : `<img src="asset/logo.png" class="w-12 h-12 object-contain opacity-30"/>`
            }
          </div>
          <div class="p-3">
            <p class="text-xs font-bold leading-tight truncate">${s.title}</p>
            <p class="text-[10px] text-zinc-400 mt-0.5">Key: ${s.key}</p>
          </div>
        </button>`;
      }).join('')}
    </div>
  </section>` : ''}
  <div class="h-3"></div>
  <section>
    <div class="flex justify-between items-center mb-5">
      <h3 class="text-base font-bold flex items-center gap-1.5">${icon('campaign','',18)} 공지사항</h3>
      <button data-tab="notice" class="text-zinc-400 text-xs font-bold">전체보기</button>
    </div>
    <div class="space-y-3">
      ${notices.slice(0,3).map(n => `
        <button data-detail="notice:${n.id}" class="w-full flex items-start gap-3 bg-white p-4 rounded-2xl border border-zinc-100 active:bg-zinc-50 transition-colors text-left">
          <div class="w-8 h-8 ${n.pinned?'bg-black':'bg-zinc-100'} rounded-lg flex items-center justify-center flex-none mt-0.5">
            ${icon(n.pinned?'priority_high':'info','',16,false)}
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-bold leading-tight">${n.title}</p>
            <p class="text-xs text-zinc-400 mt-0.5 truncate">${n.body.split('\n')[0]}</p>
          </div>
          <span class="text-[10px] text-zinc-300 font-medium flex-none">${n.at.slice(5)}</span>
        </button>
      `).join('')}
    </div>
  </section>
  <div class="h-3"></div>
  <section class="pb-8">
    <div class="flex justify-between items-center mb-5">
      <h3 class="text-base font-bold flex items-center gap-1.5">${icon('calendar_month','',18)} 다가오는 일정</h3>
      <button data-tab="calendar" class="text-zinc-400 text-xs font-bold">전체보기</button>
    </div>
    <div class="space-y-3">
      ${events.slice(0,3).map(ev => {
        const d = new Date(ev.date); const m = d.getMonth()+1; const day = d.getDate();
        const isW = ev.cat === '예배';
        return `
        <div class="flex items-center gap-4 bg-white p-4 rounded-2xl border border-zinc-100">
          <div class="w-12 h-12 ${isW?'bg-black':'bg-zinc-100'} rounded-xl flex flex-col items-center justify-center flex-none">
            <span class="text-[9px] font-black uppercase ${isW?'text-white/60':'text-zinc-400'}">${m}월</span>
            <span class="text-lg font-bold leading-none ${isW?'text-white':'text-black'}">${day}</span>
          </div>
          <div class="flex-1">
            <span class="text-[10px] font-bold bg-zinc-100 text-zinc-500 px-1.5 py-0.5 rounded">${ev.cat}</span>
            <h4 class="font-bold text-sm text-black mt-0.5">${ev.title}</h4>
            ${(ev.loc||ev.time)?`<p class="text-xs text-zinc-400">${[ev.loc,ev.time].filter(Boolean).join(' · ')}</p>`:''}
          </div>
        </div>`;
      }).join('')}
    </div>
  </section>`;
}

// ============================================================
// BULLETIN TAB
// ============================================================
function renderBulletinTab() {
  const bulletins = [...state.cache.bulletins].reverse();
  return `
  <section>
    <h2 class="text-xl font-bold tracking-tight mb-6">주보</h2>
    <div class="space-y-5">
      ${bulletins.map(b => `
        <button data-detail="bulletin:${b.id}" class="w-full text-left bg-white rounded-3xl border border-zinc-200 overflow-hidden active:bg-zinc-50 transition-colors">
          <div class="bg-gradient-to-br from-zinc-900 to-black p-6 text-white relative overflow-hidden dot-pattern">
            <div class="relative z-10">
              <div class="flex items-center gap-2 mb-3">
                <div class="w-8 h-8 bg-white/10 rounded-lg flex items-center justify-center">${icon('menu_book','text-white',18)}</div>
                <span class="text-[10px] font-bold uppercase tracking-wider text-white/60">주일 예배 주보</span>
              </div>
              <h3 class="text-lg font-bold">${b.title}</h3>
              <p class="text-white/50 text-xs mt-1">${b.date}</p>
            </div>
          </div>
          <div class="p-4">
            <p class="text-xs text-zinc-400 line-clamp-2">${b.order?.split('\n').slice(0,2).join(' / ')}</p>
            <div class="flex items-center gap-1 mt-2 text-zinc-300">
              ${icon('chevron_right','',16)}<span class="text-[10px] font-bold">자세히 보기</span>
            </div>
          </div>
        </button>
      `).join('')}
    </div>
  </section>`;
}

// ============================================================
// BULLETIN DETAIL
// ============================================================
function renderBulletinDetail() {
  const b = state.cache.bulletins.find(x => x.id === state.detail.id);
  if (!b) return '';
  const sections = [
    { i:'format_list_numbered', t:'예배순서', c:b.order },
    { i:'volunteer_activism', t:'대표기도', c:b.prayer_duty },
    { i:'menu_book', t:'성경봉독', c:b.bible_reading },
    { i:'campaign', t:'성도의 교제 (광고)', c:b.announcement_duty },
    { i:'favorite', t:'봉헌', c:b.offering_duty },
    { i:'music_note', t:'찬양곡 목록', c:b.songs },
    { i:'campaign', t:'광고 / 알림', c:b.announce },
  ];
  return `
  <div class="min-h-screen bg-zinc-50 detail-page">
    <header class="sticky top-0 z-50 px-4 py-3 bg-white/90 backdrop-blur-xl border-b border-zinc-100 flex items-center gap-3">
      <button data-action="back" class="w-10 h-10 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('arrow_back','',22)}</button>
      <h1 class="font-bold text-sm flex-1">주보</h1>
    </header>
    <div class="p-5">
      <div class="bg-white rounded-3xl overflow-hidden shadow-lg border border-zinc-100">
        <div class="bg-black text-white p-8 text-center relative overflow-hidden dot-pattern">
          <div class="relative z-10">
            <p class="text-[10px] font-bold uppercase tracking-[0.3em] text-white/50 mb-2">약속의 땅 · 주일예배</p>
            <h2 class="text-2xl font-bold">${b.date}</h2>
            <div class="w-12 h-0.5 bg-white/20 mx-auto mt-4"></div>
          </div>
        </div>
        <div class="divide-y divide-zinc-100">
          ${sections.filter(s=>s.c).map(s => `
            <div class="p-6">
              <div class="flex items-center gap-2 mb-3">
                ${icon(s.i,'text-zinc-400',16)}
                <h3 class="text-xs font-bold uppercase tracking-wider text-zinc-400">${s.t}</h3>
              </div>
              <div class="text-sm leading-relaxed text-zinc-700 whitespace-pre-line">${s.c}</div>
            </div>
          `).join('')}
        </div>
        <div class="bg-zinc-50 p-6 text-center">
          <p class="text-[10px] text-zinc-300 font-bold uppercase tracking-[0.2em]">약속의 땅 청년부</p>
        </div>
      </div>
    </div>
  </div>`;
}

// ============================================================
// NOTICE TAB
// ============================================================
function renderNoticeTab() {
  const notices = state.cache.notices;
  return `
  <section>
    <h2 class="text-xl font-bold tracking-tight mb-6">공지사항</h2>
    <div class="space-y-3">
      ${notices.map(n => `
        <button data-detail="notice:${n.id}" class="w-full flex items-start gap-3 bg-white p-5 rounded-2xl border border-zinc-100 active:bg-zinc-50 transition-colors text-left">
          <div class="w-9 h-9 ${n.pinned?'bg-black':'bg-zinc-100'} rounded-xl flex items-center justify-center flex-none">
            ${icon(n.pinned?'priority_high':'info','',16,false)}
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-bold">${n.title}</p>
            <p class="text-xs text-zinc-400 mt-1 line-clamp-2">${n.body.split('\n')[0]}</p>
            <p class="text-[10px] text-zinc-300 mt-1.5">${n.at}</p>
          </div>
        </button>
      `).join('')}
    </div>
  </section>`;
}

// ============================================================
// NOTICE DETAIL
// ============================================================
function renderNoticeDetail() {
  const n = state.cache.notices.find(x => x.id === state.detail.id);
  if (!n) return '';
  const comments = state.cache.comments[n.id] || [];
  return `
  <div class="min-h-screen bg-zinc-50 detail-page">
    <header class="sticky top-0 z-50 px-4 py-3 bg-white/90 backdrop-blur-xl border-b border-zinc-100 flex items-center gap-3">
      <button data-action="back" class="w-10 h-10 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('arrow_back','',22)}</button>
      <h1 class="font-bold text-sm flex-1">공지사항</h1>
    </header>
    <div class="p-5 space-y-4">
      <div class="bg-white rounded-2xl p-6 border border-zinc-100">
        ${n.pinned?'<span class="text-[10px] font-bold bg-red-50 text-red-500 px-2 py-1 rounded mb-3 inline-block">📌 중요 공지</span>':''}
        <h2 class="text-lg font-bold leading-snug mb-2">${n.title}</h2>
        <p class="text-[11px] text-zinc-400 mb-4">${n.at}</p>
        <p class="text-sm leading-relaxed text-zinc-700 whitespace-pre-line">${n.body}</p>
        ${n.images?.length ? `<div class="mt-4 space-y-2">${n.images.map(img=>`<img src="${img}" class="w-full rounded-xl"/>`).join('')}</div>` : ''}
      </div>
      <div class="bg-white rounded-2xl border border-zinc-100 overflow-hidden">
        <div class="px-5 py-4 border-b border-zinc-50"><p class="text-xs font-bold text-zinc-500">댓글 ${comments.length}</p></div>
        ${comments.map(c=>`
          <div class="px-5 py-3.5 border-b border-zinc-50 last:border-0">
            <div class="flex items-center gap-2 mb-1"><p class="text-xs font-bold">${c.name}</p><p class="text-[10px] text-zinc-300">${c.at}</p></div>
            <p class="text-sm text-zinc-600">${c.body}</p>
          </div>
        `).join('')}
        <div class="flex gap-2 p-3 border-t border-zinc-100">
          <input id="comment-input" placeholder="댓글 입력..." class="flex-1 px-3 py-2.5 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
          <button data-action="post-comment" data-notice-id="${n.id}" class="px-4 py-2.5 bg-black text-white rounded-xl text-xs font-bold">전송</button>
        </div>
      </div>
    </div>
  </div>`;
}

// ============================================================
// CALENDAR TAB
// ============================================================
function renderCalendarTab() {
  const events = state.cache.events;
  const vm = state._calMonth || { y: new Date().getFullYear(), m: new Date().getMonth() };
  const y = vm.y; const m = vm.m;
  const selDate = state._calSel || today();
  const firstDay = new Date(y, m, 1).getDay();
  const daysInMonth = new Date(y, m+1, 0).getDate();
  const dayLabels = ['일','월','화','수','목','금','토'];
  let cells = '';
  for (let i=0; i<firstDay; i++) cells += '<div></div>';
  for (let d=1; d<=daysInMonth; d++) {
    const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isSel = ds === selDate;
    const hasEv = events.some(e=>e.date===ds);
    const isToday = ds === today();
    const dow = new Date(ds).getDay();
    const holiday = isHoliday(ds);
    let txtColor = '';
    if (isSel) txtColor = 'text-white';
    else if (dow === 0 || holiday) txtColor = 'text-red-500';
    else if (dow === 6) txtColor = 'text-blue-500';
    let bgColor = '';
    if (isSel) bgColor = 'bg-black';
    else if (isToday) bgColor = 'bg-zinc-100';
    cells += `<button data-cal-date="${ds}" class="relative w-full aspect-square flex items-center justify-center rounded-xl text-sm font-medium transition-colors ${bgColor} ${txtColor} active:opacity-70">${d}${hasEv&&!isSel?`<span class="absolute bottom-1 w-1 h-1 ${(dow===0||holiday)?'bg-red-400':dow===6?'bg-blue-400':'bg-black'} rounded-full"></span>`:''}</button>`;
  }

  const dayEvents = events.filter(e => e.date === selDate);
  const sd = new Date(selDate);

  return `
  <section>
    <h2 class="text-xl font-bold tracking-tight mb-6">일정</h2>
    <div class="flex items-center justify-between mb-4">
      <button data-action="cal-prev" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('chevron_left','',20)}</button>
      <h3 class="font-bold text-sm">${y}년 ${m+1}월</h3>
      <button data-action="cal-next" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('chevron_right','',20)}</button>
    </div>
    <div class="grid grid-cols-7 gap-1 mb-2">
      ${dayLabels.map((d,i)=>`<div class="text-center text-[10px] font-bold ${i===0?'text-red-400':i===6?'text-blue-400':'text-zinc-400'}">${d}</div>`).join('')}
    </div>
    <div class="grid grid-cols-7 gap-1 mb-7">${cells}</div>
    <div>
      <h3 class="text-sm font-bold mb-3">${sd.getMonth()+1}월 ${sd.getDate()}일 일정</h3>
      ${dayEvents.length===0 ? '<p class="text-sm text-zinc-300 text-center py-8">등록된 일정이 없습니다</p>' :
        `<div class="space-y-2">${dayEvents.map(ev=>`
          <div class="flex items-center gap-4 bg-zinc-50 p-4 rounded-2xl">
            <div class="w-1 h-10 bg-black rounded-full"></div>
            <div>
              <span class="text-[10px] font-bold bg-zinc-200 text-zinc-500 px-1.5 py-0.5 rounded">${ev.cat}</span>
              <h4 class="font-bold text-sm mt-0.5">${ev.title}</h4>
              ${(ev.loc||ev.time)?`<p class="text-xs text-zinc-400">${[ev.loc,ev.time].filter(Boolean).join(' · ')}</p>`:''}
            </div>
          </div>
        `).join('')}</div>`
      }
    </div>
  </section>`;
}

// ============================================================
// WORSHIP DETAIL
// ============================================================
function renderWorshipDetail() {
  const worships = state.cache.worshipSets;
  const w = worships[worships.length - 1];
  if (!w) return '';
  return `
  <div class="min-h-screen bg-zinc-50 detail-page">
    <header class="sticky top-0 z-50 px-4 py-3 bg-white/90 backdrop-blur-xl border-b border-zinc-100 flex items-center gap-3">
      <button data-action="back" class="w-10 h-10 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('arrow_back','',22)}</button>
      <h1 class="font-bold text-sm flex-1">이번주 찬양</h1>
    </header>
    <div class="p-5">
      <div class="bg-zinc-50 rounded-2xl p-5 mb-6">
        <p class="text-[10px] font-bold text-zinc-400 uppercase tracking-wider mb-1">세트 정보</p>
        <p class="text-sm font-bold mb-2">${w.date}</p>
        <div class="text-xs"><span class="text-zinc-400">인도:</span> <span class="font-bold">${w.leader}</span></div>
      </div>
      <h3 class="text-sm font-bold mb-3">곡 목록</h3>
      <div class="space-y-3">
        ${w.songs.map((s,i) => {
          const sheetValid = s.sheet && (!w.storedAt || (new Date() - new Date(w.storedAt)) < 30*24*60*60*1000);
          return `
          <div class="bg-white rounded-2xl border border-zinc-200 overflow-hidden">
            <div class="flex items-center gap-4 p-4">
              <div class="w-10 h-10 bg-black rounded-xl flex items-center justify-center flex-none">
                <span class="text-white font-bold text-sm">${i+1}</span>
              </div>
              <div class="flex-1 min-w-0">
                <h4 class="font-bold text-sm">${s.title}</h4>
                <p class="text-xs text-zinc-400">Key: ${s.key}</p>
              </div>
              <div class="flex items-center gap-2">
                ${s.url ? `<a href="${s.url}" target="_blank" class="w-9 h-9 bg-red-50 rounded-xl flex items-center justify-center">${icon('play_arrow','text-red-500',20)}</a>` : ''}
                ${sheetValid ? `<button data-sheet-toggle="${i}" class="w-9 h-9 bg-zinc-100 rounded-xl flex items-center justify-center">${icon('description','text-zinc-600',18)}</button>` : ''}
              </div>
            </div>
            ${sheetValid ? `<div id="sheet-panel-${i}" class="hidden border-t border-zinc-100"><img src="${s.sheet}" class="w-full" alt="악보"/></div>` : ''}
          </div>`;
        }).join('')}
      </div>
    </div>
  </div>`;
}

// ============================================================
// CELL TAB
// ============================================================
function renderCellTab() {
  const meetings = state.cache.cellMeetings;
  const latest = meetings[0];
  if (!latest) return `<div>
    <div class="pb-5 border-b border-zinc-100 mb-5"><h1 class="text-xl font-bold tracking-tight">목장 모임 자료</h1></div>
    <div class="flex items-center justify-center py-16"><p class="text-sm text-zinc-400">등록된 자료가 없습니다</p></div>
  </div>`;
  const questions = latest.questions || [];
  return `<div>
    <div class="pb-5 border-b border-zinc-100 mb-6"><h1 class="text-xl font-bold tracking-tight">목장 모임 자료</h1><p class="text-sm text-zinc-400 mt-0.5">${latest.date}</p></div>
    <div class="space-y-5">
      <div class="bg-zinc-900 text-white p-5 rounded-2xl">
        <p class="text-xs font-bold text-zinc-400 mb-1">오늘의 말씀</p>
        <p class="text-base font-bold">${latest.verse||''}</p>
        ${latest.verseText?`<p class="text-sm text-zinc-300 mt-2 leading-relaxed italic">${latest.verseText}</p>`:''}
      </div>
      ${questions.length ? questions.map((q,qi)=>`
      <div class="bg-white p-5 rounded-2xl border border-zinc-100">
        <p class="text-xs font-bold text-zinc-400 mb-2">나눔 질문 ${qi+1}</p>
        <p class="text-sm leading-relaxed font-medium">${q}</p>
      </div>`).join('') : ''}
      ${latest.prayerItems?`
      <div class="bg-gradient-to-br from-indigo-50 to-purple-50 p-5 rounded-2xl border border-indigo-100">
        <p class="text-xs font-bold text-indigo-400 mb-2">함께 기도</p>
        <p class="text-sm leading-relaxed whitespace-pre-line text-indigo-900">${latest.prayerItems}</p>
      </div>`:''}
    </div>
  </div>`;
}

// ============================================================
// PROFILE PAGES
// ============================================================
function renderProfilePage() {
  const u = state.user;
  const cells = state.cache.cells;
  const pg = state.profilePage;
  const noti = u._noti || {worship:true,notice:true,verse:true,schedule:true,duty:true};

  const header = (title) => `<div class="sticky top-0 bg-white border-b border-zinc-100 px-5 py-4 flex items-center gap-3 z-10">
    <button data-action="close-profile-page" class="w-9 h-9 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('arrow_back','',22)}</button>
    <h1 class="font-bold text-base">${title}</h1>
  </div>`;

  if (pg === 'edit') {
    return `<div class="min-h-screen bg-zinc-50 slide-in-right">
      ${header('프로필 수정')}
      <div class="px-5 py-4 space-y-4">
        <div class="flex flex-col items-center gap-4">
          <div class="relative">
            <div class="w-24 h-24 rounded-full bg-zinc-200 border-2 border-black overflow-hidden">
              ${state._pendingProfileImg || u.profileImg ? `<img id="profile-preview-img" src="${state._pendingProfileImg||u.profileImg}" class="w-full h-full object-cover"/>` : `<span class="w-full h-full flex items-center justify-center text-2xl font-bold text-zinc-500">${(u.name||'?')[0]}</span>`}
            </div>
            <label class="absolute -bottom-1 -right-1 w-7 h-7 bg-black rounded-full flex items-center justify-center cursor-pointer">
              ${icon('photo_camera','text-white',14)}
              <input id="profile-img-input" type="file" accept="image/*" class="hidden"/>
            </label>
          </div>
          <p class="text-xs text-zinc-400">사진을 탭하여 변경</p>
        </div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">이름</label>
          <input id="edit-name" value="${u.name}" class="w-full px-4 py-3 bg-white border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
        </div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">전화번호</label>
          <input id="edit-phone" value="${fmtPhone(u.phone||'')}" placeholder="010-0000-0000" inputmode="numeric" class="w-full px-4 py-3 bg-white border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
        </div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">생년월일</label>
          <input id="edit-birth" value="${fmtDate(u.birth||'')}" placeholder="1995.03.15" inputmode="numeric" class="w-full px-4 py-3 bg-white border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
        </div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">목장</label>
          <div class="w-full px-4 py-3 bg-zinc-100 border border-zinc-200 rounded-xl text-sm text-zinc-500 flex items-center justify-between">
            <span>${cells.find(c=>c.id===u.cellId)?.name || '미배정'}</span>
            
          </div>
        </div>
        <button id="save-profile-edit" class="w-full py-3.5 bg-black text-white rounded-xl text-sm font-bold transition-opacity active:opacity-70">저장</button>
      </div>
    </div>`;
  }

  if (pg === 'noti') {
    const items = [
      {k:'worship',l:'찬양 업데이트',d:'새 찬양 세트 등록 시'},
      {k:'notice',l:'공지사항',d:'새 공지 등록 시'},
      {k:'verse',l:'오늘의 말씀',d:'매일 말씀 알림'},
      {k:'schedule',l:'새 일정',d:'새 일정 등록 시'},
      {k:'duty',l:'담당자 지정',d:'예배 담당 배정 시'},
    ];
    return `<div class="min-h-screen bg-zinc-50 slide-in-right">
      ${header('알림 설정')}
      <div class="px-5 py-6">
        <div class="bg-white rounded-2xl border border-zinc-100 divide-y divide-zinc-50">
          ${items.map(it=>`
          <div class="flex items-center justify-between px-5 py-4">
            <div>
              <p class="text-sm font-bold">${it.l}</p>
              <p class="text-xs text-zinc-400 mt-0.5">${it.d}</p>
            </div>
            <button data-noti-toggle="${it.k}" class="relative w-12 h-6 rounded-full transition-colors ${noti[it.k]?'bg-black':'bg-zinc-200'}">
              <span class="absolute top-1 transition-all w-4 h-4 bg-white rounded-full shadow ${noti[it.k]?'left-7':'left-1'}"></span>
            </button>
          </div>`).join('')}
        </div>
      </div>
    </div>`;
  }

  if (pg === 'settings') {
    const canChangeId = !u.idChangedAt;
    return `<div class="min-h-screen bg-zinc-50 slide-in-right">
      ${header('설정')}
      <div class="px-5 py-6 space-y-4">
        <!-- 비밀번호 변경 -->
        <div class="bg-white rounded-2xl border border-zinc-100 overflow-hidden">
          <button id="toggle-pw-section" class="w-full flex items-center justify-between px-5 py-4">
            <div class="flex items-center gap-3">${icon('lock','',20)}<span class="text-sm font-bold">비밀번호 변경</span></div>
            ${icon('expand_more','text-zinc-400',20)}
          </button>
          <div id="pw-section" class="hidden border-t border-zinc-100 px-5 py-4 space-y-3">
            <input id="pw-current" type="password" placeholder="현재 비밀번호" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
            <input id="pw-new" type="password" placeholder="새 비밀번호" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
            <input id="pw-confirm" type="password" placeholder="새 비밀번호 확인" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
            <button id="save-pw" class="w-full py-3 bg-black text-white rounded-xl text-sm font-bold">변경</button>
          </div>
        </div>
        <!-- 아이디 변경 (1회 가능) -->
        <div class="bg-white rounded-2xl border border-zinc-100 overflow-hidden">
          <button id="toggle-id-section" class="w-full flex items-center justify-between px-5 py-4">
            <div class="flex items-center gap-3">
              ${icon('badge','',20)}
              <div class="text-left">
                <span class="text-sm font-bold">아이디 변경</span>
                ${!canChangeId?`<p class="text-[10px] text-zinc-400">이미 변경하셨습니다 (1회 제한)</p>`:`<p class="text-[10px] text-zinc-400">1회만 변경 가능합니다</p>`}
              </div>
            </div>
            ${canChangeId ? icon('expand_more','text-zinc-400',20) : icon('lock','text-zinc-300',18)}
          </button>
          ${canChangeId ? `<div id="id-section" class="hidden border-t border-zinc-100 px-5 py-4 space-y-3">
            <p class="text-xs text-zinc-500 bg-amber-50 border border-amber-100 rounded-lg px-3 py-2">아이디는 1회만 변경 가능하며, 변경 후 이전 아이디로 로그인할 수 없습니다.</p>
            <input id="id-pw-verify" type="password" placeholder="현재 비밀번호 확인" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
            <input id="id-new" placeholder="새 아이디" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
            <button id="save-id" class="w-full py-3 bg-black text-white rounded-xl text-sm font-bold">변경</button>
          </div>` : ''}
        </div>
        <!-- 앱 버전 -->
        <div class="bg-white rounded-2xl border border-zinc-100 divide-y divide-zinc-50">
          <div class="flex items-center justify-between px-5 py-4">
            <span class="text-sm font-bold">앱 버전</span>
            <span class="text-sm text-zinc-400">v2.0.0</span>
          </div>
        </div>
        <!-- 계정 탈퇴 -->
        <button id="withdraw-btn" class="w-full py-3.5 bg-red-50 text-red-500 rounded-xl text-sm font-bold border border-red-100 transition-opacity active:opacity-70">계정 탈퇴</button>
      </div>
    </div>`;
  }
  return '';
}

// ============================================================
// ADMIN PAGE
// ============================================================
function renderAdmin() {
  const pendingCount = state.cache.users.filter(u=>u.status==='pending'||u.status==='withdraw_pending').length;
  const menu = [
    { k:'bulletin', i:'menu_book', l:'주보 관리' },
    { k:'worship', i:'music_note', l:'찬양 관리' },
    { k:'notice', i:'campaign', l:'공지 관리' },
    { k:'event', i:'calendar_month', l:'일정 관리' },
    { k:'attendance', i:'fact_check', l:'출석 관리' },
    { k:'offering', i:'volunteer_activism', l:'헌금 기록' },
    { k:'roster', i:'people', l:'명부 관리', dot: pendingCount > 0 },
    { k:'cellmeet', i:'groups', l:'목장 모임 자료' },
    { k:'cells', i:'dashboard', l:'목장 관리' },
    { k:'noti', i:'notifications', l:'알림 발송' },
  ];

  let content = '';
  if (state.adminSub === 'dashboard') {
    content = `<h2 class="text-lg font-bold mb-4">관리 메뉴</h2><div class="space-y-3">${menu.map(m=>`
      <button data-admin="${m.k}" class="w-full flex items-center gap-4 bg-white p-4 rounded-2xl border border-zinc-100 active:bg-zinc-50 transition-colors text-left">
        <div class="w-10 h-10 bg-zinc-100 rounded-xl flex items-center justify-center">${icon(m.i,'text-black',20)}</div>
        <span class="flex-1 font-bold text-sm">${m.l}</span>
        ${m.dot?`<span class="w-2.5 h-2.5 bg-red-500 rounded-full"></span>`:''}
        ${m.badge>0?`<span class="bg-red-500 text-white text-[10px] font-bold w-5 h-5 rounded-full flex items-center justify-center">${m.badge}</span>`:''}
        ${icon('chevron_right','text-zinc-300',20)}
      </button>
    `).join('')}</div>`;
  } else {
    content = `<button data-admin="dashboard" class="flex items-center gap-1 text-xs text-zinc-400 font-bold mb-5">${icon('arrow_back','',16)} 메뉴로</button>`;
    if (state.adminSub === 'bulletin') content += renderAdminBulletin();
    else if (state.adminSub === 'worship') content += renderAdminWorship();
    else if (state.adminSub === 'notice') content += renderAdminNotice();
    else if (state.adminSub === 'event') content += renderAdminEvent();
    else if (state.adminSub === 'attendance') content += renderAdminAttendance();
    else if (state.adminSub === 'offering') content += renderAdminOffering();
    else if (state.adminSub === 'roster') content += renderAdminRoster();
    else if (state.adminSub === 'cellmeet') content += renderAdminCellMeet();
    else if (state.adminSub === 'cells') content += renderAdminCells();
    else if (state.adminSub === 'noti') content += renderAdminNoti();
  }

  return `
  <div class="min-h-screen bg-zinc-50 slide-in-right">
    <header class="sticky top-0 z-50 px-4 py-3 bg-white/90 backdrop-blur-xl border-b border-zinc-100 flex items-center gap-3">
      <button data-action="back-main" class="w-10 h-10 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('arrow_back','',22)}</button>
      <h1 class="font-bold text-sm flex-1">관리자</h1>
    </header>
    <div class="p-5">${content}</div>
  </div>`;
}

function renderAdminApprove() {
  const pending = state.cache.users.filter(u=>u.status==='pending');
  const rosters = state.cache.rosters;
  if (!pending.length) return '<h2 class="text-lg font-bold mb-4">가입 승인</h2><p class="text-sm text-zinc-400 text-center py-10">대기 중인 가입 신청이 없습니다.</p>';
  return `<h2 class="text-lg font-bold mb-4">가입 승인</h2><div class="space-y-3">${pending.map(u=>{
    const match = rosters.find(r=>r.phone===u.phone);
    return `<div class="bg-white p-4 rounded-2xl border border-zinc-100">
      <div class="flex items-center justify-between mb-2">
        <div><p class="font-bold text-sm">${u.name}</p><p class="text-xs text-zinc-400">${fmtPhone(u.phone)} · ${fmtDate(u.birth)}</p></div>
        <button data-action="approve" data-uid="${u.uid}" class="px-4 py-2 bg-black text-white rounded-xl text-xs font-bold active:scale-95">승인</button>
      </div>
      ${match?`<p class="text-[10px] text-emerald-600 bg-emerald-50 px-2 py-1 rounded inline-block">📋 명부 매칭: ${match.name}</p>`:''}
    </div>`;
  }).join('')}</div>`;
}

function renderAdminWithdrawApprove() {
  const pending = state.cache.users.filter(u=>u.status==='withdraw_pending');
  if (!pending.length) return '<h2 class="text-lg font-bold mb-4">탈퇴 승인</h2><p class="text-sm text-zinc-400 text-center py-10">대기 중인 탈퇴 신청이 없습니다.</p>';
  return `<h2 class="text-lg font-bold mb-4">탈퇴 승인</h2><div class="space-y-3">${pending.map(u=>`
    <div class="bg-white p-4 rounded-2xl border border-zinc-100">
      <div class="flex items-center justify-between">
        <div><p class="font-bold text-sm">${u.name}</p><p class="text-xs text-zinc-400">${u.id} · ${fmtPhone(u.phone)}</p>
          <p class="text-[10px] text-zinc-400 mt-0.5">탈퇴 신청일: ${u.withdrawAt||'-'}</p>
        </div>
        <button data-action="approve-withdraw" data-uid="${u.uid}" class="px-4 py-2 bg-red-500 text-white rounded-xl text-xs font-bold active:scale-95">탈퇴 처리</button>
      </div>
    </div>
  `).join('')}</div>`;
}

function adminInput(id, label, ph, type='text') {
  return `<div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">${label}</label><input id="${id}" type="${type}" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="${ph}"/></div>`;
}
function adminTextarea(id, label, ph, rows=4) {
  return `<div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">${label}</label><textarea id="${id}" rows="${rows}" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black resize-none" placeholder="${ph}"></textarea></div>`;
}

function renderAdminBulletin() {
  const list = [...state.cache.bulletins].reverse();
  return `<h2 class="text-lg font-bold mb-4">주보 관리</h2>
  <div id="admin-form-area">
    <button data-action="show-bulletin-form" class="w-full py-3 border-2 border-dashed border-zinc-200 rounded-2xl text-sm font-bold text-zinc-400 mb-4">+ 새 주보</button>
    <div class="space-y-2">${list.map(b=>`<div class="bg-white p-4 rounded-2xl border border-zinc-100 flex items-center justify-between">
      <div><p class="font-bold text-sm">${b.title}</p><p class="text-xs text-zinc-400">${b.date}</p></div>
      <div class="flex gap-1">
        <button data-action="edit-bulletin" data-bid="${b.id}" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('edit','text-zinc-400',18)}</button>
        <button data-action="del-bulletin" data-bid="${b.id}" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-red-50">${icon('delete','text-red-400',18)}</button>
      </div>
    </div>`).join('')}</div>
  </div>`;
}

function renderAdminWorship() {
  const list = [...state.cache.worshipSets].reverse();
  return `<h2 class="text-lg font-bold mb-4">찬양 관리</h2>
  <div id="admin-form-area">
    <button data-action="show-worship-form" class="w-full py-3 border-2 border-dashed border-zinc-200 rounded-2xl text-sm font-bold text-zinc-400 mb-4">+ 새 세트</button>
    <div class="space-y-2">${list.map(w=>`<div class="bg-white p-4 rounded-2xl border border-zinc-100 flex items-center justify-between">
      <div><p class="font-bold text-sm">${w.date} 찬양 세트</p><p class="text-xs text-zinc-400">인도: ${w.leader} · ${w.songs.length}곡</p></div>
      <div class="flex gap-1">
        <button data-action="edit-worship" data-wid="${w.id}" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('edit','text-zinc-400',18)}</button>
        <button data-action="del-worship" data-wid="${w.id}" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-red-50">${icon('delete','text-red-400',18)}</button>
      </div>
    </div>`).join('')}</div>
  </div>`;
}

function renderAdminNotice() {
  const list = [...state.cache.notices];
  return `<h2 class="text-lg font-bold mb-4">공지 관리</h2>
  <div id="admin-form-area">
    <button data-action="show-notice-form" class="w-full py-3 border-2 border-dashed border-zinc-200 rounded-2xl text-sm font-bold text-zinc-400 mb-4">+ 새 공지</button>
    <div class="space-y-2">${list.map(n=>`<div class="bg-white p-4 rounded-2xl border border-zinc-100 flex items-center justify-between">
      <div>${n.pinned?'<span class="text-[9px] font-bold bg-red-50 text-red-500 px-1.5 py-0.5 rounded mr-1">중요</span>':''}<span class="font-bold text-sm">${n.title}</span><p class="text-xs text-zinc-400">${n.at}</p></div>
      <div class="flex gap-1">
        <button data-action="edit-notice" data-nid="${n.id}" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('edit','text-zinc-400',18)}</button>
        <button data-action="del-notice" data-nid="${n.id}" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-red-50">${icon('delete','text-red-400',18)}</button>
      </div>
    </div>`).join('')}</div>
  </div>`;
}

function renderAdminEvent() {
  const list = state.cache.events;
  return `<h2 class="text-lg font-bold mb-4">일정 관리</h2>
  <div id="admin-form-area">
    <button data-action="show-event-form" class="w-full py-3 border-2 border-dashed border-zinc-200 rounded-2xl text-sm font-bold text-zinc-400 mb-4">+ 새 일정</button>
    <div class="space-y-2">${list.map(e=>`<div class="bg-white p-4 rounded-2xl border border-zinc-100 flex items-center justify-between">
      <div><p class="font-bold text-sm">${e.title}</p><p class="text-xs text-zinc-400">${e.date} ${e.time} · ${e.cat}</p></div>
      <div class="flex gap-1">
        <button data-action="edit-event" data-eid="${e.id}" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('edit','text-zinc-400',18)}</button>
        <button data-action="del-event" data-eid="${e.id}" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-red-50">${icon('delete','text-red-400',18)}</button>
      </div>
    </div>`).join('')}</div>
  </div>`;
}

function renderAdminAttendance() {
  const rosters = state.cache.rosters;
  const cells = state.cache.cells;
  const att = state.cache.attendance;
  const d = state._attDate || today();
  const marks = att[d]?.marks || {};
  const activeTab = state.adminAttTab || 'all';
  const filtered = activeTab === 'all' ? rosters : rosters.filter(r=>r.cellId === activeTab);
  const present = filtered.filter(r=>marks[r.id]).length;
  const tabs = [{id:'all',name:'전체'},...cells.map(c=>({id:c.id,name:c.name}))];
  return `<h2 class="text-lg font-bold mb-4">출석 관리</h2>
  ${adminInput('att-date','예배일',today())}
  <div class="flex gap-2 mt-3 overflow-x-auto hide-scrollbar pb-1">
    ${tabs.map(t=>`<button data-att-tab="${t.id}" class="flex-none px-3 py-1.5 rounded-full text-xs font-bold border transition-colors ${activeTab===t.id?'bg-black text-white border-black':'bg-white text-zinc-500 border-zinc-200'}">${t.name}</button>`).join('')}
  </div>
  <div class="flex items-center justify-between my-3">
    <p class="text-sm text-zinc-400">출석: <span class="font-bold text-black">${present}</span> / ${filtered.length}</p>
    <button data-action="save-attendance" class="px-4 py-2 bg-black text-white rounded-xl text-xs font-bold active:scale-95">저장</button>
  </div>
  <div class="space-y-1">${filtered.map(r=>{
    const cellName = cells.find(c=>c.id===r.cellId)?.name||'미배정';
    return `
    <button data-action="toggle-att" data-rid="${r.id}" class="w-full flex items-center gap-3 p-3 rounded-xl transition-colors ${marks[r.id]?'bg-emerald-50 border border-emerald-200':'bg-white border border-zinc-100'}">
      <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${marks[r.id]?'bg-emerald-500 border-emerald-500':'border-zinc-300'}">
        ${marks[r.id]?icon('check','text-white',14):''}
      </div>
      <div class="flex-1 text-left">
        <span class="text-sm font-medium">${r.name}</span>
        ${activeTab==='all'?`<span class="text-[10px] text-zinc-400 ml-2">${cellName}</span>`:''}
      </div>
    </button>`;
  }).join('')}</div>`;
}

function renderAdminOffering() {
  const rosters = state.cache.rosters;
  const offerings = state.cache.offerings;
  const d = state._offDate || today();
  const weekData = offerings[d] || { items:[] };
  const total = (weekData.items||[]).reduce((s,i)=>s+i.amount,0);
  return `<h2 class="text-lg font-bold mb-4">헌금 기록</h2>
  ${adminInput('off-date','주차',today())}
  <div class="mt-4 bg-white p-4 rounded-2xl border border-zinc-100 space-y-3">
    <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">이름</label>
      <select id="off-person" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black">
        <option value="">선택</option>${rosters.map(r=>`<option value="${r.id}">${r.name}</option>`).join('')}
      </select>
    </div>
    <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">항목</label>
      <select id="off-type" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black">
        ${['주정','십일조','감사','기타'].map(t=>`<option value="${t}">${t}</option>`).join('')}
      </select>
    </div>
    ${adminInput('off-amount','금액','10000')}
    <button data-action="add-offering" class="w-full py-3 bg-black text-white rounded-xl text-sm font-bold active:opacity-70">추가</button>
  </div>
  <div class="mt-4 bg-zinc-900 text-white p-4 rounded-2xl">
    <p class="text-xs text-zinc-400">이번 주 총액</p>
    <p class="text-2xl font-bold">${fmtAmt(total)}원</p>
  </div>
  ${(weekData.items||[]).length?`<div class="mt-3 space-y-1">${(weekData.items||[]).map((it,idx)=>`
    <div class="bg-white p-3 rounded-xl border border-zinc-100 flex items-center justify-between">
      <div><span class="text-sm font-bold">${it.name}</span><span class="text-xs text-zinc-400 ml-2">${it.type}</span></div>
      <div class="flex items-center gap-2">
        <span class="text-sm font-bold">${fmtAmt(it.amount)}원</span>
        <button data-action="del-offering" data-date="${d}" data-idx="${idx}" class="w-7 h-7 flex items-center justify-center rounded-full active:bg-red-50">${icon('delete','text-red-400',16)}</button>
      </div>
    </div>
  `).join('')}</div>`:''}`;
}

function renderRosterTabs(activeTab, cells, joinCount, withdrawCount) {
  const normalTabs = [{id:'all', name:'전체'}, ...cells.map(c=>({id:c.id, name:c.name}))];
  const specialTabs = [
    {id:'pending_join', name:'가입신청', badge: joinCount, color: 'emerald'},
    {id:'pending_withdraw', name:'탈퇴신청', badge: withdrawCount, color: 'red'},
  ];
  const renderTab = (t) => {
    const isActive = activeTab === t.id;
    const isSpecial = !!t.color;
    let cls = '';
    if (isActive && t.color === 'emerald') cls = 'bg-emerald-500 text-white border-emerald-500';
    else if (isActive && t.color === 'red') cls = 'bg-red-500 text-white border-red-500';
    else if (isActive) cls = 'bg-black text-white border-black';
    else if (t.color === 'emerald') cls = 'bg-emerald-50 text-emerald-600 border-emerald-200';
    else if (t.color === 'red') cls = 'bg-red-50 text-red-500 border-red-200';
    else cls = 'bg-white text-zinc-500 border-zinc-200';
    return `<button data-roster-tab="${t.id}" class="flex-none flex items-center gap-1 px-3 py-1.5 rounded-full text-xs font-bold border transition-colors ${cls}">${t.name}${t.badge>0?`<span class="${isActive?'bg-white/30':'bg-red-500'} text-white text-[9px] font-bold w-4 h-4 rounded-full flex items-center justify-center">${t.badge}</span>`:''}</button>`;
  };
  return `<div class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar pb-1">
    ${normalTabs.map(renderTab).join('')}
    <div class="w-px bg-zinc-200 mx-1 my-1 flex-none"></div>
    ${specialTabs.map(renderTab).join('')}
  </div>`;
}

function renderAdminRoster() {
  const rosters = state.cache.rosters;
  const cells = state.cache.cells;
  const users = state.cache.users;
  const activeTab = state.adminRosterTab || 'all';
  const pendingJoin = users.filter(u=>u.status==='pending');
  const pendingWithdraw = users.filter(u=>u.status==='withdraw_pending');

  // 가입신청 탭
  if (activeTab === 'pending_join') {
    return `<h2 class="text-lg font-bold mb-1">명부 관리</h2>
    ${renderRosterTabs(activeTab, cells, pendingJoin.length, pendingWithdraw.length)}
    <div class="space-y-3">${pendingJoin.length ? pendingJoin.map(u=>{
      const match = rosters.find(r=>r.phone===u.phone);
      return `<div class="bg-white p-4 rounded-2xl border border-zinc-100">
        <div class="flex items-center justify-between mb-2">
          <div><p class="font-bold text-sm">${u.name}</p><p class="text-xs text-zinc-400">${fmtPhone(u.phone)} · ${fmtDate(u.birth)}</p></div>
          <button data-action="approve" data-uid="${u.uid}" class="px-4 py-2 bg-black text-white rounded-xl text-xs font-bold">승인</button>
        </div>
        ${match?`<p class="text-[10px] text-emerald-600 bg-emerald-50 px-2 py-1 rounded inline-block">📋 명부 매칭: ${match.name}</p>`:''}
      </div>`;
    }).join('') : '<p class="text-sm text-zinc-400 text-center py-10">대기 중인 가입 신청이 없습니다.</p>'}</div>`;
  }

  // 탈퇴신청 탭
  if (activeTab === 'pending_withdraw') {
    return `<h2 class="text-lg font-bold mb-1">명부 관리</h2>
    ${renderRosterTabs(activeTab, cells, pendingJoin.length, pendingWithdraw.length)}
    <div class="space-y-3">${pendingWithdraw.length ? pendingWithdraw.map(u=>`
      <div class="bg-white p-4 rounded-2xl border border-zinc-100">
        <div class="flex items-center justify-between">
          <div><p class="font-bold text-sm">${u.name}</p><p class="text-xs text-zinc-400">${u.id} · ${fmtPhone(u.phone)}</p>
            <p class="text-[10px] text-zinc-400 mt-0.5">신청일: ${u.withdrawAt||'-'}</p>
          </div>
          <button data-action="approve-withdraw" data-uid="${u.uid}" class="px-4 py-2 bg-red-500 text-white rounded-xl text-xs font-bold">탈퇴 처리</button>
        </div>
      </div>`).join('') : '<p class="text-sm text-zinc-400 text-center py-10">대기 중인 탈퇴 신청이 없습니다.</p>'}</div>`;
  }

  // 일반 명부 탭
  const filtered = activeTab === 'all' ? rosters : rosters.filter(r=>r.cellId===activeTab);
  const tabs = [{id:'all',name:'전체'},...cells.map(c=>({id:c.id,name:c.name}))];

  return `<h2 class="text-lg font-bold mb-1">명부 관리</h2>
  ${renderRosterTabs(activeTab, cells, pendingJoin.length, pendingWithdraw.length)}
  <button data-action="show-roster-form" class="w-full py-3 border-2 border-dashed border-zinc-200 rounded-2xl text-sm font-bold text-zinc-400 mb-3">+ 명부 추가</button>
  <div id="roster-form-area"></div>
  <div class="space-y-2">${filtered.map(r=>{
    const cell = cells.find(c=>c.id===r.cellId);
    const linkedUser = r.linkedUid ? users.find(u=>u.uid===r.linkedUid) : null;
    const isAdminR = linkedUser?.role === 'admin';
    return `
    <div id="roster-card-${r.id}" class="relative bg-white p-4 rounded-2xl border border-zinc-100 flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-zinc-900 flex items-center justify-center flex-none">
        <span class="text-white font-bold text-sm">${r.name[0]}</span>
      </div>
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-1.5 flex-wrap">
          <p class="font-bold text-sm">${r.name}</p>
          ${isAdminR?`<span class="text-[9px] font-bold bg-black text-white px-1.5 py-0.5 rounded">관리자</span>`:''}
          ${r.joined?`<span class="text-[9px] font-bold bg-emerald-500 text-white px-1.5 py-0.5 rounded">앱 가입</span>`:`<span class="text-[9px] font-bold bg-zinc-200 text-zinc-500 px-1.5 py-0.5 rounded">미가입</span>`}
        </div>
        <p class="text-xs text-zinc-400">${fmtPhone(r.phone)} · ${cell?.name||'미배정'}</p>
      </div>
      <button data-action="roster-menu" data-rid="${r.id}" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-zinc-100 active:bg-zinc-100 flex-none">
        ${icon('more_vert','text-zinc-400',20)}
      </button>
      <div id="roster-dd-${r.id}" class="hidden absolute right-2 top-12 z-50 bg-white border border-zinc-200 rounded-2xl shadow-lg overflow-hidden w-44">
        <button data-action="roster-edit" data-rid="${r.id}" class="w-full flex items-center gap-2.5 px-4 py-3 text-sm font-medium hover:bg-zinc-50 text-left">${icon('edit','text-zinc-500',16)} 정보 변경</button>
        <button data-action="roster-grant" data-rid="${r.id}" class="w-full flex items-center gap-2.5 px-4 py-3 text-sm font-medium hover:bg-zinc-50 text-left">${icon('shield','text-zinc-500',16)} ${isAdminR?'관리자 해제':'관리자 부여'}</button>
        <button data-action="roster-delete" data-rid="${r.id}" class="w-full flex items-center gap-2.5 px-4 py-3 text-sm font-medium text-red-500 hover:bg-red-50 text-left">${icon('delete','text-red-500',16)} 탈퇴 처리</button>
      </div>
    </div>`;
  }).join('')}</div>`;
}

function renderAdminCells() {
  const cells = state.cache.cells;
  return `<h2 class="text-lg font-bold mb-4">목장 관리</h2>
  <button data-action="show-cell-form" class="w-full py-3 border-2 border-dashed border-zinc-200 rounded-2xl text-sm font-bold text-zinc-400 mb-3">+ 목장 추가</button>
  <div id="cell-form-area"></div>
  <div class="space-y-2">${cells.map(c=>`
    <div class="bg-white p-4 rounded-2xl border border-zinc-100">
      <div class="flex items-center justify-between">
        <div><p class="font-bold text-sm">${c.name}</p><p class="text-xs text-zinc-400">목자: ${c.leader}</p></div>
        <div class="flex gap-2">
          <button data-action="cell-edit" data-cid="${c.id}" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('edit','text-zinc-400',18)}</button>
          <button data-action="cell-delete" data-cid="${c.id}" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-red-50">${icon('delete','text-red-400',18)}</button>
        </div>
      </div>
      <div id="cell-edit-area-${c.id}" class="hidden mt-3 space-y-2">
        <input id="cell-name-${c.id}" value="${c.name}" placeholder="목장 이름" class="w-full px-3 py-2 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
        <input id="cell-leader-${c.id}" value="${c.leader}" placeholder="목자 이름" class="w-full px-3 py-2 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
        <button data-action="cell-save" data-cid="${c.id}" class="w-full py-2 bg-black text-white rounded-xl text-xs font-bold">저장</button>
      </div>
    </div>
  `).join('')}</div>`;
}

function renderAdminCellMeet() {
  const meetings = state.cache.cellMeetings;
  return `<h2 class="text-lg font-bold mb-4">목장 모임 자료</h2>
  <button data-action="show-cellmeet-form" class="w-full py-3 border-2 border-dashed border-zinc-200 rounded-2xl text-sm font-bold text-zinc-400 mb-3">+ 자료 추가</button>
  <div id="admin-form-area"></div>
  <div class="space-y-3">${meetings.map(m=>`
    <div class="bg-white p-4 rounded-2xl border border-zinc-100">
      <div class="flex items-start justify-between mb-2">
        <div>
          <p class="font-bold text-sm">${m.date}</p>
          <p class="text-xs text-zinc-500 mt-0.5">${m.verse||''}</p>
        </div>
        <div class="flex gap-1">
          <button data-action="edit-cellmeet" data-mid="${m.id}" class="w-7 h-7 flex items-center justify-center rounded-full hover:bg-zinc-100">${icon('edit','text-zinc-400',16)}</button>
          <button data-action="del-cellmeet" data-mid="${m.id}" class="w-7 h-7 flex items-center justify-center rounded-full hover:bg-red-50">${icon('delete','text-zinc-300',16)}</button>
        </div>
      </div>
      ${(m.questions||[]).length ? `<p class="text-xs text-zinc-400 line-clamp-2">질문 ${(m.questions||[]).length}개</p>` : ''}
    </div>
  `).join('')}</div>`;
}

function renderAdminNoti() {
  return `<h2 class="text-lg font-bold mb-4">알림 발송</h2>
  <div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100">
    ${adminInput('noti-title','제목','알림 제목')}
    ${adminTextarea('noti-body','내용','알림 내용')}
    <button data-action="send-noti" class="w-full py-3 bg-black text-white rounded-xl text-sm font-bold active:opacity-70">전체 발송</button>
  </div>`;
}

// ============================================================
// EVENT BINDING
// ============================================================
function bindEvents() {
  // ── Pull to Refresh ──
  (function setupPTR() {
    let startY = 0, pulling = false, indicator = null;
    const threshold = 70;
    const mainEl = () => document.querySelector('main') || document.querySelector('.min-h-screen');

    document.addEventListener('touchstart', e => {
      // 홈탭에서만 PTR 동작
      if (state.page !== 'main' || state.tab !== 'home' || state.detail || state.profilePage) return;
      const scrollTop = window.scrollY || 0;
      if (scrollTop <= 0) { startY = e.touches[0].clientY; pulling = true; }
    }, { passive: true });

    document.addEventListener('touchmove', e => {
      if (!pulling) return;
      const dy = e.touches[0].clientY - startY;
      if (dy > 10 && !indicator) {
        indicator = document.createElement('div');
        indicator.id = 'ptr-indicator';
        indicator.style.cssText = 'position:fixed;top:60px;left:50%;transform:translateX(-50%);z-index:9999;background:#000;color:#fff;padding:6px 16px;border-radius:999px;font-size:12px;font-weight:700;opacity:0;transition:opacity 0.2s;pointer-events:none;';
        indicator.textContent = '↓ 당겨서 새로고침';
        document.body.appendChild(indicator);
        setTimeout(() => { if(indicator) indicator.style.opacity = '1'; }, 10);
      }
      if (indicator && dy > threshold) indicator.textContent = '↑ 놓으면 새로고침';
      else if (indicator) indicator.textContent = '↓ 당겨서 새로고침';
    }, { passive: true });

    document.addEventListener('touchend', async e => {
      if (!pulling) return;
      pulling = false;
      const dy = e.changedTouches[0].clientY - startY;
      if (indicator) { indicator.style.opacity = '0'; setTimeout(() => { indicator?.remove(); indicator = null; }, 200); }
      if (dy > threshold) {
        showToast('새로고침 중...');
        await loadAll();
        render();
      }
    });
  })();

  // ── Confirm modal ──
  document.getElementById('confirm-no')?.addEventListener('click', () => { state._confirmModal = null; render(); });
  document.getElementById('confirm-yes')?.addEventListener('click', () => {
    const cb = state._confirmModal?.onYes;
    state._confirmModal = null;
    if (cb) cb();
  });

  // ── Login ──
  const doLogin = async () => {
    const id = (document.getElementById('login-id')?.value || '').trim();
    const pw = document.getElementById('login-pw')?.value || '';
    const errEl = document.getElementById('login-error');
    const btnEl = document.getElementById('btn-login');
    if (!id || !pw) { errEl.textContent='아이디와 비밀번호를 입력해주세요.'; errEl.classList.remove('hidden'); return; }
    if (btnEl) { btnEl.textContent='로그인 중...'; btnEl.disabled=true; }
    errEl.classList.add('hidden');
    try {
      // 1) Firestore에서 아이디로 사용자 찾기
      const allUsers = await window.FDB.getCol('users');
      const u = allUsers.find(x => x.id === id);
      if (!u) { errEl.textContent='아이디 또는 비밀번호가 틀렸습니다.'; errEl.classList.remove('hidden'); return; }
      if (u.status === 'pending') { errEl.textContent='관리자 승인 대기 중입니다.'; errEl.classList.remove('hidden'); return; }
      if (u.status === 'withdraw_pending') { errEl.textContent='탈퇴 신청 중인 계정입니다.'; errEl.classList.remove('hidden'); return; }

      // 2) Firebase Auth로 실제 인증 (ID@promisedland.com)
      const email = id + '@promisedland.com';
      try {
        await signInWithEmailAndPassword(window.FAUTH, email, pw);
      } catch(authErr) {
        // Auth 계정 없거나 비번 틀림 → 레거시 pw 필드 폴백 (마이그레이션 기간)
        if (u.pw && u.pw === pw) {
          // 최초 로그인 시 Auth 계정 생성 (마이그레이션)
          try {
            await createUserWithEmailAndPassword(window.FAUTH, email, pw);
            // pw 필드 제거 (보안)
            await window.FDB.setDoc('users', u.uid, { pw: null });
            u.pw = null;
          } catch(createErr) {
            if (createErr.code !== 'auth/email-already-in-use') throw createErr;
            // 이미 있으면 비번이 다른 것 → 오류
            errEl.textContent='비밀번호가 틀렸습니다.'; errEl.classList.remove('hidden'); return;
          }
        } else {
          errEl.textContent='아이디 또는 비밀번호가 틀렸습니다.'; errEl.classList.remove('hidden'); return;
        }
      }

      state.user = u; state.page = 'main';
      SESSION.set(u);
      await loadAll();
      render();
    } catch(e) {
      console.error('login error', e);
      errEl.textContent='서버 연결 오류. 잠시 후 다시 시도해주세요.';
      errEl.classList.remove('hidden');
    } finally {
      if (btnEl) { btnEl.textContent='로그인'; btnEl.disabled=false; }
    }
  };
  document.getElementById('btn-login')?.addEventListener('click', doLogin);
  document.getElementById('login-pw')?.addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });

  // ── Register ──
  document.getElementById('btn-go-register')?.addEventListener('click', () => { state.page='register'; render(); });
  document.getElementById('btn-back-login')?.addEventListener('click', () => { state.page='login'; render(); });
  document.getElementById('reg-phone')?.addEventListener('input', function() { this.value = fmtPhone(this.value); });
  document.getElementById('reg-birth')?.addEventListener('input', function() {
    const d = this.value.replace(/\D/g,'');
    if(d.length<=4) this.value=d;
    else if(d.length<=6) this.value=d.slice(0,4)+'.'+d.slice(4);
    else this.value=d.slice(0,4)+'.'+d.slice(4,6)+'.'+d.slice(6,8);
  });
  document.getElementById('btn-register')?.addEventListener('click', async () => {
    const g = id => document.getElementById(id)?.value || '';
    const name=g('reg-name'), rawPhone=g('reg-phone'), birth=g('reg-birth').replace(/\D/g,''), id=g('reg-id'), pw=g('reg-pw'), pw2=g('reg-pw2');
    const agree = document.getElementById('reg-agree')?.checked;
    const errEl = document.getElementById('reg-error');
    const showErr = msg => { errEl.textContent=msg; errEl.classList.remove('hidden'); };
    if (!name||!rawPhone||!birth||!id||!pw) return showErr('모든 항목을 입력해주세요.');
    if (pw!==pw2) return showErr('비밀번호가 일치하지 않습니다.');
    if (pw.length<8 || !/[a-zA-Z]/.test(pw) || !/[0-9]/.test(pw)) return showErr('비밀번호는 영문+숫자 혼합 8자 이상이어야 합니다.');
    if (!agree) return showErr('개인정보 수집에 동의해주세요.');
    if (!/^\d{8}$/.test(birth)) return showErr('생년월일은 8자리 숫자로 입력해주세요.');
    const phone = fmtPhone(rawPhone);
    if (state.cache.users.find(u=>u.id===id)) return showErr('이미 존재하는 아이디입니다.');
    if (state.cache.users.find(u=>u.phone===phone)) return showErr('이미 등록된 전화번호입니다.');

    // 명부 매칭: 이름+전화번호 일치 or 이름+생년월일 일치
    const rosters = state.cache.rosters;
    const matchedRoster = rosters.find(r => {
      const phoneMatch = r.phone && r.phone.replace(/[^\d]/g,'') === phone.replace(/[^\d]/g,'');
      const birthMatch = r.birth && r.birth === birth;
      const nameMatch  = r.name && r.name.replace(/\s/g,'') === name.replace(/\s/g,'');
      return nameMatch && (phoneMatch || birthMatch);
    });

    // Firebase Auth 계정 생성 (ID@promisedland.com 형식)
    const email = id + '@promisedland.com';
    let authUid;
    try {
      const cred = await createUserWithEmailAndPassword(window.FAUTH, email, pw);
      authUid = cred.user.uid; // Firebase Auth UID 사용
    } catch(authErr) {
      if (authErr.code === 'auth/email-already-in-use') return showErr('이미 사용 중인 아이디입니다.');
      if (authErr.code === 'auth/weak-password') return showErr('비밀번호가 너무 약합니다.');
      console.error('auth register', authErr);
      return showErr('계정 생성 오류: ' + authErr.message);
    }

    const cellId = matchedRoster ? matchedRoster.cellId : '';
    // pw 필드는 저장 안 함 (Firebase Auth가 관리)
    const newUser = { uid:authUid, id, name, phone, birth, cellId, role:'user', status:'pending', createdAt:today(), profileImg:'', idChangedAt:null };
    await window.FDB.setDoc('users', authUid, newUser);
    state.cache.users.push(newUser);

    // 명부 매칭 시 roster 업데이트
    if (matchedRoster) {
      await window.FDB.setDoc('rosters', matchedRoster.id, { linkedUid: authUid, joined: true });
      matchedRoster.linkedUid = authUid;
      matchedRoster.joined = true;
    }

    // 가입 후 로그아웃 (pending 상태이므로 앱 접근 불가)
    await signOut(window.FAUTH);

    const matchMsg = matchedRoster ? ' 명부에서 확인되었습니다.' : ' (명부 미확인 — 관리자가 수동 확인합니다.)';
    showToast('가입 신청 완료!' + matchMsg + ' 관리자 승인 후 로그인 가능합니다.');
    state.page='login'; render();
  });

  // ── Tabs ──
  document.querySelectorAll('[data-tab]').forEach(el => {
    el.addEventListener('click', () => { state.tab=el.dataset.tab; state.detail=null; render(); });
  });

  // ── Profile ──
  document.querySelector('[data-action="open-profile"]')?.addEventListener('click', () => { state.profileOpen=true; render(); });
  document.querySelector('[data-action="close-profile"]')?.addEventListener('click', () => { state.profileOpen=false; render(); });
  document.querySelector('[data-action="logout"]')?.addEventListener('click', async () => {
    await signOut(window.FAUTH).catch(()=>{});
    state.user=null; state.page='login'; state.profileOpen=false; SESSION.clear(); render();
  });
  document.querySelector('[data-action="go-admin"]')?.addEventListener('click', () => {
    state.page='admin'; state.adminSub='dashboard'; state.profileOpen=false; render();
  });
  document.querySelectorAll('[data-profile-page]').forEach(el => {
    el.addEventListener('click', () => { state.profilePage=el.dataset.profilePage; state.profileOpen=false; render(); });
  });
  document.querySelector('[data-action="close-profile-page"]')?.addEventListener('click', () => { state.profilePage=null; render(); });

  // ── Back ──
  document.querySelectorAll('[data-action="back"]').forEach(el => {
    el.addEventListener('click', () => { state.detail=null; render(); });
  });
  document.querySelector('[data-action="back-main"]')?.addEventListener('click', () => {
    if (state.page === 'admin' && state.adminSub !== 'dashboard') {
      state.adminSub = 'dashboard'; render();
    } else {
      state.page='main'; state.tab='home'; render();
    }
  });

  // ── Details ──
  document.querySelectorAll('[data-detail]').forEach(el => {
    el.addEventListener('click', async () => {
      const [type, id] = el.dataset.detail.split(':');
      state.detail = { type, id };
      // Load comments for notice
      if (type === 'notice') {
        const snap = await window.FDB.getCol(`notices/${id}/comments`).catch(()=>[]);
        state.cache.comments[id] = snap.sort((a,b)=>(a.at||'').localeCompare(b.at||''));
      }
      render();
    });
  });


  // ── iOS 스와이프 뒤로가기 ──
  (function setupSwipeBack() {
    let startX = 0, startY = 0, swiping = false;
    const EDGE = 30; // 왼쪽 30px 안에서 시작해야 인식
    document.addEventListener('touchstart', e => {
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
      swiping = startX < EDGE;
    }, { passive: true });
    document.addEventListener('touchend', e => {
      if (!swiping) return;
      const dx = e.changedTouches[0].clientX - startX;
      const dy = Math.abs(e.changedTouches[0].clientY - startY);
      swiping = false;
      if (dx > 60 && dy < 80) {
        // 뒤로가기: 하위 페이지/모달만 닫음, 홈(메인탭)은 스와이프 불가
        if (state.detail) { state.detail = null; render(); }
        else if (state.profilePage) { state.profilePage = null; render(); }
        else if (state.page === 'admin' && state.adminSub !== 'dashboard') { state.adminSub = 'dashboard'; render(); }
        else if (state.page === 'admin') { state.page = 'main'; state.tab = 'home'; render(); }
        else if (state.page === 'register') { state.page = 'login'; render(); }
        // 메인 탭 간 스와이프는 의도치 않은 동작 방지를 위해 제거
        // (홈탭에서 스와이프해도 아무 동작 없음)
      }
    });
  })();

  // ── Worship ──
  document.querySelectorAll('[data-action="go-worship"]').forEach(el => {
    el.addEventListener('click', () => { state.detail={type:'worship',id:'latest'}; render(); });
  });
  // 홈탭 찬양카드: 유튜브 있으면 바로 재생, 없으면 세트 이동
  document.querySelectorAll('[data-worship-play]').forEach(el => {
    el.addEventListener('click', () => {
      const idx = parseInt(el.dataset.worshipPlay);
      const worships = state.cache.worshipSets;
      const latest = worships[worships.length - 1];
      const song = latest?.songs?.[idx];
      if (song?.url) {
        window.open(song.url, '_blank');
      } else {
        state.detail={type:'worship',id:'latest'}; render();
      }
    });
  });

  // ── Sheet toggle ──
  document.querySelectorAll('[data-sheet-toggle]').forEach(el => {
    el.addEventListener('click', () => {
      const panel = document.getElementById('sheet-panel-'+el.dataset.sheetToggle);
      if (panel) panel.classList.toggle('hidden');
    });
  });

  // ── Comment ──
  document.querySelector('[data-action="post-comment"]')?.addEventListener('click', async function() {
    const input = document.getElementById('comment-input');
    if (!input?.value.trim()) return;
    const nid = this.dataset.noticeId;
    const comment = { id:uid(), uid:state.user.uid, name:state.user.name, body:input.value.trim(), at:today() };
    await window.FDB.addDoc(`notices/${nid}/comments`, comment);
    if (!state.cache.comments[nid]) state.cache.comments[nid]=[];
    state.cache.comments[nid].push(comment);
    input.value=''; render();
  });
  document.getElementById('comment-input')?.addEventListener('keydown', e => {
    if(e.key==='Enter') document.querySelector('[data-action="post-comment"]')?.click();
  });

  // ── Calendar ──
  document.querySelectorAll('[data-cal-date]').forEach(el => {
    el.addEventListener('click', () => { state._calSel=el.dataset.calDate; render(); });
  });
  document.querySelector('[data-action="cal-prev"]')?.addEventListener('click', () => {
    const vm = state._calMonth || { y:new Date().getFullYear(), m:new Date().getMonth() };
    vm.m--; if(vm.m<0){vm.m=11;vm.y--;}
    state._calMonth={...vm}; render();
  });
  document.querySelector('[data-action="cal-next"]')?.addEventListener('click', () => {
    const vm = state._calMonth || { y:new Date().getFullYear(), m:new Date().getMonth() };
    vm.m++; if(vm.m>11){vm.m=0;vm.y++;}
    state._calMonth={...vm}; render();
  });

  // ── Admin nav ──
  document.querySelectorAll('[data-admin]').forEach(el => {
    el.addEventListener('click', () => { state.adminSub=el.dataset.admin; render(); });
  });

  // ── Admin: Approve ──
  document.querySelectorAll('[data-action="approve"]').forEach(el => {
    el.addEventListener('click', async () => {
      const targetUid = el.dataset.uid;
      const u = state.cache.users.find(x=>x.uid===targetUid);
      // 명부 매칭 재확인 (아직 linkedUid 없을 경우)
      const rosters = state.cache.rosters;
      let matchedRoster = rosters.find(r=>r.linkedUid===targetUid);
      if (!matchedRoster && u) {
        matchedRoster = rosters.find(r => {
          const phoneMatch = r.phone && r.phone.replace(/[^\d]/g,'') === (u.phone||'').replace(/[^\d]/g,'');
          const birthMatch = r.birth && r.birth === u.birth;
          const nameMatch  = r.name && r.name.replace(/\s/g,'') === (u.name||'').replace(/\s/g,'');
          return nameMatch && (phoneMatch || birthMatch);
        });
        if (matchedRoster) {
          await window.FDB.setDoc('rosters', matchedRoster.id, { linkedUid: targetUid, joined: true });
          matchedRoster.linkedUid = targetUid;
          matchedRoster.joined = true;
        }
      }
      // cellId 자동 배정
      const cellId = matchedRoster ? matchedRoster.cellId : (u?.cellId || '');
      await window.FDB.setDoc('users', targetUid, { status:'active', cellId });
      if (u) { u.status='active'; u.cellId=cellId; }
      showToast('승인 완료!' + (matchedRoster ? ` (${matchedRoster.name} — ${state.cache.cells.find(c=>c.id===cellId)?.name||'목장 배정'})` : '')); render();
    });
  });

  // ── Admin: Approve withdraw ──
  document.querySelectorAll('[data-action="approve-withdraw"]').forEach(el => {
    el.addEventListener('click', () => {
      const targetUid = el.dataset.uid;
      showConfirm('정말 탈퇴 처리하시겠습니까?', async () => {
        await window.FDB.deleteDoc('users', targetUid);
        state.cache.users = state.cache.users.filter(u=>u.uid!==targetUid);
        showToast('탈퇴 처리 완료!'); render();
      }, '탈퇴 처리');
    });
  });

  // ── Admin: Delete items ──
  document.querySelectorAll('[data-action="del-notice"]').forEach(el => {
    el.addEventListener('click', () => {
      showConfirm('공지를 삭제하시겠습니까?', async () => {
        await window.FDB.deleteDoc('notices', el.dataset.nid);
        state.cache.notices = state.cache.notices.filter(n=>n.id!==el.dataset.nid);
        render();
      });
    });
  });
  document.querySelectorAll('[data-action="del-event"]').forEach(el => {
    el.addEventListener('click', () => {
      showConfirm('일정을 삭제하시겠습니까?', async () => {
        await window.FDB.deleteDoc('events', el.dataset.eid);
        state.cache.events = state.cache.events.filter(e=>e.id!==el.dataset.eid);
        render();
      });
    });
  });
  document.querySelectorAll('[data-action="del-bulletin"]').forEach(el => {
    el.addEventListener('click', () => {
      showConfirm('주보를 삭제하시겠습니까?', async () => {
        await window.FDB.deleteDoc('bulletins', el.dataset.bid);
        state.cache.bulletins = state.cache.bulletins.filter(b=>b.id!==el.dataset.bid);
        render();
      });
    });
  });
  document.querySelectorAll('[data-action="del-worship"]').forEach(el => {
    el.addEventListener('click', () => {
      showConfirm('찬양 세트를 삭제하시겠습니까?', async () => {
        await window.FDB.deleteDoc('worshipSets', el.dataset.wid);
        state.cache.worshipSets = state.cache.worshipSets.filter(w=>w.id!==el.dataset.wid);
        render();
      });
    });
  });
  document.querySelectorAll('[data-action="del-cellmeet"]').forEach(el => {
    el.addEventListener('click', () => {
      showConfirm('목장 모임 자료를 삭제하시겠습니까?', async () => {
        await window.FDB.deleteDoc('cellMeetings', el.dataset.mid);
        state.cache.cellMeetings = state.cache.cellMeetings.filter(m=>m.id!==el.dataset.mid);
        render();
      });
    });
  });
  document.querySelectorAll('[data-action="del-offering"]').forEach(el => {
    el.addEventListener('click', () => {
      showConfirm('헌금 기록을 삭제하시겠습니까?', async () => {
        const d = el.dataset.date; const idx = parseInt(el.dataset.idx);
        const offerings = state.cache.offerings;
        if (offerings[d]) { offerings[d].items.splice(idx,1); await window.FDB.setDoc('offering', d, offerings[d]); }
        state._offDate=d; render();
      });
    });
  });

  // ── Admin: Attendance ──
  document.querySelectorAll('[data-action="toggle-att"]').forEach(el => {
    el.addEventListener('click', () => {
      const d = document.getElementById('att-date')?.value || today();
      const att = state.cache.attendance;
      if (!att[d]) att[d] = { marks:{} };
      att[d].marks[el.dataset.rid] = !att[d].marks[el.dataset.rid];
      state._attDate=d; render();
    });
  });
  document.querySelectorAll('[data-att-tab]').forEach(el => {
    el.addEventListener('click', () => { state.adminAttTab=el.dataset.attTab; render(); });
  });
  document.querySelector('[data-action="save-attendance"]')?.addEventListener('click', async () => {
    const d = document.getElementById('att-date')?.value || today();
    const att = state.cache.attendance;
    await window.FDB.setDoc('attendance', d, att[d]||{marks:{}});
    showToast('출석 저장 완료!');
  });

  // ── Admin: Offering ──
  document.querySelector('[data-action="add-offering"]')?.addEventListener('click', async () => {
    const d = document.getElementById('off-date')?.value || today();
    const pid = document.getElementById('off-person')?.value;
    const type = document.getElementById('off-type')?.value;
    const amount = Number(document.getElementById('off-amount')?.value.replace(/,/g,''));
    if (!pid || !amount) return;
    const rosters = state.cache.rosters;
    const person = rosters.find(r=>r.id===pid);
    const offerings = state.cache.offerings;
    if (!offerings[d]) offerings[d] = { items:[] };
    offerings[d].items.push({ id:uid(), personId:pid, name:person?.name||'', type, amount });
    await window.FDB.setDoc('offering', d, offerings[d]);
    state._offDate=d; render();
  });

  // ── Admin: Send notification ──
  document.querySelector('[data-action="send-noti"]')?.addEventListener('click', async () => {
    const title = document.getElementById('noti-title')?.value;
    const body = document.getElementById('noti-body')?.value;
    if (!title) return;
    const nid = uid();
    const notiData = { id:nid, title, body, type:'etc', at:today() };
    await window.FDB.setDoc('notifications', nid, notiData);
    state.cache.notifications.push(notiData);
    showToast('알림 발송 완료!');
  });

  // ── Admin: Roster tab ──
  document.querySelectorAll('[data-roster-tab]').forEach(el => {
    el.addEventListener('click', () => { state.adminRosterTab=el.dataset.rosterTab; render(); });
  });

  // ── Admin: Roster menu ──
  document.querySelectorAll('[data-action="roster-menu"]').forEach(el => {
    el.addEventListener('click', e => {
      e.stopPropagation();
      const dd = document.getElementById('roster-dd-'+el.dataset.rid);
      document.querySelectorAll('[id^="roster-dd-"]').forEach(d=>{ if(d!==dd) d.classList.add('hidden'); });
      dd?.classList.toggle('hidden');
    });
  });
  document.querySelectorAll('[data-action="roster-edit"]').forEach(el => {
    el.addEventListener('click', e => {
      e.stopPropagation();
      const rid = el.dataset.rid;
      const r = state.cache.rosters.find(x=>x.id===rid); if (!r) return;
      const cells = state.cache.cells;
      const dd = document.getElementById('roster-dd-'+rid); dd?.classList.add('hidden');
      const card = document.getElementById('roster-card-'+rid); if (!card) return;
      const existing = document.getElementById('roster-inline-edit-'+rid);
      if (existing) { existing.remove(); return; }
      const editDiv = document.createElement('div');
      editDiv.id = 'roster-inline-edit-'+rid;
      editDiv.className = 'mt-3 space-y-2';
      editDiv.innerHTML = `
        <input id="re-name-${rid}" value="${r.name}" class="w-full px-3 py-2 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
        <input id="re-phone-${rid}" value="${fmtPhone(r.phone)}" inputmode="numeric" class="w-full px-3 py-2 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
        <input id="re-birth-${rid}" value="${r.birth}" inputmode="numeric" class="w-full px-3 py-2 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
        <select id="re-cell-${rid}" class="w-full px-3 py-2 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black">
          <option value="">미배정</option>${cells.map(c=>`<option value="${c.id}"${c.id===r.cellId?' selected':''}>${c.name}</option>`).join('')}
        </select>
        <button id="re-save-${rid}" class="w-full py-2 bg-black text-white rounded-xl text-xs font-bold">저장</button>`;
      card.appendChild(editDiv);
      document.getElementById('re-phone-'+rid)?.addEventListener('input', function() { this.value=fmtPhone(this.value); });
      document.getElementById('re-save-'+rid)?.addEventListener('click', async () => {
        const g = id => document.getElementById(id)?.value||'';
        const updated = { ...r, name:g('re-name-'+rid)||r.name, phone:fmtPhone(g('re-phone-'+rid)||r.phone), birth:g('re-birth-'+rid)||r.birth, cellId:g('re-cell-'+rid)||r.cellId };
        await window.FDB.setDoc('rosters', rid, updated);
        const idx = state.cache.rosters.findIndex(x=>x.id===rid);
        if (idx>=0) state.cache.rosters[idx]=updated;
        showToast('정보가 변경되었습니다.'); render();
      });
    });
  });
  document.querySelectorAll('[data-action="roster-grant"]').forEach(el => {
    el.addEventListener('click', async e => {
      e.stopPropagation();
      const rid = el.dataset.rid;
      const r = state.cache.rosters.find(x=>x.id===rid); if (!r||!r.linkedUid) return;
      const u = state.cache.users.find(x=>x.uid===r.linkedUid);
      if (u) {
        u.role = u.role==='admin'?'user':'admin';
        await window.FDB.setDoc('users', u.uid, { role:u.role });
      }
      showToast('변경 완료!'); render();
    });
  });
  document.querySelectorAll('[data-action="roster-delete"]').forEach(el => {
    el.addEventListener('click', e => {
      e.stopPropagation();
      showConfirm('탈퇴 처리하시겠습니까?', async () => {
        const rid = el.dataset.rid;
        await window.FDB.deleteDoc('rosters', rid);
        state.cache.rosters = state.cache.rosters.filter(r=>r.id!==rid);
        render();
      });
    });
  });

  // ── Admin: Edit notice ──
  document.querySelectorAll('[data-action="edit-notice"]').forEach(el => {
    el.addEventListener('click', () => {
      const nid = el.dataset.nid;
      const n = state.cache.notices.find(x=>x.id===nid); if (!n) return;
      const area = document.getElementById('admin-form-area'); if (!area) return;
      area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4 fade-in">
        ${adminInput('nf-title','제목','공지 제목')}
        ${adminTextarea('nf-body','내용','',5)}
        <label class="flex items-center gap-2"><input id="nf-pinned" type="checkbox" class="w-4 h-4 rounded accent-black"/><span class="text-sm font-medium">중요 공지로 고정</span></label>
        <div class="flex gap-2">
          <button onclick="state.adminSub='notice';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">취소</button>
          <button id="update-notice" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">수정</button>
        </div>
      </div>`;
      document.getElementById('nf-title').value = n.title;
      document.getElementById('nf-body').value = n.body;
      document.getElementById('nf-pinned').checked = n.pinned;
      document.getElementById('update-notice')?.addEventListener('click', async () => {
        const updated = { ...n, title:document.getElementById('nf-title').value, body:document.getElementById('nf-body').value, pinned:document.getElementById('nf-pinned').checked };
        await window.FDB.setDoc('notices', nid, updated);
        const idx = state.cache.notices.findIndex(x=>x.id===nid);
        if(idx>=0) state.cache.notices[idx]=updated;
        showToast('공지 수정 완료!'); render();
      });
    });
  });

  // ── Admin: Edit event ──
  document.querySelectorAll('[data-action="edit-event"]').forEach(el => {
    el.addEventListener('click', () => {
      const eid = el.dataset.eid;
      const ev = state.cache.events.find(x=>x.id===eid); if (!ev) return;
      const area = document.getElementById('admin-form-area'); if (!area) return;
      area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4 fade-in">
        ${adminInput('ef-title','제목','')}
        ${adminInput('ef-date','날짜','')}
        ${adminInput('ef-time','시간','')}
        ${adminInput('ef-loc','장소','')}
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">카테고리</label>
          <select id="ef-cat" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black">
            ${['예배','모임','행사','생일','기타'].map(c=>`<option value="${c}"${c===ev.cat?' selected':''}>${c}</option>`).join('')}
          </select>
        </div>
        <div class="flex gap-2">
          <button onclick="state.adminSub='event';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">취소</button>
          <button id="update-event" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">수정</button>
        </div>
      </div>`;
      document.getElementById('ef-title').value=ev.title; document.getElementById('ef-date').value=ev.date;
      document.getElementById('ef-time').value=ev.time||''; document.getElementById('ef-loc').value=ev.loc||'';
      document.getElementById('update-event')?.addEventListener('click', async () => {
        const g = id => document.getElementById(id)?.value||'';
        const updated = { ...ev, title:g('ef-title'), date:g('ef-date'), time:g('ef-time'), loc:g('ef-loc'), cat:g('ef-cat')||'기타' };
        await window.FDB.setDoc('events', eid, updated);
        const idx = state.cache.events.findIndex(x=>x.id===eid);
        if(idx>=0) state.cache.events[idx]=updated;
        showToast('일정 수정 완료!'); render();
      });
    });
  });

  // ── Admin: Edit bulletin ──
  document.querySelectorAll('[data-action="edit-bulletin"]').forEach(el => {
    el.addEventListener('click', () => {
      const bid = el.dataset.bid;
      const b = state.cache.bulletins.find(x=>x.id===bid); if (!b) return;
      const rosters = state.cache.rosters;
      const rOpts = `<option value="">미정</option>${rosters.map(r=>`<option value="${r.name}">${r.name}</option>`).join('')}`;
      const area = document.getElementById('admin-form-area'); if (!area) return;
      area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4 fade-in">
        ${adminInput('bf-title','제목','')} ${adminInput('bf-date','날짜','')}
        ${adminTextarea('bf-order','예배순서','',6)}
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">대표기도</label><select id="bf-prayer" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm">${rOpts}</select></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">성경봉독</label><select id="bf-bible" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm">${rOpts}</select></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">성도의 교제</label><select id="bf-announce" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm">${rOpts}</select></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">봉헌</label><select id="bf-offering" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm">${rOpts}</select></div>
        ${adminTextarea('bf-songs','찬양곡 목록','',4)} ${adminTextarea('bf-announce-text','광고 내용','',4)}
        <div class="flex gap-2">
          <button onclick="state.adminSub='bulletin';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">취소</button>
          <button id="update-bulletin" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">수정</button>
        </div>
      </div>`;
      document.getElementById('bf-title').value=b.title; document.getElementById('bf-date').value=b.date;
      document.getElementById('bf-order').value=b.order||'';
      const selVal = (sid, val) => { const el=document.getElementById(sid); if(el) el.value=val||''; };
      selVal('bf-prayer',b.prayer_duty); selVal('bf-bible',b.bible_reading); selVal('bf-announce',b.announcement_duty); selVal('bf-offering',b.offering_duty);
      document.getElementById('bf-songs').value=b.songs||''; document.getElementById('bf-announce-text').value=b.announce||'';
      document.getElementById('update-bulletin')?.addEventListener('click', async () => {
        const g = id => document.getElementById(id)?.value||'';
        const updated = { ...b, title:g('bf-title'), date:g('bf-date'), order:g('bf-order'), prayer_duty:g('bf-prayer'), bible_reading:g('bf-bible'), announcement_duty:g('bf-announce'), offering_duty:g('bf-offering'), songs:g('bf-songs'), announce:g('bf-announce-text') };
        await window.FDB.setDoc('bulletins', bid, updated);
        const idx = state.cache.bulletins.findIndex(x=>x.id===bid);
        if(idx>=0) state.cache.bulletins[idx]=updated;
        showToast('주보 수정 완료!'); render();
      });
    });
  });

  // ── Admin: Edit worship ──
  document.querySelectorAll('[data-action="edit-worship"]').forEach(el => {
    el.addEventListener('click', () => {
      const wid = el.dataset.wid;
      const ws = state.cache.worshipSets.find(x=>x.id===wid); if (!ws) return;
      const KEYS=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
      let songCount = ws.songs.length || 1;
      const area = document.getElementById('admin-form-area'); if(!area) return;
      const getSongRows = (songs) => {
        let rows='';
        for(let i=0;i<songCount;i++){
          const s = songs[i]||{title:'',url:'',key:'C'};
          rows+=`<div class="bg-zinc-50 rounded-xl p-3 space-y-2 mb-2">
            <p class="text-[10px] font-bold text-zinc-400">곡 ${i+1}</p>
            <input id="ws-title-${i}" value="${s.title||''}" placeholder="곡 제목" class="w-full px-3 py-2 bg-white border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
            <input id="ws-url-${i}" value="${s.url||''}" placeholder="유튜브 링크" class="w-full px-3 py-2 bg-white border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
            <div class="flex-1"><label class="block text-[10px] font-bold text-zinc-500 mb-1">키</label>
              <select id="ws-key-${i}" class="w-full px-3 py-2 bg-white border border-zinc-200 rounded-xl text-sm">${KEYS.map(k=>`<option value="${k}"${k===s.key?' selected':''}>${k}</option>`).join('')}</select>
            </div>
          </div>`;
        }
        return rows;
      };
      area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4 fade-in">
        ${adminInput('wf-date','주차 날짜','')}
        ${adminInput('wf-leader','인도자','')}
        <div><label class="block text-xs font-bold text-zinc-600 mb-2 ml-1">곡 목록</label>
          <div id="song-rows">${getSongRows(ws.songs)}</div>
          <button id="add-song-row" class="w-full py-2 border border-dashed border-zinc-200 rounded-xl text-xs font-bold text-zinc-400 mt-1">+ 곡 추가</button>
        </div>
        <div class="flex gap-2">
          <button onclick="state.adminSub='worship';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">취소</button>
          <button id="update-worship" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">수정</button>
        </div>
      </div>`;
      document.getElementById('wf-date').value=ws.date; document.getElementById('wf-leader').value=ws.leader||'';
      document.getElementById('add-song-row')?.addEventListener('click',()=>{ songCount++; document.getElementById('song-rows').innerHTML=getSongRows(ws.songs); });
      document.getElementById('update-worship')?.addEventListener('click', async () => {
        const g = id => document.getElementById(id)?.value||'';
        const songs = [];
        for(let i=0;i<songCount;i++){ const t=g('ws-title-'+i); if(t) songs.push({title:t,url:g('ws-url-'+i),key:g('ws-key-'+i)||'C',sheet:''}); }
        const updated = { ...ws, date:g('wf-date'), leader:g('wf-leader'), songs };
        await window.FDB.setDoc('worshipSets', wid, updated);
        const idx = state.cache.worshipSets.findIndex(x=>x.id===wid);
        if(idx>=0) state.cache.worshipSets[idx]=updated;
        showToast('찬양 수정 완료!'); render();
      });
    });
  });

  // ── Admin: Edit cellmeet ──
  document.querySelectorAll('[data-action="edit-cellmeet"]').forEach(el => {
    el.addEventListener('click', () => {
      const mid = el.dataset.mid;
      const m = state.cache.cellMeetings.find(x=>x.id===mid); if (!m) return;
      let qCount = m.questions?.length || 1;
      const area = document.getElementById('admin-form-area'); if(!area) return;
      const getQRows = () => {
        let rows='';
        for(let i=0;i<qCount;i++){
          rows+=`<div class="flex gap-2 items-start mb-2"><textarea id="cm-q-${i}" rows="2" placeholder="질문 ${i+1}" class="flex-1 px-3 py-2 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black resize-none"></textarea></div>`;
        }
        return rows;
      };
      area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4 fade-in">
        ${adminInput('cm-date','날짜','')} ${adminInput('cm-verse','말씀 구절','')}
        ${adminTextarea('cm-versetext','말씀 본문 (핵심)','',2)}
        <div><label class="block text-xs font-bold text-zinc-600 mb-2 ml-1">나눔 질문</label>
          <div id="cm-q-rows">${getQRows()}</div>
          <button id="add-question-btn" class="w-full py-2 border border-dashed border-zinc-200 rounded-xl text-xs font-bold text-zinc-400 mt-1">+ 질문 추가</button>
        </div>
        ${adminTextarea('cm-prayer','함께 기도 제목','',4)}
        <div class="flex gap-2">
          <button onclick="state.adminSub='cellmeet';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">취소</button>
          <button id="update-cellmeet" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">수정</button>
        </div>
      </div>`;
      document.getElementById('cm-date').value=m.date; document.getElementById('cm-verse').value=m.verse||'';
      document.getElementById('cm-versetext').value=m.verseText||''; document.getElementById('cm-prayer').value=m.prayerItems||'';
      m.questions?.forEach((q,i)=>{ const el=document.getElementById('cm-q-'+i); if(el) el.value=q; });
      document.getElementById('add-question-btn')?.addEventListener('click',()=>{ qCount++; document.getElementById('cm-q-rows').innerHTML=getQRows(); });
      document.getElementById('update-cellmeet')?.addEventListener('click', async () => {
        const g = id => document.getElementById(id)?.value||'';
        const questions=[];
        for(let i=0;i<qCount;i++){ const q=g('cm-q-'+i); if(q.trim()) questions.push(q.trim()); }
        const updated = { ...m, date:g('cm-date'), verse:g('cm-verse'), verseText:g('cm-versetext'), questions, prayerItems:g('cm-prayer') };
        await window.FDB.setDoc('cellMeetings', mid, updated);
        const idx = state.cache.cellMeetings.findIndex(x=>x.id===mid);
        if(idx>=0) state.cache.cellMeetings[idx]=updated;
        showToast('목장 모임 자료 수정 완료!'); render();
      });
    });
  });

  // ── Admin: Noti toggle ──
  document.querySelectorAll('[data-noti-toggle]').forEach(el => {
    el.addEventListener('click', async () => {
      const key = el.dataset.notiToggle;
      const noti = state.user._noti || {worship:true,notice:true,verse:true,schedule:true,duty:true};
      noti[key] = !noti[key];
      state.user._noti = noti;
      await window.FDB.setDoc('users', state.user.uid, { _noti: noti });
      SESSION.set(state.user); render();
    });
  });

  // ── Settings ──
  document.getElementById('toggle-pw-section')?.addEventListener('click', () => {
    document.getElementById('pw-section')?.classList.toggle('hidden');
  });
  document.getElementById('toggle-id-section')?.addEventListener('click', () => {
    document.getElementById('id-section')?.classList.toggle('hidden');
  });
  document.getElementById('save-pw')?.addEventListener('click', async () => {
    const cur=document.getElementById('pw-current')?.value;
    const nw=document.getElementById('pw-new')?.value;
    const cf=document.getElementById('pw-confirm')?.value;
    const u=state.cache.users.find(x=>x.uid===state.user.uid);
    if (!u||u.pw!==cur) return showToast('현재 비밀번호가 틀렸습니다.');
    if (nw!==cf) return showToast('새 비밀번호가 일치하지 않습니다.');
    if (nw.length<8 || !/[a-zA-Z]/.test(nw) || !/[0-9]/.test(nw)) return showToast('영문+숫자 혼합 8자 이상이어야 합니다.');
    u.pw=nw;
    await window.FDB.setDoc('users', u.uid, { pw:nw });
    state.user=u; SESSION.set(u);
    showToast('비밀번호 변경 완료!');
  });
  document.getElementById('save-id')?.addEventListener('click', async () => {
    const pwVerify=document.getElementById('id-pw-verify')?.value;
    const newId=document.getElementById('id-new')?.value?.trim();
    const u=state.cache.users.find(x=>x.uid===state.user.uid);
    if (!u||u.pw!==pwVerify) return showToast('비밀번호가 틀렸습니다.');
    if (!newId) return showToast('새 아이디를 입력해주세요.');
    if (newId.length<3) return showToast('아이디는 3자 이상이어야 합니다.');
    if (state.cache.users.find(x=>x.id===newId&&x.uid!==u.uid)) return showToast('이미 사용 중인 아이디입니다.');
    u.id=newId; u.idChangedAt=today();
    await window.FDB.setDoc('users', u.uid, { id:newId, idChangedAt:today() });
    state.user=u; SESSION.set(u);
    showToast('아이디 변경 완료! 다음 로그인 시 새 아이디를 사용해주세요.');
    render();
  });
  document.getElementById('withdraw-btn')?.addEventListener('click', () => {
    // 비밀번호 입력 모달
    state._confirmModal = {
      msg: `<div class="space-y-3">
        <p>탈퇴 신청 후 관리자 승인이 필요합니다.<br/>현재 비밀번호를 입력해주세요.</p>
        <input id="withdraw-pw-input" type="password" placeholder="비밀번호" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black mt-2"/>
      </div>`,
      yesLabel: '탈퇴 신청',
      yesClass: 'bg-red-500 text-white',
      onYes: async () => {
        const pw = document.getElementById('withdraw-pw-input')?.value;
        const u = state.cache.users.find(x=>x.uid===state.user.uid);
        if (!u) { showToast('사용자 정보를 찾을 수 없습니다.'); return; }
        // Firebase Auth 비밀번호 확인
        try {
          const authUser = window.FAUTH.currentUser;
          if (authUser) {
            const email = u.id + '@promisedland.com';
            const cred = EmailAuthProvider.credential(email, pw);
            await reauthenticateWithCredential(authUser, cred);
          } else if (u.pw !== pw) {
            showToast('비밀번호가 틀렸습니다.'); return;
          }
        } catch(e) {
          showToast('비밀번호가 틀렸습니다.'); return;
        }
        await window.FDB.setDoc('users', u.uid, { status:'withdraw_pending', withdrawAt:today() });
        await signOut(window.FAUTH).catch(()=>{});
        SESSION.clear();
        state.user=null; state.page='login'; state.profilePage=null;
        showToast('탈퇴 신청이 접수되었습니다. 관리자 승인 후 처리됩니다.');
        render();
      }
    };
    render();
  });

  // ── Profile edit: image upload → crop modal ──
  document.getElementById('profile-img-input')?.addEventListener('change', function() {
    const file = this.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        const origW = img.naturalWidth; const origH = img.naturalHeight;
        const size = 240;
        const aspect = origW/origH;
        let w,h;
        if (aspect>1) { w=size; h=size/aspect; } else { h=size; w=size*aspect; }
        state._cropModal = { src:e.target.result, origW, origH, w, h, ox:(size-w)/2, oy:(size-h)/2 };
        state._pendingProfileFile = file;
        render();
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });

  document.getElementById('save-profile-edit')?.addEventListener('click', async () => {
    const name = document.getElementById('edit-name')?.value;
    const phone = fmtPhone(document.getElementById('edit-phone')?.value||'');
    const birth = document.getElementById('edit-birth')?.value.replace(/\D/g,'');
    const cellId = state.user.cellId; // 목장은 관리자만 변경 가능
    let profileImg = state.user.profileImg;
    if (state._pendingProfileImg) {
      showToast('사진 업로드 중...');
      const url = await window.FDB.uploadBase64(`profiles/${state.user.uid}`, state._pendingProfileImg);
      if (url) profileImg = url;
      state._pendingProfileImg = null;
    }
    const updated = { ...state.user };
    if (name) updated.name=name;
    updated.phone=phone; updated.birth=birth; updated.cellId=cellId; updated.profileImg=profileImg;
    await window.FDB.setDoc('users', state.user.uid, updated);
    const idx = state.cache.users.findIndex(u=>u.uid===state.user.uid);
    if (idx>=0) state.cache.users[idx]=updated;
    state.user=updated; SESSION.set(updated);
    showToast('프로필 저장 완료!'); state.profilePage=null; render();
  });

  // ── Edit phone/birth realtime format in profile edit ──
  document.getElementById('edit-phone')?.addEventListener('input', function() { this.value=fmtPhone(this.value); });
  document.getElementById('edit-birth')?.addEventListener('input', function() {
    const d=this.value.replace(/\D/g,'');
    if(d.length<=4) this.value=d;
    else if(d.length<=6) this.value=d.slice(0,4)+'.'+d.slice(4);
    else this.value=d.slice(0,4)+'.'+d.slice(4,6)+'.'+d.slice(6,8);
  });

  // ── Admin: Show forms ──
  // Notice form
  document.querySelector('[data-action="show-notice-form"]')?.addEventListener('click', () => {
    const area = document.getElementById('admin-form-area'); if (!area) return;
    let pendingImgs = [];
    area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4 fade-in">
      ${adminInput('nf-title','제목','공지 제목')}
      ${adminTextarea('nf-body','내용','공지 내용을 입력하세요',5)}
      <div>
        <label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">사진 첨부</label>
        <label class="flex items-center gap-2 px-3 py-2.5 bg-zinc-50 border border-zinc-200 rounded-xl text-sm text-zinc-400 cursor-pointer w-full">
          ${icon('attach_file','',18)} 이미지 선택 (여러 장 가능)
          <input id="nf-images" type="file" accept="image/*" multiple class="hidden"/>
        </label>
        <div id="nf-image-preview" class="flex gap-2 mt-2 flex-wrap"></div>
      </div>
      <label class="flex items-center gap-2"><input id="nf-pinned" type="checkbox" class="w-4 h-4 rounded accent-black"/><span class="text-sm font-medium">중요 공지로 고정</span></label>
      <div class="flex gap-2">
        <button onclick="state.adminSub='notice';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">취소</button>
        <button id="save-notice" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">저장</button>
      </div>
    </div>`;
    document.getElementById('nf-images')?.addEventListener('change', function() {
      const preview = document.getElementById('nf-image-preview');
      Array.from(this.files).forEach(file => {
        const r = new FileReader();
        r.onload = e => {
          pendingImgs.push({file, dataUrl: e.target.result});
          if (preview) { const img=document.createElement('img'); img.src=e.target.result; img.className='w-16 h-16 rounded-xl object-cover border border-zinc-200'; preview.appendChild(img); }
        };
        r.readAsDataURL(file);
      });
    });
    document.getElementById('save-notice')?.addEventListener('click', async () => {
      const title = document.getElementById('nf-title')?.value; if (!title) return;
      showToast('저장 중...');
      const imageUrls = [];
      for (const {file} of pendingImgs) {
        const nid2 = uid();
        const url = await window.FDB.uploadFile(`notice_images/${nid2}`, file);
        if (url) imageUrls.push(url);
      }
      const nid = uid();
      const n = { id:nid, title, body:document.getElementById('nf-body')?.value||'', pinned:document.getElementById('nf-pinned')?.checked||false, by:state.user.uid, at:today(), images:imageUrls };
      await window.FDB.setDoc('notices', nid, n);
      state.cache.notices.unshift(n);
      showToast('공지 저장 완료!'); render();
    });
  });

  // Event form
  document.querySelector('[data-action="show-event-form"]')?.addEventListener('click', () => {
    const area = document.getElementById('admin-form-area'); if (!area) return;
    area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4 fade-in">
      ${adminInput('ef-title','제목','주일 청년 예배')}
      ${adminInput('ef-date','날짜',today())}
      ${adminInput('ef-time','시간','14:00')}
      ${adminInput('ef-loc','장소','본당')}
      <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">카테고리</label>
        <select id="ef-cat" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm">
          ${['예배','모임','행사','생일','기타'].map(c=>`<option value="${c}">${c}</option>`).join('')}
        </select>
      </div>
      <div class="flex gap-2">
        <button onclick="state.adminSub='event';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">취소</button>
        <button id="save-event" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">저장</button>
      </div>
    </div>`;
    document.getElementById('save-event')?.addEventListener('click', async () => {
      const g = id => document.getElementById(id)?.value||'';
      const title=g('ef-title'); if (!title) return;
      const eid = uid();
      const ev = { id:eid, title, date:g('ef-date'), time:g('ef-time'), loc:g('ef-loc'), cat:g('ef-cat')||'기타' };
      await window.FDB.setDoc('events', eid, ev);
      state.cache.events.push(ev); state.cache.events.sort((a,b)=>a.date.localeCompare(b.date));
      showToast('일정 저장 완료!'); render();
    });
  });

  // Roster form
  document.querySelector('[data-action="show-roster-form"]')?.addEventListener('click', () => {
    const cells = state.cache.cells;
    const area = document.getElementById('roster-form-area'); if (!area) return;
    area.innerHTML = `<div class="bg-white p-4 rounded-2xl border border-zinc-100 mb-4 space-y-3 fade-in">
      <input id="rf-name" placeholder="이름" class="w-full px-3 py-2.5 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
      <input id="rf-phone" inputmode="numeric" placeholder="010-0000-0000" class="w-full px-3 py-2.5 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
      <input id="rf-birth" inputmode="numeric" placeholder="19950315" class="w-full px-3 py-2.5 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
      <select id="rf-cell" class="w-full px-3 py-2.5 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black">
        <option value="">목장 선택</option>${cells.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}
      </select>
      <div class="flex gap-2">
        <button id="cancel-roster-form" class="flex-1 py-2 border border-zinc-200 rounded-xl text-sm font-bold">취소</button>
        <button id="save-roster" class="flex-1 py-2 bg-black text-white rounded-xl text-sm font-bold">추가</button>
      </div>
    </div>`;
    document.getElementById('rf-phone')?.addEventListener('input', function() { this.value=fmtPhone(this.value); });
    document.getElementById('cancel-roster-form')?.addEventListener('click', () => { area.innerHTML=''; });
    document.getElementById('save-roster')?.addEventListener('click', async () => {
      const g = id => document.getElementById(id)?.value||'';
      const name=g('rf-name'), phone=fmtPhone(g('rf-phone')), birth=g('rf-birth'), cellId=g('rf-cell');
      if (!name||!phone) return showToast('이름과 전화번호를 입력해주세요.');
      const rid = uid();
      const roster = { id:rid, name, phone, birth, cellId, linkedUid:null };
      await window.FDB.setDoc('rosters', rid, roster);
      state.cache.rosters.push(roster);
      showToast('명부 추가 완료!'); render();
    });
  });

  // Cell management
  document.querySelector('[data-action="show-cell-form"]')?.addEventListener('click', () => {
    const area = document.getElementById('cell-form-area'); if (!area) return;
    if (area.innerHTML) { area.innerHTML=''; return; }
    area.innerHTML = `<div class="bg-white p-4 rounded-2xl border border-zinc-100 mb-3 space-y-2 fade-in">
      <input id="new-cell-name" placeholder="목장 이름" class="w-full px-3 py-2.5 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
      <input id="new-cell-leader" placeholder="목자 이름" class="w-full px-3 py-2.5 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
      <button id="save-new-cell" class="w-full py-2 bg-black text-white rounded-xl text-xs font-bold">추가</button>
    </div>`;
    document.getElementById('save-new-cell')?.addEventListener('click', async () => {
      const name=document.getElementById('new-cell-name')?.value;
      const leader=document.getElementById('new-cell-leader')?.value;
      if (!name) return;
      const cid=uid();
      const cell={id:cid,name,leader:leader||'',order:state.cache.cells.length+1};
      await window.FDB.setDoc('cells', cid, cell);
      state.cache.cells.push(cell);
      showToast('목장 추가 완료!'); render();
    });
  });
  document.querySelectorAll('[data-action="cell-edit"]').forEach(el => {
    el.addEventListener('click', () => { document.getElementById('cell-edit-area-'+el.dataset.cid)?.classList.toggle('hidden'); });
  });
  document.querySelectorAll('[data-action="cell-save"]').forEach(el => {
    el.addEventListener('click', async () => {
      const cid=el.dataset.cid;
      const name=document.getElementById('cell-name-'+cid)?.value;
      const leader=document.getElementById('cell-leader-'+cid)?.value;
      if (!name) return;
      await window.FDB.setDoc('cells', cid, { name, leader });
      const c=state.cache.cells.find(x=>x.id===cid);
      if(c){c.name=name;c.leader=leader;}
      showToast('목장 정보 변경 완료!'); render();
    });
  });
  document.querySelectorAll('[data-action="cell-delete"]').forEach(el => {
    el.addEventListener('click', () => {
      showConfirm('목장을 삭제하시겠습니까?', async () => {
        const cid=el.dataset.cid;
        await window.FDB.deleteDoc('cells', cid);
        state.cache.cells=state.cache.cells.filter(c=>c.id!==cid);
        render();
      });
    });
  });

  // CellMeet form
  document.querySelector('[data-action="show-cellmeet-form"]')?.addEventListener('click', () => {
    const area = document.getElementById('admin-form-area'); if (!area) return;
    let qCount=1;
    const getQRows = () => {
      let rows='';
      for(let i=0;i<qCount;i++){
        rows+=`<div class="flex gap-2 items-start mb-2"><textarea id="cm-q-${i}" rows="2" placeholder="질문 ${i+1}" class="flex-1 px-3 py-2 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black resize-none"></textarea></div>`;
      }
      return rows;
    };
    area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4 fade-in">
      ${adminInput('cm-date','날짜',today())}
      ${adminInput('cm-verse','말씀 구절','요한복음 15:1-8')}
      ${adminTextarea('cm-versetext','말씀 본문 (핵심)','"나는 포도나무요..."',2)}
      <div>
        <label class="block text-xs font-bold text-zinc-600 mb-2 ml-1">나눔 질문</label>
        <div id="cm-q-rows">${getQRows()}</div>
        <button id="add-question-btn" class="w-full py-2 border border-dashed border-zinc-200 rounded-xl text-xs font-bold text-zinc-400 mt-1">+ 질문 추가</button>
      </div>
      ${adminTextarea('cm-prayer','함께 기도 제목','• 목장 지체를 위해',4)}
      <div class="flex gap-2">
        <button onclick="state.adminSub='cellmeet';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">취소</button>
        <button id="save-cellmeet" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">저장</button>
      </div>
    </div>`;
    document.getElementById('add-question-btn')?.addEventListener('click', () => { qCount++; document.getElementById('cm-q-rows').innerHTML=getQRows(); });
    document.getElementById('save-cellmeet')?.addEventListener('click', async () => {
      const g = id => document.getElementById(id)?.value||'';
      const date=g('cm-date'); if(!date) return;
      const questions=[];
      for(let i=0;i<qCount;i++){ const q=g('cm-q-'+i); if(q.trim()) questions.push(q.trim()); }
      const mid=uid();
      const meeting={ id:mid, date, verse:g('cm-verse'), verseText:g('cm-versetext'), questions, prayerItems:g('cm-prayer'), by:state.user.uid, at:today() };
      await window.FDB.setDoc('cellMeetings', mid, meeting);
      state.cache.cellMeetings.unshift(meeting);
      showToast('목장 모임 자료 저장 완료!'); render();
    });
  });

  // Worship form
  const worshipFormEl = document.querySelector('[data-action="show-worship-form"]');
  if (worshipFormEl) {
    worshipFormEl.removeEventListener('click', worshipFormEl._handler);
    const KEYS=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    let songCount=1;
    const getSongRows = () => {
      let rows='';
      for(let i=0;i<songCount;i++){
        rows+=`<div class="bg-zinc-50 rounded-xl p-3 space-y-2 mb-2">
          <p class="text-[10px] font-bold text-zinc-400">곡 ${i+1}</p>
          <input id="ws-title-${i}" placeholder="곡 제목" class="w-full px-3 py-2 bg-white border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
          <input id="ws-url-${i}" placeholder="유튜브 링크" class="w-full px-3 py-2 bg-white border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
          <div class="flex gap-2">
            <div class="flex-1"><label class="block text-[10px] font-bold text-zinc-500 mb-1">키</label>
              <select id="ws-key-${i}" class="w-full px-3 py-2 bg-white border border-zinc-200 rounded-xl text-sm">${KEYS.map(k=>`<option value="${k}">${k}</option>`).join('')}</select>
            </div>
            <div class="flex-1"><label class="block text-[10px] font-bold text-zinc-500 mb-1">악보 (이미지)</label>
              <label class="flex items-center gap-1 px-3 py-2 bg-white border border-zinc-200 rounded-xl text-xs text-zinc-400 cursor-pointer">
                📎 파일선택
                <input id="ws-sheet-${i}" type="file" accept="image/*" class="hidden"/>
              </label>
              <p id="ws-sheet-name-${i}" class="text-[10px] text-zinc-400 mt-0.5 truncate"></p>
            </div>
          </div>
        </div>`;
      }
      return rows;
    };
    worshipFormEl._handler = () => {
      const area = document.getElementById('admin-form-area'); if (!area) return;
      songCount=1;
      area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4 fade-in">
        ${adminInput('wf-date','주차 날짜',today())}
        ${adminInput('wf-leader','인도자','')}
        <div><label class="block text-xs font-bold text-zinc-600 mb-2 ml-1">곡 목록</label>
          <div id="song-rows">${getSongRows()}</div>
          <button id="add-song-row" class="w-full py-2 border border-dashed border-zinc-200 rounded-xl text-xs font-bold text-zinc-400 mt-1">+ 곡 추가</button>
        </div>
        <div class="flex gap-2">
          <button onclick="state.adminSub='worship';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">취소</button>
          <button id="save-worship" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">저장</button>
        </div>
      </div>`;
      const bindSheets = () => { for(let i=0;i<songCount;i++){ document.getElementById('ws-sheet-'+i)?.addEventListener('change', function(){ const nm=document.getElementById('ws-sheet-name-'+i); if(nm) nm.textContent=this.files[0]?.name||''; }); } };
      bindSheets();
      document.getElementById('add-song-row')?.addEventListener('click', () => { songCount++; document.getElementById('song-rows').innerHTML=getSongRows(); bindSheets(); });
      document.getElementById('save-worship')?.addEventListener('click', async () => {
        const g = id => document.getElementById(id)?.value||'';
        const date=g('wf-date'); if(!date) return;
        showToast('저장 중...');
        const songs=[];
        for(let i=0;i<songCount;i++){
          const title=g('ws-title-'+i); if(!title) continue;
          const fileEl=document.getElementById('ws-sheet-'+i); const file=fileEl?.files[0];
          let sheetUrl='';
          if(file){ sheetUrl=await window.FDB.uploadFile(`sheets/${uid()}`, file); }
          songs.push({title,url:g('ws-url-'+i),key:g('ws-key-'+i)||'C',sheet:sheetUrl||''});
        }
        const wid=uid();
        const ws={id:wid,date,leader:g('wf-leader'),songs,by:state.user.uid,at:today(),storedAt:today()};
        await window.FDB.setDoc('worshipSets', wid, ws);
        state.cache.worshipSets.push(ws);
        showToast('찬양 저장 완료!'); render();
      });
    };
    worshipFormEl.addEventListener('click', worshipFormEl._handler);
  }

  // Bulletin form
  const bulletinFormEl = document.querySelector('[data-action="show-bulletin-form"]');
  if (bulletinFormEl) {
    bulletinFormEl._handler = () => {
      const rosters=state.cache.rosters; const area=document.getElementById('admin-form-area'); if(!area) return;
      const rOpts=`<option value="">미정</option>${rosters.map(r=>`<option value="${r.name}">${r.name}</option>`).join('')}`;
      area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4 fade-in">
        ${adminInput('bf-title','제목','2026년 3월 1일 주보')}
        ${adminInput('bf-date','날짜',today())}
        ${adminTextarea('bf-order','예배순서','1. 예배의 부름\n2. 경배와 찬양...',6)}
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">대표기도 담당</label><select id="bf-prayer" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm">${rOpts}</select></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">성경봉독 담당</label><select id="bf-bible" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm">${rOpts}</select></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">성도의 교제 담당</label><select id="bf-announce" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm">${rOpts}</select></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">봉헌 담당</label><select id="bf-offering" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm">${rOpts}</select></div>
        ${adminTextarea('bf-songs','찬양곡 목록','1. 곡명 (Key: G)',4)}
        ${adminTextarea('bf-announce-text','광고 내용','• 수련회 안내',4)}
        <div class="flex gap-2">
          <button onclick="state.adminSub='bulletin';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">취소</button>
          <button id="save-bulletin" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">저장</button>
        </div>
      </div>`;
      document.getElementById('save-bulletin')?.addEventListener('click', async () => {
        const g = id => document.getElementById(id)?.value||'';
        const title=g('bf-title'),date=g('bf-date'); if(!title||!date) return;
        const bid=uid();
        const b={id:bid,title,date,order:g('bf-order'),prayer_duty:g('bf-prayer'),bible_reading:g('bf-bible'),announcement_duty:g('bf-announce'),offering_duty:g('bf-offering'),songs:g('bf-songs'),announce:g('bf-announce-text'),by:state.user.uid,at:today()};
        await window.FDB.setDoc('bulletins', bid, b);
        state.cache.bulletins.push(b); state.cache.bulletins.sort((a,b)=>a.date.localeCompare(b.date));
        showToast('주보 저장 완료!'); render();
      });
    };
    bulletinFormEl.removeEventListener('click', bulletinFormEl._handler);
    bulletinFormEl.addEventListener('click', bulletinFormEl._handler);
  }
}

// ============================================================
// CROP MODAL BINDING
// ============================================================
function bindCropModal() {
  if (!state._cropModal) return;
  const dragArea = document.getElementById('crop-drag-area');
  const imgEl    = document.getElementById('crop-img');
  const scaleInput = document.getElementById('crop-scale');
  if (!dragArea || !imgEl) return;

  const SIZE = 240; // 원형 크롭 지름
  // 드래그 영역 중심 = 이미지 표시 기준점
  const areaRect = dragArea.getBoundingClientRect();
  const areaW = areaRect.width || 360;
  const areaH = areaRect.height || 300;
  // 원의 중심 (drag area 기준)
  const cx = areaW / 2;
  const cy = areaH / 2;

  // state._cropModal.ox/oy 는 이미지 left/top (drag area 기준)
  // 이미지가 원을 완전히 덮도록 클램프
  const clamp = () => {
    const c = state._cropModal;
    // 이미지 오른쪽 끝이 원의 오른쪽보다 오른쪽이어야 함
    const minOx = cx + SIZE/2 - c.w; // 이미지 최소 left
    const maxOx = cx - SIZE/2;       // 이미지 최대 left
    const minOy = cy + SIZE/2 - c.h;
    const maxOy = cy - SIZE/2;
    c.ox = Math.min(maxOx, Math.max(minOx, c.ox));
    c.oy = Math.min(maxOy, Math.max(minOy, c.oy));
  };

  const applyImg = () => {
    clamp();
    const c = state._cropModal;
    imgEl.style.left  = c.ox + 'px';
    imgEl.style.top   = c.oy + 'px';
    imgEl.style.width = c.w  + 'px';
    imgEl.style.height= c.h  + 'px';
  };
  applyImg();

  // ── 슬라이더 ──
  const applyScale = (scale) => {
    const c = state._cropModal;
    const newW = c.origW * scale;
    const newH = c.origH * scale;
    // 원 중심 기준으로 스케일
    const pivotX = cx; const pivotY = cy;
    const ratioX = (pivotX - c.ox) / c.w;
    const ratioY = (pivotY - c.oy) / c.h;
    c.ox = pivotX - ratioX * newW;
    c.oy = pivotY - ratioY * newH;
    c.w  = newW; c.h = newH;
    applyImg();
  };

  scaleInput?.addEventListener('input', function() {
    applyScale(parseInt(this.value) / 100);
  });

  // ── PC: 마우스 드래그 ──
  let dragging = false, mStartX, mStartY, mStartOX, mStartOY;
  dragArea.addEventListener('mousedown', e => {
    dragging = true;
    mStartX = e.clientX; mStartY = e.clientY;
    mStartOX = state._cropModal.ox; mStartOY = state._cropModal.oy;
    dragArea.style.cursor = 'grabbing';
    e.preventDefault();
  });
  document.addEventListener('mousemove', e => {
    if (!dragging) return;
    state._cropModal.ox = mStartOX + (e.clientX - mStartX);
    state._cropModal.oy = mStartOY + (e.clientY - mStartY);
    applyImg();
  });
  document.addEventListener('mouseup', () => {
    dragging = false;
    if (dragArea) dragArea.style.cursor = 'grab';
  });

  // ── 모바일: 한손가락 이동 + 두손가락 핀치줌 ──
  let tStartOX, tStartOY, tStartX, tStartY;
  let pinchStartDist = 0, pinchStartW = 0, pinchStartH = 0;
  let pinchStartOX = 0, pinchStartOY = 0;

  const getTouchDist = (t) => {
    const dx = t[1].clientX - t[0].clientX;
    const dy = t[1].clientY - t[0].clientY;
    return Math.sqrt(dx*dx + dy*dy);
  };
  const getTouchCenter = (t) => ({
    x: (t[0].clientX + t[1].clientX) / 2,
    y: (t[0].clientY + t[1].clientY) / 2,
  });

  dragArea.addEventListener('touchstart', e => {
    if (e.touches.length === 1) {
      tStartX = e.touches[0].clientX; tStartY = e.touches[0].clientY;
      tStartOX = state._cropModal.ox; tStartOY = state._cropModal.oy;
    } else if (e.touches.length === 2) {
      pinchStartDist = getTouchDist(e.touches);
      pinchStartW = state._cropModal.w;
      pinchStartH = state._cropModal.h;
      pinchStartOX = state._cropModal.ox;
      pinchStartOY = state._cropModal.oy;
    }
    e.preventDefault();
  }, { passive: false });

  dragArea.addEventListener('touchmove', e => {
    if (e.touches.length === 1) {
      // 한손가락 이동
      state._cropModal.ox = tStartOX + (e.touches[0].clientX - tStartX);
      state._cropModal.oy = tStartOY + (e.touches[0].clientY - tStartY);
      applyImg();
    } else if (e.touches.length === 2) {
      // 두손가락 핀치줌
      const dist  = getTouchDist(e.touches);
      const ratio = dist / pinchStartDist;
      const newW  = pinchStartW * ratio;
      const newH  = pinchStartH * ratio;
      // 핀치 중심 기준으로 이미지 이동
      const center = getTouchCenter(e.touches);
      const startCenter = { x: (pinchStartOX + pinchStartW/2), y: (pinchStartOY + pinchStartH/2) };
      // 핀치 센터 기준 스케일
      const rect2 = dragArea.getBoundingClientRect();
      const lcx = center.x - rect2.left;
      const lcy = center.y - rect2.top;
      const ratioX2 = (lcx - pinchStartOX) / pinchStartW;
      const ratioY2 = (lcy - pinchStartOY) / pinchStartH;
      state._cropModal.ox = lcx - ratioX2 * newW;
      state._cropModal.oy = lcy - ratioY2 * newH;
      state._cropModal.w  = newW; state._cropModal.h = newH;
      // 슬라이더 동기화
      if (scaleInput) scaleInput.value = Math.round(newW / state._cropModal.origW * 100);
      applyImg();
    }
    e.preventDefault();
  }, { passive: false });

  dragArea.addEventListener('touchend', e => {}, { passive: true });

  // ── 완료 버튼: 원형 크롭 캔버스 ──
  document.getElementById('crop-confirm')?.addEventListener('click', () => {
    const c   = state._cropModal;
    const OUT = 400; // 출력 해상도
    const canvas = document.createElement('canvas');
    canvas.width = OUT; canvas.height = OUT;
    const ctx = canvas.getContext('2d');

    // 원형 클리핑
    ctx.beginPath();
    ctx.arc(OUT/2, OUT/2, OUT/2, 0, Math.PI*2);
    ctx.clip();

    // drag area 기준 원 위치
    const rect3 = dragArea.getBoundingClientRect();
    const aw = rect3.width || areaW;
    const ah = rect3.height || areaH;
    const circleCX = aw / 2;
    const circleCY = ah / 2;
    // 이미지에서 원이 차지하는 소스 영역
    const srcX = (circleCX - SIZE/2 - c.ox) * (c.origW / c.w);
    const srcY = (circleCY - SIZE/2 - c.oy) * (c.origH / c.h);
    const srcW = SIZE * (c.origW / c.w);
    const srcH = SIZE * (c.origH / c.h);

    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => {
      ctx.drawImage(img, srcX, srcY, srcW, srcH, 0, 0, OUT, OUT);
      state._pendingProfileImg = canvas.toDataURL('image/jpeg', 0.9);
      state._cropModal = null;
      render();
    };
    img.src = c.src;
  });

  document.getElementById('crop-cancel')?.addEventListener('click', () => {
    state._cropModal = null; state._pendingProfileFile = null; render();
  });
}

// ============================================================
// APP INIT
// ============================================================
async function initApp() {
  const session = SESSION.get();
  if (session) {
    state.user = session;
    await loadAll();
    // refresh user from DB
    const freshUser = state.cache.users.find(u=>u.uid===session.uid);
    if (freshUser) { state.user=freshUser; SESSION.set(freshUser); }
    state.page = 'main';
  } else {
    state.page = 'login';
  }
  render();
}

window._appInit = initApp;
if (window._fbReady) initApp();
</script>
</body>
</html>
