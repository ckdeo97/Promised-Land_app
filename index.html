<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>ì•½ì†ì˜ ë•… - ì²­ë…„ë¶€</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script>
tailwind.config = {
  theme: {
    extend: {
      fontFamily: { sans: ['Inter', 'sans-serif'] },
    }
  }
}
</script>
<style>
  * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
  body { font-family: 'Inter', sans-serif; overscroll-behavior: none; }
  .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24; }
  .material-symbols-outlined.filled { font-variation-settings: 'FILL' 1, 'wght' 300, 'GRAD' 0, 'opsz' 24; }
  .hide-scrollbar::-webkit-scrollbar { display: none; }
  .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  .slide-up { animation: slideUp 0.3s cubic-bezier(0.32,0.72,0,1); }
  .fade-in { animation: fadeIn 0.2s ease; }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  input, textarea, select { font-family: 'Inter', sans-serif; }
  .dot-pattern { background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.08) 1px, transparent 0); background-size: 20px 20px; }
</style>
</head>
<body class="bg-white text-black min-h-screen">

<div id="app"></div>

<script>
// ============================================================
// STORAGE LAYER (localStorage wrapper)
// ============================================================
const DB = {
  get(key, fallback) {
    try { const v = localStorage.getItem('jmc_' + key); return v ? JSON.parse(v) : fallback; }
    catch { return fallback; }
  },
  set(key, val) { localStorage.setItem('jmc_' + key, JSON.stringify(val)); },
  remove(key) { localStorage.removeItem('jmc_' + key); }
};

// ============================================================
// INITIAL SEED DATA
// ============================================================
function seedIfNeeded() {
  if (DB.get('seeded', false)) return;

  DB.set('users', [
    { uid:'admin1', id:'admin', pw:'1234', name:'ì•½ì†ì˜ ë•… ê´€ë¦¬ì', phone:'010-1234-5678', birth:'19950315', cellId:'c2', role:'admin', status:'active', createdAt:'2026-01-01', profileImg:'' }
  ]);

  DB.set('rosters', [
    { id:'r1', name:'ê¹€ì°½ëŒ€', phone:'010-1234-5678', birth:'19950315', cellId:'c2', linkedUid:'admin1' },
    { id:'r2', name:'ì´ì„œì—°', phone:'010-2345-6789', birth:'19970827', cellId:'c1', linkedUid:null },
    { id:'r3', name:'ë°•ë¯¼ì¤€', phone:'010-3456-7890', birth:'19961127', cellId:'c1', linkedUid:null },
    { id:'r4', name:'ìµœìœ ì§„', phone:'010-4567-8901', birth:'19980503', cellId:'c3', linkedUid:null },
    { id:'r5', name:'ì •í•˜ì€', phone:'010-5678-9012', birth:'20000112', cellId:'c2', linkedUid:null },
    { id:'r6', name:'í•œì†Œë§', phone:'010-6789-0123', birth:'19990720', cellId:'c3', linkedUid:null },
  ]);

  DB.set('cells', [
    { id:'c1', name:'ë¦¬ë‚˜ëª©ì¥', leader:'ê¹€ë¦¬ë‚˜', order:1 },
    { id:'c2', name:'ì°½ëŒ€ëª©ì¥', leader:'ê¹€ì°½ëŒ€', order:2 },
    { id:'c3', name:'ì€í˜œëª©ì¥', leader:'ë°•ì€í˜œ', order:3 },
  ]);

  DB.set('notices', [
    { id:'n1', title:'ë™ê³„ ìˆ˜ë ¨íšŒ ì‹ ì²­ ë§ˆê° ì•ˆë‚´', body:'1ì›” 15ì¼(ìˆ˜)ê¹Œì§€ ì‹ ì²­ì„ ì™„ë£Œí•´ ì£¼ì„¸ìš”.\nì¥ì†Œ: ì–‘í‰ ìˆ˜ì–‘ê´€\nì°¸ê°€ë¹„: 5ë§Œì›\nìì„¸í•œ ë‚´ìš©ì€ ì„ì›ì—ê²Œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.', by:'admin1', at:'2026-02-20', pinned:true },
    { id:'n2', title:'12ì›” ì„¬ê¹€ì´ ì¼ì • ê³µìœ ', body:'ì°¬ì–‘íŒ€Â·ê¸°ë„íŒ€Â·ì•ˆë‚´íŒ€ ìŠ¤ì¼€ì¤„ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\nê° íŒ€ë³„ ì¼ì •ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.', by:'admin1', at:'2026-02-19', pinned:false },
    { id:'n3', title:'ëª©ì¥ ëª¨ì„ ì¥ì†Œ ë³€ê²½ ì•ˆë‚´', body:'3ëª©ì¥ ì´ë²ˆ ì£¼ êµìœ¡ê´€ 1ì¸µìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.', by:'admin1', at:'2026-02-17', pinned:false },
  ]);

  DB.set('comments', {
    n1: [{ id:'cm1', uid:'admin1', name:'ê¹€ì°½ëŒ€', body:'ì‹ ì²­ ë§í¬ëŠ” ë‹¨í†¡ë°©ì— ì˜¬ë ¤ë‘ì—ˆìŠµë‹ˆë‹¤!', at:'2026-02-20' }],
    n2: [], n3: []
  });

  DB.set('events', [
    { id:'e1', title:'ì£¼ì¼ ì²­ë…„ ì˜ˆë°°', date:'2026-02-22', time:'14:00', loc:'ë³¸ë‹¹', cat:'ì˜ˆë°°' },
    { id:'e2', title:'ì´ì„œì—°, ë°•ë¯¼ì¤€ ìƒì¼ ğŸ‚', date:'2026-02-27', time:'', loc:'', cat:'ìƒì¼' },
    { id:'e3', title:'í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ìºë¡¤ë§', date:'2026-03-01', time:'16:00', loc:'ì‹œì²­ ê´‘ì¥', cat:'í–‰ì‚¬' },
    { id:'e4', title:'ëª©ì¥ ë¦¬ë” ëª¨ì„', date:'2026-03-05', time:'19:00', loc:'êµìœ¡ê´€', cat:'ëª¨ì„' },
  ]);

  DB.set('bulletins', [
    { id:'b1', title:'2026ë…„ 2ì›” 22ì¼ ì£¼ë³´', date:'2026-02-22', by:'admin1', at:'2026-02-21',
      order:'1. ì˜ˆë°°ì˜ ë¶€ë¦„\n2. ê²½ë°°ì™€ ì°¬ì–‘\n3. ëŒ€í‘œê¸°ë„\n4. ì„±ê²½ë´‰ë…\n5. ë§ì”€ ì„ í¬\n6. ë´‰í—Œ\n7. ë´‰í—Œê¸°ë„\n8. ê´‘ê³ (ì„±ë„ì˜ êµì œ)\n9. ì¶•ë„',
      announce:'â€¢ ë™ê³„ ìˆ˜ë ¨íšŒ ì‹ ì²­ ë§ˆê°: 1ì›” 15ì¼\nâ€¢ ìƒˆê°€ì¡± í™˜ì˜: í•œì†Œë§ ìë§¤\nâ€¢ ë‹¤ìŒ ì£¼ ì°¬ì–‘ ì—°ìŠµ: í† ìš”ì¼ ì˜¤í›„ 3ì‹œ',
      prayer_duty:'ì •í•˜ì€',
      bible_reading:'ë°•ë¯¼ì¤€',
      offering_duty:'ìµœìœ ì§„',
      announcement_duty:'ì´ì„œì—°',
      songs:'1. ì£¼ë‹˜ í•œ ë¶„ë§Œìœ¼ë¡œ (Key: G)\n2. Good Grace (Key: A)\n3. ì˜¤ì§ ì£¼ë§Œì´ (Key: D)\n4. Way Maker (Key: E)'
    }
  ]);

  DB.set('worshipSets', [
    { id:'w1', date:'2026-02-22', leader:'ê¹€ì°½ëŒ€',
      members:{ piano:'ì´ì„œì—°', drum:'ë°•ë¯¼ì¤€', ppt:'ìµœìœ ì§„' },
      songs:[
        { title:'ì£¼ë‹˜ í•œ ë¶„ë§Œìœ¼ë¡œ', url:'https://youtube.com/watch?v=example1', key:'G', sheet:'' },
        { title:'Good Grace', url:'https://youtube.com/watch?v=example2', key:'A', sheet:'' },
        { title:'ì˜¤ì§ ì£¼ë§Œì´', url:'https://youtube.com/watch?v=example3', key:'D', sheet:'' },
        { title:'Way Maker', url:'https://youtube.com/watch?v=example4', key:'E', sheet:'' },
      ],
      by:'admin1', at:'2026-02-20'
    }
  ]);

  DB.set('notifications', [
    { id:'noti1', title:'ìƒˆ ì£¼ë³´ ì—…ë¡œë“œ', body:'2ì›” 22ì¼ ì£¼ë³´ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', type:'bulletin', at:'2026-02-21' },
    { id:'noti2', title:'ì´ë²ˆì£¼ ì°¬ì–‘ ì—…ë°ì´íŠ¸', body:'ì´ë²ˆ ì£¼ ì°¬ì–‘ ì„¸íŠ¸ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', type:'worship', at:'2026-02-20' },
  ]);

  DB.set('attendance', {});
  DB.set('offerings', {});
  DB.set('cellMeetings', [
    { id:'cm1', date:'2026-02-22', verse:'ìš”í•œë³µìŒ 15:1-8',
      verseText:'"ë‚˜ëŠ” í¬ë„ë‚˜ë¬´ìš” ë„ˆí¬ëŠ” ê°€ì§€ë¼"',
      shareQ:'ì˜¤ëŠ˜ ë§ì”€ì—ì„œ ê°€ì¥ ì™€ë‹¿ì€ ë¶€ë¶„ì€ ë¬´ì—‡ì¸ê°€ìš”?',
      heartQ:'ì´ë²ˆ ì£¼ ë‚˜ì˜ ì‚¶ì—ì„œ ì˜ˆìˆ˜ë‹˜ê»˜ ë” ì˜ì§€í•´ì•¼ í•  ë¶€ë¶„ì€?',
      prayerItems:'â€¢ ìš°ë¦¬ ëª©ì¥ ëª¨ë“  ì§€ì²´ë¥¼ ìœ„í•´\nâ€¢ ì´ë²ˆ ì£¼ ì–´ë ¤ì›€ì„ ê²ªëŠ” ì§€ì²´ë¥¼ ìœ„í•´\nâ€¢ ì•½ì†ì˜ ë•… ì²­ë…„ë¶€ ë¶€í¥ì„ ìœ„í•´',
      by:'admin1', at:'2026-02-20' }
  ]);
  DB.set('seeded', true);
}

seedIfNeeded();

// ============================================================
// STATE
// ============================================================
let state = {
  user: DB.get('currentUser', null),
  page: DB.get('currentUser', null) ? 'main' : 'login',
  tab: 'home',
  detail: null,
  adminSub: 'dashboard',
  profileOpen: false,
  profilePage: null, // 'edit' | 'noti' | 'settings'
  toast: null,
  adminRosterTab: 'all',
  adminAttTab: null,
  _pendingProfileImg: null,
};

const uid = () => Math.random().toString(36).substr(2, 9);
const today = () => new Date().toISOString().split('T')[0];
const fmtPhone = v => { const d=v.replace(/\D/g,''); if(d.length<=3) return d; if(d.length<=7) return d.slice(0,3)+'-'+d.slice(3); return d.slice(0,3)+'-'+d.slice(3,7)+'-'+d.slice(7,11); };

// ============================================================
// RENDER ENGINE
// ============================================================
function render() {
  const app = document.getElementById('app');
  let html = '';

  if (!state.user) {
    if (state.page === 'register') html = renderRegister();
    else html = renderLogin();
  } else if (state.page === 'admin') {
    html = renderAdmin();
  } else if (state.profilePage) {
    html = renderProfilePage();
  } else if (state.detail) {
    if (state.detail.type === 'bulletin') html = renderBulletinDetail();
    else if (state.detail.type === 'notice') html = renderNoticeDetail();
    else if (state.detail.type === 'worship') html = renderWorshipDetail();
    else html = renderMain();
  } else {
    html = renderMain();
  }

  if (state.toast) {
    html += `<div class="fixed top-20 left-1/2 -translate-x-1/2 z-[200] bg-black text-white px-5 py-3 rounded-2xl text-sm font-bold shadow-xl fade-in">${state.toast}</div>`;
  }

  app.innerHTML = html;
  bindEvents();
}

function showToast(msg) {
  state.toast = msg;
  render();
  setTimeout(() => { state.toast = null; render(); }, 2000);
}

function icon(name, cls='', size=24, fill=false) {
  return `<span class="material-symbols-outlined ${fill?'filled':''} ${cls}" style="font-size:${size}px">${name}</span>`;
}

// ============================================================
// LOGIN
// ============================================================
function renderLogin() {
  return `
  <div class="min-h-screen bg-white flex flex-col items-center justify-center px-8">
    <div class="w-full max-w-sm">
      <div class="text-center mb-10">
        <div class="w-20 h-20 bg-black rounded-3xl flex items-center justify-center mx-auto mb-5">
          <span class="text-white font-black text-2xl">PL</span>
        </div>
        <h1 class="text-2xl font-bold tracking-tight">ì•½ì†ì˜ ë•…</h1>
        <p class="text-zinc-400 text-sm mt-1">ì²­ë…„ë¶€ ì»¤ë®¤ë‹ˆí‹°</p>
      </div>
      <div class="space-y-4">
        <input id="login-id" type="text" placeholder="ì•„ì´ë””" class="w-full px-4 py-3.5 bg-zinc-50 border border-zinc-200 rounded-2xl text-sm focus:outline-none focus:border-black focus:ring-1 focus:ring-black"/>
        <input id="login-pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full px-4 py-3.5 bg-zinc-50 border border-zinc-200 rounded-2xl text-sm focus:outline-none focus:border-black focus:ring-1 focus:ring-black"/>
        <div id="login-error" class="text-red-500 text-xs font-medium px-1 hidden"></div>
        <button id="btn-login" class="w-full py-3.5 bg-black text-white rounded-2xl font-bold text-sm active:scale-[0.98] transition-transform">ë¡œê·¸ì¸</button>
      </div>
      <div class="text-center mt-6">
        <button id="btn-go-register" class="text-sm text-zinc-500 font-medium">
          ì•„ì§ ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <span class="text-black font-bold underline underline-offset-2">íšŒì›ê°€ì…</span>
        </button>
      </div>
      <div class="text-center mt-8 text-xs text-zinc-300">í…ŒìŠ¤íŠ¸: admin / 1234</div>
    </div>
  </div>`;
}

// ============================================================
// REGISTER
// ============================================================
function renderRegister() {
  return `
  <div class="min-h-screen bg-white px-6 py-8">
    <button id="btn-back-login" class="flex items-center gap-1 text-sm text-zinc-500 mb-6">${icon('arrow_back','',20)} ë’¤ë¡œ</button>
    <h1 class="text-2xl font-bold mb-1">íšŒì›ê°€ì…</h1>
    <p class="text-zinc-400 text-sm mb-8">ì•½ì†ì˜ ë•… ì²­ë…„ë¶€ ì»¤ë®¤ë‹ˆí‹°ì— ê°€ì…í•©ë‹ˆë‹¤.</p>
    <div class="space-y-4">
      <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì´ë¦„</label><input id="reg-name" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="í™ê¸¸ë™"/></div>
      <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì „í™”ë²ˆí˜¸</label><input id="reg-phone" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="01012345678"/></div>
      <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ìƒë…„ì›”ì¼</label><input id="reg-birth" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="19950315"/></div>
      <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì•„ì´ë””</label><input id="reg-id" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="ì‚¬ìš©í•  ì•„ì´ë””"/></div>
      <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ë¹„ë°€ë²ˆí˜¸</label><input id="reg-pw" type="password" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="4ì ì´ìƒ"/></div>
      <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input id="reg-pw2" type="password" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥"/></div>
      <label class="flex items-start gap-3 pt-2">
        <input id="reg-agree" type="checkbox" class="mt-0.5 w-5 h-5 rounded border-zinc-300 accent-black"/>
        <span class="text-xs text-zinc-500 leading-relaxed">ê°œì¸ì •ë³´(ì´ë¦„, ì „í™”ë²ˆí˜¸, ìƒë…„ì›”ì¼) ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.</span>
      </label>
      <div id="reg-error" class="text-red-500 text-xs font-medium hidden"></div>
      <button id="btn-register" class="w-full py-3.5 bg-black text-white rounded-2xl font-bold text-sm active:scale-[0.98] transition-transform">ê°€ì… ì‹ ì²­</button>
    </div>
  </div>`;
}

// ============================================================
// MAIN (tabs)
// ============================================================
function renderMain() {
  const u = state.user;
  const isAdmin = u.role === 'admin';
  const notis = DB.get('notifications', []);

  let content = '';
  if (state.tab === 'home') content = renderHomeTab();
  else if (state.tab === 'bulletin') content = renderBulletinTab();
  else if (state.tab === 'notice') content = renderNoticeTab();
  else if (state.tab === 'calendar') content = renderCalendarTab();
  else if (state.tab === 'cell') content = renderCellTab();

  const tabs = [
    { key:'home', icon:'home', label:'í™ˆ' },
    { key:'bulletin', icon:'menu_book', label:'ì£¼ë³´' },
    { key:'notice', icon:'campaign', label:'ê³µì§€' },
    { key:'calendar', icon:'calendar_month', label:'ì¼ì •' },
    { key:'cell', icon:'groups', label:'ëª©ì¥' },
  ];

  return `
  <div class="min-h-screen bg-white pb-28">
    <!-- Header -->
    <header class="sticky top-0 z-50 px-5 pt-4 pb-3 bg-white/90 backdrop-blur-xl border-b border-zinc-100">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-black rounded-xl flex items-center justify-center">
            <span class="text-white font-black text-sm">PL</span>
          </div>
          <div>
            <p class="text-[10px] font-bold text-zinc-400 uppercase tracking-[0.15em]">ì•½ì†ì˜ ë•…</p>
            <h1 class="text-lg font-bold tracking-tight">${u.name} ğŸ‘‹</h1>
          </div>
        </div>
        <div class="flex gap-2">
          <button data-action="go-worship" class="w-10 h-10 flex items-center justify-center rounded-full border border-zinc-200 active:bg-zinc-100">
            ${icon('music_note','',22)}
          </button>
          <button data-action="open-profile" class="relative w-10 h-10 rounded-full bg-zinc-200 flex items-center justify-center border-2 border-black overflow-hidden">
            ${u.profileImg ? `<img src="${u.profileImg}" class="w-full h-full object-cover"/>` : `<span class="text-sm font-bold text-zinc-500">${(u.name||'?')[0]}</span>`}
            ${notis.length > 0 ? '<span class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border border-white"></span>' : ''}
          </button>
        </div>
      </div>
    </header>

    <main class="px-5 mt-6 space-y-8">${content}</main>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 left-0 right-0 z-50 px-2 pb-6 pt-2 bg-white/90 backdrop-blur-xl border-t border-zinc-100">
      <div class="flex justify-around items-center max-w-md mx-auto">
        ${tabs.map(t => `
          <button data-tab="${t.key}" class="flex flex-col items-center gap-0.5 px-4 py-1 transition-colors ${state.tab===t.key?'text-black':'text-zinc-400'}">
            ${icon(t.icon,'',26,state.tab===t.key)}
            <span class="text-[10px] font-bold tracking-wider">${t.label}</span>
          </button>
        `).join('')}
      </div>
    </nav>

    ${state.profileOpen ? renderProfileSheet() : ''}
  </div>`;
}

// ============================================================
// PROFILE SHEET
// ============================================================
function renderProfileSheet() {
  const u = state.user;
  const isAdmin = u.role === 'admin';
  const cells = DB.get('cells', []);
  const cell = cells.find(c => c.id === u.cellId);
  return `
  <div data-action="close-profile" class="fixed inset-0 z-[100] bg-black/40 backdrop-blur-sm fade-in"></div>
  <div class="fixed bottom-0 left-0 right-0 z-[101] bg-white rounded-t-3xl shadow-2xl slide-up">
    <div class="flex justify-center pt-3 pb-1"><div class="w-10 h-1 bg-zinc-200 rounded-full"></div></div>
    <div class="flex items-center gap-4 px-6 py-4 border-b border-zinc-100">
      ${u.profileImg ? `<div class="w-14 h-14 rounded-full bg-zinc-200 flex items-center justify-center border-2 border-black overflow-hidden"><img src="${u.profileImg}" class="w-full h-full object-cover"/></div>` :
        `<div class="w-14 h-14 rounded-full bg-zinc-200 flex items-center justify-center border-2 border-black"><span class="text-xl font-bold text-zinc-500">${(u.name||'?')[0]}</span></div>`}
      <div>
        <p class="font-bold text-base">${u.name}</p>
        <p class="text-sm text-zinc-400">${cell ? cell.name : 'ëª©ì¥ ë¯¸ë°°ì •'} Â· ${isAdmin?'ê´€ë¦¬ì':'ì²­ë…„ë¶€ì›'}</p>
      </div>
    </div>
    <div class="px-4 py-3 space-y-1">
      ${isAdmin ? `
      <button data-action="go-admin" class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl active:bg-zinc-50 transition-colors text-left">
        <div class="w-10 h-10 bg-zinc-100 rounded-xl flex items-center justify-center">${icon('admin_panel_settings','text-black')}</div>
        <div class="flex-1"><p class="font-bold text-sm">ê´€ë¦¬ì í˜ì´ì§€</p><p class="text-xs text-zinc-400">ì£¼ë³´Â·ì°¬ì–‘Â·ê³µì§€Â·ì¶œì„Â·í—Œê¸ˆ ê´€ë¦¬</p></div>
        ${icon('chevron_right','text-zinc-300',20)}
      </button>` : ''}
      <button data-profile-page="edit" class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl active:bg-zinc-50 transition-colors text-left">
        <div class="w-10 h-10 bg-zinc-100 rounded-xl flex items-center justify-center">${icon('person','text-black')}</div>
        <div class="flex-1"><p class="font-bold text-sm">í”„ë¡œí•„ ìˆ˜ì •</p><p class="text-xs text-zinc-400">ì‚¬ì§„, ëª©ì¥, ì—°ë½ì²˜, ìƒë…„ì›”ì¼</p></div>
        ${icon('chevron_right','text-zinc-300',20)}
      </button>
      <button data-profile-page="noti" class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl active:bg-zinc-50 transition-colors text-left">
        <div class="w-10 h-10 bg-zinc-100 rounded-xl flex items-center justify-center">${icon('notifications','text-black')}</div>
        <div class="flex-1"><p class="font-bold text-sm">ì•Œë¦¼ ì„¤ì •</p><p class="text-xs text-zinc-400">ì°¬ì–‘Â·ê³µì§€Â·ë§ì”€Â·ì¼ì •Â·ë‹´ë‹¹ì ê°ê° ì„¤ì •</p></div>
        ${icon('chevron_right','text-zinc-300',20)}
      </button>
      <button data-profile-page="settings" class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl active:bg-zinc-50 transition-colors text-left">
        <div class="w-10 h-10 bg-zinc-100 rounded-xl flex items-center justify-center">${icon('settings','text-black')}</div>
        <div class="flex-1"><p class="font-bold text-sm">ì„¤ì •</p><p class="text-xs text-zinc-400">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½, ê³„ì • ê´€ë¦¬</p></div>
        ${icon('chevron_right','text-zinc-300',20)}
      </button>
      <button data-action="logout" class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl active:bg-red-50 transition-colors text-left">
        <div class="w-10 h-10 bg-red-50 rounded-xl flex items-center justify-center">${icon('logout','text-red-500')}</div>
        <p class="font-bold text-sm text-red-500">ë¡œê·¸ì•„ì›ƒ</p>
      </button>
    </div>
    <div class="h-8"></div>
  </div>`;
}

// ============================================================
// HOME TAB
// ============================================================
function renderHomeTab() {
  const bulletins = DB.get('bulletins', []);
  const worships = DB.get('worshipSets', []);
  const notices = DB.get('notices', []);
  const events = DB.get('events', []).sort((a,b) => a.date.localeCompare(b.date));
  const latest = worships[worships.length - 1];
  const lb = bulletins[bulletins.length - 1];

  const dutySection = lb ? `
  <section>
    <h2 class="text-lg font-bold tracking-tight mb-3">ê¸ˆì£¼ ì˜ˆë°° ë‹´ë‹¹</h2>
    <div class="bg-white rounded-2xl border border-zinc-100 overflow-hidden">
      <div class="bg-black px-5 py-3 flex items-center gap-2">
        ${icon('church','text-white',18)}
        <span class="text-white text-xs font-bold">${lb.date} ì˜ˆë°°</span>
      </div>
      <div class="divide-y divide-zinc-50">
        ${[
          {l:'ëŒ€í‘œê¸°ë„', v:lb.prayer_duty||'ë¯¸ì •', i:'volunteer_activism'},
          {l:'ì„±ê²½ë´‰ë…', v:lb.bible_reading||'ë¯¸ì •', i:'menu_book'},
          {l:'ì„±ë„ì˜ êµì œ', v:lb.announcement_duty||'ë¯¸ì •', i:'campaign'},
          {l:'ë´‰í—Œ', v:lb.offering_duty||'ë¯¸ì •', i:'favorite'},
        ].map(d => `
        <div class="flex items-center gap-3 px-5 py-3.5">
          <div class="w-8 h-8 bg-zinc-100 rounded-lg flex items-center justify-center flex-none">${icon(d.i,'text-zinc-600',16)}</div>
          <span class="text-xs text-zinc-400 w-20 flex-none">${d.l}</span>
          <span class="text-sm font-bold">${d.v}</span>
        </div>`).join('')}
      </div>
    </div>
  </section>` : `
  <section>
    <div class="bg-zinc-50 rounded-2xl p-5 text-center">
      <p class="text-sm text-zinc-400">ë“±ë¡ëœ ì£¼ë³´ê°€ ì—†ìŠµë‹ˆë‹¤</p>
    </div>
  </section>`;

  return `
  <!-- ì˜¤ëŠ˜ì˜ ë§ì”€ -->
  <section>
    <div class="bg-black rounded-3xl p-6 text-white relative overflow-hidden">
      <div class="relative z-10">
        <span class="px-2.5 py-1 bg-white/10 border border-white/20 rounded-lg text-[10px] font-bold uppercase tracking-wider">ì˜¤ëŠ˜ì˜ ë§ì”€</span>
        <blockquote class="text-xl font-bold leading-snug mt-4 mb-3">"ë‚´ê²Œ ëŠ¥ë ¥ ì£¼ì‹œëŠ” ì ì•ˆì—ì„œ<br/>ë‚´ê°€ ëª¨ë“  ê²ƒì„ í•  ìˆ˜ ìˆëŠë‹ˆë¼"</blockquote>
        <p class="text-zinc-400 text-sm">ë¹Œë¦½ë³´ì„œ 4:13</p>
      </div>
      <div class="absolute -right-10 -bottom-10 w-48 h-48 bg-white/5 rounded-full blur-3xl"></div>
      <div class="absolute -right-4 top-4 opacity-[0.06]">${icon('menu_book','text-white',120)}</div>
    </div>
  </section>

  <!-- ê¸ˆì£¼ ì˜ˆë°° ë‹´ë‹¹ -->
  ${dutySection}

  <!-- ì´ë²ˆì£¼ ì°¬ì–‘ -->
  ${latest ? `
  <section>
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-sm font-bold flex items-center gap-1.5">${icon('music_note','',18)} ì´ë²ˆì£¼ ì°¬ì–‘</h3>
      <button data-action="go-worship" class="text-zinc-400 text-xs font-bold">ì „ì²´ë³´ê¸°</button>
    </div>
    <div class="flex gap-3 overflow-x-auto pb-1 -mx-5 px-5 hide-scrollbar">
      ${latest.songs.map((s,i) => `
        <button data-action="go-worship" class="flex-none w-36 bg-white rounded-2xl border border-zinc-200 overflow-hidden active:bg-zinc-50 transition-colors text-left">
          <div class="w-full h-24 bg-zinc-100 flex items-center justify-center">${icon('graphic_eq','text-zinc-200',48)}</div>
          <div class="p-3">
            <p class="text-xs font-bold leading-tight truncate">${s.title}</p>
            <p class="text-[10px] text-zinc-400 mt-0.5">Key: ${s.key}</p>
          </div>
        </button>
      `).join('')}
    </div>
  </section>` : ''}

  <!-- ê³µì§€ì‚¬í•­ -->
  <section>
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-sm font-bold flex items-center gap-1.5">${icon('campaign','',18)} ê³µì§€ì‚¬í•­</h3>
      <button data-tab="notice" class="text-zinc-400 text-xs font-bold">ì „ì²´ë³´ê¸°</button>
    </div>
    <div class="space-y-2">
      ${notices.slice(0,3).map(n => `
        <button data-detail="notice:${n.id}" class="w-full flex items-start gap-3 bg-white p-4 rounded-2xl border border-zinc-100 active:bg-zinc-50 transition-colors text-left">
          <div class="w-8 h-8 ${n.pinned?'bg-black':'bg-zinc-100'} rounded-lg flex items-center justify-center flex-none mt-0.5">
            ${icon(n.pinned?'priority_high':'info','',16,false)}
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-bold leading-tight">${n.title}</p>
            <p class="text-xs text-zinc-400 mt-0.5 truncate">${n.body.split('\n')[0]}</p>
          </div>
          <span class="text-[10px] text-zinc-300 font-medium flex-none">${n.at.slice(5)}</span>
        </button>
      `).join('')}
    </div>
  </section>

  <!-- ë‹¤ê°€ì˜¤ëŠ” ì¼ì • -->
  <section class="pb-4">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-sm font-bold flex items-center gap-1.5">${icon('calendar_month','',18)} ë‹¤ê°€ì˜¤ëŠ” ì¼ì •</h3>
      <button data-tab="calendar" class="text-zinc-400 text-xs font-bold">ì „ì²´ë³´ê¸°</button>
    </div>
    <div class="space-y-2">
      ${events.slice(0,3).map(ev => {
        const d = new Date(ev.date); const m = d.getMonth()+1; const day = d.getDate();
        const isW = ev.cat === 'ì˜ˆë°°';
        return `
        <div class="flex items-center gap-4 bg-white p-4 rounded-2xl border border-zinc-100">
          <div class="w-12 h-12 ${isW?'bg-black':'bg-zinc-100'} rounded-xl flex flex-col items-center justify-center flex-none">
            <span class="text-[9px] font-black uppercase ${isW?'text-white/60':'text-zinc-400'}">${m}ì›”</span>
            <span class="text-lg font-bold leading-none ${isW?'text-white':'text-black'}">${day}</span>
          </div>
          <div class="flex-1">
            <span class="text-[10px] font-bold bg-zinc-100 text-zinc-500 px-1.5 py-0.5 rounded">${ev.cat}</span>
            <h4 class="font-bold text-sm text-black mt-0.5">${ev.title}</h4>
            ${(ev.loc||ev.time)?`<p class="text-xs text-zinc-400">${[ev.loc,ev.time].filter(Boolean).join(' Â· ')}</p>`:''}
          </div>
        </div>`;
      }).join('')}
    </div>
  </section>`;
}

// ============================================================
// BULLETIN TAB
// ============================================================
function renderBulletinTab() {
  const bulletins = DB.get('bulletins', []);
  return `
  <section>
    <h2 class="text-xl font-bold tracking-tight mb-5">ì£¼ë³´</h2>
    <div class="space-y-4">
      ${[...bulletins].reverse().map(b => `
        <button data-detail="bulletin:${b.id}" class="w-full text-left bg-white rounded-3xl border border-zinc-200 overflow-hidden active:bg-zinc-50 transition-colors">
          <div class="bg-gradient-to-br from-zinc-900 to-black p-6 text-white relative overflow-hidden dot-pattern">
            <div class="relative z-10">
              <div class="flex items-center gap-2 mb-3">
                <div class="w-8 h-8 bg-white/10 rounded-lg flex items-center justify-center">${icon('menu_book','text-white',18)}</div>
                <span class="text-[10px] font-bold uppercase tracking-wider text-white/60">ì£¼ì¼ ì˜ˆë°° ì£¼ë³´</span>
              </div>
              <h3 class="text-lg font-bold">${b.title}</h3>
              <p class="text-white/50 text-xs mt-1">${b.date}</p>
            </div>
          </div>
          <div class="p-4">
            <p class="text-xs text-zinc-400 line-clamp-2">${b.order?.split('\n').slice(0,2).join(' / ')}</p>
            <div class="flex items-center gap-1 mt-2 text-zinc-300">
              ${icon('chevron_right','',16)}<span class="text-[10px] font-bold">ìì„¸íˆ ë³´ê¸°</span>
            </div>
          </div>
        </button>
      `).join('')}
    </div>
  </section>`;
}

// ============================================================
// BULLETIN DETAIL
// ============================================================
function renderBulletinDetail() {
  const b = DB.get('bulletins', []).find(x => x.id === state.detail.id);
  if (!b) return '';
  const sections = [
    { i:'format_list_numbered', t:'ì˜ˆë°°ìˆœì„œ', c:b.order },
    { i:'volunteer_activism', t:'ëŒ€í‘œê¸°ë„', c:b.prayer_duty },
    { i:'menu_book', t:'ì„±ê²½ë´‰ë…', c:b.bible_reading },
    { i:'campaign', t:'ì„±ë„ì˜ êµì œ (ê´‘ê³ )', c:b.announcement_duty },
    { i:'favorite', t:'ë´‰í—Œ', c:b.offering_duty },
    { i:'music_note', t:'ì°¬ì–‘ê³¡ ëª©ë¡', c:b.songs },
    { i:'campaign', t:'ê´‘ê³  / ì•Œë¦¼', c:b.announce },
  ];
  return `
  <div class="min-h-screen bg-zinc-50">
    <header class="sticky top-0 z-50 px-4 py-3 bg-white/90 backdrop-blur-xl border-b border-zinc-100 flex items-center gap-3">
      <button data-action="back" class="w-10 h-10 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('arrow_back','',22)}</button>
      <h1 class="font-bold text-sm flex-1">ì£¼ë³´</h1>
    </header>
    <div class="p-5">
      <div class="bg-white rounded-3xl overflow-hidden shadow-lg border border-zinc-100">
        <div class="bg-black text-white p-8 text-center relative overflow-hidden dot-pattern">
          <div class="relative z-10">
            <p class="text-[10px] font-bold uppercase tracking-[0.3em] text-white/50 mb-2">ì•½ì†ì˜ ë•… Â· ì£¼ì¼ì˜ˆë°°</p>
            <h2 class="text-2xl font-bold">${b.date}</h2>
            <div class="w-12 h-0.5 bg-white/20 mx-auto mt-4"></div>
          </div>
        </div>
        <div class="divide-y divide-zinc-100">
          ${sections.filter(s=>s.c).map(s => `
            <div class="p-6">
              <div class="flex items-center gap-2 mb-3">
                ${icon(s.i,'text-zinc-400',16)}
                <h3 class="text-xs font-bold uppercase tracking-wider text-zinc-400">${s.t}</h3>
              </div>
              <div class="text-sm leading-relaxed text-zinc-700 whitespace-pre-line">${s.c}</div>
            </div>
          `).join('')}
        </div>
        <div class="bg-zinc-50 p-6 text-center">
          <p class="text-[10px] text-zinc-300 font-bold uppercase tracking-[0.2em]">ì•½ì†ì˜ ë•… ì²­ë…„ë¶€</p>
        </div>
      </div>
    </div>
  </div>`;
}

// ============================================================
// NOTICE TAB
// ============================================================
function renderNoticeTab() {
  const notices = DB.get('notices', []);
  return `
  <section>
    <h2 class="text-xl font-bold tracking-tight mb-5">ê³µì§€ì‚¬í•­</h2>
    <div class="space-y-3">
      ${notices.map(n => `
        <button data-detail="notice:${n.id}" class="w-full flex items-start gap-3 bg-white p-4 rounded-2xl border border-zinc-100 active:bg-zinc-50 transition-colors text-left">
          <div class="w-10 h-10 ${n.pinned?'bg-black':'bg-zinc-100'} rounded-xl flex items-center justify-center flex-none">
            ${icon(n.pinned?'push_pin':'article','',20)}
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2">
              ${n.pinned?'<span class="text-[9px] font-bold bg-red-50 text-red-500 px-1.5 py-0.5 rounded">ì¤‘ìš”</span>':''}
              <p class="text-sm font-bold leading-tight">${n.title}</p>
            </div>
            <p class="text-xs text-zinc-400 mt-1 line-clamp-2">${n.body}</p>
            <p class="text-[10px] text-zinc-300 mt-2">${n.at}</p>
          </div>
        </button>
      `).join('')}
    </div>
  </section>`;
}

// ============================================================
// NOTICE DETAIL
// ============================================================
function renderNoticeDetail() {
  const n = DB.get('notices', []).find(x => x.id === state.detail.id);
  if (!n) return '';
  const comments = DB.get('comments', {})[n.id] || [];
  return `
  <div class="min-h-screen bg-white pb-24">
    <header class="sticky top-0 z-50 px-4 py-3 bg-white/90 backdrop-blur-xl border-b border-zinc-100 flex items-center gap-3">
      <button data-action="back" class="w-10 h-10 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('arrow_back','',22)}</button>
      <h1 class="font-bold text-sm flex-1">ê³µì§€ì‚¬í•­</h1>
    </header>
    <div class="px-5 py-6">
      ${n.pinned?'<span class="text-[10px] font-bold bg-red-50 text-red-500 px-2 py-1 rounded mb-3 inline-block">ì¤‘ìš”</span>':''}
      <h2 class="text-xl font-bold mb-2">${n.title}</h2>
      <p class="text-xs text-zinc-400 mb-6">${n.at}</p>
      <div class="text-sm leading-relaxed text-zinc-700 whitespace-pre-line">${n.body}</div>
    </div>
    <div class="px-5 border-t border-zinc-100 pt-5">
      <h3 class="text-sm font-bold mb-4">ëŒ“ê¸€ ${comments.length}ê°œ</h3>
      <div class="space-y-4 mb-6">
        ${comments.map(c => `
          <div class="flex gap-3">
            <div class="w-8 h-8 bg-zinc-200 rounded-full flex items-center justify-center flex-none">
              <span class="text-xs font-bold text-zinc-500">${c.name[0]}</span>
            </div>
            <div>
              <div class="flex items-center gap-2">
                <span class="text-xs font-bold">${c.name}</span>
                <span class="text-[10px] text-zinc-300">${c.at}</span>
              </div>
              <p class="text-sm text-zinc-600 mt-0.5">${c.body}</p>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-zinc-100 px-4 py-3 flex gap-2">
      <input id="comment-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." class="flex-1 px-4 py-2.5 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
      <button data-action="post-comment" data-notice-id="${n.id}" class="px-4 py-2.5 bg-black text-white rounded-xl text-sm font-bold active:scale-95 transition-transform">ë“±ë¡</button>
    </div>
  </div>`;
}

// ============================================================
// CALENDAR TAB
// ============================================================
function renderCalendarTab() {
  const events = DB.get('events', []);
  const now = new Date();
  const selDate = state._calSel || today();
  const vm = state._calMonth || { y: now.getFullYear(), m: now.getMonth() };
  const y = vm.y, m = vm.m;
  const firstDay = new Date(y,m,1).getDay();
  const dim = new Date(y,m+1,0).getDate();
  const eventDates = new Set(events.map(e=>e.date));

  let cells = '';
  for (let i=0; i<firstDay; i++) cells += '<div></div>';
  for (let d=1; d<=dim; d++) {
    const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isSel = ds === selDate;
    const hasEv = eventDates.has(ds);
    const isToday = ds === today();
    cells += `<button data-cal-date="${ds}" class="relative w-full aspect-square flex items-center justify-center rounded-xl text-sm font-medium transition-colors ${isSel?'bg-black text-white':isToday?'bg-zinc-100':'active:bg-zinc-50'}">${d}${hasEv&&!isSel?'<span class="absolute bottom-1 w-1 h-1 bg-black rounded-full"></span>':''}</button>`;
  }

  const dayEvents = events.filter(e => e.date === selDate);
  const sd = new Date(selDate);

  return `
  <section>
    <h2 class="text-xl font-bold tracking-tight mb-5">ì¼ì •</h2>
    <div class="flex items-center justify-between mb-4">
      <button data-action="cal-prev" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('chevron_left','',20)}</button>
      <h3 class="font-bold text-sm">${y}ë…„ ${m+1}ì›”</h3>
      <button data-action="cal-next" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('chevron_right','',20)}</button>
    </div>
    <div class="grid grid-cols-7 gap-1 mb-2">
      ${['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].map(d=>`<div class="text-center text-[10px] font-bold text-zinc-400">${d}</div>`).join('')}
    </div>
    <div class="grid grid-cols-7 gap-1 mb-6">${cells}</div>
    <div>
      <h3 class="text-sm font-bold mb-3">${sd.getMonth()+1}ì›” ${sd.getDate()}ì¼ ì¼ì •</h3>
      ${dayEvents.length===0 ? '<p class="text-sm text-zinc-300 text-center py-8">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</p>' :
        `<div class="space-y-2">${dayEvents.map(ev=>`
          <div class="flex items-center gap-4 bg-zinc-50 p-4 rounded-2xl">
            <div class="w-1 h-10 bg-black rounded-full"></div>
            <div>
              <span class="text-[10px] font-bold bg-zinc-200 text-zinc-500 px-1.5 py-0.5 rounded">${ev.cat}</span>
              <h4 class="font-bold text-sm mt-0.5">${ev.title}</h4>
              ${(ev.loc||ev.time)?`<p class="text-xs text-zinc-400">${[ev.loc,ev.time].filter(Boolean).join(' Â· ')}</p>`:''}
            </div>
          </div>
        `).join('')}</div>`
      }
    </div>
  </section>`;
}

// ============================================================
// WORSHIP DETAIL
// ============================================================
function renderWorshipDetail() {
  const worships = DB.get('worshipSets', []);
  const w = worships[worships.length - 1];
  if (!w) return '';
  return `
  <div class="min-h-screen bg-white">
    <header class="sticky top-0 z-50 px-4 py-3 bg-white/90 backdrop-blur-xl border-b border-zinc-100 flex items-center gap-3">
      <button data-action="back" class="w-10 h-10 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('arrow_back','',22)}</button>
      <h1 class="font-bold text-sm flex-1">ì´ë²ˆì£¼ ì°¬ì–‘</h1>
    </header>
    <div class="p-5">
      <div class="bg-zinc-50 rounded-2xl p-5 mb-6">
        <p class="text-[10px] font-bold text-zinc-400 uppercase tracking-wider mb-1">ì„¸íŠ¸ ì •ë³´</p>
        <p class="text-sm font-bold mb-3">${w.date}</p>
        <div class="grid grid-cols-2 gap-2 text-xs">
          <div><span class="text-zinc-400">ì¸ë„:</span> <span class="font-bold">${w.leader}</span></div>
          <div><span class="text-zinc-400">í”¼ì•„ë…¸:</span> <span class="font-bold">${w.members.piano}</span></div>
          <div><span class="text-zinc-400">ë“œëŸ¼:</span> <span class="font-bold">${w.members.drum}</span></div>
          <div><span class="text-zinc-400">PPT:</span> <span class="font-bold">${w.members.ppt}</span></div>
        </div>
      </div>
      <h3 class="text-sm font-bold mb-3">ê³¡ ëª©ë¡</h3>
      <div class="space-y-3">
        ${w.songs.map((s,i) => {
          const sheetValid = s.sheet && (!w.storedAt || (new Date() - new Date(w.storedAt)) < 30*24*60*60*1000);
          return `
          <div class="bg-white rounded-2xl border border-zinc-200 overflow-hidden">
            <div class="flex items-center gap-4 p-4">
              <div class="w-10 h-10 bg-black rounded-xl flex items-center justify-center flex-none">
                <span class="text-white font-bold text-sm">${i+1}</span>
              </div>
              <div class="flex-1 min-w-0">
                <h4 class="font-bold text-sm">${s.title}</h4>
                <p class="text-xs text-zinc-400">Key: ${s.key}</p>
              </div>
              <div class="flex items-center gap-2">
                ${s.url ? `<a href="${s.url}" target="_blank" class="w-9 h-9 bg-red-50 rounded-xl flex items-center justify-center">${icon('play_arrow','text-red-500',20)}</a>` : ''}
                ${sheetValid ? `<a href="${s.sheet}" download="ì•…ë³´_${s.title}.jpg" class="w-9 h-9 bg-zinc-100 rounded-xl flex items-center justify-center" title="ì•…ë³´ ë‹¤ìš´ë¡œë“œ">${icon('download','text-zinc-600',18)}</a>` : ''}
              </div>
            </div>
            ${sheetValid ? `<div class="border-t border-zinc-100"><img src="${s.sheet}" class="w-full" alt="ì•…ë³´"/></div>` : ''}
            ${s.sheet && !sheetValid ? `<div class="border-t border-zinc-100 px-4 py-2 bg-zinc-50"><p class="text-[10px] text-zinc-400">ì•…ë³´ ë³´ê´€ ê¸°ê°„(30ì¼) ë§Œë£Œ</p></div>` : ''}
          </div>`;
        }).join('')}
      </div>
    </div>
  </div>`;
}

// ============================================================
// ADMIN PAGE
// ============================================================
function renderAdmin() {
  const menu = [
    { k:'approve', i:'how_to_reg', l:'ê°€ì… ìŠ¹ì¸', badge: DB.get('users',[]).filter(u=>u.status==='pending').length },
    { k:'bulletin', i:'menu_book', l:'ì£¼ë³´ ê´€ë¦¬' },
    { k:'worship', i:'music_note', l:'ì°¬ì–‘ ê´€ë¦¬' },
    { k:'notice', i:'campaign', l:'ê³µì§€ ê´€ë¦¬' },
    { k:'event', i:'calendar_month', l:'ì¼ì • ê´€ë¦¬' },
    { k:'attendance', i:'fact_check', l:'ì¶œì„ ê´€ë¦¬' },
    { k:'offering', i:'volunteer_activism', l:'í—Œê¸ˆ ê¸°ë¡' },
    { k:'roster', i:'people', l:'ëª…ë¶€ ê´€ë¦¬' },
    { k:'cellmeet', i:'groups', l:'ëª©ì¥ ëª¨ì„ ê´€ë¦¬' },
    { k:'noti', i:'notifications', l:'ì•Œë¦¼ ë°œì†¡' },
  ];

  let content = '';
  if (state.adminSub === 'dashboard') {
    content = `<h2 class="text-lg font-bold mb-3">ê´€ë¦¬ ë©”ë‰´</h2><div class="space-y-3">${menu.map(m=>`
      <button data-admin="${m.k}" class="w-full flex items-center gap-4 bg-white p-4 rounded-2xl border border-zinc-100 active:bg-zinc-50 transition-colors text-left">
        <div class="w-10 h-10 bg-zinc-100 rounded-xl flex items-center justify-center">${icon(m.i,'text-black',20)}</div>
        <span class="flex-1 font-bold text-sm">${m.l}</span>
        ${m.badge>0?`<span class="bg-red-500 text-white text-[10px] font-bold w-5 h-5 rounded-full flex items-center justify-center">${m.badge}</span>`:''}
        ${icon('chevron_right','text-zinc-300',20)}
      </button>
    `).join('')}</div>`;
  } else {
    content = `<button data-admin="dashboard" class="flex items-center gap-1 text-xs text-zinc-400 font-bold mb-4">${icon('arrow_back','',16)} ë©”ë‰´ë¡œ</button>`;
    if (state.adminSub === 'approve') content += renderAdminApprove();
    else if (state.adminSub === 'bulletin') content += renderAdminBulletin();
    else if (state.adminSub === 'worship') content += renderAdminWorship();
    else if (state.adminSub === 'notice') content += renderAdminNotice();
    else if (state.adminSub === 'event') content += renderAdminEvent();
    else if (state.adminSub === 'attendance') content += renderAdminAttendance();
    else if (state.adminSub === 'offering') content += renderAdminOffering();
    else if (state.adminSub === 'roster') content += renderAdminRoster();
    else if (state.adminSub === 'cellmeet') content += renderAdminCellMeet();
    else if (state.adminSub === 'noti') content += renderAdminNoti();
  }

  return `
  <div class="min-h-screen bg-zinc-50">
    <header class="sticky top-0 z-50 px-4 py-3 bg-white/90 backdrop-blur-xl border-b border-zinc-100 flex items-center gap-3">
      <button data-action="back-main" class="w-10 h-10 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('arrow_back','',22)}</button>
      <h1 class="font-bold text-sm flex-1">ê´€ë¦¬ì</h1>
    </header>
    <div class="p-5">${content}</div>
  </div>`;
}

function renderAdminApprove() {
  const pending = DB.get('users',[]).filter(u=>u.status==='pending');
  const rosters = DB.get('rosters',[]);
  if (!pending.length) return '<h2 class="text-lg font-bold mb-4">ê°€ì… ìŠ¹ì¸</h2><p class="text-sm text-zinc-400 text-center py-10">ëŒ€ê¸° ì¤‘ì¸ ê°€ì… ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
  return `<h2 class="text-lg font-bold mb-4">ê°€ì… ìŠ¹ì¸</h2><div class="space-y-3">${pending.map(u=>{
    const match = rosters.find(r=>r.phone===u.phone);
    return `<div class="bg-white p-4 rounded-2xl border border-zinc-100">
      <div class="flex items-center justify-between mb-2">
        <div><p class="font-bold text-sm">${u.name}</p><p class="text-xs text-zinc-400">${u.phone} Â· ${u.birth}</p></div>
        <button data-action="approve" data-uid="${u.uid}" class="px-4 py-2 bg-black text-white rounded-xl text-xs font-bold active:scale-95">ìŠ¹ì¸</button>
      </div>
      ${match?`<p class="text-[10px] text-emerald-600 bg-emerald-50 px-2 py-1 rounded inline-block">ğŸ“‹ ëª…ë¶€ ë§¤ì¹­: ${match.name}</p>`:''}
    </div>`;
  }).join('')}</div>`;
}

function adminInput(id, label, ph, type='text') {
  return `<div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">${label}</label><input id="${id}" type="${type}" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="${ph}"/></div>`;
}
function adminTextarea(id, label, ph, rows=4) {
  return `<div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">${label}</label><textarea id="${id}" rows="${rows}" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black resize-none" placeholder="${ph}"></textarea></div>`;
}

function renderAdminBulletin() {
  const list = DB.get('bulletins',[]);
  return `<h2 class="text-lg font-bold mb-4">ì£¼ë³´ ê´€ë¦¬</h2>
  <div id="admin-form-area">
    <button data-action="show-bulletin-form" class="w-full py-3 border-2 border-dashed border-zinc-200 rounded-2xl text-sm font-bold text-zinc-400 mb-4">+ ìƒˆ ì£¼ë³´</button>
    <div class="space-y-2">${[...list].reverse().map(b=>`<div class="bg-white p-4 rounded-2xl border border-zinc-100"><p class="font-bold text-sm">${b.title}</p><p class="text-xs text-zinc-400">${b.date}</p></div>`).join('')}</div>
  </div>`;
}

function renderAdminWorship() {
  const list = DB.get('worshipSets',[]);
  return `<h2 class="text-lg font-bold mb-4">ì°¬ì–‘ ê´€ë¦¬</h2>
  <div id="admin-form-area">
    <button data-action="show-worship-form" class="w-full py-3 border-2 border-dashed border-zinc-200 rounded-2xl text-sm font-bold text-zinc-400 mb-4">+ ìƒˆ ì„¸íŠ¸</button>
    <div class="space-y-2">${[...list].reverse().map(w=>`<div class="bg-white p-4 rounded-2xl border border-zinc-100"><p class="font-bold text-sm">${w.date} ì°¬ì–‘ ì„¸íŠ¸</p><p class="text-xs text-zinc-400">ì¸ë„: ${w.leader} Â· ${w.songs.length}ê³¡</p></div>`).join('')}</div>
  </div>`;
}

function renderAdminNotice() {
  const list = DB.get('notices',[]);
  return `<h2 class="text-lg font-bold mb-4">ê³µì§€ ê´€ë¦¬</h2>
  <div id="admin-form-area">
    <button data-action="show-notice-form" class="w-full py-3 border-2 border-dashed border-zinc-200 rounded-2xl text-sm font-bold text-zinc-400 mb-4">+ ìƒˆ ê³µì§€</button>
    <div class="space-y-2">${[...list].reverse().map(n=>`<div class="bg-white p-4 rounded-2xl border border-zinc-100 flex items-center justify-between">
      <div>${n.pinned?'<span class="text-[9px] font-bold bg-red-50 text-red-500 px-1.5 py-0.5 rounded mr-1">ì¤‘ìš”</span>':''}<span class="font-bold text-sm">${n.title}</span><p class="text-xs text-zinc-400">${n.at}</p></div>
      <button data-action="del-notice" data-nid="${n.id}" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-red-50">${icon('delete','text-red-400',18)}</button>
    </div>`).join('')}</div>
  </div>`;
}

function renderAdminEvent() {
  const list = DB.get('events',[]);
  return `<h2 class="text-lg font-bold mb-4">ì¼ì • ê´€ë¦¬</h2>
  <div id="admin-form-area">
    <button data-action="show-event-form" class="w-full py-3 border-2 border-dashed border-zinc-200 rounded-2xl text-sm font-bold text-zinc-400 mb-4">+ ìƒˆ ì¼ì •</button>
    <div class="space-y-2">${list.map(e=>`<div class="bg-white p-4 rounded-2xl border border-zinc-100 flex items-center justify-between">
      <div><p class="font-bold text-sm">${e.title}</p><p class="text-xs text-zinc-400">${e.date} ${e.time} Â· ${e.cat}</p></div>
      <button data-action="del-event" data-eid="${e.id}" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-red-50">${icon('delete','text-red-400',18)}</button>
    </div>`).join('')}</div>
  </div>`;
}

function renderAdminAttendance() {
  const rosters = DB.get('rosters',[]);
  const cells = DB.get('cells',[]);
  const att = DB.get('attendance',{});
  const d = state._attDate || today();
  const marks = att[d]?.marks || {};
  const activeTab = state.adminAttTab || 'all';
  const filtered = activeTab === 'all' ? rosters : rosters.filter(r=>r.cellId === activeTab);
  const present = filtered.filter(r=>marks[r.id]).length;
  const tabs = [{id:'all',name:'ì „ì²´'},...cells.map(c=>({id:c.id,name:c.name}))];
  return `<h2 class="text-lg font-bold mb-4">ì¶œì„ ê´€ë¦¬</h2>
  ${adminInput('att-date','ì˜ˆë°°ì¼',today())}
  <div class="flex gap-2 mt-3 overflow-x-auto hide-scrollbar pb-1">
    ${tabs.map(t=>`<button data-att-tab="${t.id}" class="flex-none px-3 py-1.5 rounded-full text-xs font-bold border transition-colors ${activeTab===t.id?'bg-black text-white border-black':'bg-white text-zinc-500 border-zinc-200'}">${t.name}</button>`).join('')}
  </div>
  <div class="flex items-center justify-between my-3">
    <p class="text-sm text-zinc-400">ì¶œì„: <span class="font-bold text-black">${present}</span> / ${filtered.length}</p>
    <button data-action="save-attendance" class="px-4 py-2 bg-black text-white rounded-xl text-xs font-bold active:scale-95">ì €ì¥</button>
  </div>
  <div class="space-y-1">${filtered.map(r=>{
    const cellName = cells.find(c=>c.id===r.cellId)?.name||'ë¯¸ë°°ì •';
    return `
    <button data-action="toggle-att" data-rid="${r.id}" class="w-full flex items-center gap-3 p-3 rounded-xl transition-colors ${marks[r.id]?'bg-emerald-50 border border-emerald-200':'bg-white border border-zinc-100'}">
      <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${marks[r.id]?'bg-emerald-500 border-emerald-500':'border-zinc-300'}">
        ${marks[r.id]?icon('check','text-white',14):''}
      </div>
      <div class="flex-1 text-left">
        <span class="text-sm font-medium">${r.name}</span>
        ${activeTab==='all'?`<span class="text-[10px] text-zinc-400 ml-2">${cellName}</span>`:''}
      </div>
    </button>`;
  }).join('')}</div>`;
}


function renderAdminOffering() {
  const rosters = DB.get('rosters',[]);
  const offerings = DB.get('offerings',{});
  const d = state._offDate || today();
  const weekData = offerings[d] || { items:[] };
  const total = weekData.items.reduce((s,i)=>s+i.amount,0);
  return `<h2 class="text-lg font-bold mb-4">í—Œê¸ˆ ê¸°ë¡</h2>
  ${adminInput('off-date','ì£¼ì°¨',today())}
  <div class="mt-4 bg-white p-4 rounded-2xl border border-zinc-100 space-y-3">
    <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì´ë¦„</label>
      <select id="off-person" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black">
        <option value="">ì„ íƒ</option>${rosters.map(r=>`<option value="${r.id}">${r.name}</option>`).join('')}
      </select>
    </div>
    <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">í•­ëª©</label>
      <select id="off-type" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black">
        ${['ì£¼ì •','ì‹­ì¼ì¡°','ê°ì‚¬','ê¸°íƒ€'].map(t=>`<option value="${t}">${t}</option>`).join('')}
      </select>
    </div>
    ${adminInput('off-amount','ê¸ˆì•¡','10000')}
    <button data-action="add-offering" class="w-full py-3 bg-black text-white rounded-xl text-sm font-bold active:scale-[0.98]">ì¶”ê°€</button>
  </div>
  <div class="mt-4 bg-zinc-900 text-white p-4 rounded-2xl">
    <p class="text-xs text-zinc-400">ì´ë²ˆ ì£¼ ì´ì•¡</p>
    <p class="text-2xl font-bold">${total.toLocaleString()}ì›</p>
  </div>
  ${weekData.items.length?`<div class="mt-3 space-y-1">${weekData.items.map(it=>`
    <div class="bg-white p-3 rounded-xl border border-zinc-100 flex items-center justify-between">
      <div><span class="text-sm font-bold">${it.name}</span><span class="text-xs text-zinc-400 ml-2">${it.type}</span></div>
      <span class="text-sm font-bold">${it.amount.toLocaleString()}ì›</span>
    </div>
  `).join('')}</div>`:''}`;
}

function renderAdminRoster() {
  const rosters = DB.get('rosters',[]);
  const cells = DB.get('cells',[]);
  const users = DB.get('users',[]);
  const activeTab = state.adminRosterTab || 'all';
  const filtered = activeTab === 'all' ? rosters : rosters.filter(r=>r.cellId===activeTab);
  const tabs = [{id:'all',name:'ì „ì²´'},...cells.map(c=>({id:c.id,name:c.name}))];

  return `<h2 class="text-lg font-bold mb-4">ëª…ë¶€ ê´€ë¦¬</h2>
  <div class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar pb-1">
    ${tabs.map(t=>`<button data-roster-tab="${t.id}" class="flex-none px-3 py-1.5 rounded-full text-xs font-bold border transition-colors ${activeTab===t.id?'bg-black text-white border-black':'bg-white text-zinc-500 border-zinc-200'}">${t.name}</button>`).join('')}
  </div>
  <button data-action="show-roster-form" class="w-full py-3 border-2 border-dashed border-zinc-200 rounded-2xl text-sm font-bold text-zinc-400 mb-3">+ ëª…ë¶€ ì¶”ê°€</button>
  <div id="roster-form-area"></div>
  <div class="space-y-2">${filtered.map(r=>{
    const cell = cells.find(c=>c.id===r.cellId);
    const linkedUser = r.linkedUid ? users.find(u=>u.uid===r.linkedUid) : null;
    const isAdmin = linkedUser?.role === 'admin';
    return `
    <div id="roster-card-${r.id}" class="relative bg-white p-4 rounded-2xl border border-zinc-100 flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-zinc-900 flex items-center justify-center flex-none">
        <span class="text-white font-bold text-sm">${r.name[0]}</span>
      </div>
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-1.5">
          <p class="font-bold text-sm">${r.name}</p>
          ${isAdmin?`<span class="text-[9px] font-bold bg-black text-white px-1.5 py-0.5 rounded">ê´€ë¦¬ì</span>`:''}
        </div>
        <p class="text-xs text-zinc-400">${r.phone} Â· ${cell?.name||'ë¯¸ë°°ì •'}</p>
      </div>
      <button data-action="roster-menu" data-rid="${r.id}" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-zinc-100 active:bg-zinc-100 flex-none">
        ${icon('more_vert','text-zinc-400',20)}
      </button>
      <div id="roster-dd-${r.id}" class="hidden absolute right-2 top-12 z-50 bg-white border border-zinc-200 rounded-2xl shadow-lg overflow-hidden w-44">
        <button data-action="roster-edit" data-rid="${r.id}" class="w-full flex items-center gap-2.5 px-4 py-3 text-sm font-medium hover:bg-zinc-50 text-left">${icon('edit','text-zinc-500',16)} ì •ë³´ ë³€ê²½</button>
        <button data-action="roster-grant" data-rid="${r.id}" class="w-full flex items-center gap-2.5 px-4 py-3 text-sm font-medium hover:bg-zinc-50 text-left">${icon('shield','text-zinc-500',16)} ${isAdmin?'ê´€ë¦¬ì í•´ì œ':'ê´€ë¦¬ì ë¶€ì—¬'}</button>
        <button data-action="roster-delete" data-rid="${r.id}" class="w-full flex items-center gap-2.5 px-4 py-3 text-sm font-medium text-red-500 hover:bg-red-50 text-left">${icon('delete','text-red-500',16)} íƒˆí‡´ ì²˜ë¦¬</button>
      </div>
    </div>`;
  }).join('')}</div>`;
}

function renderCellTab() {
  const meetings = DB.get('cellMeetings',[]).sort((a,b)=>b.date.localeCompare(a.date));
  const latest = meetings[0];
  if (!latest) return `<div class="flex-1 flex flex-col">
    <div class="px-5 pt-5 pb-4 border-b border-zinc-100"><h1 class="text-xl font-bold tracking-tight">ëª©ì¥ ëª¨ì„</h1></div>
    <div class="flex-1 flex items-center justify-center"><p class="text-sm text-zinc-400">ë“±ë¡ëœ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤</p></div>
  </div>`;
  return `<div class="flex-1 flex flex-col">
    <div class="px-5 pt-5 pb-4 border-b border-zinc-100"><h1 class="text-xl font-bold tracking-tight">ëª©ì¥ ëª¨ì„</h1><p class="text-sm text-zinc-400 mt-0.5">${latest.date}</p></div>
    <div class="flex-1 overflow-y-auto px-5 py-5 space-y-4">
      <div class="bg-zinc-900 text-white p-5 rounded-2xl">
        <p class="text-xs font-bold text-zinc-400 mb-1">ì˜¤ëŠ˜ì˜ ë§ì”€</p>
        <p class="text-base font-bold">${latest.verse||''}</p>
        ${latest.verseText?`<p class="text-sm text-zinc-300 mt-2 leading-relaxed italic">${latest.verseText}</p>`:''}
      </div>
      ${latest.shareQ?`
      <div class="bg-white p-5 rounded-2xl border border-zinc-100">
        <p class="text-xs font-bold text-zinc-400 mb-2">ë‚˜ëˆ” ì§ˆë¬¸</p>
        <p class="text-sm leading-relaxed font-medium">${latest.shareQ}</p>
      </div>`:''}
      ${latest.heartQ?`
      <div class="bg-white p-5 rounded-2xl border border-zinc-100">
        <p class="text-xs font-bold text-zinc-400 mb-2">ë§ˆìŒ ëª¨ì•„</p>
        <p class="text-sm leading-relaxed">${latest.heartQ}</p>
      </div>`:''}
      ${latest.prayerItems?`
      <div class="bg-gradient-to-br from-indigo-50 to-purple-50 p-5 rounded-2xl border border-indigo-100">
        <p class="text-xs font-bold text-indigo-400 mb-2">í•¨ê»˜ ê¸°ë„</p>
        <p class="text-sm leading-relaxed whitespace-pre-line text-indigo-900">${latest.prayerItems}</p>
      </div>`:''}
    </div>
  </div>`;
}

function renderProfilePage() {
  const u = state.user;
  const cells = DB.get('cells',[]);
  const pg = state.profilePage;
  const notiKey = 'noti_'+u.uid;
  const noti = DB.get(notiKey, {worship:true,notice:true,verse:true,schedule:true,duty:true});

  const header = (title) => `<div class="sticky top-0 bg-white border-b border-zinc-100 px-5 py-4 flex items-center gap-3 z-10">
    <button data-action="close-profile-page" class="w-9 h-9 flex items-center justify-center rounded-full active:bg-zinc-100">${icon('arrow_back','',22)}</button>
    <h1 class="font-bold text-base">${title}</h1>
  </div>`;

  if (pg === 'edit') {
    return `<div class="min-h-screen bg-zinc-50">
      ${header('í”„ë¡œí•„ ìˆ˜ì •')}
      <div class="px-5 py-6 space-y-5">
        <div class="flex flex-col items-center gap-3">
          <div class="relative">
            <div class="w-20 h-20 rounded-full bg-zinc-200 border-2 border-black flex items-center justify-center overflow-hidden" id="profile-img-preview">
              ${u.profileImg?`<img src="${u.profileImg}" class="w-full h-full object-cover"/>`:`<span class="text-2xl font-bold text-zinc-500">${(u.name||'?')[0]}</span>`}
            </div>
            <label class="absolute -bottom-1 -right-1 w-7 h-7 bg-black rounded-full flex items-center justify-center cursor-pointer">
              ${icon('photo_camera','text-white',14)}
              <input id="profile-img-input" type="file" accept="image/*" class="hidden"/>
            </label>
          </div>
          <p class="text-xs text-zinc-400">ì‚¬ì§„ì„ íƒ­í•˜ì—¬ ë³€ê²½ (ìµœëŒ€ 300Ã—300 ì €ì¥)</p>
        </div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì´ë¦„</label>
          <input id="edit-name" value="${u.name}" class="w-full px-4 py-3 bg-white border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
        </div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì „í™”ë²ˆí˜¸</label>
          <input id="edit-phone" value="${u.phone||''}" placeholder="010-0000-0000" class="w-full px-4 py-3 bg-white border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
        </div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ìƒë…„ì›”ì¼</label>
          <input id="edit-birth" value="${u.birth||''}" placeholder="19950315" class="w-full px-4 py-3 bg-white border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
        </div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ëª©ì¥</label>
          <select id="edit-cell" class="w-full px-4 py-3 bg-white border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black">
            <option value="">ë¯¸ë°°ì •</option>
            ${cells.map(c=>`<option value="${c.id}"${c.id===u.cellId?' selected':''}>${c.name}</option>`).join('')}
          </select>
        </div>
        <button id="save-profile-edit" class="w-full py-3.5 bg-black text-white rounded-xl text-sm font-bold active:scale-[0.98]">ì €ì¥</button>
      </div>
    </div>`;
  }

  if (pg === 'noti') {
    const items = [
      {k:'worship',l:'ì°¬ì–‘ ì—…ë°ì´íŠ¸',d:'ìƒˆ ì°¬ì–‘ ì„¸íŠ¸ ë“±ë¡ ì‹œ'},
      {k:'notice',l:'ê³µì§€ì‚¬í•­',d:'ìƒˆ ê³µì§€ ë“±ë¡ ì‹œ'},
      {k:'verse',l:'ì˜¤ëŠ˜ì˜ ë§ì”€',d:'ë§¤ì¼ ë§ì”€ ì•Œë¦¼'},
      {k:'schedule',l:'ìƒˆ ì¼ì •',d:'ìƒˆ ì¼ì • ë“±ë¡ ì‹œ'},
      {k:'duty',l:'ë‹´ë‹¹ì ì§€ì •',d:'ì˜ˆë°° ë‹´ë‹¹ ë°°ì • ì‹œ'},
    ];
    return `<div class="min-h-screen bg-zinc-50">
      ${header('ì•Œë¦¼ ì„¤ì •')}
      <div class="px-5 py-6">
        <div class="bg-white rounded-2xl border border-zinc-100 divide-y divide-zinc-50">
          ${items.map(it=>`
          <div class="flex items-center justify-between px-5 py-4">
            <div>
              <p class="text-sm font-bold">${it.l}</p>
              <p class="text-xs text-zinc-400 mt-0.5">${it.d}</p>
            </div>
            <button data-noti-toggle="${it.k}" class="relative w-12 h-6 rounded-full transition-colors ${noti[it.k]?'bg-black':'bg-zinc-200'}">
              <span class="absolute top-1 transition-all w-4 h-4 bg-white rounded-full shadow ${noti[it.k]?'left-7':'left-1'}"></span>
            </button>
          </div>`).join('')}
        </div>
      </div>
    </div>`;
  }

  if (pg === 'settings') {
    return `<div class="min-h-screen bg-zinc-50">
      ${header('ì„¤ì •')}
      <div class="px-5 py-6 space-y-4">
        <div class="bg-white rounded-2xl border border-zinc-100 overflow-hidden">
          <button id="toggle-pw-section" class="w-full flex items-center justify-between px-5 py-4">
            <div class="flex items-center gap-3">${icon('lock','',20)}<span class="text-sm font-bold">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</span></div>
            ${icon('expand_more','text-zinc-400',20)}
          </button>
          <div id="pw-section" class="hidden border-t border-zinc-100 px-5 py-4 space-y-3">
            <input id="pw-current" type="password" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
            <input id="pw-new" type="password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
            <input id="pw-confirm" type="password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
            <button id="save-pw" class="w-full py-3 bg-black text-white rounded-xl text-sm font-bold">ë³€ê²½</button>
          </div>
        </div>
        <div class="bg-white rounded-2xl border border-zinc-100 divide-y divide-zinc-50">
          <div class="flex items-center justify-between px-5 py-4">
            <span class="text-sm font-bold">ì•± ë²„ì „</span>
            <span class="text-sm text-zinc-400">v1.0.0</span>
          </div>
          <button id="clear-cache-btn" class="w-full flex items-center justify-between px-5 py-4">
            <span class="text-sm font-bold">ìºì‹œ ì´ˆê¸°í™”</span>
            ${icon('chevron_right','text-zinc-300',20)}
          </button>
        </div>
        <button id="withdraw-btn" class="w-full py-3.5 bg-red-50 text-red-500 rounded-xl text-sm font-bold border border-red-100 active:scale-[0.98]">ê³„ì • íƒˆí‡´</button>
      </div>
    </div>`;
  }
  return '';
}

function renderAdminCellMeet() {
  const meetings = DB.get('cellMeetings',[]).sort((a,b)=>b.date.localeCompare(a.date));
  const ai = (id,label,ph='')=>`<div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">${label}</label><input id="${id}" value="" placeholder="${ph}" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/></div>`;
  const at = (id,label,ph,rows=4)=>`<div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">${label}</label><textarea id="${id}" placeholder="${ph}" rows="${rows}" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black resize-none"></textarea></div>`;
  return `<h2 class="text-lg font-bold mb-4">ëª©ì¥ ëª¨ì„ ê´€ë¦¬</h2>
  <button data-action="show-cellmeet-form" class="w-full py-3 border-2 border-dashed border-zinc-200 rounded-2xl text-sm font-bold text-zinc-400 mb-3">+ ëª©ì¥ ëª¨ì„ ìë£Œ ì¶”ê°€</button>
  <div id="admin-form-area"></div>
  <div class="space-y-3">${meetings.map(m=>`
    <div class="bg-white p-4 rounded-2xl border border-zinc-100">
      <div class="flex items-start justify-between mb-2">
        <div>
          <p class="font-bold text-sm">${m.date}</p>
          <p class="text-xs text-zinc-500 mt-0.5">${m.verse||''}</p>
        </div>
        <button onclick="DB.set('cellMeetings',DB.get('cellMeetings',[]).filter(x=>x.id!=='${m.id}'));render();" class="w-7 h-7 flex items-center justify-center rounded-full hover:bg-red-50">
          ${icon('delete','text-zinc-300',16)}
        </button>
      </div>
      ${m.shareQ?`<p class="text-xs text-zinc-400 line-clamp-2">ë‚˜ëˆ”: ${m.shareQ}</p>`:''}
    </div>
  `).join('')}</div>`;
}

function renderAdminNoti() {
  return `<h2 class="text-lg font-bold mb-4">ì•Œë¦¼ ë°œì†¡</h2>
  <div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100">
    ${adminInput('noti-title','ì œëª©','ì•Œë¦¼ ì œëª©')}
    ${adminTextarea('noti-body','ë‚´ìš©','ì•Œë¦¼ ë‚´ìš©')}
    <button data-action="send-noti" class="w-full py-3 bg-black text-white rounded-xl text-sm font-bold active:scale-[0.98]">ì „ì²´ ë°œì†¡</button>
  </div>`;
}

// ============================================================
// EVENT BINDING
// ============================================================
function bindEvents() {
  // Login
  document.getElementById('btn-login')?.addEventListener('click', () => {
    const id = document.getElementById('login-id').value;
    const pw = document.getElementById('login-pw').value;
    const users = DB.get('users', []);
    const u = users.find(x => x.id === id && x.pw === pw);
    const errEl = document.getElementById('login-error');
    if (!u) { errEl.textContent = 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.'; errEl.classList.remove('hidden'); return; }
    if (u.status === 'pending') { errEl.textContent = 'ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.'; errEl.classList.remove('hidden'); return; }
    state.user = u; state.page = 'main'; DB.set('currentUser', u); render();
  });

  document.getElementById('login-pw')?.addEventListener('keydown', e => {
    if (e.key === 'Enter') document.getElementById('btn-login')?.click();
  });

  // Register
  document.getElementById('btn-go-register')?.addEventListener('click', () => { state.page = 'register'; render(); });
  document.getElementById('btn-back-login')?.addEventListener('click', () => { state.page = 'login'; render(); });
  document.getElementById('btn-register')?.addEventListener('click', () => {
    const g = id => document.getElementById(id)?.value || '';
    const name=g('reg-name'), phone=g('reg-phone'), birth=g('reg-birth'), id=g('reg-id'), pw=g('reg-pw'), pw2=g('reg-pw2');
    const agree = document.getElementById('reg-agree')?.checked;
    const errEl = document.getElementById('reg-error');
    const showErr = msg => { errEl.textContent=msg; errEl.classList.remove('hidden'); };
    if (!name||!phone||!birth||!id||!pw) return showErr('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    if (pw!==pw2) return showErr('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    if (pw.length<4) return showErr('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
    if (!agree) return showErr('ê°œì¸ì •ë³´ ìˆ˜ì§‘ì— ë™ì˜í•´ì£¼ì„¸ìš”.');
    if (!/^\d{8}$/.test(birth)) return showErr('ìƒë…„ì›”ì¼ì€ 8ìë¦¬ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');

    const users = DB.get('users',[]);
    if (users.find(u=>u.id===id)) return showErr('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.');
    if (users.find(u=>u.phone===phone)) return showErr('ì´ë¯¸ ë“±ë¡ëœ ì „í™”ë²ˆí˜¸ì…ë‹ˆë‹¤.');
    users.push({ uid:uid(), id, pw, name, phone, birth, cellId:'', role:'user', status:'pending', createdAt:today() });
    DB.set('users', users);
    showToast('ê°€ì… ì‹ ì²­ ì™„ë£Œ! ê´€ë¦¬ì ìŠ¹ì¸ í›„ ë¡œê·¸ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    state.page = 'login'; render();
  });

  // Tabs
  document.querySelectorAll('[data-tab]').forEach(el => {
    el.addEventListener('click', () => { state.tab = el.dataset.tab; state.detail = null; render(); });
  });

  // Profile
  document.querySelector('[data-action="open-profile"]')?.addEventListener('click', () => { state.profileOpen = true; render(); });
  document.querySelector('[data-action="close-profile"]')?.addEventListener('click', () => { state.profileOpen = false; render(); });
  document.querySelector('[data-action="logout"]')?.addEventListener('click', () => {
    state.user = null; state.page = 'login'; state.profileOpen = false; DB.remove('currentUser'); render();
  });
  document.querySelector('[data-action="go-admin"]')?.addEventListener('click', () => {
    state.page = 'admin'; state.adminSub = 'dashboard'; state.profileOpen = false; render();
  });

  // Back / Navigation
  document.querySelectorAll('[data-action="back"]').forEach(el => {
    el.addEventListener('click', () => { state.detail = null; render(); });
  });
  document.querySelector('[data-action="back-main"]')?.addEventListener('click', () => { state.page = 'main'; state.tab = 'home'; render(); });

  // Details
  document.querySelectorAll('[data-detail]').forEach(el => {
    el.addEventListener('click', () => {
      const [type, id] = el.dataset.detail.split(':');
      state.detail = { type, id }; render();
    });
  });

  // Worship
  document.querySelectorAll('[data-action="go-worship"]').forEach(el => {
    el.addEventListener('click', () => { state.detail = { type:'worship', id:'latest' }; render(); });
  });

  // Comment
  document.querySelector('[data-action="post-comment"]')?.addEventListener('click', function() {
    const input = document.getElementById('comment-input');
    if (!input?.value.trim()) return;
    const nid = this.dataset.noticeId;
    const comments = DB.get('comments', {});
    if (!comments[nid]) comments[nid] = [];
    comments[nid].push({ id:uid(), uid:state.user.uid, name:state.user.name, body:input.value.trim(), at:today() });
    DB.set('comments', comments);
    render();
  });
  document.getElementById('comment-input')?.addEventListener('keydown', e => {
    if (e.key === 'Enter') document.querySelector('[data-action="post-comment"]')?.click();
  });

  // Calendar
  document.querySelectorAll('[data-cal-date]').forEach(el => {
    el.addEventListener('click', () => { state._calSel = el.dataset.calDate; render(); });
  });
  document.querySelector('[data-action="cal-prev"]')?.addEventListener('click', () => {
    const vm = state._calMonth || { y: new Date().getFullYear(), m: new Date().getMonth() };
    vm.m--; if (vm.m < 0) { vm.m = 11; vm.y--; }
    state._calMonth = vm; render();
  });
  document.querySelector('[data-action="cal-next"]')?.addEventListener('click', () => {
    const vm = state._calMonth || { y: new Date().getFullYear(), m: new Date().getMonth() };
    vm.m++; if (vm.m > 11) { vm.m = 0; vm.y++; }
    state._calMonth = vm; render();
  });

  // Admin navigation
  document.querySelectorAll('[data-admin]').forEach(el => {
    el.addEventListener('click', () => { state.adminSub = el.dataset.admin; render(); });
  });

  // Admin: Approve
  document.querySelectorAll('[data-action="approve"]').forEach(el => {
    el.addEventListener('click', () => {
      const users = DB.get('users', []);
      const u = users.find(x => x.uid === el.dataset.uid);
      if (u) u.status = 'active';
      DB.set('users', users);
      showToast('ìŠ¹ì¸ ì™„ë£Œ!');
    });
  });

  // Admin: Delete notice
  document.querySelectorAll('[data-action="del-notice"]').forEach(el => {
    el.addEventListener('click', () => {
      const notices = DB.get('notices',[]).filter(n => n.id !== el.dataset.nid);
      DB.set('notices', notices); render();
    });
  });

  // Admin: Delete event
  document.querySelectorAll('[data-action="del-event"]').forEach(el => {
    el.addEventListener('click', () => {
      const events = DB.get('events',[]).filter(e => e.id !== el.dataset.eid);
      DB.set('events', events); render();
    });
  });

  // Admin: Attendance
  document.querySelectorAll('[data-action="toggle-att"]').forEach(el => {
    el.addEventListener('click', () => {
      const d = document.getElementById('att-date')?.value || today();
      const att = DB.get('attendance', {});
      if (!att[d]) att[d] = { marks:{} };
      att[d].marks[el.dataset.rid] = !att[d].marks[el.dataset.rid];
      DB.set('attendance', att);
      state._attDate = d; render();
    });
  });
  document.querySelector('[data-action="save-attendance"]')?.addEventListener('click', () => { showToast('ì¶œì„ ì €ì¥ ì™„ë£Œ!'); });

  // Admin: Offering
  document.querySelector('[data-action="add-offering"]')?.addEventListener('click', () => {
    const d = document.getElementById('off-date')?.value || today();
    const pid = document.getElementById('off-person')?.value;
    const type = document.getElementById('off-type')?.value;
    const amount = Number(document.getElementById('off-amount')?.value);
    if (!pid || !amount) return;
    const rosters = DB.get('rosters',[]);
    const person = rosters.find(r=>r.id===pid);
    const offerings = DB.get('offerings',{});
    if (!offerings[d]) offerings[d] = { items:[] };
    offerings[d].items.push({ id:uid(), personId:pid, name:person?.name||'', type, amount });
    DB.set('offerings', offerings);
    state._offDate = d; render();
  });

  // Admin: Send notification
  document.querySelector('[data-action="send-noti"]')?.addEventListener('click', () => {
    const title = document.getElementById('noti-title')?.value;
    const body = document.getElementById('noti-body')?.value;
    if (!title) return;
    const notis = DB.get('notifications', []);
    notis.push({ id:uid(), title, body, type:'etc', at:today() });
    DB.set('notifications', notis);
    showToast('ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ!');
  });

  // Admin: Show forms (inline)
  const formActions = {
    'show-notice-form': () => {
      const area = document.getElementById('admin-form-area');
      if (!area) return;
      area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4">
        ${adminInput('nf-title','ì œëª©','ê³µì§€ ì œëª©')}
        ${adminTextarea('nf-body','ë‚´ìš©','ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”',5)}
        <label class="flex items-center gap-2"><input id="nf-pinned" type="checkbox" class="w-4 h-4 rounded accent-black"/><span class="text-sm font-medium">ì¤‘ìš” ê³µì§€ë¡œ ê³ ì •</span></label>
        <div class="flex gap-2">
          <button onclick="state.adminSub='notice';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">ì·¨ì†Œ</button>
          <button id="save-notice" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">ì €ì¥</button>
        </div>
      </div>`;
      document.getElementById('save-notice')?.addEventListener('click', () => {
        const title = document.getElementById('nf-title')?.value;
        if (!title) return;
        const notices = DB.get('notices',[]);
        const n = { id:uid(), title, body:document.getElementById('nf-body')?.value||'', pinned:document.getElementById('nf-pinned')?.checked||false, by:state.user.uid, at:today() };
        notices.push(n);
        DB.set('notices', notices);
        const comments = DB.get('comments',{}); comments[n.id] = []; DB.set('comments', comments);
        showToast('ê³µì§€ ì €ì¥ ì™„ë£Œ!'); render();
      });
    },
    'show-event-form': () => {
      const area = document.getElementById('admin-form-area');
      if (!area) return;
      area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4">
        ${adminInput('ef-title','ì œëª©','ì£¼ì¼ ì²­ë…„ ì˜ˆë°°')}
        ${adminInput('ef-date','ë‚ ì§œ','2026-03-01')}
        ${adminInput('ef-time','ì‹œê°„','14:00')}
        ${adminInput('ef-loc','ì¥ì†Œ','ë³¸ë‹¹')}
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì¹´í…Œê³ ë¦¬</label>
          <select id="ef-cat" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black">
            ${['ì˜ˆë°°','ëª¨ì„','í–‰ì‚¬','ìƒì¼','ê¸°íƒ€'].map(c=>`<option value="${c}">${c}</option>`).join('')}
          </select>
        </div>
        <div class="flex gap-2">
          <button onclick="state.adminSub='event';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">ì·¨ì†Œ</button>
          <button id="save-event" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">ì €ì¥</button>
        </div>
      </div>`;
      document.getElementById('save-event')?.addEventListener('click', () => {
        const g = id => document.getElementById(id)?.value || '';
        const title = g('ef-title'); if (!title) return;
        const events = DB.get('events',[]);
        events.push({ id:uid(), title, date:g('ef-date'), time:g('ef-time'), loc:g('ef-loc'), cat:g('ef-cat')||'ê¸°íƒ€' });
        DB.set('events', events); showToast('ì¼ì • ì €ì¥ ì™„ë£Œ!'); render();
      });
    },
    'show-roster-form': () => {
      const cells = DB.get('cells',[]);
      const area = document.getElementById('roster-form-area'); if (!area) return;
      area.innerHTML = `<div class="bg-white p-4 rounded-2xl border border-zinc-100 mb-4 space-y-3">
        ${adminInput('rf-name','ì´ë¦„','í™ê¸¸ë™')}
        ${adminInput('rf-phone','ì „í™”ë²ˆí˜¸','010-0000-0000')}
        ${adminInput('rf-birth','ìƒë…„ì›”ì¼','19950315')}
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ëª©ì¥</label>
          <select id="rf-cell" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black">
            <option value="">ì„ íƒ</option>${cells.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}
          </select>
        </div>
        <div class="flex gap-2">
          <button onclick="state.adminSub='roster';render()" class="flex-1 py-2.5 border border-zinc-200 rounded-xl text-sm font-bold">ì·¨ì†Œ</button>
          <button id="save-roster" class="flex-1 py-2.5 bg-black text-white rounded-xl text-sm font-bold">ì¶”ê°€</button>
        </div>
      </div>`;
      document.getElementById('rf-phone')?.addEventListener('input', function(){ this.value=fmtPhone(this.value); });
      document.getElementById('save-roster')?.addEventListener('click', () => {
        const g = id => document.getElementById(id)?.value || '';
        const name = g('rf-name'), phone = g('rf-phone'); if (!name||!phone) return;
        const rosters = DB.get('rosters',[]);
        rosters.push({ id:uid(), name, phone, birth:g('rf-birth'), cellId:g('rf-cell'), linkedUid:null });
        DB.set('rosters', rosters); showToast('ëª…ë¶€ ì¶”ê°€ ì™„ë£Œ!'); render();
      });
    },
  };

  Object.keys(formActions).forEach(action => {
    document.querySelector(`[data-action="${action}"]`)?.addEventListener('click', formActions[action]);
  });

  // Set date input values
  const attDate = document.getElementById('att-date');
  if (attDate && !attDate.value) attDate.value = state._attDate || today();
  const offDate = document.getElementById('off-date');
  if (offDate && !offDate.value) offDate.value = state._offDate || today();

  // Profile page navigation
  document.querySelectorAll('[data-profile-page]').forEach(el => {
    el.addEventListener('click', () => { state.profilePage = el.dataset.profilePage; state.profileOpen = false; render(); });
  });
  document.querySelector('[data-action="close-profile-page"]')?.addEventListener('click', () => { state.profilePage = null; render(); });

  // Profile edit save
  document.getElementById('save-profile-edit')?.addEventListener('click', () => {
    const name = document.getElementById('edit-name')?.value || state.user.name;
    const phone = document.getElementById('edit-phone')?.value || state.user.phone;
    const birth = document.getElementById('edit-birth')?.value || state.user.birth;
    const cellId = document.getElementById('edit-cell')?.value || state.user.cellId;
    const users = DB.get('users', []);
    const idx = users.findIndex(u => u.uid === state.user.uid);
    const newImg = state._pendingProfileImg || state.user.profileImg || '';
    if (idx >= 0) { users[idx] = { ...users[idx], name, phone, birth, cellId, profileImg: newImg }; DB.set('users', users); }
    state.user = { ...state.user, name, phone, birth, cellId, profileImg: newImg };
    state._pendingProfileImg = null;
    DB.set('currentUser', state.user);
    // ëª…ë¶€ë„ ì—…ë°ì´íŠ¸
    const rosters = DB.get('rosters', []);
    const ri = rosters.findIndex(r => r.linkedUid === state.user.uid);
    if (ri >= 0) { rosters[ri] = { ...rosters[ri], name, phone, birth, cellId }; DB.set('rosters', rosters); }
    state.profilePage = null;
    showToast('í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!'); render();
  });
  // Phone auto-format in profile edit
  document.getElementById('edit-phone')?.addEventListener('input', function() { this.value = fmtPhone(this.value); });

  // Profile image upload
  document.getElementById('profile-img-input')?.addEventListener('change', function() {
    const file = this.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        const MAX = 300;
        const scale = Math.min(1, MAX/img.width, MAX/img.height);
        const canvas = document.createElement('canvas');
        canvas.width = Math.round(img.width * scale);
        canvas.height = Math.round(img.height * scale);
        canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
        const data = canvas.toDataURL('image/jpeg', 0.85);
        state._pendingProfileImg = data;
        const preview = document.getElementById('profile-img-preview');
        if (preview) preview.innerHTML = `<img src="${data}" class="w-full h-full object-cover"/>`;
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });

  // Notification toggles
  document.querySelectorAll('[data-noti-toggle]').forEach(el => {
    el.addEventListener('click', () => {
      const key = el.dataset.notiToggle;
      const notiKey = 'noti_' + state.user.uid;
      const noti = DB.get(notiKey, {worship:true,notice:true,verse:true,schedule:true,duty:true});
      noti[key] = !noti[key];
      DB.set(notiKey, noti);
      render();
    });
  });

  // Settings page
  document.getElementById('toggle-pw-section')?.addEventListener('click', () => {
    document.getElementById('pw-section')?.classList.toggle('hidden');
  });
  document.getElementById('save-pw')?.addEventListener('click', () => {
    const current = document.getElementById('pw-current')?.value;
    const nw = document.getElementById('pw-new')?.value;
    const confirm = document.getElementById('pw-confirm')?.value;
    if (!current || !nw) return showToast('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    if (nw !== confirm) return showToast('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    const users = DB.get('users', []);
    const u = users.find(x => x.uid === state.user.uid);
    if (!u || u.pw !== current) return showToast('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
    u.pw = nw; DB.set('users', users);
    state.user = { ...state.user, pw: nw }; DB.set('currentUser', state.user);
    showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!');
  });
  document.getElementById('clear-cache-btn')?.addEventListener('click', () => {
    if (confirm('ìºì‹œë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?')) { showToast('ìºì‹œ ì´ˆê¸°í™” ì™„ë£Œ'); }
  });
  document.getElementById('withdraw-btn')?.addEventListener('click', () => {
    if (confirm('ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
      const users = DB.get('users', []).filter(u => u.uid !== state.user.uid);
      DB.set('users', users); DB.remove('currentUser');
      state.user = null; state.page = 'login'; state.profilePage = null; render();
    }
  });

  // Offering amount format
  document.getElementById('off-amount')?.addEventListener('input', function() {
    const raw = this.value.replace(/[^0-9]/g,'');
    this.value = raw ? Number(raw).toLocaleString() : '';
  });

  // Attendance tabs
  document.querySelectorAll('[data-att-tab]').forEach(el => {
    el.addEventListener('click', () => { state.adminAttTab = el.dataset.attTab; render(); });
  });

  // Roster tabs
  document.querySelectorAll('[data-roster-tab]').forEach(el => {
    el.addEventListener('click', () => { state.adminRosterTab = el.dataset.rosterTab; render(); });
  });

  // Roster 3-dot menu
  document.querySelectorAll('[data-action="roster-menu"]').forEach(el => {
    el.addEventListener('click', e => {
      e.stopPropagation();
      const rid = el.dataset.rid;
      document.querySelectorAll('[id^="roster-dd-"]').forEach(d => { if (d.id !== 'roster-dd-'+rid) d.classList.add('hidden'); });
      document.getElementById('roster-dd-'+rid)?.classList.toggle('hidden');
    });
  });
  document.body.addEventListener('click', () => {
    document.querySelectorAll('[id^="roster-dd-"]').forEach(d => d.classList.add('hidden'));
  });

  document.querySelectorAll('[data-action="roster-delete"]').forEach(el => {
    el.addEventListener('click', () => {
      if (!confirm('ì •ë§ íƒˆí‡´ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      DB.set('rosters', DB.get('rosters',[]).filter(r => r.id !== el.dataset.rid));
      showToast('íƒˆí‡´ ì²˜ë¦¬ ì™„ë£Œ'); render();
    });
  });
  document.querySelectorAll('[data-action="roster-grant"]').forEach(el => {
    el.addEventListener('click', () => {
      const roster = DB.get('rosters',[]).find(r => r.id === el.dataset.rid);
      if (!roster?.linkedUid) { showToast('ì—°ê²°ëœ ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const users = DB.get('users',[]); const u = users.find(x => x.uid === roster.linkedUid);
      if (!u) { showToast('ê³„ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      u.role = u.role === 'admin' ? 'user' : 'admin';
      DB.set('users', users); showToast(u.role==='admin'?'ê´€ë¦¬ì ê¶Œí•œ ë¶€ì—¬ë¨':'ê´€ë¦¬ì ê¶Œí•œ í•´ì œë¨'); render();
    });
  });
  document.querySelectorAll('[data-action="roster-edit"]').forEach(el => {
    el.addEventListener('click', () => {
      const rid = el.dataset.rid;
      const r = DB.get('rosters',[]).find(x => x.id === rid); if (!r) return;
      const cells = DB.get('cells',[]);
      const card = document.getElementById('roster-card-'+rid); if (!card) return;
      card.outerHTML = `<div class="bg-white p-4 rounded-2xl border border-zinc-200 space-y-3">
        <p class="text-xs font-bold text-zinc-500 mb-1">${r.name} ì •ë³´ ë³€ê²½</p>
        <input id="re-name-${rid}" value="${r.name}" class="w-full px-3 py-2 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="ì´ë¦„"/>
        <input id="re-phone-${rid}" value="${r.phone}" class="w-full px-3 py-2 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="010-0000-0000"/>
        <input id="re-birth-${rid}" value="${r.birth||''}" class="w-full px-3 py-2 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="ìƒë…„ì›”ì¼"/>
        <select id="re-cell-${rid}" class="w-full px-3 py-2 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black">
          <option value="">ë¯¸ë°°ì •</option>${cells.map(c=>`<option value="${c.id}"${c.id===r.cellId?' selected':''}>${c.name}</option>`).join('')}
        </select>
        <div class="flex gap-2">
          <button onclick="state.adminSub='roster';render()" class="flex-1 py-2 border border-zinc-200 rounded-xl text-sm font-bold">ì·¨ì†Œ</button>
          <button id="save-re-${rid}" class="flex-1 py-2 bg-black text-white rounded-xl text-sm font-bold">ì €ì¥</button>
        </div>
      </div>`;
      document.getElementById('re-phone-'+rid)?.addEventListener('input', function() { this.value = fmtPhone(this.value); });
      document.getElementById('save-re-'+rid)?.addEventListener('click', () => {
        const g = id => document.getElementById(id)?.value;
        const rosters2 = DB.get('rosters',[]);
        const idx = rosters2.findIndex(x => x.id === rid);
        if (idx >= 0) rosters2[idx] = { ...rosters2[idx], name:g('re-name-'+rid)||r.name, phone:g('re-phone-'+rid)||r.phone, birth:g('re-birth-'+rid)||r.birth, cellId:g('re-cell-'+rid)||r.cellId };
        DB.set('rosters', rosters2); showToast('ì •ë³´ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.'); render();
      });
    });
  });

  // Admin: cellmeet form
  document.querySelector('[data-action="show-cellmeet-form"]')?.addEventListener('click', () => {
    const area = document.getElementById('admin-form-area'); if (!area) return;
    area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4">
      ${adminInput('cm-date','ë‚ ì§œ','2026-03-01')}
      ${adminInput('cm-verse','ë§ì”€ êµ¬ì ˆ','ìš”í•œë³µìŒ 15:1-8')}
      ${adminTextarea('cm-versetext','ë§ì”€ ë³¸ë¬¸ (í•µì‹¬)','"ë‚˜ëŠ” í¬ë„ë‚˜ë¬´ìš”..."',2)}
      ${adminTextarea('cm-shareq','ë‚˜ëˆ” ì§ˆë¬¸','ì˜¤ëŠ˜ ë§ì”€ì—ì„œ ê°€ì¥ ì™€ë‹¿ì€ ë¶€ë¶„ì€?',3)}
      ${adminTextarea('cm-heartq','ë§ˆìŒ ëª¨ì•„','ì´ë²ˆ ì£¼ ë‚˜ì˜ ì‚¶ì—ì„œ...',3)}
      ${adminTextarea('cm-prayer','í•¨ê»˜ ê¸°ë„ ì œëª©','â€¢ ëª©ì¥ ì§€ì²´ë¥¼ ìœ„í•´\nâ€¢ ì–´ë ¤ì›€ì„ ê²ªëŠ” ì§€ì²´ë¥¼ ìœ„í•´',4)}
      <div class="flex gap-2">
        <button onclick="state.adminSub='cellmeet';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">ì·¨ì†Œ</button>
        <button id="save-cellmeet" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">ì €ì¥</button>
      </div>
    </div>`;
    document.getElementById('save-cellmeet')?.addEventListener('click', () => {
      const g = id => document.getElementById(id)?.value || '';
      const date = g('cm-date'); if (!date) return;
      const meetings = DB.get('cellMeetings',[]);
      meetings.push({ id:uid(), date, verse:g('cm-verse'), verseText:g('cm-versetext'), shareQ:g('cm-shareq'), heartQ:g('cm-heartq'), prayerItems:g('cm-prayer'), by:state.user.uid, at:today() });
      DB.set('cellMeetings', meetings); showToast('ëª©ì¥ ëª¨ì„ ìë£Œ ì €ì¥ ì™„ë£Œ!'); render();
    });
  });

  // Admin: worship form (ê°œì„ ëœ ë²„ì „ - ê³¡ë³„ í‚¤/ì•…ë³´)
  const worshipFormEl = document.querySelector('[data-action="show-worship-form"]');
  if (worshipFormEl) {
    worshipFormEl.removeEventListener('click', worshipFormEl._handler);
    const KEYS = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    let songCount = 1;
    const getSongRows = () => {
      let rows = '';
      for (let i = 0; i < songCount; i++) {
        rows += `<div class="bg-zinc-50 rounded-xl p-3 space-y-2 mb-2">
          <p class="text-[10px] font-bold text-zinc-400">ê³¡ ${i+1}</p>
          <input id="ws-title-${i}" placeholder="ê³¡ ì œëª©" class="w-full px-3 py-2 bg-white border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
          <input id="ws-url-${i}" placeholder="ìœ íŠœë¸Œ ë§í¬" class="w-full px-3 py-2 bg-white border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black"/>
          <div class="flex gap-2">
            <div class="flex-1"><label class="block text-[10px] font-bold text-zinc-500 mb-1">í‚¤</label>
              <select id="ws-key-${i}" class="w-full px-3 py-2 bg-white border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black">${KEYS.map(k=>`<option value="${k}">${k}</option>`).join('')}</select>
            </div>
            <div class="flex-1"><label class="block text-[10px] font-bold text-zinc-500 mb-1">ì•…ë³´ (ì´ë¯¸ì§€)</label>
              <label class="flex items-center gap-1 px-3 py-2 bg-white border border-zinc-200 rounded-xl text-xs text-zinc-400 cursor-pointer">
                ğŸ“ íŒŒì¼ì„ íƒ
                <input id="ws-sheet-${i}" type="file" accept="image/*" class="hidden"/>
              </label>
              <p id="ws-sheet-name-${i}" class="text-[10px] text-zinc-400 mt-0.5 truncate"></p>
            </div>
          </div>
        </div>`;
      }
      return rows;
    };
    worshipFormEl._handler = () => {
      const area = document.getElementById('admin-form-area'); if (!area) return;
      songCount = 1;
      area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4">
        ${adminInput('wf-date','ì£¼ì°¨ ë‚ ì§œ','2026-03-01')}
        ${adminInput('wf-leader','ì¸ë„ì','')}
        ${adminInput('wf-piano','í”¼ì•„ë…¸','')}
        ${adminInput('wf-drum','ë“œëŸ¼','')}
        ${adminInput('wf-ppt','PPT','')}
        <div><label class="block text-xs font-bold text-zinc-600 mb-2 ml-1">ê³¡ ëª©ë¡</label>
          <div id="song-rows">${getSongRows()}</div>
          <button id="add-song-row" class="w-full py-2 border border-dashed border-zinc-200 rounded-xl text-xs font-bold text-zinc-400 mt-1">+ ê³¡ ì¶”ê°€</button>
        </div>
        <p class="text-[10px] text-zinc-400">â€» ì•…ë³´ëŠ” ì›ë³¸ ì €ì¥, ë“±ë¡ì¼ë¡œë¶€í„° 30ì¼ê°„ í‘œì‹œë©ë‹ˆë‹¤.</p>
        <div class="flex gap-2">
          <button onclick="state.adminSub='worship';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">ì·¨ì†Œ</button>
          <button id="save-worship" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">ì €ì¥</button>
        </div>
      </div>`;
      const bindSheets = () => { for(let i=0;i<songCount;i++) { document.getElementById('ws-sheet-'+i)?.addEventListener('change', function(){ const nm=document.getElementById('ws-sheet-name-'+i); if(nm) nm.textContent=this.files[0]?.name||''; }); } };
      bindSheets();
      document.getElementById('add-song-row')?.addEventListener('click', () => { songCount++; document.getElementById('song-rows').innerHTML=getSongRows(); bindSheets(); });
      document.getElementById('save-worship')?.addEventListener('click', async () => {
        const g = id => document.getElementById(id)?.value||'';
        const date = g('wf-date'); if (!date) return;
        const songPromises = Array.from({length:songCount},(_,i) => new Promise(res => {
          const fileEl = document.getElementById('ws-sheet-'+i); const file = fileEl?.files[0];
          const title=g('ws-title-'+i); const url=g('ws-url-'+i); const key=g('ws-key-'+i)||'C';
          if (file) { const reader=new FileReader(); reader.onload=e=>res({title,url,key,sheet:e.target.result}); reader.readAsDataURL(file); }
          else res({title,url,key,sheet:''});
        }));
        const songs = await Promise.all(songPromises);
        const ws = DB.get('worshipSets',[]); 
        ws.push({id:uid(),date,leader:g('wf-leader'),members:{piano:g('wf-piano'),drum:g('wf-drum'),ppt:g('wf-ppt')},songs:songs.filter(s=>s.title),by:state.user.uid,at:today(),storedAt:today()});
        DB.set('worshipSets',ws);
        const notis=DB.get('notifications',[]);notis.push({id:uid(),title:'ì´ë²ˆì£¼ ì°¬ì–‘ ì—…ë°ì´íŠ¸',body:`${date} ì°¬ì–‘ ì„¸íŠ¸ ë“±ë¡`,type:'worship',at:today()});DB.set('notifications',notis);
        showToast('ì°¬ì–‘ ì €ì¥ ì™„ë£Œ!'); render();
      });
    };
    worshipFormEl.addEventListener('click', worshipFormEl._handler);
  }

  // Admin: bulletin form (ê°œì„ ëœ ë²„ì „ - ë‹´ë‹¹ìë³„)
  const bulletinFormEl = document.querySelector('[data-action="show-bulletin-form"]');
  if (bulletinFormEl) {
    bulletinFormEl._handler = () => {
      const rosters = DB.get('rosters',[]); const area = document.getElementById('admin-form-area'); if (!area) return;
      const rOpts = `<option value="">ë¯¸ì •</option>${rosters.map(r=>`<option value="${r.name}">${r.name}</option>`).join('')}`;
      area.innerHTML = `<div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4">
        ${adminInput('bf-title','ì œëª©','2026ë…„ 3ì›” 1ì¼ ì£¼ë³´')}
        ${adminInput('bf-date','ë‚ ì§œ','2026-03-01')}
        ${adminTextarea('bf-order','ì˜ˆë°°ìˆœì„œ','1. ì˜ˆë°°ì˜ ë¶€ë¦„\n2. ê²½ë°°ì™€ ì°¬ì–‘...',6)}
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ëŒ€í‘œê¸°ë„ ë‹´ë‹¹</label><select id="bf-prayer" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black">${rOpts}</select></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì„±ê²½ë´‰ë… ë‹´ë‹¹</label><select id="bf-bible" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black">${rOpts}</select></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì„±ë„ì˜ êµì œ ë‹´ë‹¹</label><select id="bf-announce" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black">${rOpts}</select></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ë´‰í—Œ ë‹´ë‹¹</label><select id="bf-offering" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black">${rOpts}</select></div>
        ${adminTextarea('bf-songs','ì°¬ì–‘ê³¡ ëª©ë¡','1. ê³¡ëª… (Key: G)',4)}
        ${adminTextarea('bf-announce-text','ê´‘ê³  ë‚´ìš©','â€¢ ìˆ˜ë ¨íšŒ ì•ˆë‚´',4)}
        <div class="flex gap-2">
          <button onclick="state.adminSub='bulletin';render()" class="flex-1 py-3 border border-zinc-200 rounded-xl text-sm font-bold">ì·¨ì†Œ</button>
          <button id="save-bulletin" class="flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold">ì €ì¥</button>
        </div>
      </div>`;
      document.getElementById('save-bulletin')?.addEventListener('click', () => {
        const g = id => document.getElementById(id)?.value||'';
        const title=g('bf-title'),date=g('bf-date'); if(!title||!date) return;
        const bulletins = DB.get('bulletins',[]);
        bulletins.push({id:uid(),title,date,order:g('bf-order'),prayer_duty:g('bf-prayer'),bible_reading:g('bf-bible'),announcement_duty:g('bf-announce'),offering_duty:g('bf-offering'),songs:g('bf-songs'),announce:g('bf-announce-text'),by:state.user.uid,at:today()});
        DB.set('bulletins',bulletins);
        showToast('ì£¼ë³´ ì €ì¥ ì™„ë£Œ!'); render();
      });
    };
    bulletinFormEl.addEventListener('click', bulletinFormEl._handler);
  }
}

// Initial render
render();
</script>

</body>
</html>
