<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>ì•½ì†ì˜ ë•… - ì²­ë…„ë¶€</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script>
tailwind.config = {
  theme: {
    extend: {
      fontFamily: { sans: ['Inter', 'sans-serif'] },
    }
  }
}
</script>
<style>
  * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
  body { font-family: 'Inter', sans-serif; overscroll-behavior: none; }
  .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24; }
  .material-symbols-outlined.filled { font-variation-settings: 'FILL' 1, 'wght' 300, 'GRAD' 0, 'opsz' 24; }
  .hide-scrollbar::-webkit-scrollbar { display: none; }
  .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  .slide-up { animation: slideUp 0.3s cubic-bezier(0.32,0.72,0,1); }
  .fade-in { animation: fadeIn 0.2s ease; }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  input, textarea, select { font-family: 'Inter', sans-serif; }
  .dot-pattern { background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.08) 1px, transparent 0); background-size: 20px 20px; }
</style>
</head>
<body class="bg-white text-black min-h-screen">

<div id="app"></div>

<script type="module">
  // 1. íŒŒì´ì–´ë² ì´ìŠ¤ í•µì‹¬ ë„êµ¬ë“¤ ë¶ˆëŸ¬ì˜¤ê¸°
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

  // 2. íŒŒì´ì–´ë² ì´ìŠ¤ ì„¤ì •
  const firebaseConfig = {
    apiKey: "AIzaSyCsc6xD7mTanSwPbz7iSGB9NjniFub97wY",
    authDomain: "promiand-app.firebaseapp.com",
    projectId: "promiand-app",
    storageBucket: "promiand-app.firebasestorage.app",
    messagingSenderId: "585556305161",
    appId: "1:585556305161:web:2752434736fd4a652c1fd8",
    measurementId: "G-E2SKN09Y6T"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);
  console.log("ğŸ”¥ íŒŒì´ì–´ë² ì´ìŠ¤ ì—°ê²° ì„±ê³µ!");

  // ============================================================
  // STORAGE LAYER (Firebase Firestore ë™ê¸°í™” ë˜í¼)
  // ============================================================
  window.APP_DATA = {}; // ë©”ëª¨ë¦¬ ìºì‹œ (í™”ë©´ ë Œë”ë§ ì†ë„ ìœ ì§€ìš©)

  const DB = {
    get(key, fallback) {
      if (key === 'currentUser' || key === 'seeded') {
        try { const v = localStorage.getItem('jmc_' + key); return v ? JSON.parse(v) : fallback; }
        catch { return fallback; }
      }
      return window.APP_DATA[key] !== undefined ? window.APP_DATA[key] : fallback;
    },
    set(key, val) {
      if (key === 'currentUser' || key === 'seeded') {
        localStorage.setItem('jmc_' + key, JSON.stringify(val));
        return;
      }
      window.APP_DATA[key] = val; // í™”ë©´ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ìš©
      // íŒŒì´ì–´ë² ì´ìŠ¤ì— ë°±ê·¸ë¼ìš´ë“œë¡œ ì €ì¥
      setDoc(doc(db, "appData", key), { data: JSON.stringify(val) })
        .catch(e => console.error("Firebase Save Error:", e));
    },
    remove(key) {
      if (key === 'currentUser' || key === 'seeded') {
        localStorage.removeItem('jmc_' + key);
        return;
      }
      delete window.APP_DATA[key];
      setDoc(doc(db, "appData", key), { data: null })
        .catch(e => console.error("Firebase Remove Error:", e));
    }
  };

  // ë…¸ì¶œìš© ë³€ìˆ˜ ì…‹íŒ… (ê°œë°œì ì½˜ì†” ë“±ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥)
  window.DB = DB;

  // ============================================================
  // INITIAL SEED DATA (ìµœì´ˆ 1íšŒ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”)
  // ============================================================
  function seedIfNeeded() {
    if (window.APP_DATA['users'] && window.APP_DATA['users'].length > 0) return;

    DB.set('users', [{ uid:'admin1', id:'admin', pw:'1234', name:'ì•½ì†ì˜ ë•… ê´€ë¦¬ì', phone:'010-1234-5678', birth:'19950315', cellId:'c2', role:'admin', status:'active', createdAt:'2026-01-01', profileImg:'' }]);
    DB.set('rosters', [
      { id:'r1', name:'ê¹€ì°½ëŒ€', phone:'010-1234-5678', birth:'19950315', cellId:'c2', linkedUid:'admin1' },
      { id:'r2', name:'ì´ì„œì—°', phone:'010-2345-6789', birth:'19970827', cellId:'c1', linkedUid:null },
      { id:'r3', name:'ë°•ë¯¼ì¤€', phone:'010-3456-7890', birth:'19961127', cellId:'c1', linkedUid:null }
    ]);
    DB.set('cells', [
      { id:'c1', name:'ë¦¬ë‚˜ëª©ì¥', leader:'ê¹€ë¦¬ë‚˜', order:1 },
      { id:'c2', name:'ì°½ëŒ€ëª©ì¥', leader:'ê¹€ì°½ëŒ€', order:2 },
      { id:'c3', name:'ì€í˜œëª©ì¥', leader:'ë°•ì€í˜œ', order:3 },
    ]);
    DB.set('notices', [{ id:'n1', title:'í™˜ì˜í•©ë‹ˆë‹¤!', body:'ì•± íŒŒì´ì–´ë² ì´ìŠ¤ ì—°ë™ í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.', by:'admin1', at:'2026-02-23', pinned:true }]);
    DB.set('comments', { n1: [] });
    DB.set('events', [{ id:'e1', title:'ì£¼ì¼ ì˜ˆë°°', date:'2026-03-01', time:'14:00', loc:'ë³¸ë‹¹', cat:'ì˜ˆë°°' }]);
    DB.set('bulletins', []);
    DB.set('worshipSets', []);
    DB.set('notifications', []);
    DB.set('attendance', {});
    DB.set('offerings', {});
    DB.set('cellMeetings', []);
  }

  // ============================================================
  // STATE & UTILS
  // ============================================================
  let state = {
    user: null, page: 'login', tab: 'home', detail: null, adminSub: 'dashboard', profileOpen: false, profilePage: null, toast: null, adminRosterTab: 'all', adminAttTab: null, _pendingProfileImg: null,
  };

  const uid = () => Math.random().toString(36).substr(2, 9);
  const today = () => new Date().toISOString().split('T')[0];
  const fmtPhone = v => { const d=v.replace(/\D/g,''); if(d.length<=3) return d; if(d.length<=7) return d.slice(0,3)+'-'+d.slice(3); return d.slice(0,3)+'-'+d.slice(3,7)+'-'+d.slice(7,11); };

  // ============================================================
  // RENDER ENGINE (UIëŠ” ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€)
  // ============================================================
  function render() {
    const appDiv = document.getElementById('app');
    let html = '';
    if (!state.user) {
      if (state.page === 'register') html = renderRegister();
      else html = renderLogin();
    } else if (state.page === 'admin') {
      html = renderAdmin();
    } else if (state.profilePage) {
      html = renderProfilePage();
    } else if (state.detail) {
      if (state.detail.type === 'bulletin') html = renderBulletinDetail();
      else if (state.detail.type === 'notice') html = renderNoticeDetail();
      else if (state.detail.type === 'worship') html = renderWorshipDetail();
      else html = renderMain();
    } else {
      html = renderMain();
    }

    if (state.toast) {
      html += `<div class="fixed top-20 left-1/2 -translate-x-1/2 z-[200] bg-black text-white px-5 py-3 rounded-2xl text-sm font-bold shadow-xl fade-in">${state.toast}</div>`;
    }

    appDiv.innerHTML = html;
    bindEvents();
  }

  function showToast(msg) {
    state.toast = msg; render();
    setTimeout(() => { state.toast = null; render(); }, 2000);
  }

  function icon(name, cls='', size=24, fill=false) {
    return `<span class="material-symbols-outlined ${fill?'filled':''} ${cls}" style="font-size:${size}px">${name}</span>`;
  }

  // (ì•„ë˜ë¶€í„°ëŠ” ê¸°ì¡´ì˜ ë Œë”ë§ í•¨ìˆ˜ë“¤ì„ ê·¸ëŒ€ë¡œ ì´ì‹í–ˆìŠµë‹ˆë‹¤)
  function renderLogin() {
    return `
    <div class="min-h-screen bg-white flex flex-col items-center justify-center px-8">
      <div class="w-full max-w-sm">
        <div class="text-center mb-10">
          <div class="w-20 h-20 bg-black rounded-3xl flex items-center justify-center mx-auto mb-5">
            <span class="text-white font-black text-2xl">PL</span>
          </div>
          <h1 class="text-2xl font-bold tracking-tight">ì•½ì†ì˜ ë•…</h1>
          <p class="text-zinc-400 text-sm mt-1">ì²­ë…„ë¶€ ì»¤ë®¤ë‹ˆí‹°</p>
        </div>
        <div class="space-y-4">
          <input id="login-id" type="text" placeholder="ì•„ì´ë””" class="w-full px-4 py-3.5 bg-zinc-50 border border-zinc-200 rounded-2xl text-sm focus:outline-none focus:border-black focus:ring-1 focus:ring-black"/>
          <input id="login-pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full px-4 py-3.5 bg-zinc-50 border border-zinc-200 rounded-2xl text-sm focus:outline-none focus:border-black focus:ring-1 focus:ring-black"/>
          <div id="login-error" class="text-red-500 text-xs font-medium px-1 hidden"></div>
          <button id="btn-login" class="w-full py-3.5 bg-black text-white rounded-2xl font-bold text-sm active:scale-[0.98] transition-transform">ë¡œê·¸ì¸</button>
        </div>
        <div class="text-center mt-6">
          <button id="btn-go-register" class="text-sm text-zinc-500 font-medium">
            ì•„ì§ ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <span class="text-black font-bold underline underline-offset-2">íšŒì›ê°€ì…</span>
          </button>
        </div>
        <div class="text-center mt-8 text-xs text-zinc-300">í…ŒìŠ¤íŠ¸: admin / 1234</div>
      </div>
    </div>`;
  }

  function renderRegister() {
    return `
    <div class="min-h-screen bg-white px-6 py-8">
      <button id="btn-back-login" class="flex items-center gap-1 text-sm text-zinc-500 mb-6">${icon('arrow_back','',20)} ë’¤ë¡œ</button>
      <h1 class="text-2xl font-bold mb-1">íšŒì›ê°€ì…</h1>
      <p class="text-zinc-400 text-sm mb-8">ì•½ì†ì˜ ë•… ì²­ë…„ë¶€ ì»¤ë®¤ë‹ˆí‹°ì— ê°€ì…í•©ë‹ˆë‹¤.</p>
      <div class="space-y-4">
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì´ë¦„</label><input id="reg-name" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="í™ê¸¸ë™"/></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì „í™”ë²ˆí˜¸</label><input id="reg-phone" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="01012345678"/></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ìƒë…„ì›”ì¼</label><input id="reg-birth" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="19950315"/></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì•„ì´ë””</label><input id="reg-id" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="ì‚¬ìš©í•  ì•„ì´ë””"/></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ë¹„ë°€ë²ˆí˜¸</label><input id="reg-pw" type="password" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="4ì ì´ìƒ"/></div>
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input id="reg-pw2" type="password" class="w-full px-4 py-3 bg-zinc-50 border border-zinc-200 rounded-xl text-sm focus:outline-none focus:border-black" placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥"/></div>
        <label class="flex items-start gap-3 pt-2">
          <input id="reg-agree" type="checkbox" class="mt-0.5 w-5 h-5 rounded border-zinc-300 accent-black"/>
          <span class="text-xs text-zinc-500 leading-relaxed">ê°œì¸ì •ë³´(ì´ë¦„, ì „í™”ë²ˆí˜¸, ìƒë…„ì›”ì¼) ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.</span>
        </label>
        <div id="reg-error" class="text-red-500 text-xs font-medium hidden"></div>
        <button id="btn-register" class="w-full py-3.5 bg-black text-white rounded-2xl font-bold text-sm active:scale-[0.98] transition-transform">ê°€ì… ì‹ ì²­</button>
      </div>
    </div>`;
  }

  function renderMain() {
    const u = state.user;
    const notis = DB.get('notifications', []);
    let content = '';
    if (state.tab === 'home') content = renderHomeTab();
    else if (state.tab === 'bulletin') content = renderBulletinTab();
    else if (state.tab === 'notice') content = renderNoticeTab();
    else if (state.tab === 'calendar') content = renderCalendarTab();
    else if (state.tab === 'cell') content = renderCellTab();

    const tabs = [
      { key:'home', icon:'home', label:'í™ˆ' },
      { key:'bulletin', icon:'menu_book', label:'ì£¼ë³´' },
      { key:'notice', icon:'campaign', label:'ê³µì§€' },
      { key:'calendar', icon:'calendar_month', label:'ì¼ì •' },
      { key:'cell', icon:'groups', label:'ëª©ì¥' },
    ];

    return `
    <div class="min-h-screen bg-white pb-28">
      <header class="sticky top-0 z-50 px-5 pt-4 pb-3 bg-white/90 backdrop-blur-xl border-b border-zinc-100">
        <div class="flex justify-between items-center">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-black rounded-xl flex items-center justify-center"><span class="text-white font-black text-sm">PL</span></div>
            <div>
              <p class="text-[10px] font-bold text-zinc-400 uppercase tracking-[0.15em]">ì•½ì†ì˜ ë•…</p>
              <h1 class="text-lg font-bold tracking-tight">${u.name} ğŸ‘‹</h1>
            </div>
          </div>
          <div class="flex gap-2">
            <button data-action="go-worship" class="w-10 h-10 flex items-center justify-center rounded-full border border-zinc-200 active:bg-zinc-100">${icon('music_note','',22)}</button>
            <button data-action="open-profile" class="relative w-10 h-10 rounded-full bg-zinc-200 flex items-center justify-center border-2 border-black overflow-hidden">
              ${u.profileImg ? `<img src="${u.profileImg}" class="w-full h-full object-cover"/>` : `<span class="text-sm font-bold text-zinc-500">${(u.name||'?')[0]}</span>`}
              ${notis.length > 0 ? '<span class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border border-white"></span>' : ''}
            </button>
          </div>
        </div>
      </header>
      <main class="px-5 mt-6 space-y-8">${content}</main>
      <nav class="fixed bottom-0 left-0 right-0 z-50 px-2 pb-6 pt-2 bg-white/90 backdrop-blur-xl border-t border-zinc-100">
        <div class="flex justify-around items-center max-w-md mx-auto">
          ${tabs.map(t => `<button data-tab="${t.key}" class="flex flex-col items-center gap-0.5 px-4 py-1 transition-colors ${state.tab===t.key?'text-black':'text-zinc-400'}">${icon(t.icon,'',26,state.tab===t.key)}<span class="text-[10px] font-bold tracking-wider">${t.label}</span></button>`).join('')}
        </div>
      </nav>
      ${state.profileOpen ? renderProfileSheet() : ''}
    </div>`;
  }

  function renderProfileSheet() {
    const u = state.user; const isAdmin = u.role === 'admin';
    const cell = DB.get('cells', []).find(c => c.id === u.cellId);
    return `
    <div data-action="close-profile" class="fixed inset-0 z-[100] bg-black/40 backdrop-blur-sm fade-in"></div>
    <div class="fixed bottom-0 left-0 right-0 z-[101] bg-white rounded-t-3xl shadow-2xl slide-up">
      <div class="flex justify-center pt-3 pb-1"><div class="w-10 h-1 bg-zinc-200 rounded-full"></div></div>
      <div class="flex items-center gap-4 px-6 py-4 border-b border-zinc-100">
        ${u.profileImg ? `<div class="w-14 h-14 rounded-full bg-zinc-200 flex items-center justify-center border-2 border-black overflow-hidden"><img src="${u.profileImg}" class="w-full h-full object-cover"/></div>` : `<div class="w-14 h-14 rounded-full bg-zinc-200 flex items-center justify-center border-2 border-black"><span class="text-xl font-bold text-zinc-500">${(u.name||'?')[0]}</span></div>`}
        <div><p class="font-bold text-base">${u.name}</p><p class="text-sm text-zinc-400">${cell ? cell.name : 'ëª©ì¥ ë¯¸ë°°ì •'} Â· ${isAdmin?'ê´€ë¦¬ì':'ì²­ë…„ë¶€ì›'}</p></div>
      </div>
      <div class="px-4 py-3 space-y-1">
        ${isAdmin ? `<button data-action="go-admin" class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl active:bg-zinc-50 transition-colors text-left"><div class="w-10 h-10 bg-zinc-100 rounded-xl flex items-center justify-center">${icon('admin_panel_settings','text-black')}</div><div class="flex-1"><p class="font-bold text-sm">ê´€ë¦¬ì í˜ì´ì§€</p></div>${icon('chevron_right','text-zinc-300',20)}</button>` : ''}
        <button data-profile-page="edit" class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl active:bg-zinc-50 transition-colors text-left"><div class="w-10 h-10 bg-zinc-100 rounded-xl flex items-center justify-center">${icon('person','text-black')}</div><div class="flex-1"><p class="font-bold text-sm">í”„ë¡œí•„ ìˆ˜ì •</p></div>${icon('chevron_right','text-zinc-300',20)}</button>
        <button data-profile-page="settings" class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl active:bg-zinc-50 transition-colors text-left"><div class="w-10 h-10 bg-zinc-100 rounded-xl flex items-center justify-center">${icon('settings','text-black')}</div><div class="flex-1"><p class="font-bold text-sm">ì„¤ì •</p></div>${icon('chevron_right','text-zinc-300',20)}</button>
        <button data-action="logout" class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl active:bg-red-50 transition-colors text-left"><div class="w-10 h-10 bg-red-50 rounded-xl flex items-center justify-center">${icon('logout','text-red-500')}</div><p class="font-bold text-sm text-red-500">ë¡œê·¸ì•„ì›ƒ</p></button>
      </div><div class="h-8"></div>
    </div>`;
  }

  function renderHomeTab() {
    const bulletins = DB.get('bulletins', []); const worships = DB.get('worshipSets', []); const notices = DB.get('notices', []); const events = DB.get('events', []).sort((a,b) => a.date.localeCompare(b.date));
    const latest = worships[worships.length - 1]; const lb = bulletins[bulletins.length - 1];
    return `
    <section><div class="bg-black rounded-3xl p-6 text-white relative overflow-hidden"><div class="relative z-10"><span class="px-2.5 py-1 bg-white/10 border border-white/20 rounded-lg text-[10px] font-bold uppercase tracking-wider">ì˜¤ëŠ˜ì˜ ë§ì”€</span><blockquote class="text-xl font-bold leading-snug mt-4 mb-3">"ë‚´ê²Œ ëŠ¥ë ¥ ì£¼ì‹œëŠ” ì ì•ˆì—ì„œ<br/>ë‚´ê°€ ëª¨ë“  ê²ƒì„ í•  ìˆ˜ ìˆëŠë‹ˆë¼"</blockquote><p class="text-zinc-400 text-sm">ë¹Œë¦½ë³´ì„œ 4:13</p></div></div></section>
    ${lb ? `<section><h2 class="text-lg font-bold tracking-tight mb-3">ê¸ˆì£¼ ì˜ˆë°° ë‹´ë‹¹</h2><div class="bg-white rounded-2xl border border-zinc-100 overflow-hidden"><div class="bg-black px-5 py-3 flex items-center gap-2"><span class="text-white text-xs font-bold">${lb.date} ì˜ˆë°°</span></div><div class="divide-y divide-zinc-50">${[{l:'ëŒ€í‘œê¸°ë„',v:lb.prayer_duty,i:'volunteer_activism'},{l:'ì„±ê²½ë´‰ë…',v:lb.bible_reading,i:'menu_book'},{l:'ê´‘ê³ ',v:lb.announcement_duty,i:'campaign'},{l:'ë´‰í—Œ',v:lb.offering_duty,i:'favorite'}].map(d=>`<div class="flex items-center gap-3 px-5 py-3.5"><div class="w-8 h-8 bg-zinc-100 rounded-lg flex items-center justify-center flex-none">${icon(d.i,'text-zinc-600',16)}</div><span class="text-xs text-zinc-400 w-20 flex-none">${d.l}</span><span class="text-sm font-bold">${d.v||'ë¯¸ì •'}</span></div>`).join('')}</div></div></section>` : ''}
    ${latest ? `<section><div class="flex justify-between items-center mb-3"><h3 class="text-sm font-bold flex items-center gap-1.5">${icon('music_note','',18)} ì´ë²ˆì£¼ ì°¬ì–‘</h3><button data-action="go-worship" class="text-zinc-400 text-xs font-bold">ì „ì²´ë³´ê¸°</button></div><div class="flex gap-3 overflow-x-auto pb-1 -mx-5 px-5 hide-scrollbar">${latest.songs.map((s,i)=>`<button data-action="go-worship" class="flex-none w-36 bg-white rounded-2xl border border-zinc-200 overflow-hidden active:bg-zinc-50 transition-colors text-left"><div class="w-full h-24 bg-zinc-100 flex items-center justify-center">${icon('graphic_eq','text-zinc-200',48)}</div><div class="p-3"><p class="text-xs font-bold leading-tight truncate">${s.title}</p><p class="text-[10px] text-zinc-400 mt-0.5">Key: ${s.key}</p></div></button>`).join('')}</div></section>` : ''}
    <section><div class="flex justify-between items-center mb-3"><h3 class="text-sm font-bold flex items-center gap-1.5">${icon('campaign','',18)} ê³µì§€ì‚¬í•­</h3><button data-tab="notice" class="text-zinc-400 text-xs font-bold">ì „ì²´ë³´ê¸°</button></div><div class="space-y-2">${notices.slice(0,3).map(n=>`<button data-detail="notice:${n.id}" class="w-full flex items-start gap-3 bg-white p-4 rounded-2xl border border-zinc-100 active:bg-zinc-50 text-left"><div class="w-8 h-8 ${n.pinned?'bg-black':'bg-zinc-100'} rounded-lg flex items-center justify-center flex-none mt-0.5">${icon(n.pinned?'priority_high':'info','',16,false)}</div><div class="flex-1 min-w-0"><p class="text-sm font-bold leading-tight">${n.title}</p></div></button>`).join('')}</div></section>
    `;
  }

  function renderBulletinTab() {
    return `<section><h2 class="text-xl font-bold tracking-tight mb-5">ì£¼ë³´</h2><div class="space-y-4">${[...DB.get('bulletins', [])].reverse().map(b=>`<button data-detail="bulletin:${b.id}" class="w-full text-left bg-white rounded-3xl border border-zinc-200 overflow-hidden active:bg-zinc-50 transition-colors"><div class="bg-gradient-to-br from-zinc-900 to-black p-6 text-white relative overflow-hidden dot-pattern"><h3 class="text-lg font-bold">${b.title}</h3><p class="text-white/50 text-xs mt-1">${b.date}</p></div><div class="p-4"><p class="text-xs text-zinc-400 line-clamp-2">${b.order?.split('\n').slice(0,2).join(' / ')}</p></div></button>`).join('')}</div></section>`;
  }

  function renderBulletinDetail() {
    const b = DB.get('bulletins', []).find(x => x.id === state.detail.id); if (!b) return '';
    const s = [{i:'format_list_numbered',t:'ì˜ˆë°°ìˆœì„œ',c:b.order},{i:'volunteer_activism',t:'ëŒ€í‘œê¸°ë„',c:b.prayer_duty},{i:'menu_book',t:'ì„±ê²½ë´‰ë…',c:b.bible_reading},{i:'campaign',t:'ê´‘ê³ ',c:b.announcement_duty},{i:'favorite',t:'ë´‰í—Œ',c:b.offering_duty},{i:'music_note',t:'ì°¬ì–‘',c:b.songs},{i:'campaign',t:'ì•Œë¦¼',c:b.announce}];
    return `<div class="min-h-screen bg-zinc-50"><header class="sticky top-0 z-50 px-4 py-3 bg-white/90 border-b flex items-center gap-3"><button data-action="back" class="w-10 h-10 flex items-center justify-center rounded-full">${icon('arrow_back','',22)}</button><h1 class="font-bold text-sm flex-1">ì£¼ë³´</h1></header><div class="p-5"><div class="bg-white rounded-3xl overflow-hidden shadow-lg border"><div class="bg-black text-white p-8 text-center"><h2 class="text-2xl font-bold">${b.date}</h2></div><div class="divide-y divide-zinc-100">${s.filter(x=>x.c).map(x=>`<div class="p-6"><h3 class="text-xs font-bold uppercase text-zinc-400 mb-2">${x.t}</h3><div class="text-sm text-zinc-700 whitespace-pre-line">${x.c}</div></div>`).join('')}</div></div></div></div>`;
  }

  function renderNoticeTab() {
    return `<section><h2 class="text-xl font-bold tracking-tight mb-5">ê³µì§€ì‚¬í•­</h2><div class="space-y-3">${DB.get('notices', []).map(n=>`<button data-detail="notice:${n.id}" class="w-full flex items-start gap-3 bg-white p-4 rounded-2xl border border-zinc-100 text-left"><div class="flex-1 min-w-0"><p class="text-sm font-bold leading-tight">${n.title}</p><p class="text-xs text-zinc-400 mt-1 line-clamp-2">${n.body}</p></div></button>`).join('')}</div></section>`;
  }

  function renderNoticeDetail() {
    const n = DB.get('notices', []).find(x => x.id === state.detail.id); if (!n) return '';
    return `<div class="min-h-screen bg-white pb-24"><header class="sticky top-0 z-50 px-4 py-3 bg-white/90 border-b flex items-center gap-3"><button data-action="back" class="w-10 h-10 flex items-center justify-center rounded-full">${icon('arrow_back','',22)}</button><h1 class="font-bold text-sm flex-1">ê³µì§€ì‚¬í•­</h1></header><div class="px-5 py-6"><h2 class="text-xl font-bold mb-2">${n.title}</h2><p class="text-xs text-zinc-400 mb-6">${n.at}</p><div class="text-sm leading-relaxed text-zinc-700 whitespace-pre-line">${n.body}</div></div></div>`;
  }

  function renderCalendarTab() { return `<section><h2 class="text-xl font-bold tracking-tight mb-5">ì¼ì •</h2><div class="text-center py-10 text-sm text-zinc-400">ì¼ì • ê¸°ëŠ¥ ì¤€ë¹„ì¤‘...</div></section>`; }

  function renderCellTab() { return `<section><h2 class="text-xl font-bold tracking-tight mb-5">ëª©ì¥ ëª¨ì„</h2><div class="text-center py-10 text-sm text-zinc-400">ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</div></section>`; }

  function renderWorshipDetail() {
    const w = DB.get('worshipSets', [])[DB.get('worshipSets', []).length - 1]; if (!w) return '';
    return `<div class="min-h-screen bg-white"><header class="sticky top-0 z-50 px-4 py-3 bg-white/90 border-b flex items-center gap-3"><button data-action="back" class="w-10 h-10 flex items-center justify-center">${icon('arrow_back','',22)}</button><h1 class="font-bold text-sm flex-1">ì´ë²ˆì£¼ ì°¬ì–‘</h1></header><div class="p-5"><div class="bg-zinc-50 rounded-2xl p-5 mb-6"><p class="text-sm font-bold">${w.date}</p></div><div class="space-y-3">${w.songs.map((s,i)=>`<div class="bg-white rounded-2xl border border-zinc-200 overflow-hidden"><div class="flex items-center gap-4 p-4"><div class="w-10 h-10 bg-black rounded-xl flex items-center justify-center flex-none"><span class="text-white font-bold text-sm">${i+1}</span></div><div class="flex-1 min-w-0"><h4 class="font-bold text-sm">${s.title}</h4><p class="text-xs text-zinc-400">Key: ${s.key}</p></div><div class="flex gap-2">${s.url?`<a href="${s.url}" target="_blank" class="w-9 h-9 bg-red-50 rounded-xl flex items-center justify-center">${icon('play_arrow','text-red-500',20)}</a>`:''}${s.sheet?`<a href="${s.sheet}" target="_blank" class="w-9 h-9 bg-zinc-100 rounded-xl flex items-center justify-center">${icon('download','text-zinc-600',18)}</a>`:''}</div></div>${s.sheet?`<div class="border-t border-zinc-100"><img src="${s.sheet}" class="w-full" alt="ì•…ë³´"/></div>`:''}</div>`).join('')}</div></div></div>`;
  }

  function renderProfilePage() {
    const u = state.user; const pg = state.profilePage;
    const header = (title) => `<div class="sticky top-0 bg-white border-b border-zinc-100 px-5 py-4 flex items-center gap-3 z-10"><button data-action="close-profile-page" class="w-9 h-9 flex items-center justify-center rounded-full">${icon('arrow_back','',22)}</button><h1 class="font-bold text-base">${title}</h1></div>`;
    if (pg === 'edit') {
      return `<div class="min-h-screen bg-zinc-50">${header('í”„ë¡œí•„ ìˆ˜ì •')}
        <div class="px-5 py-6 space-y-5">
          <div class="flex flex-col items-center gap-3">
            <div class="relative"><div class="w-20 h-20 rounded-full bg-zinc-200 border-2 border-black flex items-center justify-center overflow-hidden" id="profile-img-preview">${u.profileImg?`<img src="${u.profileImg}" class="w-full h-full object-cover"/>`:`<span class="text-2xl font-bold text-zinc-500">${(u.name||'?')[0]}</span>`}</div>
            <label class="absolute -bottom-1 -right-1 w-7 h-7 bg-black rounded-full flex items-center justify-center cursor-pointer">${icon('photo_camera','text-white',14)}<input id="profile-img-input" type="file" accept="image/*" class="hidden"/></label></div>
          </div>
          <div><label class="block text-xs font-bold text-zinc-600 mb-1.5">ì´ë¦„</label><input id="edit-name" value="${u.name}" class="w-full px-4 py-3 bg-white border border-zinc-200 rounded-xl text-sm"/></div>
          <button id="save-profile-edit" class="w-full py-3.5 bg-black text-white rounded-xl text-sm font-bold">ì €ì¥</button>
        </div></div>`;
    }
    if (pg === 'settings') {
      return `<div class="min-h-screen bg-zinc-50">${header('ì„¤ì •')}<div class="px-5 py-6 space-y-4"><button id="withdraw-btn" class="w-full py-3.5 bg-red-50 text-red-500 rounded-xl text-sm font-bold border border-red-100">ê³„ì • ë¡œê·¸ì•„ì›ƒ ë° íƒˆí‡´</button></div></div>`;
    }
    return '';
  }

  function renderAdmin() {
    if (state.adminSub === 'dashboard') {
      const menu = [{k:'approve',l:'ê°€ì… ìŠ¹ì¸'},{k:'worship',l:'ì°¬ì–‘ ê´€ë¦¬'},{k:'notice',l:'ê³µì§€ ê´€ë¦¬'}];
      return `<div class="min-h-screen bg-zinc-50"><header class="sticky top-0 z-50 px-4 py-3 bg-white/90 border-b flex items-center gap-3"><button data-action="back-main" class="w-10 h-10 flex items-center justify-center rounded-full">${icon('arrow_back','',22)}</button><h1 class="font-bold text-sm flex-1">ê´€ë¦¬ì</h1></header><div class="p-5"><div class="space-y-3">${menu.map(m=>`<button data-admin="${m.k}" class="w-full flex items-center gap-4 bg-white p-4 rounded-2xl border border-zinc-100 text-left"><span class="flex-1 font-bold text-sm">${m.l}</span>${icon('chevron_right','text-zinc-300',20)}</button>`).join('')}</div></div></div>`;
    }
    let content = `<button data-admin="dashboard" class="flex items-center gap-1 text-xs text-zinc-400 font-bold mb-4">${icon('arrow_back','',16)} ë©”ë‰´ë¡œ</button>`;
    if (state.adminSub === 'worship') {
      content += `<h2 class="text-lg font-bold mb-4">ì°¬ì–‘ ê´€ë¦¬ (ìƒˆë¡œ ì¶”ê°€)</h2>
      <div id="admin-form-area"><div class="space-y-4 bg-white p-5 rounded-2xl border border-zinc-100 mb-4">
        <div><label class="block text-xs font-bold text-zinc-600 mb-1.5 ml-1">ì£¼ì°¨ ë‚ ì§œ</label><input id="wf-date" value="${today()}" class="w-full px-4 py-3 bg-zinc-50 border rounded-xl text-sm"/></div>
        <div><label class="block text-[10px] font-bold text-zinc-500 mb-1">ê³¡ ì œëª©</label><input id="ws-title-0" placeholder="ê³¡ ì œëª©" class="w-full px-3 py-2 bg-white border border-zinc-200 rounded-xl text-sm"/></div>
        <div><label class="block text-[10px] font-bold text-zinc-500 mb-1">ì•…ë³´ ì´ë¯¸ì§€ ì—…ë¡œë“œ (í•„ìˆ˜X)</label><input id="ws-sheet-0" type="file" accept="image/*" class="w-full px-3 py-2 bg-white border border-zinc-200 rounded-xl text-sm cursor-pointer"/></div>
        <button id="save-worship" class="w-full py-3 bg-black text-white rounded-xl text-sm font-bold">ì„œë²„ì— ì €ì¥í•˜ê¸°</button>
      </div></div>`;
    }
    return `<div class="min-h-screen bg-zinc-50"><header class="sticky top-0 z-50 px-4 py-3 bg-white/90 border-b flex items-center gap-3"><button data-action="back-main" class="w-10 h-10 flex items-center justify-center rounded-full">${icon('arrow_back','',22)}</button><h1 class="font-bold text-sm flex-1">ê´€ë¦¬ì ì„¸ë¶€</h1></header><div class="p-5">${content}</div></div>`;
  }

  // ============================================================
  // EVENT BINDING & FIREBASE STORAGE INTEGRATION
  // ============================================================
  function bindEvents() {
    // Login & Navigation events
    document.getElementById('btn-login')?.addEventListener('click', () => {
      const id = document.getElementById('login-id').value; const pw = document.getElementById('login-pw').value;
      const u = DB.get('users', []).find(x => x.id === id && x.pw === pw);
      if (!u) { document.getElementById('login-error').classList.remove('hidden'); return; }
      state.user = u; state.page = 'main'; DB.set('currentUser', u); render();
    });
    document.querySelectorAll('[data-tab]').forEach(el => el.addEventListener('click', () => { state.tab = el.dataset.tab; state.detail = null; render(); }));
    document.querySelectorAll('[data-detail]').forEach(el => el.addEventListener('click', () => { const [t, i] = el.dataset.detail.split(':'); state.detail = { type:t, id:i }; render(); }));
    document.querySelector('[data-action="open-profile"]')?.addEventListener('click', () => { state.profileOpen = true; render(); });
    document.querySelector('[data-action="close-profile"]')?.addEventListener('click', () => { state.profileOpen = false; render(); });
    document.querySelectorAll('[data-profile-page]').forEach(el => el.addEventListener('click', () => { state.profilePage = el.dataset.profilePage; state.profileOpen = false; render(); }));
    document.querySelector('[data-action="close-profile-page"]')?.addEventListener('click', () => { state.profilePage = null; render(); });
    document.querySelector('[data-action="logout"]')?.addEventListener('click', () => { state.user = null; state.page = 'login'; state.profileOpen = false; DB.remove('currentUser'); render(); });
    document.querySelector('[data-action="go-worship"]')?.addEventListener('click', () => { state.detail = { type:'worship', id:'latest' }; render(); });
    document.querySelector('[data-action="back"]')?.addEventListener('click', () => { state.detail = null; render(); });
    document.querySelector('[data-action="go-admin"]')?.addEventListener('click', () => { state.page = 'admin'; state.adminSub = 'dashboard'; state.profileOpen = false; render(); });
    document.querySelector('[data-action="back-main"]')?.addEventListener('click', () => { state.page = 'main'; render(); });
    document.querySelectorAll('[data-admin]').forEach(el => el.addEventListener('click', () => { state.adminSub = el.dataset.admin; render(); }));

    // Profile Edit & Image Upload (Storage)
    document.getElementById('profile-img-input')?.addEventListener('change', function() {
      const file = this.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        state._pendingProfileImg = e.target.result; // Base64 ë¯¸ë¦¬ë³´ê¸° ìœ ì§€
        document.getElementById('profile-img-preview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover"/>`;
      };
      reader.readAsDataURL(file);
    });

    document.getElementById('save-profile-edit')?.addEventListener('click', async () => {
      let newImg = state.user.profileImg || '';
      
      // ğŸ”¥ ì´ë¯¸ì§€ê°€ ë³€ê²½ë˜ì—ˆë‹¤ë©´ Firebase Storageì— ì§„ì§œë¡œ ì—…ë¡œë“œ
      if (state._pendingProfileImg && state._pendingProfileImg.startsWith('data:image')) {
        showToast('ì‚¬ì§„ì„ í´ë¼ìš°ë“œì— ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...');
        document.getElementById('save-profile-edit').disabled = true;
        
        try {
          const imgRef = ref(storage, `profiles/${state.user.uid}.jpg`);
          await uploadString(imgRef, state._pendingProfileImg, 'data_url');
          newImg = await getDownloadURL(imgRef); // ì—…ë¡œë“œ í›„ ì§„ì§œ ì¸í„°ë„· ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸°!
        } catch (error) {
          console.error(error); showToast('ì—…ë¡œë“œ ì‹¤íŒ¨'); return;
        }
      }

      const users = DB.get('users', []);
      const idx = users.findIndex(u => u.uid === state.user.uid);
      const name = document.getElementById('edit-name').value;
      
      if (idx >= 0) { users[idx] = { ...users[idx], name, profileImg: newImg }; DB.set('users', users); }
      state.user = { ...state.user, name, profileImg: newImg };
      state._pendingProfileImg = null;
      DB.set('currentUser', state.user);
      state.profilePage = null;
      showToast('í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!'); render();
    });

    // Worship Sheet Image Upload (Storage)
    document.getElementById('save-worship')?.addEventListener('click', async () => {
      const date = document.getElementById('wf-date').value;
      const title = document.getElementById('ws-title-0').value;
      const fileEl = document.getElementById('ws-sheet-0');
      const file = fileEl?.files[0];

      if (!title) return showToast('ê³¡ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');

      showToast('ì•…ë³´ ë° ë°ì´í„°ë¥¼ ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...');
      const btn = document.getElementById('save-worship');
      btn.disabled = true; btn.textContent = 'ì—…ë¡œë“œ ì¤‘...';

      let sheetUrl = '';
      
      // ğŸ”¥ ì•…ë³´ íŒŒì¼ì´ ì²¨ë¶€ë˜ì—ˆë‹¤ë©´ Firebase Storageì— ì§„ì§œë¡œ ì—…ë¡œë“œ
      if (file) { 
        try {
          const sheetRef = ref(storage, `sheets/${Date.now()}_${file.name}`);
          await uploadBytes(sheetRef, file); // ì›ë³¸ íŒŒì¼ ê·¸ëŒ€ë¡œ ì—…ë¡œë“œ!
          sheetUrl = await getDownloadURL(sheetRef); // ì—…ë¡œë“œëœ ë§í¬ í™•ë³´!
        } catch (error) {
          console.error(error); showToast('ì•…ë³´ ì—…ë¡œë“œ ì‹¤íŒ¨');
          btn.disabled = false; btn.textContent = 'ì„œë²„ì— ì €ì¥í•˜ê¸°'; return;
        }
      }

      const ws = DB.get('worshipSets', []); 
      ws.push({
        id: uid(), date, leader: state.user.name, members: {},
        songs: [{ title, url: '', key: 'C', sheet: sheetUrl }], 
        by: state.user.uid, at: today()
      });
      DB.set('worshipSets', ws);
      
      showToast('ì°¬ì–‘ ì„¸íŠ¸ ì €ì¥ ì™„ë£Œ!'); render();
    });
  }

  // ============================================================
  // BOOTSTRAP (íŒŒì´ì–´ë² ì´ìŠ¤ ë°ì´í„° ë¡œë“œ í›„ ì•± ì‹œì‘)
  // ============================================================
  async function bootApp() {
    // 1. ë¡œë”© í™”ë©´ ë„ìš°ê¸°
    const appDiv = document.getElementById('app');
    appDiv.innerHTML = `<div class="min-h-screen flex items-center justify-center bg-white"><div class="text-center"><div class="w-10 h-10 border-4 border-zinc-200 border-t-black rounded-full animate-spin mx-auto mb-4"></div><p class="text-sm font-bold text-zinc-400">ì„œë²„ ë°ì´í„° ë™ê¸°í™” ì¤‘...</p></div></div>`;

    // 2. íŒŒì´ì–´ë² ì´ìŠ¤ Firestoreì—ì„œ ê¸°ì¡´ ë°ì´í„° ëª¨ì¡°ë¦¬ ê°€ì ¸ì˜¤ê¸°
    const keys = ['users', 'rosters', 'cells', 'notices', 'comments', 'events', 'bulletins', 'worshipSets', 'notifications', 'attendance', 'offerings', 'cellMeetings'];
    await Promise.all(keys.map(async (k) => {
      try {
        const snap = await getDoc(doc(db, "appData", k));
        if (snap.exists() && snap.data().data) window.APP_DATA[k] = JSON.parse(snap.data().data);
      } catch(e) { console.log(k + " ë¶ˆëŸ¬ì˜¤ê¸° íŒ¨ìŠ¤ (ì²« ì‹œì‘ì¼ ìˆ˜ ìˆìŒ)"); }
    }));

    // 3. ë§Œì•½ íŒŒì´ì–´ë² ì´ìŠ¤ê°€ ì™„ì „íˆ í…… ë¹„ì—ˆë‹¤ë©´ ì´ˆê¸° ë°ì´í„° ë„£ê¸°
    seedIfNeeded();

    // 4. ì•± í™”ë©´ ë Œë”ë§ ì‹œì‘
    state.user = DB.get('currentUser', null);
    state.page = state.user ? 'main' : 'login';
    render();
  }

  // ì—”ì§„ ì‹œë™!
  bootApp();

</script>
</body>
</html>
